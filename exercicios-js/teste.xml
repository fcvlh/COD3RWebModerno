<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25" zv="Cache for UNIX (IBM AIX for System Power System-64) 2017.2 (Build 744U)" ts="2020-03-03 21:10:49">
<Routine name="IBSR.preco.MrgPrzPrEPontual" type="MAC" languagemode="0" timestamp="65437,58039.71774"><![CDATA[
IBSRprecoMrgPrzPrEPontual ; Atualiza Margem-Prazo-Prc.Especial Pontual ; <06/10 - DSD> ;Última Alteração   FLCARVALHO 28/02/2020 16:07:19
#Include sistema.BibliotecaMacro2
		;
MPE(USRT,CDEE,DFAT,%AMRO,RG,TIRE) ; PROCESSA ALTERACOES - MARGEM-PRAZO-PRC.ESPECIAL
 		;
 		N (USRT,CDEE,DFAT,%AMRO,RG,TIRE)
		S PART=$J,ZVEN=""
		S XAPCN=($G(%AMRO)="PCOINAC") ; <flcarvalho - GDTI-3047 - Indica se é aplicação de cenário do sistema de custos>
		;
        D CIJ 
		D CIN
		;
		I TPAP?1"M" D PMA,ARM,IPE I 1
		E  I TPAP?1"P" D ARP I 1
		E  I TPAP?1"E" D ARE I 1
		E  I TPAP?1"D" D ARD I 1
		;
		D ADC ; <flcarvalho - GDTI-4279 - Envio da condição comercial para o sistema de custos quando houver alteração na margem / prazo. />
		;
MPEZ	Q
		;
CIJ 	; Carrega Informacoes da Interface
		;
		;I $G(USRT)?1"DSD" B  ; ********************
		;I $G(USRT)?1"DSD" S RG="M;073120640001;01;11100001;19/10/2018;;0.0750;15;;999999;;6969;31/12/1840;;"
		;S RG="P;020164700001;1;16040000;18/01/2013;.05;0;15;;925;;;;1.2692;"
		;I $G(USRT)?1"DSD" S RG="M;422442850001;01;11100001;17/03/2014;;-.0686;15;;15026;;6515;31/12/1840;2.7148;"
		;I $G(USRT)?1"DSD" S RG="M;324040630028;01;15190000;19/07/2017;;-.6479;15;;305422;;6515;31/12/1840;2.4883;"
		;
 		S TPAP=$P(RG,";",01) ; Tipo de ação       : (id_tipo_acaopco)    ? (char(1) M (margem),
 		                     ;                                                      P (prazo),
 		                     ;                                                      E (preço especial)) ou
 		                     ;                                                      D (desconto comercial - TAREFA 75941)
 		S CNPJ=$P(RG,";",02) ; Cliente            : (cd_pess)            - (varchar(20) CNPJ (sem DV))
 		S PTEN=$P(RG,";",03) ; Ponto Entrega      : (cd_ptoe_cli)        ? (varchar(2)) 
 		S CPRO=$P(RG,";",04) ; Produto            : (cd_prod)            - (number(10) código produto Abadi)
 		S DTVI=$P(RG,";",05) ; Dt.Ini.Vigência    : (dt_ini_vig_acaopco) - (data (dd/mm/aaaa))
 		S MDCL=$P(RG,";",06) ; Margem do Cliente/
 		S VUDC=MDCL          ; Desconto Comercial : (vr_prop_mrg)        ? (number(15,4))
 		S VGAP=$P(RG,";",07) ; GAP de Margem ADT  : (vr_prop_gap)        ? (number(15,4))
		S PRAZ=$P(RG,";",08) ; Prazo Faturamento  : (qt_prop_dia_prazo)  ? (number(3,0))
 		S VGPR=$P(RG,";",09) ; GAP de Margem PRE  : (Gap_Premium)        - (number(15,4))
		S DCAP=$P(RG,";",10) ; Docto.Ação Preço   : (Numero_Ação)        - (number(10))
		S TPRZ=$P(RG,";",11) ; Tipo de Prazo      : (tipoPrazo)          - (number(1))
		S CDEP=$P(RG,";",12) ; Dependência        : (dependencia)        - (number(4))
		S DTEX=$P(RG,";",13) ; Dt.Fim Vigência    : (dtExpiracao)        - (data (dd/mm/aaaa))
		S VUCE=$P(RG,";",14) ; Vl.Unit.Combinado
		                     ; p/Entrega          : (vlUnitEntrega)      - (number(15,4))
		S VUCR=$P(RG,";",15) ; Vl.Unit.Combinado
		                     ; p/Retira           : (vlUnitRetira)       - (number(15,4))
		;
 		S STR=TPAP,TED=14 D RCE S TPAP=STR
		S STR=CNPJ,TED=14 D RCE S CNPJ=+STR
		S STR=PTEN,TED=14 D RCE S PTEN=STR
		S STR=CPRO,TED=14 D RCE S CPRO=+STR
		S STR=DTVI,TED=14 D RCE S DTVI=STR
		S STR=MDCL,TED=14 D RCE S MDCL=STR
		S STR=VUDC,TED=14 D RCE S VUDC=STR
		S STR=VGAP,TED=14 D RCE S VGAP=STR
		S STR=PRAZ,TED=14 D RCE S PRAZ=STR
		S STR=VGPR,TED=14 D RCE S VGPR=STR
		S STR=DCAP,TED=14 D RCE S DCAP=STR
		S STR=TPRZ,TED=14 D RCE S TPRZ=STR
		S STR=CDEP,TED=14 D RCE S CDEP=STR
		S STR=DTEX,TED=14 D RCE S DTEX=STR
		S STR=VUCE,TED=14 D RCE S VUCE=STR
		S STR=VUCR,TED=14 D RCE S VUCR=STR
		S TIRE=""
		;
		; Formata Cliente
		S CCLI=$E(CNPJ+1000000000000,2,13)_$S(PTEN?1N.N:$E(PTEN+100,2,3),1:PTEN)
		I '$D(^IBCLI(CCLI)) S CCLI=$E(CCLI,4,14)
		;
		; Formata Produto
		S CPRO=$E(CPRO+100000000,2,9)
		;
		; Formata Dependência
		S CDEP=$E(CDEP+10000,2,5)
		;
		; Formata Valores - Etapa 1
		I MDCL'?1"" S MDCL=$J(MDCL,0,4)
		I VGAP'?1"" S VGAP=$J(VGAP,0,4)
		I VGPR'?1"" S VGPR=$J(VGPR,0,4)
		;
		I VUCE'?1"" S VUCE=$J(VUCE,0,4)
		I VUCR'?1"" S VUCR=$J(VUCR,0,4)
		;
		I VUDC'?1"" S VUDC=$J(VUDC,0,4)
		;
		; Formata Prazo
		;
		; Formata Tp.Prazo
		;
 		; Margens/Prazos/Preços Especiais/Descontos Comerciais carregados nas Tabelas do ABADI
 		S ^IPAUX(PART,"MPE",1)=RG ; FORMATO: TPAP;CNPJ;PTEN;CPRO;DTVI;MDCL;VGAP;PRAZ;VGPR;DCAP;TPRZ
		;
 		I TPAP?1"M" S RG1=CCLI_"|"_CPRO_"|"_CPRO_"|"_CDEP_"|"_DTVI_"|"_MDCL_"||"_VGAP_"||"_VGPR_"||"_TIRE
 		E  I TPAP?1"P" S RG1=CCLI_"|"_CPRO_"|"_CPRO_"|"_PRAZ_"|"_TPRZ_"||"_TIRE
 		E  I TPAP?1"E" S RG1=CCLI_"|"_CPRO_"|"_CPRO_"|"_CDEP_"|"_DTEX_"|"_VUCE_"||"_VUCR_"||"_TIRE_"|"_DTVI
		E  D
		.S VUDC=MDCL,DTEX=DTVI
		.S RG1=CCLI_"|"_CPRO_"|"_CPRO_"|"_CDEP_"|"_DTEX_"|"_VUDC_"||"_TIRE_"|"_DTVI
		;
		S ^IPAUX(PART,"MPE",1,1)=RG1
		;
		; Formata Valores - Etapa 2
		I MDCL'?1"" S MDCL=$J(MDCL*100,0,2)
		I VGAP'?1"" S VGAP=$J(VGAP*100,0,2)
		I VGPR'?1"" S VGPR=$J(VGPR*100,0,2)
		;
		I VUCE'?1"" S VUCE=$J(VUCE*100,0,2)
		I VUCR'?1"" S VUCR=$J(VUCR*100,0,2)
		;
		I VUDC'?1"" S VUDC=$J(VUDC*100,0,2) ; PARA DESC.COMERCIAL (TAR,75941 - DSD - 04/2018)
		
		S RG1=^IPAUX(PART,"MPE",1,1)
		I TPAP?1"M" S $P(RG1,"|",7)=MDCL,$P(RG1,"|",9)=VGAP,$P(RG1,"|",11)=VGPR
		E  I TPAP?1"E" S $P(RG1,"|",7)=VUCE,$P(RG1,"|",9)=VUCR
		E  I TPAP?1"D" S $P(RG1,"|",7)=VUDC ; P/DESCONTO COMERCIAL (TAR.75941 - DSD - 04/2018)
		S ^IPAUX(PART,"MPE",1,1)=RG1
		;
CIJZ 	Q  
 		;
CIN 	; Critica Informações recebidas - Ação de Preços
		;
 		S RG=^IPAUX(PART,"MPE",1),TPAP=$P(RG,";",1)
 		S RG1=^IPAUX(PART,"MPE",1,1),CCLI=$P(RG1,"|",1),CPRO=$P(RG1,"|",2)
 		I TPAP?1"M" S CDEP=$P(RG1,"|",4),DTVI=$P(RG1,"|",5),MDCL=$P(RG1,"|",7),VGAP=$P(RG1,"|",9),VGPR=$P(RG1,"|",11)
 		E  I TPAP?1"P" S PRAZ=$P(RG1,"|",4),TPRZ=$P(RG1,"|",5)
 		E  I TPAP?1"E" S CDEP=$P(RG1,"|",4),DTEX=$P(RG1,"|",5),VUCE=$P(RG1,"|",7),VUCR=$P(RG1,"|",9)
		E  S CDEP=$P(RG1,"|",4),DTEX=$P(RG1,"|",5),VUDC=$P(RG1,"|",7)
		;
 	    S TIRE=""
 		;
		D CTR I TIRE'?1"" G CINZ                ; .Critica Tp.Registro
		D CCL I TIRE'?1"" G CINZ                ; .Critica Cliente
		;
		I TPAP?1"M" D
		.D CPR                                  ; .Critica Produto
		.I TIRE?1"" D CDP	            		; .Critica Dependência (TAR.006E408C - DSD - 12/2013)
		.I TIRE?1"" D CIV                       ; .Critica Início de Vigência
		.I TIRE?1"" D CVM                       ; .Critica valores Margem/Gap
		E  I TPAP?1"P" D
		.D CPR                                  ; .Critica Produto
		.I TIRE?1"" D CPF                       ; .Critica Prazo de Faturamento
		.I TIRE?1"" D CTP                       ; .Critica Tipo de Prazo  
		E  I TPAP?1"E" D
		.D CDP				            		; .Critica Dependência
		.I TIRE?1"" D CPR                       ; .Critica Produto
		.I TIRE?1"" D CVI                       ; .Critica Início de Vigência
		.I TIRE?1"" D CFV                       ; .Critica Fim de Vigência
		.I TIRE?1"" D CVE                       ; .Critica valores Combinados
		E  D                                    ; TAREFA 75941 - DSD - 04/2018
		.D CPR                                  ; .Critica Produto
		.I TIRE?1"" D CDP	            		; .Critica Dependência
		.I TIRE?1"" D CFV                       ; .Critica Fim de Vigência
		.I TIRE?1"" D CVD                       ; .Critica valor do Desconto Comercial
		;
		I TIRE'?1"" G CINZ
		;
CINZ 	Q  
 		;
CTR		; Critica Tipo de Registro
		;
		I TPAP?1"M" S %AP="PCO",%MOD="MA",%ROT="CC"
		E  I TPAP?1"P" S %AP="BSC",%MOD="CB",%ROT="IC"
		E  I TPAP?1"E" S %AP="PCO",%MOD="CA",%ROT="PE"
		E  I TPAP?1"D" S %AP="PCO",%MOD="CA",%ROT="DC"
		E  S TIRE="ERRO: Tipo de Ação ("_TPAP_") não identificado"
		;
CTRZ	Q
		;
CCL		; Critica Cliente
		;
		S X=$G(^IBCLI(CCLI,0)),SCLI=$P(X,"|",22)
		I X?1"" S TIRE="ERRO: Cliente ("_CCLI_") não cadastrado."
		E  I SCLI S TIRE="ERRO: Cliente ("_CCLI_") inativo"
		E  D
		.D RDC
 		.I TPAP?1"M" D
 		..S X=0
 		..I $G(ILMD) L ^IPMCD(CCLI):0 E  S X=1 I 1
 		..E  L ^IPMCL(CCLI):0 E  S X=1
 		..I (X)&&('XAPCN) S TIRE="ERRO: Margem de cliente ("_CCLI_") em uso. Tente mais tarde." ; <flcarvalho - GDTI-3047 - Valida os bloqueios do cliente>
		.E  I TPAP?1"P" D
 		..I $D(^IBCPZ(CCLI)) S TIRE="Cliente ("_CCLI_") com prazo congelado." 
		..S XCCLI=$E(CCLI,1,($L(CCLI)-2))_"01"
 		..L (^IPLPF(CCLI),^IBCLI(XCCLI)):0 
		..E  S TIRE="ERRO: Prazo de cliente ("_CCLI_") em uso. Tente mais tarde."
		.E  I TPAP?1"E" D
 		..I $E(CNEG,1)'=2!(",23101,"[(","_CNEG_",")) S TIRE="ERRO: Cliente deve ser CONSUMIDOR (exceto cooperativa de consumo)."
 		.E  D
 		..L ^IPDSC(CCLI):0
 		..E  S TIRE="ERRO: Desconto Comercial de cliente ("_CCLI_") em uso. Tente mais tarde."
		;
CCLZ	Q
		;
CPR		; Critica Produto
		;
		I ",P,E,"[(","_TPAP_",") D COM I PROUTIL'?1"" S CPRO=PROUTIL ; Recupera prod.comum do marcado
 		S X=$G(^IBPRO(CPRO)),CEMB=$P(X,"|",4),TPRO=$P(X,"|",21),CLPR=$P(X,"|",24)
		I X?1"" S TIRE="ERRO: Produto ("_CPRO_") não cadastrado."
		E  I CLPR'=1 S TIRE="ERRO: Produto ("_CPRO_") deve ser combustível."
		E  D
		.S EEMB="" I CEMB'?1"" S X=$G(^IBEMB(CEMB)),EEMB=$P(X,"|",3)
		.I ",M,D,"[(","_TPAP_",") D
 		..I EEMB S TIRE="ERRO: Produto ("_CPRO_") deve ser granel."
 		..E  D
 		...S PROMAR=CPRO D DPM
 		...I PROMAR?1"" S TIRE="ERRO: Produto ("_PROMAR_") inválido p/cadastramento de "_$S(TPAP?1"M":"margem.",1:"desconto comercial.")
 		...E  I TPAP?1"M" D
 		....S CPRO=PROMAR D RGP 
 		....I '$D(^IPMMA(PRODUTO)) S TIRE="ERRO: Produto ("_PRODUTO_") sem margem máxima cadastrada."
		.E  I TPAP?1"E" D
		..I 'TPRO D
 		...I CNEG'=22000&&(CCLI'=66975699000101)&&((",10,11,15,18,"'[(","_$E(CPRO,1,2)_","))||(",11000007,11000008,13010000,"[(","_CPRO_","))) S TIRE="ERRO: Deve ser gasolina, álcool, diesel ou biodiesel."
 		...E  I (CNEG=22000!(CCLI=66975699000101))&&(",10,11,15,18,"'[(","_$E(CPRO,1,2)_",")) S TIRE="ERRO: Deve ser gasolina, álcool, diesel ou biodiesel."
		...E  I $E(CNEG,1)'?1"2"!(",23101,"[(","_CNEG_",")) S TIRE="ERRO: Cliente deve ser consumidor."
 		...; TAREFA 0063E43F - DSD - 05/2013 ;E  I '$D(^IPCPE(1,CCLI)),",23400,23504,23606,23602,22000,"'[(","_CNEG_","),CCLI'=59275792000601 S TIRE="ERRO: Cliente deve ser ferroviário ou órgão do governo."
		...E  D
 		....S DATT=DFAT D RBS 
 		....I CDEA?1"" S TIRE="ERRO: Não existe base supridora cadastrada p/ O produto."
 		....E  I 'CMOR S TIRE="ERRO: Não existe município cadastrado p/ a base supridora do cliente."
 		..E  D
 		...I EEMB S TIRE="ERRO: Produto ("_CPRO_") deve ser granel."
		...E  S CMOR=XCMOR,CDEA=CDEP 
		.E  I CPRO'=12000000,",10,11,14,15,16,17,18,19,"'[(","_$E(CPRO,1,2)_",") S TIRE="ERRO: Produto ("_CPRO_") inválido." 
		;
		S X=^IPAUX(PART,"MPE",1,1),$P(X,"|",3)=CPRO,^IPAUX(PART,"MPE",1,1)=X
		S COMB=$E(CPRO,1,2) I ",16,17,19,"[(","_COMB_",") S COMB=17
		;
CPRZ	Q
		;
CDP		; Critica Dependência
		;
		I TPAP?1"M",'ILMD G CDPZ
		;
		S X=$G(^IBDEP(CDEP)),CUFD=$P(X,"|",8),CGCD=$P(X,"|",9),XCMOR=$P(X,"|",32)
		I X?1"" S TIRE="ERRO: Dependência não cadastrada."
		E  I TPAP?1"M" D
		.I ('XAPCN),$D(^IPRCL(1,CCLI,CDEP,COMB)) S TIRE="ERRO: Cliente c/restrição de atendimento para o produto na dependência." ; <flcarvalho - GDTI-3047 - XAPCN - Indica se é aplicação de cenário do sistema de custos>
		.;I $D(^IPRCL(1,CCLI,CDEP,COMB)) S TIRE="ERRO: Cliente c/restrição de atendimento para o produto na dependência."
		.E  D
		..D RCC
		..I CODCOM,'$D(^IPGMP(CDEP,TMER,CMIX,CODCOM,CPRO)) S MS="ERRO: Poduto aditivado s/relação de GAP com produto comum "_CODCOM_", na BASE "_CDEP_". Atualize a rotina PCO-MA-GM."
		E  D
 		.S CGCD=$E(CGCD,1,8)_$E(CGCD,10,13)_"01" 
 		.S X=^IBCLI(CGCD,1),CMUN=$P(X,"|",4) 
		;
CDPZ	Q
		;
CIV		; Critica Data de Início de Vigência
		;
		S DAT=DTVI D DEI
 		I DAT<1 S TIRE="ERRO: Data inválida."
 		E  I DAT<(+$$H^sistema.DOLLAR) S TIRE="ERRO: Vigência não pode ser menor que hoje."
		E  D
 		.S DTVI=DAT
 		.S DATT=DTVI,DIEINA=CPRO D DIN
 		.I DIEINA'?1"" S TIRE="ERRO: Produto ("_DIEINA_") inválido p/venda."
 		.E  D
 		..D BSP
 		..I CMOR?1""!(STDE) S TIRE="ERRO: Cliente/produto ("_CPRO_") sem BASE SUPRIDORA na data de vigência."
		..E  I TPAP?1"M" D
		... I ('XAPCN) && ($$margemEstaBloqueada(DTVI, CPRO)) S TIRE="ERRO: Preços e margens em manutenção. Tente mais tarde." ; <flcarvalho - GDTI-5783 - Tarefa-122448 - Bloqueio por grupo de produto />
		...; Inclusão da verificação de bloqueio de margens Tarefa 0059761B - DSD - 01/2015
 		...;S X=$G(^IPBMA(1)),DIBF=$P(X,"|",2) 
 		...;I ('XAPCN)&&(DIBF)&&(DTVI'<DIBF) S TIRE="ERRO: Preços e margens em manutenção. Tente mais tarde." ; <flcarvalho - GDTI-3047 - XAPCN - Indica se é aplicação de cenário do sistema de custos>
		...;;I DIBF,DTVI'<DIBF S TIRE="ERRO: Preços e margens em manutenção. Tente mais tarde."
		;
		I TPAP?1"M" S X=^IPAUX(PART,"MPE",1,1),$P(X,"|",5)=DTVI,^IPAUX(PART,"MPE",1,1)=X
		;
CIVZ	Q
		;
		// <marcuslm - GDTI-538 - Preço Especial c/Data Início de Vigência />
		;
CVI		; Critica Data Início Vigência (Preço Especial)
		;
		I ",31/12/1840,"[(","_DTVI_",") D  ; GDTI 538 - ING - 09/2019
		.S DAT=+$$H^sistema.DOLLAR D ^sistema.DIE
		.S DTVI=%X_"/"_%Z_"/"_%Y
 		S DAT=DTVI D DEI
 		I DAT<1 S TIRE="ERRO: Data inválida."
 		E  I DAT<(+$$H^sistema.DOLLAR) S TIRE="ERRO: Vigência não pode ser menor que hoje."
		E  S DTVI=DAT
		;
		I ",E,D,"[(","_TPAP_",") S X=^IPAUX(PART,"MPE",1,1),$P(X,"|",11)=DTVI,^IPAUX(PART,"MPE",1,1)=X
		;
CVIZ	Q
		;
CFV		; Critica Data de Fim de Vigência
		;
 		S DAT=DTEX D DEI
 		I DAT<1 S TIRE="ERRO: Data inválida."
 		E  I DAT<(+$$H^sistema.DOLLAR) S TIRE="ERRO: Vigência não pode ser menor que hoje."
		E  S DTEX=DAT
		;
		I ",E,D,"[(","_TPAP_",") S X=^IPAUX(PART,"MPE",1,1),$P(X,"|",5)=DTEX,^IPAUX(PART,"MPE",1,1)=X
		;
CFVZ	Q
		;
CVM		; Critica Composição dos Valores de Margem/GAP
		;
		; Sistema de Ação de Preços:
		;
		; . Por definição a interface dos Sist.Ação Preços X ABADI informa somente
		;   o código do produto de menor margem (produto comum);
		; . São enviados os valores da margem (produto comum), o gap do produto a-
		;   ditivado (se necessário), e o gap do produto premium (se necessário, e
		;   somente nos casos de gasolina C).
		;
		; . O gap aditivado não pode ser maior que o gap premium  
		;
		S ILMDCD=$S(ILMD:CDEA,1:"") ; Margem por Dependência - TAR.006E408C - DSD - 12/2013 
		;
 		D RIN K ILMDCD
		D RTG
		;
		I FTPGAP=2 S TIRE="ERRO: Produto deve ser de menor margem (produto comum)."
		;E  I MDCL'?1""&&(MDCL>MMAXPM) S TIRE="ERRO: Margem informada ("_$J(MDCL/100,0,4)_") maior que margem máxima do produto ("_$J(MMAXPM/100,0,4)_")" ;GDTI1424
		E  I CPROPR D
		.I VGPR'?1""&&((VGAP?1""&(VGAPAD>VGPR))||(VGAP'?1""&(VGAP>VGPR))) S TIRE="ERRO: GAP Premium ("_$J(VGPR/100,0,4)_") deve ser maior que GAP Aditivado ("_$S(VGAP?1"":$J(VGAPAD/100,0,4),1:$J(VGAP/100,0,4))_")."
		.E  I VGAP'?1""&&((VGPR?1""&(VGAP>VGAPPR))) S TIRE="ERRO: GAP Premium ("_$J(VGAPPR/100,0,4)_") deve ser maior que GAP Aditivado ("_$J(VGAP/100,0,4)_")."
		E  I FTPGAP,MDCL?1"" D  ; GDTI 3281 - DSD - 10/2018
		.I VGAP'?1""!(VGPR'?1"") D
		..S DAT=$O(^IPMCD(CCLI,CPRO,CDEP,(DTVI+1)),-1)
		..S X="" I DAT S X=^IPMCD(CCLI,CPRO,CDEP,DAT)
		..I $P(X,"|",2)?1"" set TIRE = "ERRO: Produto de menor margem ("_CPRO_") sem margem cadastrada"
		;
CVMZ	Q
		;
CVE		; Critica Composição dos Valores de Preço Especial
		;
		I 'VUCE,'VUCR S TIRE="ERRO: Preço especial (retira e entrega) não definidos."
		E  I CNEG=21000,VUCE S TIRE="ERRO: Cliente TRR não pode acordar preço especial RETIRA."	
		;
CVEZ	Q
		;
CVD		; Critica Valor do Desconto Comercial
		;
CVDZ	Q
		;
CPF		; Critica Prazo de Faturamento
		;
		I PRAZ?1"" S TIRE="ERRO: Prazo não definido."
		E  I PRAZ'?1N.N S TIRE="ERRO: Prazo de faturamento deve ser numérico."
		;
CPFZ	Q
		;
CTP		; Critica Tipo de Prazo de Faturamento
		;
		I TPRZ'?1"" D
		.I TPRZ'?1N.N S TIRE="ERRO: Tipo de prazo de faturamento deve ser numérico ou NULO."
		.E  I ",0,1,2,3,4,5,6,"'[(","_TPRZ_",") S TIRE="ERRO: Tipo de prazo deve ser entre 0 e 6."
		;
CTPZ	Q
		;
RDC		; Recupera Dados Adicionais do Cliente
		;
 		S X=$G(^IBCLI(CCLI,1)),CMUE=$P(X,"|",4),CIEC=$P(X,"|",5) 
 		S X=$G(^IBCLI(CCLI,2)),CNEG=$P(X,"|",2),CZVC=$P(X,"|",4),ICLR=$P(X,"|",15),CMIX=$P(X,"|",20) 
 		S (COPV,CIMA)="",COPV=$O(^IBIPC(CCLI,COPV)) I COPV,$D(^IBPVI(COPV)) S X=^IBPVI(COPV),CIMA=$P(X,"|",8)
 		S X=^IBMUN(CMUE),CUFE=$P(X,"|",4) 
		S X=^IBNEG(CNEG),NNEG=$P(X,"|",3)
 		S CMIX=$S('CMIX:" ",1:$P("U,R",",",CMIX))
 		S TMER=$S(CNEG=21000:"T",CNEG=22000:"G",$E(CNEG,1)=2:"C",$E(CNEG,1)=1:"R",1:"")
		S CGVC="" I CZVC S CGVC=$E(CZVC,1,3)_"000"
		;
		D VMD ; Margem por Dependência - TAR.006E408C - DSD - 12/2013 
		;
RDCZ	Q
		;
BSP 	; Recupera Base Supridora do Produto
		;
		I ILMD S CDEA=CDEP ; TAR.006E408C - DSD - 12/2013
		E  D
		.S DATT=DTVI D RBS
		.S CDEP=CDEA I CDEP?1"" S CDEP=" "
 		S STDE=1 I CDEA'?1"",$D(^IBDEP(CDEA)) S X=^IBDEP(CDEA),STDE=$P(X,"|",25),CMOR=$P(X,"|",32)
		;
BSPZ 	Q
 		;
RTG 	; Recupera Tipo de Gap
		;
		K ^IPAUX(PART,"MPE",2)
 		S FTPGAP=0
		S MMAXPM=""
 		S (CPROAD,VLGMAD,MMAXAD,MDCLAD,VGAPAD)="" ; PROD.ADITIVADO/GAP MÍNIMO ADITIVADO/MARGEM MÁXIMA ADITIVADA/MARGEM ADITIVADO/GAP ADITIVADO
 		S (CPROPR,VLGMPR,MMAXPR,MDCLPR,VGAPPR)="" ; PROD.PREMIUM  /GAP MÍNIMO PREMIUM  /MARGEM MÁXIMA PREMIUM  /MARGEM PREMIUM  /GAP PREMIUM
		S (CPME,VLGM)=""
		;
 		I CDEP?1"" G RTGZ
		;
 		I $D(^IPGMP(CDEP,TMER,CMIX,CPRO)) S FTPGAP=1
 		E  S CPME="" F  S CPME=$O(^IPGMP(CDEP,TMER,CMIX,CPME)) Q:CPME?1""  I $D(^IPGMP(CDEP,TMER,CMIX,CPME,CPRO)) S FTPGAP=2 Q
		;
		D RLI S MMAXPM=MMAX
		;
		; Verifica Gap Minimo
		;
 		I FTPGAP'=1 G RTGZ
		;
		S XDTVI=DTVI+1 
		I ILMD D
 		.S XDTVI=$O(^IPMCD(CCLI,CPRO,CDEP,XDTVI),-1)
 		.S X="" I XDTVI S X=$G(^IPMCD(CCLI,CPRO,CDEP,XDTVI))
 		.S MDCLPM=$P(X,"|",2),INNV=0 I MDCLPM?1"" S INNV=1
 		.S ^IPAUX(PART,"MPE",2,CPRO,CDEP)=XDTVI_"|"_MDCLPM
		E  D
 		.S XDTVI=$O(^IPMCL(CCLI,CPRO,XDTVI),-1)
 		.S X="" I XDTVI S X=$G(^IPMCL(CCLI,CPRO,XDTVI))
 		.S MDCLPM=$P(X,"|",2)
 		.S ^IPAUX(PART,"MPE",2,CPRO,CDEP)=XDTVI_"|"_MDCLPM
		;
		S CPMA="",XIPGMPR=1
RTG1	S CPMA=$O(^IPGMP(CDEP,TMER,CMIX,CPRO,CPMA))
		I CPMA?1"" D  G RTGZ
		.I (VGPR'?1"") && ('XIPGMPR) Set TIRE="ERRO: Produto ("_CPRO_") sem relação de GAP com produto premium."  ; <marcuslm GDTI-3554 - 2018/12 />
		;
		D CVG  ; TAR ALM-18861 - DSD - 05/2016 - Indicativo de Produtos Válidos para Recuperação de Margem
		I (",11050001,11050003,"[(","_CPMA_",")) S XIPGMPR = IPGM ; <flcarvalho - Após a recuperação da flag do produto premium, armazena o valor, pois a variável é sobrescrita
		I 'IPGM G RTG1
		;
		;D RPV I 'IPRM G RTG1  ; TAR ALM-18861 - DSD - 05/2016 - Indicativo de Produtos Válidos para Recuperação de Margem
		;
		S XDTVI=DTVI+1
 		S XDTVI=$O(^IPGMP(CDEP,TMER,CMIX,CPRO,CPMA,XDTVI),-1)
 		S X="" I XDTVI S X=$G(^IPGMP(CDEP,TMER,CMIX,CPRO,CPMA,XDTVI))
 		S VLGM=$P(X,"|",2)
		;
		I ",11050001,11050003,"[(","_CPMA_",") D  
		.; *** GAP de produto premium (GASOLINA PREMIUM/OCTAPRO)    ***
		.; *** INCLUSÃO 11050003 - TAREFA ALM-52976 - DSD - 07/2017 ***
		.I ILMD&($D(^IPMCD(CCLI,CPMA,CDEP)))
		.E  I 'ILMD&($D(^IPMCL(CCLI,CPMA)))
		.E  I VGPR'?1""
		.I  D
		..D RMM
 		..I CMOR?1""!(STDE) S:VGPR'?1"" TIRE="ERRO: Cliente/produto ("_CPRO_") sem BASE SUPRIDORA na data de vigência."
		..E  D
		...S CPROPR=CPMA,VLGMPR=VLGM
		...S MMAXPR=MMAX,MDCLPR=MDCC,VGAPPR=VGCC
 		...S ^IPAUX(PART,"MPE",2,CPMA,CDEP)=XDTVI_"|"_MDCC_"|"_VGCC_"|"_MMAX_"|"_VLGM
		E  D
		.; *** GAP de produto aditivado ***
		.I ILMD&($D(^IPMCD(CCLI,CPMA,CDEP)))
		.E  I 'ILMD&($D(^IPMCL(CCLI,CPMA)))
		.E  I VGAP'?1""
		.I  D
		..D RMM
 		..I CMOR?1""!(STDE) S:VGAP'?1"" TIRE="ERRO: Cliente/produto ("_CPRO_") sem BASE SUPRIDORA na data de vigência."
		..E  D
		...S CPROAD=CPMA,VLGMAD=VLGM
		...S MMAXAD=MMAX,MDCLAD=MDCC,VGAPAD=VGCC
 		...S ^IPAUX(PART,"MPE",2,CPMA,CDEP)=XDTVI_"|"_MDCC_"|"_VGCC_"|"_MMAX_"|"_VLGM
		;
		G RTG1		
 		;
RTGZ 	Q
 		;
RMM		; Recupera Margem Máxima/Base Supridora
		;
		N CPRO S CPRO=CPMA
		;
		D RLI
		;
		S XDTVI=DTVI+1 
		I ILMD D
 		.S XDTVI=$O(^IPMCD(CCLI,CPRO,CDEP,XDTVI),-1)
 		.S X="" I XDTVI S X=$G(^IPMCD(CCLI,CPRO,CDEP,XDTVI))
		E  D
 		.S XDTVI=$O(^IPMCL(CCLI,CPRO,XDTVI),-1)
 		.S X="" I XDTVI S X=$G(^IPMCL(CCLI,CPRO,XDTVI))
 		S MDCC=$P(X,"|",2),VGCC=$P(X,"|",3)
		;
 		D BSP
		;
RMMZ	Q
		;
PMA		; Projeta Margens
		;
		K ^IPAUX(PART,"MPE",9)
		I TIRE'?1"" G PMAZ
		;
 		S X=^IPAUX(PART,"MPE",1,1)
 		S CCLI=$P(X,"|",01),CPRO=$P(X,"|",03)
 		S DTVI=$P(X,"|",05),MDCL=$P(X,"|",07),VGAP=$P(X,"|",09),VGPR=$P(X,"|",11)
		;
	    I MDCL'?1"" D  I TIRE'?1"" G PMAZ
		.D APC
		.I CPROAD'?1"" D AMD(CPROAD,MMAXAD)
		.I CPROPR'?1"" D AMD(CPROPR,MMAXPR)
		;
		I CPROAD'?1"",VGAP'?1"" D AGD(CPROAD,MMAXAD,VGAP) I TIRE'?1"" G PMAZ
		I CPROPR'?1"",VGPR'?1"" D AGD(CPROPR,MMAXPR,VGPR) I TIRE'?1"" G PMAZ
		;
PMAZ	Q
		;
APC		; Aplica Margem ao Produto Comum
		;
		S XDTVI=DTVI-1
		I ILMD D
		.F  S XDTVI=$O(^IPMCD(CCLI,CPRO,CDEP,XDTVI)) Q:XDTVI?1""  D
		..M ^IPAUX(PART,"MPE",9,CPRO,CDEP,XDTVI)=^IPMCD(CCLI,CPRO,CDEP,XDTVI)
		E  D
		.F  S XDTVI=$O(^IPMCL(CCLI,CPRO,XDTVI)) Q:XDTVI?1""  D
		..M ^IPAUX(PART,"MPE",9,CPRO,CDEP,XDTVI)=^IPMCL(CCLI,CPRO,XDTVI)
		S X=$G(^IPAUX(PART,"MPE",9,CPRO,CDEP,DTVI)),$P(X,"|",2)=MDCL,^IPAUX(PART,"MPE",9,CPRO,CDEP,DTVI)=X
		;
APCZ	Q
		;
AMD(XCPRO,XMMAX) ; Aplica Margem ao Produto Aditivado/Premium
		;
		N XDTVI,YDTVI,XVGAP,XMDCL
		I TIRE'?1"" G AMDZ
		;
		S XDTVI=DTVI-1
		I ILMD D
		.F  S XDTVI=$O(^IPMCD(CCLI,XCPRO,CDEP,XDTVI)) Q:XDTVI?1""  D
		..M ^IPAUX(PART,"MPE",9,XCPRO,CDEP,XDTVI)=^IPMCD(CCLI,XCPRO,CDEP,XDTVI)
		E  D
		.F  S XDTVI=$O(^IPMCL(CCLI,XCPRO,XDTVI)) Q:XDTVI?1""  D
		..M ^IPAUX(PART,"MPE",9,XCPRO,CDEP,XDTVI)=^IPMCL(CCLI,XCPRO,XDTVI)
		I '$D(^IPAUX(PART,"MPE",9,XCPRO,CDEP,DTVI)) D
		.S XDTVI=DTVI+1
		.I ILMD D
		..S X="",XDTVI=$O(^IPMCD(CCLI,XCPRO,CDEP,XDTVI),-1)
		..I XDTVI S X=^IPMCD(CCLI,XCPRO,CDEP,XDTVI)
		.E  D
		..S X="",XDTVI=$O(^IPMCL(CCLI,XCPRO,XDTVI),-1)
		..I XDTVI S X=^IPMCL(CCLI,XCPRO,XDTVI)
		.S XVGAP=$P(X,"|",3),$P(^IPAUX(PART,"MPE",9,XCPRO,CDEP,DTVI),"|",3)=XVGAP
		;
		S XDTVI=""
		F  S XDTVI=$O(^IPAUX(PART,"MPE",9,XCPRO,CDEP,XDTVI)) Q:XDTVI?1""!(TIRE'?1"")  D
		.S X=^IPAUX(PART,"MPE",9,XCPRO,CDEP,XDTVI),XVGAP=$P(X,"|",3)
		.S YDTVI=XDTVI+1
		.S X="",YDTVI=$O(^IPAUX(PART,"MPE",9,CPRO,CDEP,YDTVI),-1) 
		.I YDTVI S X=^IPAUX(PART,"MPE",9,CPRO,CDEP,YDTVI)
		.S XMDCL=$P(X,"|",2),XMDCL=XMDCL+XVGAP
		.;I XMDCL>XMMAX S TIRE="ERRO: Margem calculada ("_$J(XMDCL/100,0,4)_") maior que margem máxima do produto "_XCPRO_" ("_$J(XMMAX/100,0,4)_")." ;GDTI1424
		.S X=^IPAUX(PART,"MPE",9,XCPRO,CDEP,XDTVI),$P(X,"|",2)=XMDCL,^IPAUX(PART,"MPE",9,XCPRO,CDEP,XDTVI)=X ;GDTI1424
		;
AMDZ	Q
		;
AGD(XCPRO,XMMAX,XVGAP) ; Aplica GAP ao Produto Aditivado/Premium
		;
		N XDTVI,YDTVI,XMDCL
		I TIRE'?1"" G AGDZ
		;
		I '$D(^IPAUX(PART,"MPE",9,XCPRO)) D
		.S XDTVI=DTVI-1
		.I ILMD D
		.F  S XDTVI=$O(^IPMCD(CCLI,XCPRO,CDEP,XDTVI)) Q:XDTVI?1""  D
		..M ^IPAUX(PART,"MPE",9,XCPRO,CDEP,XDTVI)=^IPMCD(CCLI,XCPRO,CDEP,XDTVI)
		.E  D
		.F  S XDTVI=$O(^IPMCL(CCLI,XCPRO,XDTVI)) Q:XDTVI?1""  D
		..M ^IPAUX(PART,"MPE",9,XCPRO,CDEP,XDTVI)=^IPMCL(CCLI,XCPRO,XDTVI)
		;
		S X=$G(^IPAUX(PART,"MPE",9,CPRO,CDEP,DTVI)),XMDCL=$P(X,"|",2)
		I XMDCL?1"" D
		.S YDTVI=DTVI+1
		.I ILMD D
		..S X="",YDTVI=$O(^IPMCD(CCLI,CPRO,CDEP,YDTVI),-1) 
		..I YDTVI S X=^IPMCD(CCLI,CPRO,CDEP,YDTVI),XMDCL=$P(X,"|",2)
		.E  D
		..S X="",YDTVI=$O(^IPMCL(CCLI,CPRO,YDTVI),-1) 
		..I YDTVI S X=^IPMCL(CCLI,CPRO,YDTVI),XMDCL=$P(X,"|",2)
		S XMDCL=XMDCL+XVGAP
		;I XMDCL>XMMAX S TIRE="ERRO: Margem calculada ("_$J(XMDCL/100,0,4)_") maior que margem máxima do produto "_XCPRO_" ("_$J(XMMAX/100,0,4)_")." ;GDTI1424
		S X=$G(^IPAUX(PART,"MPE",9,XCPRO,CDEP,DTVI)),$P(X,"|",2,3)=XMDCL_"|"_XVGAP,^IPAUX(PART,"MPE",9,XCPRO,CDEP,DTVI)=X ;GDTI1424
		;
AGDZ	Q
		;
ARM 	; ARMazena Margem/Gap Cliente/Produto
		;
 		S H=$$H^sistema.DOLLAR 
 		S DACE=$P(H,",",1),HORT=$P(H,",",2) 
 		S CARG=DACE_","_HORT_","_USRT 
 		S OTRA=CARG_","_CDEE
 		; 
 		S X=^IPAUX(PART,"MPE",1),DCAP=$P(X,";",10)
 		S X=^IPAUX(PART,"MPE",1,1),CCLI=$P(X,"|",01),DTVI=$P(X,"|",05)
		;
		I TIRE'?1"" G ARM1
		;
		S (XCPRO,XDTVI,XCDEP)=""
ARM01	S XCPRO=$O(^IPAUX(PART,"MPE",9,XCPRO)) I XCPRO?1"" G ARM1
ARM02	S XCDEP=$O(^IPAUX(PART,"MPE",9,XCPRO,XCDEP)) I XCDEP?1"" G ARM01
ARM03	S XDTVI=$O(^IPAUX(PART,"MPE",9,XCPRO,XCDEP,XDTVI)) I XDTVI?1"" G ARM02
		S RGTP=^IPAUX(PART,"MPE",9,XCPRO,XCDEP,XDTVI),LPPO=$L(RGTP,"|")
		I ILMD S RGTA=$G(^IPMCD(CCLI,XCPRO,XCDEP,XDTVI))
		E  S RGTA=$G(^IPMCL(CCLI,XCPRO,XDTVI))
		S LPAN=$L(RGTA,"|")
		;
		S LPIE=LPPO I LPAN>LPPO S LPIE=LPAN
		S ARM=0 F I=2:1:LPIE I I'=4,$P(RGTP,"|",I)'=$P(RGTA,"|",I) S ARM=1,ARM(XCPRO,XCDEP)="" Q  ; I=01 - PIECE 01 - CARG
		;                                                                                         ; I=04 - PIECE 04 - OBSV
        ;;;S ARM=1 ; ************** PROVISORIO P/TESTE DE PERFORMACE
		;
		I 'ARM G ARM03
		;
		S TALT=1 I RGTA'?1"" S TALT=2
 		S $P(RGTP,"|",1)=CARG
		I DTVI=XDTVI S $P(RGTP,"|",4)=DCAP
 		I ILMD D
 		.S ^IPMCD(CCLI,XCPRO,XCDEP,XDTVI)=RGTP 
		.S MDCL=$P(RGTP,"|",2),VGAP=$P(RGTP,"|",3),OBSV=$P(RGTP,"|",4)
 		.S SEQL1=$I(^IPMCD.LOG(CCLI,XCPRO,XCDEP,DACE))
 		.S ^IPMCD.LOG(CCLI,XCPRO,XCDEP,DACE,SEQL1,USRT)=TALT_"|"_OTRA_"|"_XDTVI_"|"_MDCL_"|"_VGAP_"|"_OBSV_"||"_XCDEP
		.I DCAP S ^IPMCD.APC(DCAP,XDTVI,CCLI,XCPRO,XCDEP)=""
		E  D
 		.S ^IPMCL(CCLI,XCPRO,XDTVI)=RGTP 
		.S MDCL=$P(RGTP,"|",2),VGAP=$P(RGTP,"|",3),OBSV=$P(RGTP,"|",4)
 		.S SEQL1=$I(^IPLMC(CCLI,XCPRO,DACE))
 		.S ^IPLMC(CCLI,XCPRO,DACE,SEQL1,USRT)=TALT_"|"_OTRA_"|"_XDTVI_"|"_MDCL_"|"_VGAP_"|"_OBSV
 		;
 		S X=^IBCLI(CCLI,2),WCNEG=$P(X,"|",2),WCZVC=$P(X,"|",4),WCGVC=$E(WCZVC,1,3)_"000"
		;
 		S WGMADE="",WGDVIG=$O(^IPMDE(WCGVC,XCPRO,(XDTVI+1)),-1)
 		I WGDVIG D
 		.S X=^IPMDE(WCGVC,XCPRO,WGDVIG),WGMADE=$P(X,"|",2),WGMADB=$P(X,"|",3)
 		.I WCNEG=11260,WGMADB'?1"" S WGMADE=WGMADB
 		S WZMADE="",WZDVIG=$O(^IPMDE(WCZVC,XCPRO,(XDTVI+1)),-1)
 		I WZDVIG D
 		.S X=^IPMDE(WCZVC,XCPRO,WZDVIG),WZMADE=$P(X,"|",2),WZMADB=$P(X,"|",3) 
 		.I WCNEG=11260,WZMADB'?1"" S WZMADE=WZMADB
 		S WMADE=WGMADE,WGZVC=WCGVC I WZMADE<WGMADE S WMADE=WZMADE,WGZVC=WCZVC
 		I MDCL<WMADE D
 		.S audSTAT=$S(TALT=1:"Inclusao",1:"Alteracao"),audCHAVE=CCLI_","_XCPRO_","_XDTVI_","_WGZVC_","_WMADE
 		.S oAudEdit=##class(cbpi.abadi.audit.IPMCLEdicao).criar(audCHAVE,RGTA,RGTP)
 		.D ##class(audit.Auditoria).auditar("IPMCL",audSTAT,"PCO_IN_MG"_audSTAT,oAudEdit,audSTAT_" Margens Abaixo do Minimo ")
 		;
		G ARM03
		;
ARM1	D LOM
		;
ARMZ 	Q  
 		;
ARP     ; ARmazena Prazos do cliente
		;
 		S H=$$H^sistema.DOLLAR 
 		S DACE=$P(H,",",1),HORT=$P(H,",",2) 
 		S CARG=DACE_","_HORT_","_USRT 
 		S OTRA=CARG_","_CDEE
 		; 
 		S X=^IPAUX(PART,"MPE",1),DCAP=$P(X,";",10)
 		S X=^IPAUX(PART,"MPE",1,1),CCLI=$P(X,"|",01),CPRO=$P(X,"|",03),PRAZ=$P(X,"|",04),TPRZ=$P(X,"|",05)
		;
		I TIRE'?1"" G ARP1
		;
 		S RGTA=$G(^IFCIC(CCLI,CPRO)),PRAZA=$P(RGTA,"|",1),TPRZA=$P(RGTA,"|",6),FSEGA=$P(RGTA,"|",07),FTERA=$P(RGTA,"|",08),FQUAA=$P(RGTA,"|",09),FQUIA=$P(RGTA,"|",10),FSEXA=$P(RGTA,"|",11),FSABA=$P(RGTA,"|",12)
 		S TALT=2 I RGTA?1"" S TALT=1
		S (FSEG,FTER,FQUA,FQUI,FSEX,FSAB)="",TPRZ=0
		;I TPRZ?1"" D
		;.I TALT=1 S TPRZ=0 ; TIPO DE PRAZO DEFAULT - DIAS DA DATA
		;.E  S TPRZ=TPRZA 
 		S ARM=0 I PRAZ'=PRAZA!(TPRZ'=TPRZA) S ARM=1
 		I 'ARM G ARP1
 		;
 		S RGTP=RGTA
 		S $P(RGTP,"|",1)=PRAZ,$P(RGTP,"|",3)=CARG,$P(RGTP,"|",6,12)=TPRZ_"|"_FSEG_"|"_FTER_"|"_FQUA_"|"_FQUI_"|"_FSEX_"|"_FSAB
 		;
 		S ^IFCIC(CCLI,CPRO)=RGTP
        D RAP 
		;
 		S TPRZ=$P(RGTP,"|",06),PRAZ=$P(RGTP,"|",01),DLPE=$P(RGTP,"|",04),PRZE=$P(RGTP,"|",05) 
 		S FSEG=$P(RGTP,"|",07),FTER=$P(RGTP,"|",08),FQUA=$P(RGTP,"|",09),FQUI=$P(RGTP,"|",10) 
 		S FSEX=$P(RGTP,"|",11),FSAB=$P(RGTP,"|",12),TPCB=$P(RGTP,"|",13),PZCB=$P(RGTP,"|",14) 
 		S CSEG=$P(RGTP,"|",15),CTER=$P(RGTP,"|",16),CQUA=$P(RGTP,"|",17),CQUI=$P(RGTP,"|",18) 
 		S CSEX=$P(RGTP,"|",19),CSAB=$P(RGTP,"|",20),CDOM=$P(RGTP,"|",21),FDUT=$P(RGTP,"|",22) 
 		S ^IBHPZ(CCLI,CPRO,DACE,HORT,USRT)=TALT_"|"_DCAP
 		S ^IBHPZ(CCLI,CPRO,DACE,HORT,USRT,"F")=TPRZ_"|"_PRAZ_"|"_FSEG_"|"_FTER_"|"_FQUA_"|"_FQUI_"|"_FSEX_"|"_FSAB_"|"_PRZE_"|"_DLPE 
		I DCAP S ^IBHPZ.APC(DCAP,DACE,CCLI,CPRO)=""
		;
ARP1	D LOP
		;
ARPZ 	Q  
        ;
ARE     ; ARmazena Preço Especial do cliente
		;
 		S H=$$H^sistema.DOLLAR 
 		S DATA=$P(H,",",1),HORA=$P(H,",",2) 
 		S CARG=DATA_","_HORA_","_USRT 
 		S OTRA=CARG_","_CDEE
		;
 		S X=^IPAUX(PART,"MPE",1),DCAP=$P(X,";",10)
 		S X=^IPAUX(PART,"MPE",1,1)
 		S CCLI=$P(X,"|",01),CPRO=$P(X,"|",03),CDEP=$P(X,"|",04),DTEX=$P(X,"|",05)
 		;S VUCE=$P(X,"|",07),VUCR=$P(X,"|",09)                   // <marcuslm - GDTI-538 - Preço Especial c/Data Início de Vigência />
 		S VUCE=$P(X,"|",07),VUCR=$P(X,"|",09),DTVI=$P(X,"|",11)  // <marcuslm - GDTI-538 - Preço Especial c/Data Início de Vigência />
		;
		I TIRE'?1"" G ARE1
		;
		S RGTP=CARG_"|"_VUCE_"|"_VUCR_"|"_DTEX_"|"_DCAP,LPPO=$L(RGTP,"|") 
		;
		; <flcarvalho - GDTI-538 - 2018-02 - Recupera o preço especial vigente>
		S RGTA=$G(^IPCPE(1,CCLI,CDEP,CPRO,DTVI)),LPAN=$L(RGTA,"|") // <marcuslm - GDTI-538 - Preço Especial c/Data Início de Vigência />
		;S RGTA=$G(^IPCPE(1,CCLI,CDEP,CPRO)),LPAN=$L(RGTA,"|")     // <marcuslm - GDTI-538 - Preço Especial c/Data Início de Vigência />
		; *** D RPE(CCLI,CDEP,CPRO,.oPE)
		; *** S RGTA=oPE.GetAt("CONTEUDO"),LPAN=$L(RGTA,"|")
		; *** S XDIVG=oPE.GetAt("INICIO")
		; *** S XDTEX=oPE.GetAt("FIM")
		;
		S LPIE=LPPO I LPAN>LPPO S LPIE=LPAN
		S ARM=0 F I=2:1:LPIE I $P(RGTP,"|",I)'=$P(RGTA,"|",I) S ARM=1 Q       ; I=01 - PIECE 01 - CARG
		;
		I 'ARM G ARE1
		;
		; <flcarvalho - GDTI-538 - 2018-02 - Caso exista uma vigência que conflite com a vigência enviada pelo APCO, atualiza a última para >
		S TALT=1 I RGTA'?1"" S TALT=2
 		;S ^IPCPE(1,CCLI,CDEP,CPRO)=RGTP        // <marcuslm - GDTI-538 - Preço Especial c/Data Início de Vigência /> 
 		S ^IPCPE(1,CCLI,CDEP,CPRO,DTVI)=RGTP    // <marcuslm - GDTI-538 - Preço Especial c/Data Início de Vigência />
 		;S ^IPCPE("LOG",CCLI,CDEP,CPRO,DATA,HORA,USRT)=TALT_"|"_VUCE_"|"_VUCR_"|"_DTEX_"|"_DCAP                               // <marcuslm - GDTI-538 - Preço Especial c/Data Início de Vigência />
 		S ^IPCPE("LOG",CCLI,CDEP,CPRO,DTVI,HORA,$P(CARG,",",3))=TALT_"|"_VUCE_"|"_VUCR_"|"_DTEX_"|"_DCAP_"||"_CARG_"|"_DTVI   // <marcuslm - GDTI-538 - Preço Especial c/Data Início de Vigência />
		I DCAP S ^IPCPE.APC(DCAP,DATA,CCLI,CPRO,CDEP)=""
		; *** I XDTEX>DATA,RGTA'="" D EVG
		; *** S TALT=1 I RGTA'?1"" S TALT=2
 		; *** S ^IPCPE(1,CCLI,CDEP,CPRO,DATA)=RGTP
 		; *** S ^IPCPE("LOG",CCLI,CDEP,CPRO,DATA,HORA,USRT)=TALT_"|"_VUCE_"|"_VUCR_"|"_DTEX_"|"_DCAP
		; *** I DCAP S ^IPCPE.APC(DCAP,DATA,CCLI,CPRO,CDEP)=""
		;
ARE1	D LOE
		;
AREZ	Q
		;
ARD 	; ARMazena Desconto Comercial Cliente/Produto
		;
 		S H=$$H^sistema.DOLLAR 
 		S DACE=$P(H,",",1),HORT=$P(H,",",2) 
 		S CARG=DACE_","_HORT_","_USRT 
 		S OTRA=CARG_","_CDEE
 		; 
 		S X=^IPAUX(PART,"MPE",1),DCAP=$P(X,";",10)
 		S X=^IPAUX(PART,"MPE",1,1)
 		S CCLI=$P(X,"|",01),CPRO=$P(X,"|",03),CDEP=$P(X,"|",4),DTEX=$P(X,"|",05),VUDC=$P(X,"|",07)
		S DTVI=DACE
		;
		I TIRE'?1"" G ARD1
		;
		S RGTP=CARG_"|"_VUDC_"|"_DTEX_"|"_DCAP,LPPO=$L(RGTP,"|") 
		;
		S RGTA=$G(^IPDSC(CCLI,CPRO,CDEP,DTVI))
		S LPAN=$L(RGTA,"|")
		;
		S LPIE=LPPO I LPAN>LPPO S LPIE=LPAN
		S ARM=0 F I=2:1:LPIE I $P(RGTP,"|",I)'=$P(RGTA,"|",I) S ARM=1 Q  ; I=01 - PIECE 01 - CARG
		;
		I 'ARM G ARD1
		;
		S TALT=1 I RGTA'?1"" S TALT=2
 		S ^IPDSC(CCLI,CPRO,CDEP,DTVI)=RGTP 
 		S SEQL=$I(^IPDSC.LOG(CCLI,CPRO,CDEP,DACE))
 		S ^IPDSC.LOG(CCLI,CPRO,CDEP,DACE,SEQL)=TALT_"|"_OTRA_"|"_DTVI_"|"_VUDC_"|"_DTEX_"|"_DCAP
		I DCAP S ^IPDSC.APC(DCAP,DTVI,CCLI,CPRO,CDEP)=""
 		;
ARD1	D LOD
		;
ARDZ 	Q  
 		;
EVG		; Encerra ViGência ; <flcarvalho - GDTI-538 - 2018-02>
		; Encerra vigência do preço especial para o dia atual
		S $P(RGTA,"|",4)=DATA,$P(RGTA,"|",1)=CARG,$P(RGTA,"|",5)=DCAP
		S ^IPCPE(1,CCLI,CDEP,CPRO,XDIVG)=RGTA
		;S ^IPCPE("LOG",CCLI,CDEP,CPRO,DATA,HORA-1,USRT)="2|"_$P(RGTA,"|",2,99)                                    // <marcuslm - GDTI-538 - Preço Especial c/Data Início de Vigência />
		S ^IPCPE("LOG",CCLI,CDEP,CPRO,DATA,HORA-1,USRT)="2|"_$P(RGTA,"|",2,10)_"|"_XDIVG_"|"_$P(RGTA,"|",11,99)    // <marcuslm - GDTI-538 - Preço Especial c/Data Início de Vigência />
EVGZ	Q
		;
IPE		; Investiga Preço Especial Vigente - TAREFA ALM-26971 - DSD - 12/2016
		;
		I TIRE'?1""!(%AMRO'?1"PCOINMG") G IPEZ 
		;
		S OBPE="APCO_Margem-"_DCAP
 		S CARG=$$H^sistema.DOLLAR_","_USRT,DATA=$P(CARG,",",1),HORA=$P(CARG,",",2)
 		S OTRA=CARG_","_CDEE
		;
 		S X=^IPAUX(PART,"MPE",1,1)
 		S CCLI=$P(X,"|",01),CPRO=$P(X,"|",03),CDEP=$P(X,"|",4)
 		S DTVI=$P(X,"|",05),MDCL=$P(X,"|",07),VGAP=$P(X,"|",09),VGPR=$P(X,"|",11)
		;
		I '$D(ARM(CPRO,CDEP)) G IPEZ ; indica que não houve atualização de margem
		;
	    I MDCL'?1"",CPRO'?1"" D CPE(CPRO)
		I VGAP'?1"",CPROAD'?1"" D CPE(CPROAD)
		I VGPR'?1"",CPROPR'?1"" D CPE(CPROPR)
		;
IPEZ	Q
		;
CPE(XCPR) ; Cancela Preço Especial Vigente - TAREFA ALM-26971 - DSD - 12/2016
		;
		; <flcarvalho - GDTI-538 - 2018-02 - Recupera o preço especial vigente>
		;S (RGTA,RGTP)=$G(^IPCPE(1,CCLI,CDEP,XCPR)),DTEX=$P(RGTA,"|",4)     // <marcuslm - GDTI-538 - Preço Especial c/Data Início de Vigência />
		S (RGTA,RGTP)=$G(^IPCPE(1,CCLI,CDEP,XCPR,DTVI)),DTEX=$P(RGTA,"|",4) // <marcuslm - GDTI-538 - Preço Especial c/Data Início de Vigência />
		; *** D RPE(CCLI,CDEP,XCPR,.oPE)
		; *** S (RGTA,RGTP)=oPE.GetAt("CONTEUDO")
		; *** S XDIVG=oPE.GetAt("INICIO")
		; *** S DTEX=oPE.GetAt("FIM")
		I RGTA?1""!(DTEX'>DTVI) G CPEZ
		;
		S TALT=2
		S $P(RGTP,"|",1)=CARG,$P(RGTP,"|",4,6)=DTVI_"|"_DCAP_"|"_OBPE
		;
 		; <flcarvalho - GDTI-538 - 2018-02 - Armazena o preço especial informado>
 		;S ^IPCPE(1,CCLI,CDEP,XCPR)=RGTP   // <marcuslm - GDTI-538 - Preço Especial c/Data Início de Vigência />
 		S ^IPCPE(1,CCLI,CDEP,XCPR,DTVI)=RGTP    // <marcuslm - GDTI-538 - Preço Especial c/Data Início de Vigência />
 		; *** S ^IPCPE(1,CCLI,CDEP,XCPR,XDIVG)=RGTP
		;
 		;S ^IPCPE("LOG",CCLI,CDEP,XCPR,DATA,HORA,USRT)=TALT_"|"_$P(RGTP,"|",2,6)_"|"_CARG          // <marcuslm - GDTI-538 - Preço Especial c/Data Início de Vigência />
 		S ^IPCPE("LOG",CCLI,CDEP,XCPR,DATA,HORA,USRT)=TALT_"|"_$P(RGTP,"|",2,6)_"|"_CARG_"|"_DTVI  // <marcuslm - GDTI-538 - Preço Especial c/Data Início de Vigência />
		;
CPEZ	Q
		;
LOM		; Grava Log de Interface - Margem
		;
    	S X=^IPAUX(PART,"MPE",1,1),$P(X,"|",12)=TIRE,^IPAUX(PART,"MPE",1,1)=X
		;
 		S SEQL1=$I(^IPLMC.LOG(CCLI,DACE))
 		S ^IPLMC.LOG(CCLI,DACE,SEQL1)=OTRA
 		M ^IPLMC.LOG(CCLI,DACE,SEQL1)=^IPAUX(PART,"MPE")
		;
LOMZ	Q
		;
LOP		; Grava Log de Interface - Prazo
		;
    	S X=^IPAUX(PART,"MPE",1,1),$P(X,"|",06,07)=TPRZ_"|"_TIRE,^IPAUX(PART,"MPE",1,1)=X
		;
 		S SEQL1=$I(^IBHPZ.LOG(CCLI,DACE))
 		S ^IBHPZ.LOG(CCLI,DACE,SEQL1)=OTRA
 		M ^IBHPZ.LOG(CCLI,DACE,SEQL1)=^IPAUX(PART,"MPE")
		;
LOPZ	Q
		;
LOE		; Grava Log de Interface - Preço Especial
		;
    	S X=^IPAUX(PART,"MPE",1,1),$P(X,"|",10)=TIRE,^IPAUX(PART,"MPE",1,1)=X
		;
 		S SEQL1=$I(^IPCPE.LOG(CCLI,CDEP,CPRO,DATA))
 		S ^IPCPE.LOG(CCLI,CDEP,CPRO,DATA,SEQL1)=OTRA
 		M ^IPCPE.LOG(CCLI,CDEP,CPRO,DATA,SEQL1)=^IPAUX(PART,"MPE")
		;
LOEZ	Q
		;
LOD		; Grava Log de Interface - Desconto Comercial
		;
		; TAREFA 75941 - DSD - 04/2018
		;
    	S X=^IPAUX(PART,"MPE",1,1),$P(X,"|",8)=TIRE,^IPAUX(PART,"MPE",1,1)=X
		;
 		S SEQL=$I(^IPDSC.LOG.INX(CCLI,DACE))
 		S ^IPDSC.LOG.INX(CCLI,DACE,SEQL)=OTRA
 		M ^IPLMC.LOG.INX(CCLI,DACE,SEQL)=^IPAUX(PART,"MPE")
		;
LODZ	Q
		;
armazenar(CCLI,CPRO,CDEP,DTVI,MDCL,VGAP,DCAP,CDEE,USRT,AMRO="") 
		New (CCLI,CPRO,CDEP,DTVI,MDCL,VGAP,DCAP,CDEE,USRT,AMRO,status)
		;
		;   CCLI	- 	Código do cliente
		;   CPRO	- 	Código do produto
		;   CDEP	- 	Código da dependência
		;	DTVI	-	Data de Vigência
		;   MDCL	- 	Margem do cliente
		;	VGAP	-	Valor do GAP
		;	DCAP	- 	Documento de ações de preços; código do sistema de custos
		;	INNV	- 	Indicativo de não venda
		;	OBSV	-	Observação
		;	CDEE	-	Dependência onde o usuário está lotado
		;	USRT	- 	Código do usuário ABADI
		;	AMRO	-	AplicaçãoMóduloRotina
		;
		Set status = $$$OK
		;
		Set TPAP = "M"
		If ('$Find(DTVI,"/")) {
			Set DTVI = $$ZD^sistema.DOLLAR(DTVI,4)
		}
		;
		D RCC^IBSRPP
		If $Get(CODCOM)'="" { ; Se o código do produto comum estiver vazio, trata como produto comum
			Set CPRO=CODCOM
		}
		;
		If (MDCL '= "") {
			Set MDCL = MDCL / 100
		}
		If (VGAP '= "") {
			Set VGAP = VGAP / 100
		}
		;
		Set $Piece(RG,";",01) = TPAP ; Tipo de ação
	    Set $Piece(RG,";",02) = $Extract(CCLI, 1, *-2) ; Cliente
	    Set $Piece(RG,";",03) = $Extract(CCLI, *-1, *) ; Ponto Entrega
	    Set $Piece(RG,";",04) = CPRO ; Produto
	    Set $Piece(RG,";",05) = DTVI ; Dt.Ini.Vigência
	    Set $Piece(RG,";",06) = MDCL ; Margem do Cliente
	    Set $Piece(RG,";",07) = VGAP ; GAP de Margem ADITIVADA
	    ;Set $Piece(RG,";",09) = VGPR ; GAP de Margem PREMIUM
	    Set $Piece(RG,";",12) = CDEP ; Dependência
		;
		Do MPE(USRT,CDEE,DTVI,AMRO,.RG,.TIRE)
		;
		If ($Data(TIRE)) {
			If (TIRE'="") {
				Set status = TIRE
			}
		}
		Else {
			Set status = "Não foi retornado o status do processamento."
		}
		;
		Quit status
		;
margemEstaBloqueada(pData, pProduto) public {
		Set margemBloqueada = $$$NO
		;
		Set X=$Get(^IPBMA(1))
		Set DIBF=$Piece(X,"|",2)
		;
 		If (DIBF) && (pData '< DIBF) Set margemBloqueada = $$$YES
 		If '$$grupoProdutoBloqueado(pProduto, pData) Set margemBloqueada = $$$NO
 		;
		Quit margemBloqueada

}
grupoProdutoBloqueado(pProduto, pData) Public {
		;
		Set margemGrupoBloqueada = $$$NO
		;
		Set COMB=$Extract(pProduto,1,2)
		;
		Set X=$Get(^IPBMA(1)),DIBF=$Piece(X,"|",2)
		If (pData>=DIBF) {
			If ($Data(^IPBMA(1,COMB))) {
				Set margemGrupoBloqueada = $$$YES
			}
		}
		;
		Quit margemGrupoBloqueada
}
		;
RCE		D ^IBSRCE Q
RGP		D ^IBSRGP Q
RAP		D ^IBSRAP Q
COM		D COM^IBSRCM Q
DIN		D DIN^IBSRPP Q
DPM		D DPM^IBSRPP Q
RCC		D RCC^IBSRPP Q
RIN		D RIN^IBSRPR Q
RLI		D RLI^IBSRPR Q
RBS		D RBS^IBSRBS Q
DEI		D ^sistema.DEI Q
VMD 	D VMD^IBSR.preco.MrgDependencia(CCLI,.ILMD) Q
RPV 	D RPV^IBSR.preco.MrgDependencia(CCLI,CPMA,DTVI,.IPRM) Q
CVG		D CVG^IBSR.preco.MrgDependencia(CDEP,CCLI,CPMA,DTVI,.IPGM) Q // <marcuslm - GDTI-3554 - Desvincular o GAP da OCTAPRO da gasolina comum. />
RPE(strCliente,strDependencia,strProduto,&oPE) D recuperarPrecoVigente^IBSR.preco.PrecoEspecialCombClaro(strCliente,strDependencia,strProduto,.oPE) Q
ADC		D ##class(cbpi.abadi.preco.sistemacusto.DadoBasicoCenarioCusto).atualizarTabela(CCLI,CPRO,CDEP) Q ; <flcarvalho - GDTI-3047 - Atualiza a tabela de dados básicos para o sistema de custos>
]]></Routine>


<Routine name="IFFAFA3A" type="MAC" languagemode="0" timestamp="65440,62574.487375"><![CDATA[
IFFAFA3A ;ATIVA/DESATIVA FATURAMENTO <V1.2-ELR-05/88> ; Última Alteração   alexlack 27/04/2018 23:23:24 ;Última Alteração   FLCARVALHO 02/03/2020 17:22:54
	; 
	#Include sistema.BibliotecaMacro 
	#Include faturamento.Macro 
 ;
 ;AO ALTERAR O MODULO VEI VERIFICAR IAM NO PROG IFFAFA3B para quando for faturamento de mistura.
 ;
 ;
VEI ;VERIFICA ITENS
 #Dim ORIP as %String	; Representa o código da origem para consumo
 #Dim NFCI AS %String	; Representa o número da FCI da origem de consumo (Quando exigir FCI)
 #Dim oListaLotesAloc As %ListOfDataTypes //Lista de lotes alocados
 #Dim oListaLotesAlocProv As %ListOfDataTypes //Lista de lotes alocados
 #Dim oListaLoteMovAloc,oListaLoteMovArmAloc As %ListOfObjects //Lista de movimentações de remessa de armazenagem
 #Dim oListaQtdLoteMovAloc As %ListOfDataTypes //Lista de quantidade a serem utilizadas de cada movimentação alocada
 #Dim idLote as %Integer
 #Dim bTemLote,bValSaldoDisp,IPFA as %Boolean
 #Dim strCNPJArmazenador as cbpi.abadi.datatype.CPFCNPJ
 #Dim strCNPJProprietario as cbpi.abadi.datatype.CPFCNPJ
 #Dim oFCI As cbpi.abadi.estoque.FCI
 #Dim dtmProvRemCO As cbpi.abadi.datatype.DataMedidata
 #Dim numProvRemCO,itemProvRemCO As %Integer
 New bEFatEmTerceiros ;Será verdadeiro se for operação de faturamento em teceiros
 New bValSaldoDisp,strCNPJArmazenador,IPFA
 New dtmProvRemCO,numProvRemCO,itemProvRemCO
 New oListaLoteMovArmAloc
 S (QPNF,EEMB,VITN,VMER,VIPI,VTXB,VBOM,VFRU,VUPF,VFRE,VCAR,VDCR,VACR,AIRE,VUNF,VUSI)="" 
 S (AIPI,QAMC,Q20C,TAMB,DVNT,IVF18,VUFD,VMVC,CMOR,IINF,VFCI,BORE)="" 
 S (IRIP,AIRP,BIRP,NOCO,OCOR,VMAX,VDEP,VDBC,VTTB,VDPC,VPSD,NFSC)="" 
 S (EFPP,ICMC,ICPP,UNPR,SIPR,UNFR,SIFR,VDDB,PRAZ,VDAI,VDEI,TPCB,PZCB,DMSC)="" 
 S (MARU,PURE,CURE,ICMP,VPDP,VCDP,VPRP,VCRP,IPIS,ICOF,VDFN,VDFP,DDRF,NDRF,DNOR,ITRF)="" 
 S (CO72,FDUT,SUPJ,VDUF,AICQ,FATAICQ,RICD)="" 
 S VURS="" ; TAREFA ALM-42891 - DSD - 05/2017
 S (LORE,FCIITEM,FCISMOV)=""
 S (IDDR,NREE,CNFE)="" ;Dados de exportação
 S CAL=0,VOL=0,SAI=0,INDR=0
 S DFAG="" ; <flcarvalho - GDTI-5608 - Projeto 5 casas e arredondamento>
 ;
 S X=^IFPED(CDEE,NPED),DENT=$P(X,"|",5),CCLI=$P(X,"|",2),TOPA=$P(X,"|",6),ICCR=$P(X,"|",16)
 S X=^IFPED(CDEE,NPED,0,ITPE),PRAZ=$P(X,"|",74) I PRAZ["/" D APR
 S RIT=^IFPED(CDEE,NPED,0,ITPE),CPRO=$P(RIT,"|",1),IPRI=$P(RIT,"|",2),NOEM=$P(RIT,"|",20)
 Set ESTO=$P(RIT,"|",57),IAPM=$P(RIT,"|",34)
 S IPCO=$P(RIT,"|",72),PRAZ=$P(RIT,"|",74),CTRA=$P(RIT,"|",10),CCAM=$P(RIT,"|",11)
 ;ILCP e LORE devem ser recuperados e validados ainda na rotina IFFAFA3A 
 ;pois vários módulos necessitam desta informação.
 S ILCP=$P(RIT,"|",65),LORE=$P(RIT,"|",68)
 S DDRF=$P(RIT,"|",94),NDRF=$P(RIT,"|",95),DNOR=$P(RIT,"|",96),ITRF=$P(RIT,"|",97),ROTA=$P(RIT,"|",99)
 S IDDR=$P(RIT,"|",111),NREE=$P(RIT,"|",112),CNFE=$P(RIT,"|",113) ;Dados de exportação
 S VUNV=$P(RIT,"|",133) ; <flcarvalho - GDTI-4701 - Tarefa-112791 - Faturamento antecipado Vendor - 2019/08> ; Lógica do preço especial para VENDOR
 ;
 ;Recupera CLPR e CANP
 S X=$G(^IBPRO(CPRO)) S:X?1"" X=$G(^IBPEX(CPRO)) S CLPR=$P(X,"|",24),CANP=$P(X,"|",40) 
 ; recupera prazo de cobranca
 S YDENT=DENT,DENT=DFAT D ^IBSRPZ1 S DENT=YDENT,PZCB=PZCB+NDIC
 D VPA
 I CDEV S PZCB=0
 ; atualiza prazo de cobranca
 S $P(RIT,"|",76)=TPCB,$P(RIT,"|",77)=PZCB 
 ; atualiza prazo de faturamento para operacoes nao venda
 ; ISRV-Simples remessa vendor, mantém o prazo da nota para o cálculo do ICMS ; <flcarvalho - GDTI-4701 - Tarefa-112791>
 I CTOP'="01",+PRAZ'=0,$G(ISRV)'=1 S PRAZ=0,$P(RIT,"|",74)=PRAZ
 
 ;*** Valida se o Item do pedido já possui uma nota fiscal associada. AHZ
 S bValidaNotaPedido =1 
 S ItemNONF=$P(RIT,"|",18)
 If (bValidaNotaPedido && (+ItemNONF>0)) S CAL=1 G VEI1
 ;*** Se o item do pedido já possui nota fiscal associada não fatura. 

 ;Valida local de retirada
 ;	Devolve: LORE e YLORE
 D VLR I VOL!CAL G VEI1
 ;<Amauri - Projeto 4%> Registrar Origem e FCI do item do pedido
 ;
 Set NFCI=$P(RIT,"|",106)
 Set ORIP=$P(RIT,"|",110)
 Set QPED=$Piece(RIT,"|",3)
 ;
 ; Valida se a Origem e FCI estão elegiveis para o faturamento.
 Set msOcorr=""
 Set oListaLotesAloc=##class(%ListOfDataTypes).%New()
 Set oListaLotesAlocProv=##class(%ListOfDataTypes).%New()
 Set oListaLoteMovAloc=##class(%ListOfObjects).%New()
 Set oListaLoteMovArmAloc=##class(%ListOfObjects).%New()
 Set oListaQtdLoteMovAloc=##class(%ListOfDataTypes).%New()
 ;
 S CDOP=$E(CNOS,5,6) 
 S IEST=$P(RDG,"|",1)
 ;Recupera CFOR
 S X=^IBCLI(CCLI,0),CFOR=$P(X,"|",13)
 ;Define CDED
 S CDED="" I NOEM'?1"" S CDED=$E(CFOR,2,5) 
 ;Valida ESTO e, se não definido, fixa como 1 e 
 ;   tenta recuperar da ordem de embarque
 I ESTO="" S ESTO=1 I (NOEM'="")&&$D(^IFOEM(CDEE,CDED,NOEM,CPRO)) S X=^IFOEM(CDEE,CDED,NOEM,CPRO),ESTO=$P(X,"|",1) 
 ; atualiza local do estoque ESTO
 S $P(RIT,"|",57)=ESTO 
 ; 
 S ^IFPED(CDEE,NPED,0,ITPE)=RIT 
 I CTOP?1"01",PRAZ?1"",CLPR=2 D VPP 
 I CTOP?1"01",PRAZ?1"" S NOCO=1,OCOR="falta de prazo",PRODUTO=$P(RIT,"|",1),VUNP=$P(RIT,"|",4) D CAL,GRO G VEI1 
 //HPJ ALM 23847 06/2016
 //I $D(^IFPRAZ.CDEE(CDEE)),CTOP?1"01",PRAZ?1"" !(PRAZ=0),'CDEV  S NOCO=1,OCOR="falta de prazo",PRODUTO=$P(RIT,"|",1),VUNP=$P(RIT,"|",4) D CAL,GRO G VEI1 
 //
 I CTOP="01" D VPR I VOL!CAL G VEI1 
 I $D(RPRO) S X=^IFCFA(NPRF),IAPM=$P(X,"|",21) 
 E  S X=^IFCFA(NPRF),$P(X,"|",21)=IAPM,^IFCFA(NPRF)=X 
 I IAPM'?1"" D IAM G VEI1 
 ;
 ;Trata controle de lotes de produto importado e define ORIP se 
 ;   pedido estava com ORIP="A"
 Do LOT
 If CAL Set:NOCO="" NOCO=145 D CAL,GRO GoTo VEI1
 ;
 ;<Aud - Trata validação de Origem não compativel com a FCI
 ;
 If '##class(cbpi.abadi.estoque.nfe.NFeICMSTipoOrigem).requerFCI(ORIP) {
	 Set NFCI=""
 }
 ;
 If $$temErroItemImportado(EMGR,CDEE,ITPE,CPRO,ORIP,NFCI,.OCOR) Set CAL=1,NOCO=155 D CAL,GRO GoTo VEI1
 ;
 ;</Aud - Trata validação de Origem não compativel com a FCI
 ; 
 Set $P(RIT,"|",106)=NFCI
 Set $P(RIT,"|",110)=ORIP
 S ^IFPED(CDEE,NPED,0,ITPE)=RIT
 ;RIT - necessita de ORIP com o valor correto <>"A"
 D RIT I VOL!CAL G VEI1
 ;
 ;</Fim Amauri - Projeto 4%> Registrar Origem e FCI do item do pedido
 ;
 S CDOP=$E(CNOS,5,6) 
 I (CLPR=1)!(CLPR=2),'$D(^IBIED(CDEE,CUFE)),CUFE'=CUFD,+AIRE'=0!((CTOP?1"01"!(CTOP?1"02")!("67/69"[CDOP)!(CNOS?1"030261"))&("11/15"[$E(CPRO,1,2))) S NOCO=40 D CAL,GRO G VEI1 
 ;Recupera a CFOP
 Set X=^IBNOP(CNOP),CFOP=$P(X,"|",11)
 ;Valida dados de exportação
 I (CDOP="30")&&'$$validarExportacao(CDEE,DFAT,CFOP,IDDR,NREE,CNFE,CPRO,.NOCO,.OCOR) D CAL,GRO G VEI1 
 ;Se tem código da ANP, valida se foi informado o transportador
 ;   Se for o próprio cliente, o sistema preencherá as informações a partir 
 ;      dos dados do cliente, de forma que não requer validação.
 ;<ERRO65>
 I (",1990,2990,4990,"'[(","_CTRA_","))&&(CANP'="")&&(TPST'=0)&&'$$validarTrasportador(CDEE,DFAT,CFOP,CANP,CTRA,TPST,NPED,ITPE,.NOCO,.OCOR) D CAL,GRO G VEI1  
 ;DQF define QPNF
 D DQF I CAL G VEI1 
 S IEST=$P(RDG,"|",1) 
 ;Se movimenta estoque e não é remessa por conta e ordem
 ;   Remessa por conta e ordem não requer validação de saldo de estoque pois o mesmo fora provisionado.
 I (IEST?1"S")&&(CDOP'=92) D VEE I CAL G VEI1 
 // Para simples remessa, ira verificar o saldo da nota de faturamento antecipado 
 I (CTOP="03")&&((CDOP=61)||(CDOP=92)) D VSF I CAL G VEI1 
 K IEST 
 I CTOP?1"01" D VQA I CAL G VEI1 
 ;I CTOP?1"01",CLPR?1"2",EEMB,CNOS'?1"010267",('ICCR!(CNEG?1"12120")) D VPM I CAL G VEI1
 ;;;I CTOP?1"01",CLPR?1"2",EEMB,CNOS'?1"010267" D VPM I CAL G VEI1
 I CTOP?1"01",EEMB,CNOS'="010267",(CLPR=2!($E(CPRO,1,2)=67)) D VPM I CAL G VEI1        ;;;67 Produto ARLA
 D CVF 
 S ^%GAB(%AP,%PN1,%PN2,$J)="J|"_%US_"|"_%MOD_"|"_%ROT_"|"_$$H^sistema.DOLLAR 
 I CAL G VEI1 
 I CTOP?1"01",'CDEV D VCV I CAL G VEI1 
 I "010205/010206"[CNOS,'$D(^IBTAX(CDEE)) S NOCO=2,PRODUTO=CPRO D CAL,GRO G VEI1 
 I CNOS="030267",'$D(^IECON(CCLI,CPRO)) S NOCO=31,CONTR="consignacao",PRODUTO=CPRO D CAL,GRO G VEI1 
 I CNOS="010267",'$D(^IECON(CCLI,CPRO,1)) S NOCO=34,PRODUTO=CPRO D CAL,GRO G VEI1 
 I CNOS="030269",'$D(^IETEC(CCLI,CPRO)) S NOCO=31,CONTR="estoque tecnico",PRODUTO=CPRO D CAL,GRO G VEI1 
 S IEST=$P(RDG,"|",1)
 ;I EEMB!(DFAB) && ( IEST="S" ) D SLD I CAL G VEI1  ;Inibido para envio a produção AHZ; TODO descomentar após o envio do pacote
 ;
 S X="",$P(X,"|",1)=CPRO,$P(X,"|",2)=EEMB,$P(X,"|",3)=VUNF 
 S $P(X,"|",4)=VFRU,$P(X,"|",5)=VCAR,$P(X,"|",6)=IVF18,$P(X,"|",7)=AIPI 
 S $P(X,"|",8)=VMER,$P(X,"|",9)=VIPI,$P(X,"|",10)=VITN 
 S $P(X,"|",11)=VBOM,$P(X,"|",12)=VFRE,$P(X,"|",13)=QPNF 
 S $P(X,"|",14)=Q20C,$P(X,"|",15)=QAMC,$P(X,"|",16)=DVNT 
 S $P(X,"|",19)=TAMB,$P(X,"|",26)=VUFD,$P(X,"|",28)=VDEI,$P(X,"|",30)=AIRE 
 S $P(X,"|",31)=VMVC,$P(X,"|",32)=IINF,$P(X,"|",33)=CMOR 
 S $P(X,"|",34)=VFCI,$P(X,"|",35)=VMAX,$P(X,"|",36)=VDEP 
 S $P(X,"|",37)=VTXB,$P(X,"|",38)=IFDG,$P(X,"|",39)=VFUT 
 S $P(X,"|",40)=VDBC,$P(X,"|",41)=VTTB,$P(X,"|",42)=IPAF 
 S $P(X,"|",43)=VFRP,$P(X,"|",44)=TFRE,$P(X,"|",45)=VDPC 
 S $P(X,"|",46)=VPSD,$P(X,"|",47)=NFSC,$P(X,"|",49)=EFPP 
 S $P(X,"|",50)=INDR,$P(X,"|",51)=ICMC,$P(X,"|",52)=ICPP 
 S $P(X,"|",53)=UNPR,$P(X,"|",54)=SIPR,$P(X,"|",55)=UNFR 
 S $P(X,"|",56)=SIFR,$P(X,"|",57)=VDDB,$P(X,"|",58)=PRAZ 
 S $P(X,"|",59)=BORE,$P(X,"|",60)=VDAI,$P(X,"|",61)=IRIP 
 S $P(X,"|",62)=AIRP,$P(X,"|",63)=AICM,$P(X,"|",64)=PZCB 
 S $P(X,"|",65)=MARU,$P(X,"|",66)=PURE,$P(X,"|",67)=CURE 
 S $P(X,"|",68)=BIRP,$P(X,"|",69)=CCOA,$P(X,"|",70)=ICMP 
 S $P(X,"|",71)=VPDP,$P(X,"|",72)=VCDP,$P(X,"|",73)=VPRP 
 S $P(X,"|",74)=VCRP,$P(X,"|",75)=IPIS,$P(X,"|",76)=ICOF 
 S $P(X,"|",77)=VDFN,$P(X,"|",78)=VDFP,$P(X,"|",79)=CO72 
 S $P(X,"|",80)=SUPJ,$P(X,"|",84)=DMSC,$P(X,"|",85)=VDUF
 S $P(X,"|",86)=FATAICQ,$P(X,"|",87)=RICD,$P(X,"|",88)=VUSI
 S $P(X,"|",89)=LORE
 ;Valores de ICMS partilhado
 Set $P(X,"|",90)=$G(VBCD),$P(X,"|",91)=$G(VICD)
 Set $P(X,"|",92)=$G(VICO),$P(X,"|",93)=$G(VICP)
 Set $P(X,"|",103)=$G(AICD),$P(X,"|",104)=$G(PICD),$P(X,"|",105)=$G(AICP)
 ; 
 ; TAREFA 00431215 - DSD - 02/2015 - Inclusão de Pedágio p/cálculo da margem no BI
 S $P(X,"|",100)=VUPF
 ;
 //RDS806805 - ASSIS 29.07.16
 S $P(X,"|",106)=$G(MSGN)
 ;
 S $P(X,"|",107)=VURS ; TAREFA ALM-42891 - DSD - 05/2017
 S $P(X,"|",108)=ESTO
 ;Variáveis vindas do IBSRFU (CVF^IFFAFA3E) - Ricardo Mendonça - GDTI 2787
 S $P(X,"|",111)=$G(COUP),$P(X,"|",112)=$G(IDTE)
 ;
 ; < daviz - ALM113106 - Variáveis de desconto/acréscimo para o pagamento ao transportador por conta de repasse. >
 S $P(X,"|",113)=$G(VDCR),$P(X,"|",114)=$G(VACR)
 ;
 S $P(X,"|",115)=$G(MRGV) ; <flcarvalho - GDTI-4701 - Tarefa-112791 - Vendor - 2019/12>
 S $P(X,"|",116)=$J($G(DFAG),0,2) ; <flcarvalho - GDTI-5608 - Informação da diferença do ganho de ajuste/>
 ;
 S ^IFTFA(CDEE,$J,NPED,0,ITPE)=X,^IFCFA(NPRF,0,3,ITPE)=X
 ;
 ;<Amauri - Projeto 4%> Registrar na ^IFTFA os lotes alocados que serã efetivamente baixados...
 Set ok=$$registrarLotesAlocados(NPRF,CDEE,DFAT,NPED,ITPE,ORIP,NFCI,.oListaLotesAloc,oListaLoteMovAloc,oListaLotesAlocProv,oListaQtdLoteMovAloc,oListaLoteMovArmAloc)
 ;
 S ITNF=ITNF+1,PN(CPRO)="",YLORE=LORE 
 
 I "010206"[CNOS!("010205"[CNOS&(CPRO?1"15".E)) S MXI=ITNF-1 
 S ^%GAB(%AP,%PN1,%PN2,$J)="J|"_%US_"|"_%MOD_"|"_%ROT_"|"_$$H^sistema.DOLLAR 
VEI1 I CAL,IAPM?1"" K ^IFCFA(NPRF,0,2,CPRO),^IFTFA(CDEE,$J,NPED,CPRO) 
 S X=^IFCFA(NPRF),$P(X,"|",9)=ITPE,$P(X,"|",11)=ITNF,$P(X,"|",8)="",$P(X,"|",15)="",$P(X,"|",16)="",$P(X,"|",21)="",^IFCFA(NPRF)=X 
 S X=^IFCFA(NPRF,0,1),$P(X,"|",25)=SCRD,$P(X,"|",37)=CVTN,^IFCFA(NPRF,0,1)=X,$P(RDG,"|",25)=SCRD,$P(RDG,"|",37)=CVTN 
 ;
 K VOL,QPNF,EEMB,VITN,VMER,VIPI,VBOM,VFRU,VUPF,VFRE,VCAR,VDCR,VACR,VUNF,AIPI,QAMC,Q20C,DMSC 
 K TAMB,DVNT,RIT,CAL,SAI,VDPC,VPSD,NFSC,VDAI,VDEI,DMSC 
 K XCVTN,XSCRD,IAPM,RPRO,IVF18,NOCO,OCOR,VUFD,VMVC,IINF,CMOR,VFCI,VMAX,VDEP 
 K VURS ; TAREFA ALM-42891 - DSD - 05/2017
VEIZ Q  
LOT	;Trata controle de lotes de produto importado
	;Parâmetros:
	;	CAL - OUT
	#Dim cnpjArm As cbpi.abadi.datatype.CPFCNPJ
	#Dim listaMovimentacao as cbpi.abadi.estoque.dto.MovimentacaoQuantidadeLista
	#Dim strCodCliArm As %String
	#Dim qtdSaldoDisp As %Numeric
	#Dim XESTO,QTDE,QDBA,QTRE,QTPE,CERR,DERR
	New strCodCliArm,cnpjArm,qtdSaldoDisp,XESTO,QTDE,QDBA,QTRE,QTPE,CERR,DERR
	;Recupera em cnpjArm o ponto de entrega do armazenador
	Set cnpjArm="",strCodCliArm="" If (LORE'="")&&(LORE'=("1"_CDEE)) Set cnpjArm=$$recuperarCNPJArm(CDEE,LORE,.strCodCliArm)
	;Determina se é faturamento em terceiros - faturamento saindo do armazenador
	;Se for remessa de armazenagem simbólica, onde o produto já está no armazenador,
	;então deve movimentar o estoque do depósito da filial.
	Set bEFatEmTerceiros=$$eFaturamentoEmTerceiros(CDEE,LORE)&&(CCLI'=strCodCliArm)
	;
	; Se for uma operação que Movimenta Estoque e não existir lotes com saldo suficiente, gera ocorrência
	; no faturamento, caso contrário, Aloca os lotes de importados (oListaLotesAloc) que serão baixados.
	;(CDOP=55) - Faturamento Antecipado (CDOP'=91) - Faturamento por Conta e Ordem
	If (CDOP'=55)&&(CDOP'=91)&&(CDOP'=92)&&(IEST="S") {
		;Tratamento provisório para evitar faturamento de produtos com origem fixa, registrados com origem "A" ou ""
		If (EMGR=93) {
			Set X=^IBPRO(CPRO),CLPR=$Piece(X,"|",24),CFPR=$Piece(X,"|",14),RCPI=$Piece(X,"|",47) 
			;Se a origem for automática ou nula, mas o produto for de origem fixa, tenta usar a origem padrão
			If (((ORIP="")||(ORIP="A"))&&(RCPI=2)) {
				Set ORIP=##class(cbpi.abadi.estoque.ArmazemProduto).getOrigemPadrao(CDEE,LORE,1,CPRO)
				If ORIP="" {
					Set OCOR="Ocorrência 3:Produto "_CPRO_" está definido como origem fixa, mas está sendo faturado com "_
					"origem automática e não possui origem padrão definida"			 	
					Set NOCO=150,CAL=1
				}
			}
		}		
		;Se for faturamento em terceiros, valida o provisionamento de retorno de armazenagem
		If bEFatEmTerceiros {
		 	;Recupera a quantidade de produto armazenada no armazenador que 
		 	;pode ser retornada.
		 	;TODO ALX Testar para verificar se ficará na mesma nota ou em notas 
		 	;         diferentes.
		 	#dim listaMovimentacao as cbpi.abadi.estoque.dto.MovimentacaoQuantidadeLista
		 	#dim arrSaldosFCI as %ArrayOfDataTypes
		 	Set totalEmFCIOrigem=0
		 	Set bMovLoteNacional=##class(cbpi.abadi.basico.DependenciaParametro).deveGerarLoteNacional(CDEE)
		 	Set intQtdAlocada=##class(cbpi.abadi.estoque.LoteMovimentacao).obtemMovRemArm(CDEE,CNOP,CPRO,cnpjArm,.ORIP,.NFCI,QPED,.oListaLoteMovArmAloc,.qtdeTotalDisp,.listaMovimentacao)
			Set arrSaldosFCI=listaMovimentacao.getSaldosPorFCI(ORIP),FCI=""
			While arrSaldosFCI.GetNext(.FCI) {
				IF NFCI'=FCI {
					Set arrNovoItem(arrSaldosFCI.GetAt(FCI),FCI)=""
				}
				Set totalEmFCIOrigem=$G(totalEmFCIOrigem)+arrSaldosFCI.GetAt(FCI)
			}
		 	;Tratamento para o caso em que não existe saldo em terceiros para a origem solicitada
		 	If ((##class(cbpi.abadi.estoque.ArmazemProduto).getOrigemPadrao(CDEE,LORE,1,CPRO)'="")||(ORIP'=0)||bMovLoteNacional)&&(intQtdAlocada<QPED)&&(totalEmFCIOrigem<QPED) {
			 	;(##class(cbpi.abadi.estoque.ArmazemProduto).getOrigemPadrao(CDEE,LORE,1,CPRO)'="") se tem origem padrão
			 	;||(ORIP'=0) ou se origem é importada, então deve ter saldo de importado
			 	Set qtdeBloqueadaArm=qtdeTotalDisp-intQtdAlocada
			 	If (qtdeTotalDisp>=QPED) {
					Set OCOR="Ocorrência 1:Produto "_CPRO_" : Origem "_ORIP_" possui saldo suficiente "_qtdeTotalDisp_" para baixar no armazenador "_cnpjArm_", mas "_qtdeBloqueadaArm_" desse saldo está bloqueado em outros processos."								 	
			 	}
			 	Else {
					Set OCOR="Ocorrência 1: Produto "_CPRO_" : Origem "_ORIP_" não possui saldo suficiente para baixar no armazenador "_cnpjArm_"."
			 	}
				Set CAL=1,NOCO=150 
		 	}
		 	ElseIf ('$$possuiSaldoArmazem^IBSREB2(CDEE,LORE,CPRO,QPED,ESTO,IPRI)&&($$movimentaEstoqueDisponivel^IBSREB3(CDEE,CNOP,CPRO))) {
			 	;Verifica saldo em terceiros:
			 	;Se não tem saldo no armazém, então deve gerar ocorrência, de forma que 
			 	;o saldo seja liberado para o faturamento.
			 	Set CAL=1,NOCO=150,OCOR="Ocorrência 2: Produto "_CPRO_" não possui saldo suficiente em estoque (igual ou maior que "_QPED_"),"
			 	Set OCOR=OCOR_" no local "_$Case(ESTO,1:"Depósito",2:"MLI",3:"Fat.Direto",4:"Contaminado",5:"Análise",:"")
			 	Set OCOR=OCOR_" e depósito "_LORE_"."
			 	;Se possui pedido e pode suspender suspende o item por estoque. 
			 	;Para evitar retrabalho com ordem de carregamento. 
			}
			;<AHZ> teste descomentando trecho que quebra o item de origem igual mas com FCI diferentes na nota
		 	;Se quantidade alocada for menor que a quantidade necessária e origem não é 0- Nacional,
		 	;então:
		 	If ((##class(cbpi.abadi.estoque.nfe.NFeICMSTipoOrigem).requerFCI(ORIP))&&(intQtdAlocada<QPED)&&(totalEmFCIOrigem>=QPED)) {
 				Set FCI=""
 				Set intNovaQtdAlocada=intQtdAlocada
 				If arrSaldosFCI.Count()>0 {
	 				Set intNovaQtdAlocada=""
	 				For {
	 					Set intNovaQtdAlocada=$Order(arrNovoItem(intNovaQtdAlocada),-1)
	 					If intNovaQtdAlocada > QPED Quit
	 					Quit:intNovaQtdAlocada=""
	 					Set FCI=""
	 					For {
	 						Set FCI=$Order(arrNovoItem(intNovaQtdAlocada,FCI))
	 						Quit:FCI=""
	 						set newOrigem=ORIP
							set newFCI=$Translate(FCI," ","")
							set ^AHZFAFA(NPED,ITPE,FCI,newOrigem)=intNovaQtdAlocada_";"_QPED
							do RNI
	 					}
	 				}
			 	}Else {
				 	Set newOrigem="A"
 				 	Set newFCI=""
 				 	set ^AHZFAFA(NPED,ITPE,FCI,newOrigem)=intNovaQtdAlocada_";"_QPED
 				 	do RNI
			 	}
		 	}
		 	;</AHZ>
		 	if (##class(cbpi.abadi.estoque.nfe.NFeICMSTipoOrigem).requerFCI(ORIP))&&'$$qtdeFCIAtendida(CDEE,NPED,arrSaldosFCI,.strMsg) {
					Set OCOR="Ocorrência 1: Produto "_CPRO_" : Origem "_ORIP_" não possui saldo suficiente para baixar no armazenador "_cnpjArm_". "
					Set OCOR=OCOR_strMsg
			 		Set CAL=1,NOCO=150 
			}
		}
		Else  {
		 	;Verifica se tem saldo suficiente na origem escolhida
			If '$D(IEDI) S X=^IBNOP(CNOP),IEDI=$P(X,"|",8)
			Set strCNPJProprietario=""
			;Se for devolução de armazenagem para terceiros...
			If (CTOP="03")&&(CDOP=78)&&(IEDI="N")&&(IEST="S") {
				Set X=$Get(^IBCLI(CCLI,0))
				Set DVCC=$P(X,"|",3)
				If DVCC'="" Set strCNPJProprietario=$Extract(CCLI,1,12)_DVCC
			}
			If '$$temLoteOrigem^IFFAFA3F(CDEE,CPRO,NPED,ITPE,QPED,strCNPJProprietario,"",.ORIP,.NFCI,.OCOR,.oListaLotesAloc) {
				set qtdeDispAloc=##class(cbpi.abadi.estoque.Lote).qtdeDispAlocarSaldoLotes(CDEE,CPRO,ORIP,.NFCI,QPED,strCNPJProprietario,"")
				set OCOR = "Ocorrência 3: "_OCOR
				If qtdeDispAloc>QPED {
					set OCOR="Ocorrência 3: Produto "_CPRO_" : Origem "_ORIP_" possui saldo suficiente em lotes para atender o pedido. Mas parte desse saldo está bloqueado em por outro processo."
				}
				Set CAL=1
			}
		}
	}
	ElseIf (CDOP=91) {
		;Se for faturamento por conta e ordem, deve definir a origem
		;que possui estoque conforme regra de priorização de consumo.
		Set strCNPJArmazenador="",strCNPJProprietario=""
		#Import cbpi.abadi.basico
		If bEFatEmTerceiros {
			;Recupera o CNPJ do armazenador
			Set X=^IBACO(CDEE,LORE,1),strCNPJArmazenador=$P(X,"|",8)
			Set strCNPJArmazenador=##class(cbpi.abadi.basico.ClienteMap).recuperarCPFCNPJ(strCNPJArmazenador)
			;Recupera o CNPJ da filial
			Set strCNPJProprietario=$TR(##class(cbpi.abadi.basico.DependenciaMap).recuperarCNPJ(CDEE),"./-")
		}
 		If $$temLoteOrigem^IFFAFA3F(CDEE,CPRO,NPED,ITPE,QPED,strCNPJProprietario,strCNPJArmazenador,.ORIP,.NFCI,"",.oListaLotesAlocProv) {
		 	;Se tem saldo da origem a ser faturada, então a provisão poderá ocorrer,
		 	;desde que tenha saldo disponível no local do pedido. Se tem saldo suficiente
		 	;para a origem, tem saldo disponível na filial, mas não tem saldo disponível no 
		 	;local, então deve dar crítica.
		 	Set qtdSaldoDisp=0
		 	;Se filial/produto não controla saldo disponível...
			If '$$saldoArmazem^IBSREB2(CDEE,LORE,CPRO,IPRI,.QTDE,.QDBA,.QTRE,.QTPE,.CERR,.DERR) Set qtdSaldoDisp=QPED
			Else  For XESTO=1:1:3 Set qtdSaldoDisp=qtdSaldoDisp+$G(QDBA(XESTO))
		 	Set bValSaldoDisp=1
		 	;Se filial tem saldo disponível suficiente, mas não no local, dá crítica.
		 	If (qtdSaldoDisp>=QPED)&&'$$temSaldoDispArmazem^IBSREB2(CDEE,LORE,CPRO,IPRI,ESTO,QPED,bValSaldoDisp,,,.CERR,.DERR) {
			 	;Se tem saldo disponível no estoque, mas não tem saldo disponível no local/depósito, 
			 	;então deve gerar ocorrência, de forma que o saldo seja liberado para o faturamento.
			 	Set CAL=1,NOCO=150,OCOR="Ocorrência 4: Produto "_CPRO_" possui saldo suficiente em estoque (igual ou maior que "_QPED_"),"
			 	Set OCOR=OCOR_" mas este saldo não está disponível no local "_$Case(ESTO,1:"Depósito",2:"MLI",3:"Fat.Direto",4:"Contaminado",5:"Análise",:"")
			 	Set OCOR=OCOR_" e depósito "_LORE_"."
			}
 		}
 		Else {
	 		;Se não tem saldo...
	 		;TODO ALX Produto que não é produzido pela empresa não pode faturar sem saldo.
	 		;Se não tem saldo suficiente, então deve faturar com a origem e
	 		;FCI vigentes.
	 		If ORIP="A" {
	 			Set oFCI=##class(cbpi.abadi.estoque.FCI).instanciarDepProdVig(CDEE,CPRO,##class(cbpi.abadi.datatype.DataMedidata).LogicalToCache(DFAT))
	 			If $IsObject(oFCI) {
		 			Set ORIP=oFCI.origem,NFCI=oFCI.numero
		 		}
	 			Else  { 
	 				Set ORIP=##class(cbpi.abadi.estoque.Lote).%GetParameter("NACIONAL") 
	 				Set NFCI=""
	 			}
	 		}
		}
	 	;Validação de Alíquota definida no pedido, com alíquota definida para a NF, afim de identificar possíveis inconsistências
	 	;de alteração de origem.
		Set X=^IFPED(CDEE,NPED,0,ITPE),aliICMSPedido=$P(X,"|",36),origemPedido=$P(X,"|",110)
		If +aliICMSPedido=4 {
			Set (ALIQNF,ALIQPED)=""
			Set bRegraPedido=$$calIcmsRegra10^IBSRAI(,origemPedido,CUFE,CUFD,DFAT,.ALIQPED)
			Set bRegraNF=$$calIcmsRegra10^IBSRAI(,ORIP,CUFE,CUFD,DFAT,.ALIQNF)
			If (aliICMSPedido'=ALIQNF) {
			 	Set CAL=1,NOCO=150,OCOR="Ocorrência 5: Alíquota definida no pedido ("_aliICMSPedido_") diverge da alíquota difinida para faturamento."
			}
		}
	}
	ElseIf (CDOP=92) {
		;Se e remessa por conta e ordem em depósito próprio ou em terceiros, 
		;precisa reservar os lotes provisionados.
		;A origem do pedido de remessa sempre deve ser igual a da nota de venda 
		;então recupera ORIP da nota fiscal referenciada
		;Recupera dados da nota fiscal 
		Set X=^IFPED(CDEE,NPED,0,ITPE),NDRF=$P(X,"|",95),DNOR=$P(X,"|",96),ITRF=$P(X,"|",97)
		If (DNOR="")||(ITRF="")||(NDRF="")||('$D(^IFNFS(CDEE,DNOR,NDRF,0,ITRF))) {
			;Se for remessa por conta e ordem e não localizou a NFFCO...
		 	Set CAL=1,NOCO=154,OCOR="Nota fiscal de venda por conta e ordem não foi localizada (pedido "_NPED_" item "_ITPE_")"
		}
		Else  {
			Set XREG=^IFNFS(CDEE,DNOR,NDRF,0,ITRF),ORIP=+$P(XREG,"|",160),NFCI=$P(XREG,"|",145)
			Set X=^IFPED(CDEE,NPED,0,ITPE)
			Set $P(X,"|",106)=NFCI
			Set $P(X,"|",110)=ORIP
			Set ^IFPED(CDEE,NPED,0,ITPE) = X
		}
		If 'CAL {
			If ORIP=##class(cbpi.abadi.estoque.Lote).%GetParameter("AUTOMATICA") {
				;Se for remessa por conta e ordem, então ORIP não pode ser automática, pois são obtidos da nota de faturamento.
			 	Set CAL=1,NOCO=152,OCOR="Pedido de remessa por conta e ordem com origem automátiva (pedido "_NPED_" item "_ITPE_")"
			}
			ElseIf $$recuperarProvRemCO(CDEE,NPED,ITPE,.dtmProvRemCO,.numProvRemCO,.itemProvRemCO) {
				;Recupera a provisão do pedido
				If '$$reservarLoteProv(CDEE,ORIP,dtmProvRemCO,numProvRemCO,itemProvRemCO,QPED,.oListaLoteMovAloc,.oListaQtdLoteMovAloc,.msgLockSaldoSuficiente) {
					;Se não conseguiu recuperar movimentações de lotes suficientes, falha o faturamento 
					;e cancela a alocação
				 	Set CAL=1,NOCO=153,OCOR="Pedido de remessa por conta e ordem sem movimentação suficiente de lotes (pedido "_NPED_" item "_ITPE_") "_msgLockSaldoSuficiente
				}
			}
			Else  {
				;Se não conseguiu recuperar a provisão, falha o faturamento e cancela a alocação
			 	Set CAL=1,NOCO=151,OCOR="Pedido de remessa por conta e ordem sem provisão de estoque (pedido "_NPED_" item "_ITPE_")"
			}
		}
	}
	ElseIf ORIP=##class(cbpi.abadi.estoque.Lote).%GetParameter("AUTOMATICA") { 
		;Se origem for automática e não movimenta estoque, considera nacional
		Set ORIP=##class(cbpi.abadi.estoque.Lote).%GetParameter("NACIONAL")
	}
LOTZ 	Quit
	;
VLR	;Valida local de retirada (LORE)
	;Parâmetros:
	;	LORE - IN/OUT
	;	YLORE - IN/OUT
	;	VOL,CAL - OUT
	;Verifica CNPJ do Local de Retirada
	I LORE'?1"" D ^IBSRLR I CNPJ?1"",IDCO=1 S NOCO=121 D CAL,GRO G VLRZ  
	;Verifica local de retirada - todos os itens faturados devem ter o mesmo local
	D VSA I VOL G VLRZ
VLRZ	Quit
VSA	; Verifica itens para retirada em deposito armazenador com impressao de nota fiscal.
	; Todos os itens faturados em uma nota fiscal devem ter o mesmo local de retirada.
	S VOL=0
	I LORE?1"" Set LORE="1"_CDEE
	;Se local de retirada não foi definido, define como o próprio local do item.
	I $G(YLORE)?1"" Set YLORE=LORE
	;Se local é o mesmo, pode faturar,
	I LORE=YLORE G VSAZ
	;senão, sinaliza que faturamento deve seguir para outro item.
	S VOL=1
VSAZ Q
 ;
TSP ;Trata saldo positivo (ATENÇÃO: MÓDULO NÃO É CHAMADO POR NENHUMA ROTINA - DSD - 10/10)
 S QPNF=SALDO,CONGELADO=SACO 
 S X=^IFPED(CDEE,NPED,0,ITPE),$P(X,"|",3)=SALDO,^IFPED(CDEE,NPED,0,ITPE)=X 
 D CVF 
TSOZ Q  
 ;
VPP ;Verifica Pedido com Prazo nulo
 S IT="" 
VPP1 S IT=$O(^IFPED(CDEE,NPED,0,IT)) I IT?1"" G VPPZ 
 S X=^IFPED(CDEE,NPED,0,IT),PRAZ=$P(X,"|",74) 
 I PRAZ?1"" G VPP1 
 S X=^IFPED(CDEE,NPED,0,ITPE),$P(X,"|",74)=PRAZ,^IFPED(CDEE,NPED,0,ITPE)=X 
 I $D(RIT) S $P(RIT,"|",74)=PRAZ 
VPPZ Q  
recuperarProvRemCO(CDEE,NPED,ITPE,DTAR,NDAR,ITAR)	;Recupera a provisão para a remessa
	;Parâmetros: 
	;	CDEE,NPED,ITPE - IN
	;	DTAR,NDAR,ITAR - OUT
	New X,NDRF,DERF,ITRF
	Set (NDAR,ITAR,DTAR)=""
	;Recupera a NFFCO
	S X=^IFPED(CDEE,NPED,0,ITPE),NDRF=$P(X,"|",95),NERF=$P(X,"|",96),ITRF=$P(X,"|",97)
	Set X=^IFINF(CDEE,NDRF),DERF=$P(X,"|",1)
	If (NDRF'="")&&(NERF'="")&&(ITRF'="")&&$D(^IFNFS(CDEE,DERF,NDRF,0,ITRF,2)) {
		;Recupera a provisão
		Set X=^IFNFS(CDEE,DERF,NDRF,0,ITRF,2),DTAR=$P(X,"|",1),NDAR=$P(X,"|",2),ITAR=$P(X,"|",3)
	}
	Quit (DTAR'="")&&(NDAR'="")&&(ITAR'="")
reservarLoteProv(CDEE,ORIP,dtmProvRemCO,numProvRemCO,itemProvRemCO,QPED,plistaMov,plistaQtdMov,&msgLockSaldoSuficiente)	;
	;Devolve a lista com lotes bloqueados.
	;Parâmetros:
	;	oListaLotesAloc - IN
	#Dim intQtdAloc As %Integer
	#Dim dtDoc As %Date
	#Dim plistaMov As %ListOfObjects
	#Dim plistaQtdMov As %ListOfDataTypes
	#Dim oLoteMov As cbpi.abadi.estoque.LoteMovimentacao
	New intQtdAloc,dtDoc,i,oLoteMov
	Set (msgLockSaldoSuficiente,msgLock)=""
	Set dtDoc=##class(cbpi.abadi.datatype.DataMedidata).LogicalToCache(dtmProvRemCO)
	Set intQtdAloc=##class(cbpi.abadi.estoque.LoteMovimentacao).alocarMovDocItem(CDEE,dtDoc,numProvRemCO,"",itemProvRemCO,QPED,plistaMov,plistaQtdMov,.qtdeBloqueada,.msgLock)
	;Se é saldo nacional ou tem saldo suficiente...
	Set bMovLoteNacional=##class(cbpi.abadi.basico.DependenciaParametro).deveGerarLoteNacional(CDEE)
	If bMovLoteNacional {
		If intQtdAloc=QPED {
			Quit 1
		}
	}
	ElseIf ((ORIP=##class(cbpi.abadi.estoque.Lote).#NACIONAL)||(intQtdAloc=QPED)) {
		Quit 1
	}
	;Senão, falha
	;   neste caso deve liberar os bloqueios
	For i=1:1:plistaMov.Count() Set oLoteMov=plistaMov.GetAt(i) Do oLoteMov.%UnlockId(oLoteMov.%Id())
	Set qtdTotalEstoque=qtdeBloqueada+intQtdAloc
	If qtdTotalEstoque>=QPED {
		set msgLockSaldoSuficiente = "Existe quantidade suficiente mas, quantidade "_qtdeBloqueada_" está bloqueada por outros processos. "_msgLock
	}
	Quit 0
	;
VPR ;Verifica Prazo
 S NPAR=$L(PRAZ)-$L($TR(PRAZ,"/",""))+1 
 I NPAR>6 S NOCO=110,CAL=1 D CAL,GRO G VPRZ 
 K XPRAZOS 
 I $D(PRAZOS) M XPRAZOS=PRAZOS 
 F I=1:1 S PRAZ1=$P(PRAZ,"/",I) Q:(PRAZ1?1"")  S XPRAZOS(+PRAZ1)="" 
 S NPAR=0 
 S PRAZ1="" F  S PRAZ1=$O(XPRAZOS(+PRAZ1)) Q:PRAZ1?1""  S NPAR=NPAR+1 
 I NPAR>6 S VOL=1 G VPRZ 
 F I=1:1 S PRAZ1=$P(PRAZ,"/",I) Q:(PRAZ1?1"")  S PRAZOS(+PRAZ1)="" 
VPRZ Q  
 ;
APR ;Acerta variavel de prazo
 S PR="" 
 F I=1:1 S P=$P(PRAZ,"/",I) Q:P?1""  I P?1N.N,+P'=0 S PR=PR_"/"_P 
 S PRAZ=$E(PR,2,999) 
 S X=^IFPED(CDEE,NPED,0,ITPE),$P(X,"|",74)=PRAZ,^IFPED(CDEE,NPED,0,ITPE)=X 
APRZ Q  
validarExportacao(CDEE,DFAT,CFOP,IDDR,NREE,CNFE,CPRO,NOCO,OCOR)	;Valida se parâmetros para exportação estão corretos
	#Dim oNFeDestinada As cbpi.abadi.estoque.nfe.NFeDestinada
	#Dim oCFOP As cbpi.abadi.fiscal.CFOP
	New oNFeDestinada,OK,CGCD,X
	N oCFOP
	Set oCFOP=##class(cbpi.abadi.fiscal.CFOP).instanciar(CFOP,##class(cbpi.abadi.datatype.DataMedidata).LogicalToCache(DFAT))
	Set OK=1
	;Valida o drawback
	;Se a CFOP exige drawback...
	If $IsObject(oCFOP)&&(oCFOP.eOpDrawback)&&(IDDR="") Set NOCO=138,OCOR="" Quit 0 
	If (IDDR'="")&&'##class(cbpi.abadi.estoque.importacao.drawback.AtoConcessorio).%ExistsId(IDDR) Set NOCO=131,OCOR=IDDR Quit 0
	;
	If (NREE'="")&&(CNFE="")||(NREE="")&&(CNFE'="") Set NOCO=132,OCOR="" Quit 0
	If CNFE'="" {
		;Valida se a nota fiscal é válida. Ela será válida se:
		;	- Foi destinada para a filial;
		;	- Nota fiscal foi capturada e recebida no ABADI.
		Set oNFeDestinada=##class(cbpi.abadi.estoque.nfe.NFeDestinada).instanciar(CNFE)
		If '$IsObject(oNFeDestinada) S NOCO=133,OCOR=CNFE Quit 0 
		;Recupera o CNPJ da dependência
		Set X=^IBDEP(CDEE),CGCD=$P(X,"|",9),CGCD=$TR(CGCD,"./-")
		If oNFeDestinada.destinatarioCNPJ'=CGCD Set NOCO=134,OCOR=CNFE Quit 0 
		If '##class(cbpi.abadi.estoque.nfe.RecebimentoSistema).estaRecebido(oNFeDestinada) Set NOCO=133,OCOR=CNFE Quit 0 
		;Validar se o produto consta no recebimento
		If '$$validarProduto(oNFeDestinada,CPRO) S NOCO=135,OCOR=CNFE Quit 0 
		;Se foi informado o drawback, a nota fiscal deve ser da mesma empresa.
		If (IDDR'="")&&($E(oNFeDestinada.emissorCNPJ,1,8)'=$E(CGCD,1,8)) Set NOCO=136,OCOR=CNFE Quit 0 
	}
	Quit 1
validarProduto(oNFeDestinada,CPRO)	;Valida se existe um recebimento com o produto informado
	#Dim oRecebimento As cbpi.abadi.estoque.nfe.RecebimentoSistema
	New oRecebimento,seq,OK,CDEP,DFAT,NDAR,X,ITAR,XCPRO
	Set seq="",OK=0
	For  {
		Set oRecebimento=oNFeDestinada.recebimentos.GetNext(.seq)
		Quit:seq=""
		If 'oRecebimento.estaRevertido&&(oRecebimento.sistema="ABADI") {
			;Recupera informações do AR
			Set X=oRecebimento.numeroDoc,CDEP=$P(X,"|",1),DFAT=$P(X,"|",2),NDAR=$P(X,"|",3)
			;Varre o AR
			Set ITAR=""
			For  {
				Set ITAR=$O(^IEARE(CDEP,DFAT,NDAR,1,ITAR))
				Quit:ITAR=""
				Set X=^IEARE(CDEP,DFAT,NDAR,1,ITAR),XCPRO=$P(X,"|",1)
				If CPRO=XCPRO Set OK=1 Quit  ;Sai do For de item
			}
		}
		If OK Quit  ;Sai do For de recebimentos
	}
	Quit OK
	;
validarTrasportador(CDEE,DFAT,CFOP,CANP,CTRA,TPST,NPED,ITPE,NOCO,OCOR)	;Para produtos com código da ANP, valida o transportador
	;Parâmetros pela partição:
	;	CANP
	#Dim oProdutoANP As br.gov.anp.Produto
	#Dim oClassProd As cbpi.abadi.fiscal.anp.ClassificacaoProduto
	#Dim oCFOP As cbpi.abadi.fiscal.CFOP
	New oCFOP,X,CUFE,CGCT,CIET
	New oProdutoANP,oClassProd
	If CANP
	Set oProdutoANP=##class(br.gov.anp.Produto).instanciar(CANP)
	If '$IsObject(oProdutoANP) Quit 1 
	;Recupera a classeificação da ANP
	Set oClassProd=##class(cbpi.abadi.fiscal.anp.ClassificacaoProduto).instanciar(oProdutoANP,##class(cbpi.abadi.datatype.DataMedidata).LogicalToCache(DFAT))
	;Se classificação não foi cadastrada, presumi-se que não é combustível e que não requer transporte.
	If '$IsObject(oClassProd)||('oClassProd.exigeTransportador) Quit 1
	;Recupera o CFOP
	Set oCFOP=##class(cbpi.abadi.fiscal.CFOP).instanciar(CFOP,##class(cbpi.abadi.datatype.DataMedidata).LogicalToCache(DFAT))
	If 'oCFOP.exigeTransportador Quit 1
	;Se código ANP e CFOP exigem informação de transportador, 
	;   então valida se o transportador é válido.
	;   Se não tem informações de tansportador eventual
	If '$D(^IFPED(CDEE,NPED,0,ITPE,1)) Set NOCO=141,OCOR=NPED Quit 0
	;Recupera as informações do transportador eventual
	S X=^IFPED(CDEE,NPED,0,ITPE,1),CUFE=$P(X,"|",4),CGCT=$P(X,"|",5),CIET=$P(X,"|",6)
	If (CIET'="ISENTO")&&(CIET'="")&&(CUFE="") Set NOCO=142,OCOR="" Quit 0
	;Verifica a obrigatoriedade do transportador
	If $TR(CGCT," ./-")="" Set NOCO=143,OCOR=NPED Quit 0
	;Verifica se o CNPJ é válido
	If '##class(cbpi.abadi.datatype.CPFCNPJ).IsValid($TR(CGCT," ./-")) Set NOCO=144,OCOR=CGCT Quit 0
	Quit 1
	;
	;<Amauri - Projeto 4%> Registrando os lotes alocados para atender a origem/fci
registrarLotesAlocados(NPRF,CDEE,DFAT,NPED,ITPE,ORIP,NFCI,oListaLotesAloc,oListaLoteMovAloc,oListaLotesAlocProv,oListaQtdLoteMovAloc,oListaLoteMovArmAloc)
	;Parâmetros:
	;	oListaLoteMovArmAloc - Lista de movimentações de lote de remessa para armazenagem a serem 
	;                          retornados com o faturamento.
	;Registra os lotes alocados, conforme o tipo de operação, que pode ser:
	;	- Baixa simples - ^IFTFA(CDEE,NPRF,NPED,0,ITPE,1,idLote)
	;                     Grava lotes a serem baixados pelo faturamento.
	;	- Movimentação com saldo provisionado - ^IFTFA(CDEE,NPRF,NPED,0,ITPE,$$$ReservaLoteMovProv,idLoteMov)
	;                     Grava movimentações de provisão a serem consumidas no faturamento.
	;	- Movimentação que gera provisão - ^IFTFA(CDEE,NPRF,NPED,0,ITPE,3,idLote)
	;                     Grava lotes a serem consumidos pela provisão.
	;	- Movimentação com retorno de armazenagem - ^IFTFA(CDEE,NPRF,NPED,0,ITPE,4,idLoteMov)
	;                     Grava movimentações de remessa de armazenagem a serem retornadas 
	;                     para o faturamento.
	#Dim oLote As cbpi.abadi.estoque.Lote
	#Dim oLoteMov As cbpi.abadi.estoque.LoteMovimentacao
	New oLote,oLoteMov,idLote
	;
	S X=^IFTFA(CDEE,NPRF,NPED,0,ITPE)
	Set $Piece(X,"|",101)=ORIP
	Set $Piece(X,"|",102)=NFCI
	S ^IFTFA(CDEE,NPRF,NPED,0,ITPE)=X
	S ^IFCFA(NPRF,0,3,ITPE)=X
	;
	Set idLote=""
	For iKey=1:1:oListaLotesAloc.Count() {
		Set idLote=oListaLotesAloc.GetAt(iKey)
		S ^IFTFA(CDEE,NPRF,NPED,0,ITPE,$$$ReservaLoteFat,idLote)=""
	}
	;Lista de movimentações de lotes alocadas para o faturamento.
	;   Registra movimentações que provisionaram o saldo para este faturamento. 
	;   Movimentações de provisionamento serão estornadas.
	For iKey=1:1:oListaLoteMovAloc.Count() {
		Set oLoteMov=oListaLoteMovAloc.GetAt(iKey)
		S ^IFTFA(CDEE,NPRF,NPED,0,ITPE,$$$ReservaLoteMovProv,oLoteMov.%Id())=oListaQtdLoteMovAloc.GetAt(iKey)
	}
	;Se faturamento que gera provisão de saldo de estoque, registra lotes a serem baixados 
	;pelo provisionamento...
	Set idLote=""
	For iKey=1:1:oListaLotesAlocProv.Count() {
		Set idLote=oListaLotesAlocProv.GetAt(iKey)
		S ^IFTFA(CDEE,NPRF,NPED,0,ITPE,$$$ReservaLoteProv,idLote)=""
	}
	;Lista de movimentações de lotes alocadas para o faturamento.
	;   Registra movimentações que movimentaram o produto para o armazenador. 
	;   Movimentações de remessa para armazenagem serão retornadas por provisão de retorno de 
	;   armazenagem.
	For iKey=1:1:oListaLoteMovArmAloc.Count() {
		Set oLoteMov=oListaLoteMovArmAloc.GetAt(iKey)
		S ^IFTFA(CDEE,NPRF,NPED,0,ITPE,$$$ReservaLoteMovArm,oLoteMov.%Id())=""
	}
	Quit 1
eFaturamentoEmTerceiros(CDEE,LORE) ;Retorna verdadeiro se for operação de faturamento em terceiros
	;Faturamento em terceiros, é o faturamento com saída da mercadoria diretamente do armazenador
	;que permite execução de faturamento. (Projeto Caxias 2015)
	;Rótulo chamado a partir da rotina IFFAFA4A, IEMPCR e IFFACN.
	New X
	;Se não for faturamento com carregamento em operador logístico em filial com controle de estoque por armazém...
	If (##class(cbpi.abadi.basico.DependenciaParametro).getTipoDispEstoque(CDEE)'=3) Quit 0 
	;Se sai da própria filial, não é faturamento em terceiros
	If (LORE="")||(LORE=("1"_CDEE)) Quit 0
	;Se armazenador não estiver parametrizado...
	If '$D(^IBACO(CDEE,LORE,1)) Quit 0
	;Recupera se permite faturamento em terceiros
	Set X=^IBACO(CDEE,LORE,1),IPFA=$P(X,"|",12)
	If 'IPFA Quit 0
	Quit 1
recuperarCNPJArm(CDEE,LORE,CCLI)	;Recupera o ponto de entrega do armazenador
	;Rótulo chamado da rotina IEMPAR6B, IFPROC1, IFPEAT42 e outros.
	;Parâmetros:
	;	CCLI - OUT
	New X,CNPJ
	;Se armazenador não estiver cadastrado, usa o CCLI do fornecedor
	If $D(^IBACO(CDEE,LORE,1))  {
		;O CNPJ a ser utilizado é o CNPJ do cadastro do armazenador na IBACO
		Set X=^IBACO(CDEE,LORE,1),CCLI=$P(X,"|",8)
	}
	ElseIf $D(^IBPOL(LORE)) {
		;Se armazenador não estiver cadastrado, usa o CCLI do pool
		Set X=^IBPOL(LORE),CNPJ=$P(X,"|",4),CNPJ=$TR(CNPJ,"/-.")
	}
	ElseIf $D(^IBFOR(LORE)) {
		Set X=^IBFOR(LORE),CCLI=$P(X,"|",4)
	}
	If '$D(CNPJ)&&'$D(CCLI) Quit ""
	If '$D(CNPJ) Set CNPJ=##class(cbpi.abadi.basico.ClienteMap).recuperarCPFCNPJ(CCLI)
	If '$D(CCLI) Set CCLI=$E(CNPJ,1,*-2)_"01"
	Quit CNPJ
alocarSaldoResidual(CDEE,NORC="",NPED,ITPE,newORIP="A",newNFCI="",%US,%AP,%MOD,%ROT)	;Aloca saldo do pedido não atendido com o saldo existente da origem
	;Saldo deve ser alocado se não for informado a origem e FCI deve ser registrada como origem automática.
	New ITEM,ORIP,NFCI,REG,CPRO,QPED,CTRA,VIAG,CCAM,NTRA,ETRA,NMUT,CUFT
	Set ORIP=newORIP,NFCI=newFCI
	;Recupera o próximo item da seguencia. 
	Set REG=^IFPED(CDEE,NPED,0,ITPE)
	Set CPRO=$P(REG,"|",1),QPED=$P(REG,"|",3)
	Set VIAG=$P(REG,"|",9),CTRA=$P(REG,"|",10),CCAM=$P(REG,"|",11) 
	Set $P(REG,"|",106)=NFCI
	Set $P(REG,"|",110)=ORIP
	IF $G(NORC)'="" {
		;Incluir pedido/item na ordem de carregamento
		L +^IFOCE(CDEE,NORC)
		Set ITEM=$O(^IFOCE(CDEE,NORC,""),-1)+1
		Set $P(REG,"|",40)=NORC
		Set ^IFOCE(CDEE,NORC,ITEM)=CPRO_"|"_QPED_"|"_NPED_"|"_ITPE_"|"_ORIP_"|"_NFCI
		L -^IFOCE(CDEE,NORC)
	}
	Set ^IFPED(CDEE,NPED,0,ITPE)=REG
	;FIM - Incluir pedido/item na ordem de carregamento
	;Aloca item na mesma viagem
	Set DCRR=$P(REG,"|",8)
	Set (NTRA,ETRA,NMUT,CUFT)=""
	If $D(^IFPED(CDEE,NPED,0,ITPE,1)) Set X=^IFPED(CDEE,NPED,0,ITPE,1),NTRA=$P(X,"|",1),ETRA=$P(X,"|",2),NMUT=$P(X,"|",3),CUFT=$P(X,"|",4)
	Do gravarAlocacao^IFPRLA2(CDEE,NPED,ITPE,DCRR,QPED,CTRA,VIAG,CCAM,NTRA,ETRA,NMUT,CUFT,%US,%AP,%MOD,%ROT)	;Função para gravar a alocação
	Quit
atualizarOC(CDEE,NORC,NPED,ITPE,QPED,ORIP,NFCI)	;Atualiza a quantidade e um item de um pedido da ordem
	New ITEM,XNPED,XITPE
	;Determina o item da ordem que contém o item do pedido
	Set ITEM=""
	For  {
		Set ITEM=$O(^IFOCE(CDEE,NORC,ITEM))
		Quit:ITEM=""
		Set X=^IFOCE(CDEE,NORC,ITEM),XNPED=$P(X,"|",3),XITPE=$P(X,"|",4)
		Quit:((XNPED=NPED)&&(XITPE=ITPE))
	}
	;ERRO - Item não encontrado
	If ITEM="" Quit
	Set X=^IFOCE(CDEE,NORC,ITEM)
	Set $P(X,"|",2)=QPED,$P(X,"|",5)=ORIP,$P(X,"|",6)=NFCI
	Set ^IFOCE(CDEE,NORC,ITEM)=X
	Quit
	;
	; <Aud>Consiste se o produdo esta com origem e/ou FCI válidos.</Aud>
temErroItemImportado(EMGR,CDEE,ITPE,CPRO,ORIP,NFCI,&OCOR) Public {
	;
	;///If '$$eICONICLUBS^IBSR.faturamento.UtilAux(EMGR) Quit 0
	;
	Set bRequerFCI=##class(cbpi.abadi.estoque.nfe.NFeICMSTipoOrigem).requerFCI(ORIP)
	If (bRequerFCI)&&(NFCI="") {
		Set OCOR="Item: "_ITPE_" ref.: Produto "_CPRO_" < A Origem "_ORIP_" Requer uma FCI válida >"
		Quit 1
	}
	If ('bRequerFCI)&&(NFCI'="") {
		Set OCOR="Item: "_ITPE_" ref.: Produto "_CPRO_" < A Origem "_ORIP_" Não requer FCI "_NFCI_" >"
		Quit 1
	}
	If '##class(cbpi.abadi.estoque.FCI).eFCIValida(CDEE,CPRO,ORIP,NFCI,.poArrLog) {
		If poArrLog.GetAt("CPRO")'=CPRO {
			Set OCOR="Item: "_ITPE_" ref.: Produto "_CPRO_" e Origem "_ORIP_"< Cadastro da FCI com erro >"
		}
		If poArrLog.GetAt("ORIP")'=ORIP {
			Set OCOR="Item: "_ITPE_" ref.: Produto "_CPRO_" e Origem "_ORIP_"< Cadastro da FCI com erro >"
		}
		;
		Quit 1
	}
	;
	Quit 0
 }

RNI ;Registra Novo Item
 	;   1- O item do pedido deve ser desmembrado em dois: um com o saldo disponível e outro com o saldo remanescente.
	;Set XITPE=$$gravarNovoItem^IFPROC3(CDEE,NPED,ITPE,QPED,intQtdAlocada,DFAT,%US)	;Função para gravar novo item
	NEW QPEDAtual
	Tstart
	Set XITPE=$$gravarNovoItem(CDEE,NPED,ITPE,intNovaQtdAlocada,DFAT,%US,newFCI)
	;	2- A quantidade do item que está sendo faturado deve ser reduzida para o faturamento corrente.
	If XITPE > 0 {
		Set QPEDAtual=QPED-intNovaQtdAlocada
		If QPEDAtual<1 {
			Trollback 1
			Quit
		}
		Set QPED=QPEDAtual
		Set RGAN=RIT,NORC=$P(RIT,"|",40)
		Set $P(RIT,"|",3)=QPED,$P(RIT,"|",106)=NFCI
		Set ^IFPED(CDEE,NPED,0,ITPE)=RIT
		// Grava no historico qualquer alteracao no valor do pedido
		Set HIPE=10,CDEP=CDEE D ^IBSRHP
		If NORC'="" {
			Do atualizarOC(CDEE,NORC,NPED,XITPE,QPED,newOrigem,newFCI)
		 	;	3- O item com o saldo remanescente deve ser alocado na mesma viagem.
		}
		Do alocarSaldoResidual(CDEE,NORC,NPED,XITPE,newOrigem,newFCI,%US,%AP,%MOD,%ROT)
	}
RNIZ	Quit
	;
retornaQtdeFCIPedido(codDep,numPedido,numFCI) public {	
	#Dim itemPedido
	set itemPedido=""
	set quantidadeFCI=0
	for {
		Set itemPedido=$O(^IFPED(codDep,numPedido,0,itemPedido))
		quit:itemPedido=""
		Set X=^IFPED(codDep,numPedido,0,itemPedido),numFCIItem=$P(X,"|",106),quantidade=$P(X,"|",3),status=$P(X,"|",13)
		//Se não está faturada, cancelada, transferida então deve contabilizar.
		If (+status < 4) {
			If numFCIItem=numFCI {
				set quantidadeFCI=quantidadeFCI+quantidade
			}
		}
	}
	quit quantidadeFCI
}
	;
qtdeFCIAtendida(codDep,numPedido,arrSaldosFCI,&strMsg) public {
	set strMsg=""
	While arrSaldosFCI.GetNext(.FCI) {
		set intQtdFCI=arrSaldosFCI.GetAt(FCI)
		set numFCI=$Translate(FCI," ","")
		set quatidadePedido=$$retornaQtdeFCIPedido(codDep,numPedido,numFCI)
		if (intQtdFCI<quatidadePedido) {
			set strMsg="Não foi possivel alocar quantidade "_quatidadePedido_" com o FCI "_numFCI_" quantidade disponível para esse FCI: "_intQtdFCI_". "
			quit
		}
	}
	If (strMsg="") {
		quit 1
	}
	Else
	{
		quit 0
	}
}
gravarNovoItem(CDEE,NPED,ITPE,quantidadeItem,DCRR,%US,numeroFCI)	;Função para gravar novo item
	;Rótulo chamado pela rotina IFFAFA3A para quebrar itens que não 
	;tem saldo suficiente na origem.
	New (CDEE,NPED,ITPE,quantidadeItem,DCRR,%US,numeroFCI)
	Set REG=^IFPED(CDEE,NPED,0,ITPE),CPRO=$Piece(REG,"|",1),ITOR=$Piece(REG,"|",127)
	;Incluido para evitar copias indesejadas de itens. 
	If ITOR="" {
	 	Set ITOR=ITPE
	}
	Else{
		Quit 0
	}
	Set UITPE=0
	If quantidadeItem<1 Quit 0
	Set UITPE=$Order(^IFPED(CDEE,NPED,0,""),-1)
	Set X=^IFPED(CDEE,NPED),CCLI=$Piece(X,"|",2),CLPA=$Piece(X,"|",4)
	Set RIT=REG
	Set XDSAI=$Piece(RIT,"|",8)
	If XDSAI?1"" Set XDSAI=DCRR,$Piece(RIT,"|",8)=XDSAI
	Set $Piece(RIT,"|",3)=quantidadeItem,$Piece(RIT,"|",40)="",UITPE=UITPE+1
	Set $Piece(RIT,"|",106)=numeroFCI,$Piece(RIT,"|",127)=ITOR
	Set ^IFPED(CDEE,NPED,0,UITPE)=RIT
	Set ^IFPPR(CDEE,CPRO,NPED,UITPE)=""
	Set ^IFPDE(CDEE,XDSAI,NPED,UITPE)=""
	Set ^IFPPA(CDEE,XDSAI,CLPA,CCLI,NPED,UITPE)=""
	Do LOG
	If $Data(^IFPED(CDEE,NPED,0,ITPE,1)) Set ^IFPED(CDEE,NPED,0,UITPE,1)=^IFPED(CDEE,NPED,0,ITPE,1)
	Kill YQPED,CLPA,RIT
	Quit UITPE
	;	
IAM D IAM^IFFAFA3B Q  
RIT D RIT^IFFAFA3C Q  
DQF D DQF^IFFAFA3C Q  
VEE D VEE^IFFAFA3D Q  
VQA D VQA^IFFAFA3D Q  
VPM D VPM^IFFAFA3D Q  
CVF D CVF^IFFAFA3E Q  
VCV D VCV^IFFAFA3E Q  
CNP D CNP^IFFAFA4G Q  
CAL D:CNOP'=599665 CAP^IFFAFA6A D:CNOP=599665 CAL^IFFAFA6A Q
GRO D GRO^IFFAFA6B Q  
VSF D VSF^IFFAFA3D Q 
LOG D LOG^IFPROC3 Q
 ;SLD	D SLD^IFFAFA3D Q ;Inibido para envio a produção AHZ; TODO descomentar após o envio do pacote
VPA D VPA^IBSRVP Q 
	;
	;<Amauri - Fev/2015>
	;ATENÇÃO: Sempre que houver alterações na global ^IFTFA favor atualizar esta documentação
	;
	;DOCUMENTACAO DA GLOBAL ^IFTFA
	;
	; ^IFTFA(CDEE,$J,NPED,0,ITPE)	Registros Gerais do Item do Pedido
	; 
	; [ ... ]   
	; [ 100	]	VUPF - Valor do Pedágio
	; [ 101 ]	ORIP - Origem do Produto [ cbpi.abadi.estoque.nfe.NFeICMSTipoOrigem ]
	; [ 102 ]	NFCI - FCI [ cbpi.abadi.estoque.fci ]
	; [ ... ] 
	; [ 107 ]   VURS - Valor Unit.Reserva Financeira - TAREFA ALM-42891 - DSD - 05/2017
	;
	; ^IFTFA(CDEE,$J,NPED,0,ITPE,$$$ReservaLoteFat,idLote)	- Registros dos Lotes Alocados para baixa
	;
]]></Routine>


<Routine name="IFFAFA4D" type="MAC" languagemode="0" timestamp="65440,63051.315107"><![CDATA[
IFFAFA4D ;ATIVA/DESATIVA FATURAMENTO <V1.2-ELR-05/88>  ;Última Alteração   FLCARVALHO 02/03/2020 17:30:51
 #Include sistema.BibliotecaMacro
 ;  
 #Dim ORIP as %StringD	; Representa o código da origem para consumo
 #Dim NFCI AS %String	; Representa o número da FCI da origem de consumo (Quando exigir FCI)
 #Dim CPEC AS %String	; Representa o código do produto do cliente
 #Dim NPEC,DPCL,ICPC AS %String	; Informações dos dados externos do cliente para preencher o XML
 #Dim bICMSEfetivo as %Boolean 
 #Dim AIEF,VBIE,VIEF as %Numeric
 #Dim oArrImp as %ArrayOfDataTypes
 #Dim CSTICMS as %String
 #Dim CBFT as %String
 ;
GLC ;GERA/ATUALIZA LINHA DE CARAC. FISICAS     
 I IPRI S (PBRU,PLIQ)="0.00" 
 E  S X=^IFTFA(CDEE,$J,NPED,CPRO),PBRU=$P(X,"|",3),PLIQ=$P(X,"|",4),CUME=$P(X,"|",13) 
 I 'EEMB,CUME?1"3" S (PLIQ,PBRU)="1" 
 S DELC=$P("GRANEL,TAMBOR,BALDE,CAIXA,LATA,SACO,PECA,PAR,CONTAINER,CONJUNTO,METRO,UN",",",EEMB+1) I DELC?1"" S DELC=" " 
 I $D(LC(DELC)) S X=LC(DELC),NILC=$P(X,"|",1),QELC=$P(X,"|",2),PLLC=$P(X,"|",3),PBLC=$P(X,"|",4) 
 E  S NILC=0,QELC="0",PLLC="0.00",PBLC="0.00" 
 S NILC=NILC+1,QELC=(+QELC+QPNF),PLLC=$J(PLIQ*QPNF+PLLC,0,2),PBLC=$J(PBRU*QPNF+PBLC,0,2) 
 //<VCT>Em teste ELO - Busca informações de peso bruto e peso liquido caso o usuário tenha informado a mesma na alocação.
 //Nível populado apenas por lubrificantes granel, para ajuste de peso liquido e bruto
 If $$eICONIC^IBSR.faturamento.UtilAux(EMGR) {
	 S X=$Get(^IFPED(CDEE,NPED,0,ITPE,8)),XPBLC=$P(X,"|",1), XPLLC=$P(X,"|",2)
	 I XPBLC'="" S PBLC=XPBLC
	 I XPLLC'="" S PLLC=XPLLC
 }
 //<VCT>
 S X=NILC_"|"_QELC_"|"_PLLC_"|"_PBLC,LC(DELC)=X,^IFCFA(NPRF,0,4,DELC)=X 
GLCZ K PBRU,PLIQ,DELC,NILC,QELC,PLLC,PBLC,RPRO Q  
 ;
FII ;FINALIZA ITEM
 ;
 #Dim AIDE,AICR,MOTD,BIDE,VIDE,AICMNOVO,VBICNOVO,VICINOVO,AICMANT,VBCIANT,VICIANT as %Integer
 #Dim APIC,BPIC,VPIC,APST,BPST,VPST,APSR,BPSR,VPSR as %Numeric
 #Dim AISR,BISR,VISR,AISD,BISD,VISD as %Numeric
 #Dim oArrValFCP,oArrICMSTRet,oArrParamEnt as %ArrayOfDataTypes
 ;
 New AIDE,AICR,MOTD,BIDE,VIDE,AICMNOVO,VBICNOVO,VICINOVO,AICMANT,VBCIANT,VICIANT,APTC,AITC,PSCC
 New APIC,BPIC,VPIC,APST,BPST,VPST,APSR,BPSR,VPSR
 New AISR,BISR,VISR,AISD,BISD,VISD,CBFT
 New oArrValFCP,oArrICMSTRet,oArrParamEnt
 ;
 Set (AIDE,AICR,MOTD,BIDE,VIDE,VICINOVO,AICMANT,VBCIANT,VICIANT,AITC,APTC,PSCC)=""
 ;
 S X=^IFPED(CDEE,NPED,0,ITPE)
 S XNOCA=$P(X,"|",64),LORE=$P(X,"|",68),NORT=$P(X,"|",69),ROTA=$P(X,"|",99)
 ;
 ; GDTI 3262 - TAREFA 84458/ENTREGA 97428 - DSD - 11/2018 - RECALCULO DESC.COMERCIAL
 ; S VUDC=$P(X,"|",120) ; TAREFA 75941 - DSD - 04/2018
 ;
 D GRI,AIT,GDC,GDT 
 ;
 I ((CDOP=55)&("585201/685201/585160/685120"'[CNOP))||("599160/699160/693024"[CNOP)||(CDOP=92) {
	;Trata faturamento antecipado, excluindo op.fat.conta e ordem - (CDOP=55)&("585201/685201/585160/685120"'[CNOP)
	;ou remessa por conta e ordem - ("599160/699160/693024"[CNOP)||(CDOP=92)
	S X=^IFTFA(CDEE,$J,NPED,0,ITPE)
	S $P(X,"|",24)=VBII,$P(X,"|",25)=VIVI,$P(X,"|",29)=AIVV
	S $P(X,"|",48)=CIIV,$P(X,"|",20)=VBCI,$P(X,"|",21)=VICI
	S $P(X,"|",22)=VBRI,$P(X,"|",23)=VIRI,$P(X,"|",30)=AIRE
	S $P(X,"|",40)=VDBC,$P(X,"|",60)=VDAI
	S ^IFTFA(CDEE,$J,NPED,0,ITPE)=X
	S $P(RDG,"|",41)=VTDA 
 } 
 ;
 I ((CDOP=61)&("599160/699160/693024"'[CNOP))||("585201/685201/585160/685120"[CNOP)||(CDOP=91) {
	;Trata remessa de FA, excluindo remessa por conta e ordem - (CDOP=61)&("599160/699160/693024"'[CNOP)
	;ou fat.por conta e ordem - ("585201/685201/585160/685120"[CNOP)||(CDOP=91)
	S X=^IFTFA(CDEE,$J,NPED,0,ITPE)
	S $P(X,"|",53)=UNPR,$P(X,"|",54)=SIPR,$P(X,"|",55)=UNFR
	S $P(X,"|",56)=SIFR,$P(X,"|",60)=VDAI
	S ^IFTFA(CDEE,$J,NPED,0,ITPE)=X
	S $P(RDG,"|",41)=VTDA
 }
 ;
FIIZ K RPRO Q  
 ;
GRI ;GRAVA ITEM
 ;Recupera dados do AR de remessa por conta e ordem
 Set X=^IFCFA(NPRF),NDAR=$P(X,"|",32),ITAR=$P(X,"|",33)
 ;
 S X=^IFTFA(CDEE,$J,NPED,CPRO),CIPP=$P(X,"|",12),PADL=$P(X,"|",14) 
 S IAPR="",IALT=^IFCOF I IALT,$D(^IFPAL(CPRO)),CTOP?1"01" S IAPR=1 
 S D="|",(NPRO,EMBA,IFET,VDRC)="" 
 S IPDA=$P(RIT,D,59),IFET=$P(RIT,D,60),ICFT=$P(RIT,D,63) 
 S IICM=$P(RIT,D,35),IPIN=$P(RIT,D,71) 
 S X=^IFPED(CDEE,NPED),IPCF=$P(X,"|",15),ILPF=$P(X,"|",14) 
 S X=^IFPED(CDEE,NPED,0,ITPE),CTRA=$P(X,"|",10) If CTRA="" Set CTRA=9999
 S VUNV=$P(X,"|",133) ; <flcarvalho - GDTI-4701 - Tarefa-112791 - Vendor - 2019/08>
 ;
 I "010169/010269"[CNOS S IFET=1 ;*** Vendas de estoque tecnico ****
 I ((CDOP=55)&("585201/685201/585160/685120"'[CNOP))||("599160/699160/693024"[CNOP)||(CDOP=92) S VDAI=VDAI+VIRI+VIVI,(VBII,VIVI,AIVV,CIIV,VBCI,VICI,AICM,VBRI,VIRI,AIRE,VDBC)="" S:("599160/699160/693024"[CNOP) VDAI=VDAI+VIPI,VIPI="",AIPI="" S VTDA=VTDA+VDAI 
 I ((CDOP=61)&("599160/699160/693024"'[CNOP))||("585201/685201/585160/685120"[CNOP)||(CDOP=91) S VDAI=VDAI+SIPR+SIFR,(UNPR,SIPR,UNFR,SIFR)="",VTDA=VTDA+VDAI 
 ;<AHZ> alteração para Remessa por Conta e Ordem CDOP=92 não deve ter adicional de despesas acessorias. ALM 66027 
 If (CDOP=92) {
 	Set (VDAI,VBII,VIVI,AIVV,CIIV,VBCI,VICI,AICM,VBRI,VIRI,AIRE,VDBC,VIRI)=""
 	Set VDAI="",VIPI="",AIPI=""
 }
 ;</AHZ> 
 D ^IBSRST,^IBSRIF 
 I +VIRI=0 S AIRE=""
 S VDRC="" I CTOP="01",VDPC'?1"" D CDR
 S X=^IFTFA(CDEE,$J,NPED,0,ITPE),ICMC=$P(X,"|",51),ICPP=$P(X,"|",52),AICQ=$P(X,"|",86),RICD=$P(X,"|",87),MVAL=$P(X,"|",109)
 ;<Aud - Projeto ELO>
 Set PRBC=$Piece(X,"|",110)
 ;</Aud - Projeto ELO>
 ;
 S MRGV=$P(X,"|",115) ; <flcarvalho - GDTI-4701 - Tarefa-112791 - Vendor - 2019/12>
 S DFAG=$P(X,"|",116) ; <flcarvalho - GDTI-5608 - Diferença do ganho de ajuste>
 ;
 I CPRO=12000000 D
 .S (PURE,CURE,MARU,ICMP,VPDP,VCDP,VPRP,VCRP,IPIS,ICOF,SUPJ,GARU,VDUF)=""
 .I +QPNF'=0 S ICMP=$J(VICI/QPNF,0,2) ;ICMS incluido no preco para Marketing
 .
 #;<AUD - Projeto 4%> Recuperar a origem para poder definir o código de situação tributária - CSTR
 Set X=^IFPED(CDEE,NPED,0,ITPE)
 Set NFCI=$P(X,"|",106)
 Set ORIP=$P(X,"|",110)
 Set ORIGEMCSTR=ORIP
 #;</FIM AUD - 17/11/2014 - Projeto Convenio 38 (4%) - Recuperar Origem e FCI do item do pedido>
 ;
 ;<Amauri - ALM 53984 - Projeto ELO - GAP FAT10>
 Set CPEC=$Piece(X,"|",118)
 ;
 Set CPEC="",NPEC="",DPCL="",ICPC=""
 If $D(^IFPED(CDEE,NPED,0,ITPE,7)) {
	Set X=^IFPED(CDEE,NPED,0,ITPE,7)
	Set CPEC=$Piece(X,"|",1)
	Set NPEC=$Piece(X,"|",2)
	Set DPCL=$Piece(X,"|",3)
	Set ICPC=$Piece(X,"|",4)
 }
 ;
 S X=^IBPRO(CPRO),CFPR=$P(X,"|",14),CLPR=$P(X,"|",24) 
 S DURV=DFAT D ^IBSRIM 
 ;
 ;<Aud - NT 2018.005/2019.001 - ALM 103922/111225>
 #; Set CBFT=##class(br.gov.nfe.icms.beneficioFiscal).getCodigoPadrao(CUFD)
 Set (AIEF,VBIE,VIEF,ARBI)=0
 Set (CRCD,MOTD,VIDE,CBFT)=""
 Set AIOP=AICM
 Set oArrImp=$$getDadosPerfilTribBeneficio^IBSR.fiscal.PerfilTributarioSaida(CDEE,DFAT,CNOP,CCLI,CUFE,CPRO,VMER,"ICMS",CSTR,.sc)
 If oArrImp.Count()>0 {
	 Set calculaICMSEfetivo=oArrImp.GetAt("calculaICMSEfetivo")
	 Set calculaDesonICMS=oArrImp.GetAt("calculaDesonICMS")
	 Set CBFT=oArrImp.GetAt("BeneficioFiscal")
	 Set AliqICMSOrigem=oArrImp.GetAt("AliqICMSOrigem")
	 Set AliqICMSSTOrigem=oArrImp.GetAt("AliqICMSSTOrigem")
	 Set AliqICMSDestino=oArrImp.GetAt("AliqICMSDestino")
	 Set AliqICMSSTDestino=oArrImp.GetAt("AliqICMSSTDestino")
	 Set pCSTICMS=oArrImp.GetAt("CSTICMS")
	 Set pAliqBCReduzida=oArrImp.GetAt("AliqBCReduzida")
	 Set pAliqReducaoBCICMS=oArrImp.GetAt("AliqReducaoBCICMS")
	 Set pAliqICMSDestino=oArrImp.GetAt("AliqICMSDestino")
	 Set pAliqICMS=oArrImp.GetAt("AliqBaseICMS")
	 Set pAliqICMSST=oArrImp.GetAt("AliqBaseICMSST")
	 Set CBFT=oArrImp.GetAt("BeneficioFiscal")
 	 Set CRCD=oArrImp.GetAt("codRegraDesoneracao")
 	 Set MOTD=oArrImp.GetAt("codMotivoDesoneracao")
	 Set AIOP=oArrImp.GetAt("AliqICMSOPER")
	 ;
	 If (calculaICMSEfetivo) {
	 	Set bAplicaICMSEfetivo=0
	 	If ##class(cbpi.abadi.basico.ClienteMap).eConsumidor(CCLI) Set bAplicaICMSEfetivo=1
	 	If ##class(cbpi.abadi.basico.ClienteMap).eEspecial(CCLI) Set bAplicaICMSEfetivo=1
	 	If (bAplicaICMSEfetivo) {
		 	Set ARBI=pAliqReducaoBCICMS
			Set pAliqReducaoBCICMS=$J(pAliqReducaoBCICMS*100,0,2)
			Set AIEF=pAliqICMSDestino
			Set VBIE=$J(VMER*pAliqReducaoBCICMS/100,0,0)
			Set VIEF=$J(VBIE*AIEF/100,0,0)
	 	}
	 }
	 ;
	 If (calculaDesonICMS) {
		 Set oArrDeson=$$getDadosDesoneracao^IBSR.fiscal.PerfilTribSaidaICMS(CDEE,CRCD,CUFD,CUFE,DFAT,CPRO,QPNF,VMER,AICM)
		 Set VIDE=oArrDeson.GetAt("valorICMSDesonerado")
	 }
 }
 ;
 If CBFT="" Set CBFT=##class(br.gov.nfe.icms.beneficioFiscal).getCodigoBeneficio(CUFD,CNOP,CSTR,CPRO)
 If (CUFD="RJ")&&(CBFT="SEM CBENEF") Set CBFT=""
 ;
 ;</Aud - NT 2018.005/2019.001 - ALM 103922/111225>
 ;
 ;Tratamento para Orgaos Publicos Federais e Correlatas (^IBCRT)
 S (VDIR,VDCS,VDCF,VDPI)=""    ;Tem conteudo se for Org.Public.
 S XY=^IBCLI(CCLI,2),NTJU=$P(XY,"|",24) K XY 
 I CTOP?1"01"&((("23400"[CNEG&("1015/1040/1074/1104/1139/1163"[NTJU))!($D(^IBCRT(CCLI))=11))),'$D(^ILOPI(1,CCLI)) D TOP 
 ;ICMS Substituicao Refinaria
 D ITR 
 ;Isencao de Pesqueiras
 S IIPE="" I $D(^ILCID(CCLI,CPRO)) S IIPE=1 
 ;
 ;Implementacao CODIF - Portaria CAT 91/06 - SEFAZ/SP
 S X=^IFPED(CDEE,NPED,0,ITPE),INAP=$P(X,"|",89),CAUP=$P(X,"|",90),IDRF=$P(X,"|",103)
 ;
 ;Numero do Item do Pedido Externo
 S NIPE=$P(X,"|",104)
 ;
 ;Documento de referencia - SPED
 S DDRF=$P(X,"|",94),NDRF=$P(X,"|",95),DNOR=$P(X,"|",96),ITRF=$P(X,"|",97)
 ;Dados de exportação
 S IDDR=$P(X,"|",111),NREE=$P(X,"|",112),CNFE=$P(X,"|",113)
 ;Recupera Gap entre produtos aditivados e comuns
 D COM^IBSRCM I PROUTIL?1"" S PROUTIL=CPRO
 ;
 D VMD
 S (GARU,INNV)=""
 I ILMD D  ; Margem por Dependência - TAREFA 006E408C - DSD - 12/2013
 .D RPV ; TAR ALM-18861 - DSD - 05/2016 - DTCLEAN
 .I IPRM D
 ..S DTVGX=$O(^IPMCD(CCLI,PROUTIL,CDEE,(DFAT+1)),-1) 
 ..S GARU="",INNV=1
 ..I DTVGX D
 ...S X=^IPMCD(CCLI,PROUTIL,CDEE,DTVGX)
 ...S GARU=$P(X,"|",3) I $P(X,"|",2)'?1"" S INNV=0
 E  D      ; Margem por Cliente
 .S DTVGX=$O(^IPMCL(CCLI,PROUTIL,(DFAT+1)),-1) 
 .S X="" I DTVGX S X=^IPMCL(CCLI,PROUTIL,DTVGX)
 .S GARU=$P(X,"|",3)
 K PROUTIL
 ;
 ; GDTI 9999 - TAREFA xxxxx - DSD - 11/2018 - RECALCULO DESC.COMERCIAL
 D RDC
 ;
 S IPCC=""
 /*  ; ---  Tarefa  007BDC35  ---
 S IPCC="0" I $D(^ILIOC(CCLI,CPRO)) S IPCC=1
 */
 ;
 D VDW 	; Verifica Drawback - Isenção PIS/COFINS
 ;
 #;<Aud - GDTI 2920/ALM 88106 - Lacres por Deposito Armazenador>
 ;
 Set DALC=$$getDadosCompAloc(CDEE,DFAT,VIAG,NPED,ITPE)
 ;
 ;* * * A T E N Ç Ã O : Não incluir execução de módulos ou subrotinas antes 
 ;de armazenar o registro R na IFNFS para evitar a perda deste registro * * *
 S R="",D="|" I $Get(EMGR)="" 
 S $P(R,D,1)=CPRO,$P(R,D,2)=IPRI,$P(R,D,3)=NPRO,$P(R,D,4)=QPNF 
 S $P(R,D,5)=VUNF,$P(R,D,6)=VMER,$P(R,D,7)=CIPI,$P(R,D,8)=AIPI 
 S $P(R,D,9)=VIPI,$P(R,D,10)=VFRE,$P(R,D,11)=VCAR,$P(R,D,12)=ITPE 
 S $P(R,D,13)=NOEM,$P(R,D,14)=ESTO,$P(R,D,15)=EMBA,$P(R,D,16)=IBCR 
 S $P(R,D,17)=ICDF,$P(R,D,18)=IAPR,$P(R,D,19)=VBCI,$P(R,D,20)=VICI 
 S $P(R,D,21)=VBRI,$P(R,D,22)=VIRI,$P(R,D,23)=AICM,$P(R,D,24)=VBII 
 S $P(R,D,25)=VIVI,$P(R,D,26)=VUFD,$P(R,D,27)=CIPP,$P(R,D,28)=VEFI 
 S $P(R,D,29)=PEFI,$P(R,D,30)=VDEI,$P(R,D,31)=AIVV,$P(R,D,32)=AIRE 
 S $P(R,D,33)=PADL,$P(R,D,34)=IFDG,$P(R,D,35)=VFUT,$P(R,D,36)=AICF 
 S $P(R,D,37)=VIFR,$P(R,D,38)=VMVC,$P(R,D,39)=IINF,$P(R,D,40)=VFCI 
 S $P(R,D,41)=CMOR,$P(R,D,42)=VMAX,$P(R,D,43)=VDEP,$P(R,D,44)=VTXB 
 S $P(R,D,45)=VBOM,$P(R,D,46)=STIF,$P(R,D,47)=TFRE,$P(R,D,48)=VDBC 
 S $P(R,D,49)=VFRP,$P(R,D,50)=VTTB,$P(R,D,51)=IPAF,$P(R,D,52)=IPDA 
 S $P(R,D,53)=IFET,$P(R,D,54)=VDPC,$P(R,D,55)=VPSD,$P(R,D,56)=TIFR 
 S $P(R,D,57)=ICFT,$P(R,D,58)=XNOCA,$P(R,D,59)=NORT,$P(R,D,60)=EFPP 
 S $P(R,D,61)=VDRC,$P(R,D,62)=INDR,$P(R,D,63)=ICPP,$P(R,D,64)=VBIF 
 S $P(R,D,65)=UNPR,$P(R,D,66)=SIPR,$P(R,D,67)=UNFR,$P(R,D,68)=SIFR 
 S $P(R,D,69)=VDDB,$P(R,D,70)=PRAZ,$P(R,D,71)=BORE,$P(R,D,72)=VDAI 
 S $P(R,D,73)=IRIP,$P(R,D,74)=AIRP,$P(R,D,75)=IICM,$P(R,D,76)=CCOA 
 S $P(R,D,78)=PZCB,$P(R,D,79)=MARU,$P(R,D,80)=PURE,$P(R,D,81)=CURE 
 S $P(R,D,82)=BIRP,$P(R,D,83)=ICMC,$P(R,D,84)=PBRE,$P(R,D,85)=PREF 
 S $P(R,D,86)=IRPR,$P(R,D,87)=IDPR,$P(R,D,88)=ICMP,$P(R,D,89)=CSTR 
 S $P(R,D,90)=CFPR,$P(R,D,91)=VPDP,$P(R,D,92)=VCDP,$P(R,D,93)=VPRP 
 S $P(R,D,94)=VCRP,$P(R,D,95)=IPIS,$P(R,D,96)=ICOF,$P(R,D,97)=VDIR 
 S $P(R,D,98)=VDCS,$P(R,D,99)=VDCF,$P(R,D,100)=VDPI,$P(R,D,102)=IPIN 
 S $P(R,D,103)=CO72,$P(R,D,104)=SUPJ,$P(R,D,106)=IIPE
 S $P(R,D,110)=INAP,$P(R,D,111)=CAUP ;Implementacao CODIF - Portaria CAT 91/06 - SEFAZ/SP
 S $P(R,D,114)=ICIR ;Consumidor com ICMS do Revendedor COSURE começou a gravar em 03/04/2007
 S $P(R,D,115)=GARU
 S $P(R,D,129)=BRHI,$P(R,D,130)=VRHI,$P(R,D,131)=AIRH,$P(R,D,135)=VDUF,$P(R,D,137)=DMSC
 S $P(R,D,136)=IPCC
 S $P(R,D,109)=IZFM,$P(R,D,138)=NUAC ;Isenção PIS e COFINS
 S:'$D(LORE) LORE=""
 S:LORE?1"" LORE=1_CDEE
 S $P(R,D,139)=LORE
 S $P(R,D,140)=AICQ ;Redução da Aliquota de ICMS - Tarefa - 00741DA5 - Cota de Diesel - 11/2011
 S $P(R,D,141)=IDRF ;Implementacao CODIF - Portaria CAT 91/06 - SEFAZ/SP
 S $P(R,D,142)=NIPE
 S $P(R,D,143)=RICD ;Redução da Aliquota de ICMS - Tarefa - 0050FE56 - Cota de Diesel - 01/2013
 ;
 ;<Amauri - Projeto 4%> Desligando Implementação da Versão Anterior
 ; Tarefa 006E3081 - ICMS 4% - Eliana 09/2013
 ; S $P(R,"|",144)=VLPI,$P(R,"|",145)=NFCI,$P(R,"|",146)=COIM,$P(R,"|",147)=VLIM,$P(R,"|",152)=SMOV ; ICMS 4% - Tarefa 007B0113 Eliana 09/2013 Revisão
 ;</Fim Amauri - Projeto 4%> Desligando Implementação da Versão Anterior
 ;
 S VTTI="",TIIP=""
 S $P(R,"|",148)=VTTI,$P(R,"|",149)=TIIP ;Calculado depois em ^IBSRTN - Total de Tributosda NF - Tarefa 0056C373 01/06/2013 - ELIANA
 S $P(R,"|",150)=VUSI
 ;Dados de exportação
 Set $P(R,"|",157)=IDDR,$P(R,"|",158)=NREE,$P(R,"|",159)=CNFE
 ;
 ; <AMAURI - 17/11/2014 - Projeto Convenio 38 (4%) - Registrar Origem e FCI do item do pedido>
 Set $P(R,"|",145)=NFCI
 Set $P(R,"|",160)=ORIP
 ; <FIM AMAURI - 17/11/2014 - Projeto Convenio 38 (4%) - Registrar Origem e FCI do item do pedido>
 ;
 ; TAREFA 00431215 - DSD - 02/2015 - Inclusão de Pedágio p/cálculo da margem no BI
 S $P(R,"|",161)=VUPF
 ;Grava dados de ICMS partilhado
 If $G(AICD)>0 {
 	Set $P(R,"|",166)=VBCD,$P(R,"|",167)=AICD,$P(R,"|",168)=VICD
 	Set $P(R,"|",169)=PICD,$P(R,"|",170)=VICO,$P(R,"|",171)=AICP
 	Set $P(R,"|",172)=VICP
 }
 ;
 ; TAREFA ALM-42891 - DSD - 05/2017 - Inclusão de Res.Financeira p/cálculo da margem no BI
 S $P(R,"|",173)=VURS
 ;
 ; TAREFA ALM-61887 - ELIANA - 10/2017 - ELO CHEVRON - MVA Lubrificante
 Set $P(R,"|",174)=MVAL
 ;
 ;<Aud - Projeto ELO>
 Set $Piece(R,"|",175)=PRBC
 ;</Aud - Projeto ELO>
 ;
 ; TAREFA 75941 - DSD - 04/2018
 Set VTDC=$J(VUDC*QPNF,0,0)
 Set $Piece(R,"|",177)=VTDC
 ;
 Set $P(R,"|",184)=DALC ; <Aud - GDTI 2920/ALM 88106>
 ;
 S $P(R,"|",186)=VUNV ; <flcarvalho - GDTI-4701 - Tarefa-112791 - Vendor - 2019/08>
 S $P(R,"|",187)=$G(MRGV) ; <flcarvalho - GDTI-4701 - Tarefa-112791 - Vendor - 2019/12>
 S $P(R,"|",189)=$J($G(DFAG),0,2) ; <flcarvalho - GDTI-5608 - Projeto 5 casas decimais e arredondamento>
 ;
 S ^IFNFS(CDEE,DFAT,NONF,0,ITNF)=R
 ;
 ;<Aud - GDTI 3267 DU-e>
 Set oArrPTrib=$$getParametroUnidTributavel^IBSR.faturamento.EmissaoNFe(CPRO,QPNF,CNOP)
 If oArrPTrib.Count()>0 {
	 Set QTRIB=oArrPTrib.GetAt("QTRIB")
	 Set UTRIB=oArrPTrib.GetAt("UTRIB")
	 Set VTRIB=$J(((VUNF*QPNF)/QTRIB/100),0,10)
	 Set R=^IFNFS(CDEE,DFAT,NONF,0,ITNF)
	 Set $Piece(R,"|",178)=QTRIB
	 Set $Piece(R,"|",179)=UTRIB
	 Set $Piece(R,"|",180)=VTRIB
	 Set ^IFNFS(CDEE,DFAT,NONF,0,ITNF)=R
 }
 ;
 ;</Aud - GDTI 3267 DU-E>
 ;
 ;<Aud - Projeto NT 2016/02 NFe 4.00>
 ; Monta os valores para o imposto FCP capturados pela NFe emitida
 ; se a base ja estiver operando com a versão 4.00 do xml SEFAZ
 If $$aplicaVersao400^IBSR.faturamento.EmissaoNFe(CDEE) {
	;
	Set oArrICMSTRet=##class(%ArrayOfDataTypes).%New()
	Set oArrParamEnt=##class(%ArrayOfDataTypes).%New()
	;
	Do oArrParamEnt.SetAt(CCLI,"CCLI")
	Do oArrParamEnt.SetAt(CNOP,"CNOP")
 	Do oArrParamEnt.SetAt(CUFE,"CUFE")
	Do oArrParamEnt.SetAt(IPCF,"IPCF")
	Do oArrParamEnt.SetAt(NPED,"NPED")
	;
	Set (AISR,BISR,VISR,AISD,BISD,VISD,ACST,VIPS)=""
	If $$possuiICMSSTRet^IFFAFA4J(CDEE,DFAT,NONF,ITNF,.oArrParamEnt,.oArrICMSTRet) {
		Set BISR=oArrICMSTRet.GetAt("vBCICMSSTRet")
		Set VISR=oArrICMSTRet.GetAt("vICMSSTRet")
		Set AISR=oArrICMSTRet.GetAt("pICMSSTRet")
		Set BISD=oArrICMSTRet.GetAt("vBCICMSSTDest")
		Set VISD=oArrICMSTRet.GetAt("vICMSSTDest")
		Set AISD=oArrICMSTRet.GetAt("pICMSSTDest")
		Set ACST=oArrICMSTRet.GetAt("pICMSSTCalc")
		Set VIPS=oArrICMSTRet.GetAt("vICMSPropioSubs")
	}
	Set (APIC,BPIC,VPIC,APST,BPST,VPST,APSR,BPSR,VPSR)=""
	If $D(^IFTFA(CDEE,$J,NPED,0,ITPE,1))#10 {
		Set X=^IFTFA(CDEE,$J,NPED,0,ITPE,1)
		Set APIC=$Piece(X,"|",1),BPIC=$Piece(X,"|",2),VPIC=$Piece(X,"|",3)
		Set APST=$Piece(X,"|",4),BPST=$Piece(X,"|",5),VPST=$Piece(X,"|",6)
		Set APSR=$Piece(X,"|",7),BPSR=$Piece(X,"|",8),VPSR=$Piece(X,"|",9)
		;
	 	; Recupera a base do FCP do ICMS ST Retido
	 	If ($Extract(CSTR,2,3)="60")&&(BISD>0) {
		 	Set BPSR=BISD
		 	Set VPSR=$J(BPSR*APSR/100,0,0)
	 	}
		;
		; Totais do FCP do ICMS
 		If +APIC Set TVCPIC=TVCPIC+VPIC
 		If +APST Set TVCPST=TVCPST+VPST
 		If +APSR Set TVCPSR=TVCPSR+VPSR
	 }
	 ; 
	 Set RIMP=APIC_"|"_BPIC_"|"_VPIC
	 Set RIMP=RIMP_"|"_APST_"|"_BPST_"|"_VPST
	 Set RIMP=RIMP_"|"_APSR_"|"_BPSR_"|"_VPSR
	 Set RIMP=RIMP_"|"_AISR_"|"_BISR_"|"_VISR
	 Set RIMP=RIMP_"|"_AISD_"|"_BISD_"|"_VISD
	 Set $Piece(RIMP,"|",16)=$J(ACST,0,0),$Piece(RIMP,"|",17)=VIPS
	 Set $Piece(RIMP,"|",18)=$J(AIEF,0,0),$Piece(RIMP,"|",19)=VBIE,$Piece(RIMP,"|",20)=VIEF
	 Set $Piece(RIMP,"|",21)=$J(ARBI,0,0)
 	 Set $Piece(RIMP,"|",22)=CBFT,$Piece(RIMP,"|",23)=CRCD,$Piece(RIMP,"|",24)=VIDE
 	 Set $Piece(RIMP,"|",25)=MOTD,$Piece(RIMP,"|",26)=AIOP
 	 ;
	 Set ^IFNFS(CDEE,DFAT,NONF,0,ITNF,1)=RIMP
 }
 ;
 ;</Aud - Projeto NT 2016/02 - NFe 4.0>
 ; 
 If (CDOP=91) {
	 If (NDAR="") {
		 ;Se é NFFCO e não teve provisão, grava pendência de provisão
		 Set ^IFIPP(CDEE,CPRO,DFAT,NONF,ITNF)=""
	 }
	 Else  {
	 	S R2=DFAT_"|"_NDAR_"|"_ITAR
	 	S ^IFNFS(CDEE,DFAT,NONF,0,ITNF,2)=R2
	 }
 }
 ElseIf $Get(bEFatEmTerceiros)&&(NDAR'="") {
		;Se é faturamento em terceiros e gerou retorno de armazenagem...
		S R2=DFAT_"|||"_NDAR
		S ^IFNFS(CDEE,DFAT,NONF,0,ITNF,2)=R2
 }
 ;
 ;<Amauri - ALM 53984 - Projeto ELO - GAP FAT10>
 ; Grava as informações necessárias para compor o EDI que deverã ser entregue
 ; para os clientes que exigem xml no padrao ANFAVEA
 ;If CPEC'="" {
 If (CPEC'="")||(NPEC'="") {
	 Set ^IFNFS(CDEE,DFAT,NONF,0,ITNF,4)=CPEC_"|"_NPEC_"|"_DPCL_"|"_ICPC
 }
 ;
 I CUFE?1"MT",$E(CNOP)?1"6",CLPR=2,CTOP="02" D ATT // Tarefa 0060AA81 ASSIS 02.07.15
 ;
 K R,D
 ;* * * A T E N Ç Ã O : Não incluir execução de módulos ou subrotinas antes 
 ;de armazenar o registro R na IFNFS para evitar a perda deste registro * * *
 ;
 I $D(^IBEFO(CCLI,CNOP,CPRO)) S X=^IBEFO(CCLI,CNOP,CPRO),NPFO=$P(X,"|",2),PECF=$P(X,"|",3),CDIT=$P(X,"|",4),INIC=$P(X,"|",5),^IFNFS(CDEE,DFAT,NONF,10,CPRO)=NPFO_"|"_PECF_"|"_CDIT_"|"_INIC  ;; @@@
 ;
 I CPRO'?1"" S ^IFNCP(CCLI,CPRO,CDEE,NONF)=DFAT_"|"_IPCF_"|"_PRAZ_"|"_CTRA_"|"_CNOP_"|"_IPIN_"|"_QPNF_"|"_ITNF 
 ;OBS: NFs marcadas com IPIN a partir de dezembro/2002 - Eliana
 ;
 ;Documento de referencia - SPED
 ;Simples Remessa OU remessa por conta e ordem
 I (CTOP="03")&&((CDOP=61)||(CDOP=92))&&(DDRF'="") S ^IFNFS(CDEE,DFAT,NONF,8,ITNF)=DDRF_"|"_DNOR_"|"_NDRF_"|"_ITRF,^IFREF(DDRF,DNOR,NDRF,ITRF,CDEE,DFAT,NONF,ITNF)=QPNF
 ;Faturamento Antecipado ou faturamento por conta e ordem
 I (CTOP="01")&&((CDOP=55)||(CDOP=91)) S ^IFREF(CDEE,DFAT,NONF,ITNF)=QPNF
 ;
 I CTOP'?1"01" S (VALP,NPAR,PZCB,PRAZ)="" G GRI3 ;Incluido por Eliana em 24/09/2010 para não gerar Boleto para operações diferentes de Venda
 S PRAZ1="" 
GRI1 S PRAZ1=$O(^IFCFA(NPRF,0,5,PRAZ1)) I PRAZ1?1"" G GRI2 
 K ^IFCFA(NPRF,0,5,PRAZ1,ITNF) 
 G GRI1 
 ;
GRI2 ;Define numero de parcelas e valores
 ; testa prazo de cobranca
 S PRAZT=PRAZ 
 I $D(PZCB)&(PZCB>0) S PRAZT=PZCB 
 S NPAR=$L(PRAZT)-$L($TR(PRAZT,"/",""))+1 
 S VAL=(VMER+VIPI+VIRI+VIVI+VEFI+VBOM+VTTB+SIPR+SIFR+VDAI-PEFI-VDEI) 
 S VALP=VAL,XVDIR=VDIR,XVDCS=VDCS,XVDCF=VDCF,XVDPI=VDPI 
 I NPAR'=0 S VALP=VAL\NPAR,XVDIR=VDIR\NPAR,XVDCS=VDCS\NPAR,XVDCF=VDCF\NPAR,XVDPI=VDPI\NPAR,RESI=VAL#NPAR,RESI1=VDIR#NPAR,RESI2=VDCS#NPAR,RESI3=VDCF#NPAR,RESI4=VDPI#NPAR 
 F I=1:1 S PRAZ1=$P(PRAZT,"/",I) G GRI3:(PRAZ1?1"") S X=$G(^IFCFA(NPRF,0,5,PRAZ1,ITNF)),$P(X,"|",1)=$P(X,"|",1)+$S(I=1:(VALP+RESI),1:VALP),$P(X,"|",2)=$P(X,"|",2)+$S(I=1:(XVDIR+RESI1),1:XVDIR),$P(X,"|",3)=$P(X,"|",3)+$S(I=1:(XVDCS+RESI2),1:XVDCS),$P(X,"|",4)=$P(X,"|",4)+$S(I=1:(XVDCF+RESI3),1:XVDCF),$P(X,"|",5)=$P(X,"|",5)+$S(I=1:(XVDPI+RESI4),1:XVDPI),^IFCFA(NPRF,0,5,PRAZ1,ITNF)=X 
 ;
GRI3 I CTRA'?1"" D ART
 D TRPIM^IBSRDF(CTRA,.CVTR) ;Obtendo Modal do Transportador
 I CTRA'?1"","01/02"[CTOP D CCT 
 S CTOP=$E(CNOS,1,2),CDOP=$E(CNOS,5,6)
 ;GRAVA Controle de Faturamento Antecipado / Remessa (Nota Fiscal) / acerto do CDOP=91 PARA TRATAR A VENDA DSO MLOLIVEIRA RDS1598952
 I (("03/13/23"[CTOP)&&((CDOP=61)||(CDOP=92)))||(("01/11/21"[CTOP)&&((CDOP=55)||(CDOP=91))) D GCF^IBSRVF 
 I CDOP?1"67" D CON 
 I CDOP?1"69" S TNFC=1 D:IFET'=1 GIE 
 D VER^IBSREP                   ; Verifica Empenho Cia
 I WPF1=1 S WPF1=0 G GRI4 
 I CTOP?1"69" G GRI4 
 S TNFC=3,TPTS="V" 
 D EMP^IBSREP                   ; Trata Empenho Cia
GRI4 I CTOP?1"01",IFET=1,$D(^IETEC(CCLI,CPRO)) S TNFC=3 D GIE G GRIZ 
 I CTOP?1"01",$D(^IETEC(CCLI,CPRO)) S TNFC=5 D GIE 
GRIZ K NPRO,EMBA,IAPR,PADL,IFET,NPAR,VAL,VALP,VDIR,XVDIR,VDCS,XVDCS,VDCF,XVDCF,VDPI,XVDPI,PRAZ1,RESI,RESI1,RESI2,RESI3,RESI4,PRAZT Q  
 ;
RDC ; Recupera Desconto Comercial
 ;    GDTI 3262 - TAREFA 84458/ENTREGA 97428 - DSD - RECÁLCULO DESCONTO COMERCIAL
 ;
 S IRDC=1 I $G(IFAV)=1 S IRDC=0 ; <flcarvalho - GDTI-4701 - Tarefa-112791 - Faturamento antecipado Vendor - 2019/08>
 ;
 N CDEV
 D ^IBSRVP
 I CDEV D RDP^IBSR.preco.RecuperaDescComercial(CDEE,NPED,ITPE,"","",.VUDC) I 1
 ;E  D RDT^IBSR.preco.RecuperaDescComercial(CCLI,CPRO,CDEE,DFAT,.VUDC)
 E  D RDT^IBSR.preco.RecuperaDescComercial(CCLI,CPRO,CDEE,DFAT,.VUDC,,IRDC)  ; <flcarvalho - GDTI-4701 - Tarefa-112791 - Faturamento antecipado Vendor - 2019/08>
 ; 
RDCZ Q
 ;
TOP ;Trata Percentuais de IR/CSLL/COFINS/PIS p/ Orgaos Publicos
 S (VDIR,VDCS,VDCF,VDPI,VATOT,VATP)=0 
 S VATP=VMER+VIPI+VIRI+VDAI+VEFI+VBOM+VTTB+SIPR+SIFR-PEFI-VDEI 
 S PRO2=$E(CPRO,1,2)   ;2 primeiras posicoes de CPRO
 ;
 I DFAT>60019 G TOP1  ;Em 28/04/2005 Gasolina e Diesel 1.24% - corrigido em 01/07/2005 - Lili
 I DFAT>59901 G TOP2  ;A partir de 01/01/2005
 ;
 ;Alcool
 I "10,13"'[PRO2 G TOP1 
 I DFAT>60019 G TOP2 ;Alcool - Total 4.89
 S VDIR=$J(((VATP*0.24)/100),0,0) 
 S VDCS=$J(((VATP*1.0)/100),0,0) 
 S VDCF=$J(((VATP*6.74)/100),0,0) 
 S VATOT=$J(((VATP*9.44)/100),0,0) 
 S VDPI=VATOT-(VDIR+VDCS+VDCF) 
 G TOPZ 
 ;
TOP1 ;Gasolina / Oleo Diesel 
 I "11,15"'[PRO2 G TOP2 
 S VDIR=$J(((VATP*0.24)/100),0,0) 
 S VATOT=$J(((VATP*1.24)/100),0,0) 
 S VDCS=VATOT-VDIR 
 G TOPZ 
 ;
TOP2 ;Outros 
 S VDIR=$J(((VATP*0.24)/100),0,0) 
 S VDCS=$J(((VATP*1.0)/100),0,0) 
 S VDCF=$J(((VATP*3.0)/100),0,0) 
 S VATOT=$J(((VATP*4.89)/100),0,0) 
 S VDPI=VATOT-(VDIR+VDCS+VDCF) 
 ;
TOPZ Q  
 ;
CDR ;Calcula Desconto Real de combustivel
 N R 
 N VUNI,VUFD,VDPC,VPSD,EFPP,UNPR,UNFR,PBAN,BORE,BOCL,VDDB,IRIP,BIRP 
 N CIPI,CLPR,IPRT,ACDEE 
 N VBCR,VBIC,VICM,VICR,VBIV,VIVV 
 N AVUNF,AVMER,AVBCI,AVBRI,AVICI,AVIRI,AAIRE 
 N AVDBC,AAIVV,AVBII,AVIVI,ACIIV,AVMVC 
 N X,TPRO,VITN,VITND 
 N MARU,PURE,CURE,ICMP,VPDP,VCDP,VPRP,VCRP,IPIS,ICOF,SUPJ,VDUF
 S CIPI=5,CLPR=1,TPRO=0,IPRT=2,ACDEE=CDEE 
 S (VBCR,VBIC,VICM,VICR,VBIV,VIVV)="" 
 S X=(+VIRI+VIVI)/QPNF,VITND=$J(VUNF+X,0,2) 
 S AVUNF=VUNF,AVMER=VMER,AVMVC=VMVC 
 S AVBCI=VBCI,AVBRI=VBRI,AVICI=VICI,AVIRI=VIRI,AAIRE=AIRE,AVDBC=VDBC 
 S AAIVV=AIVV,AVBII=VBII,AVIVI=VIVI,ACIIV=CIIV 
 S X=^IFPED(CDEE,NPED),ICCR=$P(X,"|",16),DTRE=$P(X,"|",29)
 S ACDEE=CDEE,DURV=DFAT,PUDE=1,VDPC="" 
 S CMUE=$P(RDG,"|",7),TPCC=$S($L(CCLI)=14:1,1:3) 
 I $D(^IFPCP(CDEE,DTRE,NPED,ITPE)) D AMF^IBSRMP1(CDEE,NPED,ITPE,.MDCLAPL) ; TAREFA 004A6C45 - DSD - 04/12
 K TICF S QTDVE=QPNF D ^IBSRPU S VUNF=VUNI,PUDE=0 K MDCLAPL 
 I ($G(IFAV)=1) S MRGV=$G(MDCLTES) K MDCLTES ; <flcarvalho - GDTI-4701 - Tarefa-112791 - Vendor - 2019/12>
 S VMER=$J(VUNF*QPNF,0,0)
 D ^IBSRCI
 S X=^IBCLI(CCLI,1),CMUE=$P(X,"|",4) 
 S X=^IBCLI(CCLI,2),NTJU=$P(X,"|",24) 
 D ^IBSRIV 
 S X=(+VIRI+VIVI)/QPNF,VITN=$J(VUNF+X,0,2) 
 S VDRC=$J(VITN-VITND,0,2) 
 S VUNF=AVUNF,VMER=AVMER,VMVC=AVMVC 
 S VBCI=AVBCI,VBRI=AVBRI,VICI=AVICI,VIRI=AVIRI,AIRE=AAIRE,VDBC=AVDBC 
 S AIVV=AAIVV,VBII=AVBII,VIVI=AVIVI,CIIV=ACIIV 
 S X=^IFTFA(CDEE,$J,NPED,0,ITPE),ICMC=$P(X,"|",51),ICPP=$P(X,"|",52) 
CDRZ Q  
 ;
CON ;Trata Notas de Consignacao
 I CTOP?1"01" G CON1 
 I CTOP'?1"03" G CONZ 
 ;Nota de simples remessa
 S XVICI=VICI+SIPR+SIFR 
 K ^IECON(CCLI,CPRO,0,CDEE,NPED,ITPE) 
 S ^IECON(CCLI,CPRO,1,CDEE,DFAT,NONF)=QPNF_"|"_VMER_"|"_VIRI_"|"_XVICI_"|"_VUNF,TNFC=1 
 G CON2 
CON1 ;Nota de venda
 S XVICI=VICI+SIPR+SIFR 
 S ^IECON(CCLI,CPRO,2,NFSC,CDEE,DFAT,NONF)=QPNF_"|"_VMER_"|"_VIRI_"|"_XVICI_"|"_VUNF,TNFC=2 
CON2 D GIC 
CONZ Q  
 ;
GIC ;GRAVA INTERFACE CONSIGNACAO
 I 1 L +(^IEICO(CDEE)) 
 I $D(^IEICO(CDEE,DFAT)) S USEQ=^IEICO(CDEE,DFAT) 
 E  S USEQ=0 
 S NSEQ=USEQ+1,USEQ=NSEQ,D="|" 
 S X=^IECON(CCLI),DACT=$P(X,"|",2),DTER=$P(X,"|",3),DICO=$P(X,"|",4) 
 S X=^IECON(CCLI,CPRO),QECO=$P(X,"|",1),VMCO=$P(X,"|",2),QRES=$P(X,"|",3) 
 S TPRG=1,^IEICO(CDEE,DFAT,NSEQ)=TPRG_D_CCLI_D_CPRO_D_QECO_D_DACT_D_DTER_D_DICO_D_VMCO_D_QRES 
 S TPRG=2,X=TPRG_D_CCLI_D_CPRO_D_D_D_D_D_D_D_TNFC_D_CDEE_D_DFAT_D_NONF_D_QPNF_D_VMER_D_VIRI_D_XVICI_D_VUNF_D_NFSC 
 S NSEQ=NSEQ+1,^IEICO(CDEE,DFAT,NSEQ)=X,USEQ=NSEQ 
 S ^IEICO(CDEE,DFAT)=USEQ 
 I 1 L -(^IEICO(CDEE)) 
 K QECO,DACT,DTER,DICO,VMCO,TNFC,TPRG 
GICZ Q  
 ;
GIE ;GRAVA INTERFACE EST. TEC.
 S TPTR=$S(TNFC=1:"R",TNFC=3:"V",TNFC=5:"O",1:"") 
 I TPTR="" G GIEZ 
 D ^IBSRET 
GIEZ Q  
 ;
AIT ;ATUALIZA ITEM DO PEDIDO
 ;CDEP defina para gerar o histórico do pedido
 N XCPRO,CDEP,VUNP
 S XCPRO=CPRO,CDEP=CDEE
 ;
 S SPED=4 
 S X=^IFPED(CDEE,NPED,0,ITPE)
 S $P(X,"|",6)=VFRU,$P(X,"|",13)=SPED,$P(X,"|",18)=NONF,$P(X,"|",19)=ITNF,$P(X,"|",27)=DFAT
 S $P(X,"|",120)=VUDC ; GDTI 3262 - TAREFA 84458/ENTREGA 97428 - DSD - 11/2018 - RECALCULO DESC.COMERCIAL
 S VUNP=$P(X,"|",4)
 S ^IFPED(CDEE,NPED,0,ITPE)=X
 ;
 ; TAREFA - 57904 Sergio Freesz
 S HIPE=50 D ^IBSRHP
 I XNOCA'?1"" S ^IFOCR(CDEE,XNOCA,1,NONF,ITNF)="",FEET=1
 I NORT'?1"" S ^IFORT(CDEE,NORT,1,NONF,ITNF)=NPED_"|"_ITPE,FEET=1
 ;
 ;Projeto AXIODIS / Roteirizador - Elimina ^IFPRT
 I $D(^IFPRT(CDEE,NPED,ITPE)) K ^IFPRT(CDEE,NPED,ITPE)
 ; 
 /*
 ; LINHA SOB RESPONSABILIDADE DE MLUDWIG - INIBIDO TEMPORARIAMENTE EM 23/05/12 - DSD 
 I NORT'?1"" S ^IFORT(CDEE,NORT,1,NONF,ITNF)=NPED_"|"_ITPE S FLG="" D VSC I FLG S FEET=1
 */
 S NTAN="" I XNOCA?1"" G AIT1 
 D COM^IBSRCM I PROUTIL'?1"" S XCPRO=PROUTIL ;Recupera produto comum para o Marcado
 ;Recupera produto comum para o Aditivado
 I CPRO=15050009 S XCPRO=15010007 
 I "15060005/15060009"[CPRO S XCPRO=15060004 
 I "15061801/15061804"[CPRO S XCPRO=15061802 
 I "15660001/15660003"[CPRO S XCPRO=15660000  ;DMA ISO - Diesel Maritimo Importado (TAREFA 0063E1B9 - DSD)
 I CPRO=15090001 S XCPRO=15080001 
 I CPRO=15140001 S XCPRO=15140000 
 I "15150001/15150003/15180001/15180003/15200001/15200003/15220001/15220003/15700001/15700011"[CPRO S XCPRO=15150000 
 I "15160001/15160003/15190001/15190003/15210001/15210003/15230001/15230003/15710001/15710011/15730001/15740001/15750001"[CPRO S XCPRO=15160000
 I "15240001/15240003/15260001/15260003/15270001/15270003/15720001/15720011"[CPRO S XCPRO=15250000 ; 1527 - Tarefa 007CA116
 I "15310001/15310003/15310012/15310014/15310017"[CPRO S XCPRO=15300000 ; TAREFA 0046E766 - DSD - 11/2012
 I "15330001/15330003"[CPRO S XCPRO=15320000 ; TAREFA 006DBDD3 - DSD - 12/2013
 S X=$G(^IFOCR(CDEE,XNOCA,0,XCPRO)),NTAN=$P(X,"|",1) 
AIT1 ;Atualiza ordem de carregamento ferrobasi
 I "0545/6545"'[CDEE!(CTOP'?1"01"&(CNOS'="030261")) G AITZ 
 N XNOCA 
 S XNOCA="" 
AIT2 S XNOCA=$O(^IFOCP(CDEE,NPED,XNOCA)) I XNOCA?1"" G AITZ 
 I $D(^IFOCR(CDEE,XNOCA,1)) G AIT2 
 I '$D(^IFOCR(CDEE,XNOCA,2,NPED)) G AIT2 
 S ^IFOCR(CDEE,XNOCA,1,NONF,ITNF)="" 
 G AIT2 
AITZ K SPED,PROUTIL Q  
 ;
GDC ;GRAVA DADOS DO CARREGAMENTO
 S IADC=$P(RIT,"|",17) 
 I IADC'=3 G GDCZ 
 S ^IFNFS(CDEE,DFAT,NONF,3,ITNF)=QAMC_"|"_Q20C_"|"_TAMB_"|"_DVNT 
GDCZ Q  
 ;
GDT ;GRAVA DADOS DO TRANSPORTADOR
 I CVTR'=1 G GDTZ 
 I 'EEMB G GDTZ 
 S QCCA=QPNF 
 S ^IFCAC(CDEE,DFAT,CTRA,CCAM,VIAG,CPRO,NONF)=QCCA_"" 
 K QCCA 
GDTZ Q  
 ;
INV ;AT INVERT DO ITEM
 S X=^IFPFA(CDEE,NPED),XCCAM=$P(X,"|",1),DSAI=$P(X,"|",2),VIAG=$P(X,"|",3) 
 K ^IFPPR(CDEE,CPRO,NPED,ITPE) 
 S XDSAI=$S(DSAI?1"99999":DFAT,1:DSAI) 
 K ^IFPDE(CDEE,XDSAI,NPED,ITPE) 
 K ^IFPPF(CDEE,DSAI,VIAG,XCCAM,NPED,ITPE) 
 S ^IFPFD(CDEE,DFAT,NPED,ITPE)="" 
 S IPDG=$P(RIT,"|",5) 
 I IPDG S ^IFNPD(CDEE,DFAT,NONF,ITNF)="" 
 S X=^IFCOF,IALT=$P(X,"|",1) 
 I IALT&($D(^IFPAL(CPRO))) I "010101/010103/010104/010155/010201/010203/010204/010205/010206/010255/010301"[CNOS&(IPRT=2) S ^IFNFA(CDEE,DFAT,NONF)="" 
 S DD=$E(CFOR,2,5) 
INVZ K XDSAI,IPDG,IALT,RPRO Q  
 ;
ART ;Armazena Transito
 S SVBOM=VBOM 
 S X=^IFPED(CDEE,NPED),ILPF=$P(X,"|",14),ICCR=$P(X,"|",16),USRT=$P(X,"|",17) 
 S CDRF=$E(CFOR,2,5)
 I ILPF?1"D",CTOP="01" S:CDRF="" CDRF=CDEE S:'$D(^IBDEP(CDRF)) CDRF=CDEE 
 ; Iremos enviar para o BI a informacao do volume do frete
 I ILPF?1"D",CDRF?1"" G ARTZ 
 D TRANS^IBSRDF(CTRA,.TPST),TRPIM^IBSRDF(CTRA,.CVTR) 
 I CVTR?1"2",TPST=0,CDRF'?1"",$D(^IRTTF(CDEE,CDRF)) S X=^IRTTF(CDEE,CDRF),CDRF=$P(X,"|",1),ILPF="T" I '$D(^IBDEP(CDRF)) G ARTZ 
 I ILPF?1"D",'$D(^IBDEP(CDRF)) G ARTZ
 I (CDOP=55)||(CDOP=91) G ARTZ
 ; Notas de faturamento antecipado nao geram lancamento de frete
 I ILPF'?1"D"!(CDRF?1"") S CDRF=CDEE 
 S XQPNF=QPNF 
 S X=$G(^IFPED(CDEE,NPED,0,ITPE)) I X?1"" G ART1 
 S YQPNF="" 
 S X=^IFPED(CDEE,NPED,0,ITPE) 
 F I=47:1:56 S AL=$P(X,"|",I),Q=$P(AL,";",2),YQPNF=YQPNF+Q 
 I YQPNF'?1"",CVTR=1 S XQPNF=YQPNF 
ART1 S CARG=$$H^sistema.DOLLAR_","_USRT 
 I CPRO?1"" S XXCPRO="00000000",TCTR=2,(VCAR,PBLC,VTXB,XVBOM)=0 G ART2 
 S NPRO="",EMBA="",XXCPRO=CPRO 
 S X=^IBPRO(XXCPRO),CEMB=$P(X,"|",4),PBRU=$P(X,"|",9) 
 ;
 I 'DFAB,'EEMB D RPB ;Recupera Peso Bruto e Líquido
 ;
 S X=^IBEMB(CEMB),EEMB=$P(X,"|",3),TCTR=$S(EEMB=0:1,1:2) 
 S PBLC=$J(PBRU*XQPNF,0,2) 
 I +ICCR=0 S VBOM=(VTXB*XQPNF)\1 
 S VOUT=0 
 D CVI^IBSRIF 
 ;
ART2 ;GERA ARQUIVO DE FRETE
 D TRANS^IBSRDF(CTRA,.TPST)
 I TPST=2 S (VFUT,VTXB,VCAR,VBOM,VIFR,VFRP,VBIF,VFAR,VDFN,VDFP)="",IPAF="N",VPED=0
 S VFAR="",VPED=0
 ;
 ;Obtem Taxa Balsa (Vide FRT/CB/VB)
 I CVTR=4
 {
 	;Obtem Taxa p/ transportador.................(Vide FRT/CB/VB)
 	I $D(CTRA),$D(^IRVTB(1,CDEE,CTRA))
 	{
	 	S XDIVG="",XDIVG=$ZP(^IRVTB(1,CDEE,CTRA,XDIVG))
	 	I XDIVG'?1"" S X=$G(^IRVTB(1,CDEE,CTRA,XDIVG)) S:X'?1"" VTTB=$P(X,"|",2)
 	} 
 
 	;Obtem Taxa p/ transportador x Cliente.......(Vide FRT/CB/VB)
 	I $D(CTRA),$D(^IRVTB(2,CDEE,CTRA,CCLI))
 	{
	 	S XDIVG="",XDIVG=$ZP(^IRVTB(2,CDEE,CTRA,CCLI,XDIVG))
	 	I XDIVG'?1"" S X=$G(^IRVTB(2,CDEE,CTRA,CCLI,XDIVG)) S:X'?1"" VTTB=$P(X,"|",2)
 	}
 }
 S X=XXCPRO_"|"_NPRO_"|"_EMBA_"|"_TCTR_"|"_XQPNF_"|"_PBLC_"|"_VFUT_"|"_VCAR_"|"_VTXB_"|"_VBOM_"|"_VBIF_"|"_VIFR_"|"_VOUT_"|"_VFRP_"|"_CARG_"|"_VACP_"|"_VPED_"|"_VFAR_"|"_VDFN_"|"_VDFP 
 ;
 ;Gravando Vlr Taxa Balsa
 I $D(VTTB) S $P(X,"|",25)=VTTB
 ;TODO ALX Remover depois da implantação do Elo
 
 ;Ricardo Mendonça - 15/03/2018 - GDTI 2787
 S $P(X,"|",28)=$G(COUP),$P(X,"|",29)=$G(IDTE)
 ;
 ; < daviz && matheusrc - ALM 113106 - Recuperando valores de acréscimo/desconto >
 S $P(X,"|",30)=$G(VDCR) ; Valor de decréscimo para o pagamento ao transportador por conta de repasse.
 S $P(X,"|",31)=$G(VACR) ; Valor de acréscimo para o pagamento ao transportador por conta de repasse.
 ;
 S ^IRFRT(CDRF,CDEE,151,1,NONF,ITNF)=X 
 S ^IRIFR(CDEE,DFAT,1,CDRF,CDEE,151,1,NONF,ITNF)=DFAT_"|"_CARG
 ;
 I $D(^ITCTR(CTRA)) 
 {
	 S ^ITLFR(CDRF,CDEE,DFAT,151,1,NONF,ITNF)=X
	 S ZWREG=X,ZWCDEE=CDRF,ZWCDEN=CDEE,ZWDATA=DFAT,ZWTDOC=151,ZWNIVE=1,ZWNDOC=NONF,ZWITNF=ITNF,ZWALT="INC",ZWROT="ART2+5^IFFAFA4D" D LFI ;;;ALT TROP
 }
 I IPAF="S",+(VCAR+VBOM)=0 S ^IRNSF(CDRF,CDEE,DFAT,151,NONF,XXCPRO)="" 
ARTZ S VBOM=SVBOM 
 K X,AL,Q,XQPNF,YQPNF,XXCPRO,CARG,USRT,VTXB,SVBOM Q  
 ;
CCT ;Controle Cota Transporte
 N CDED,CDEN,DATA,DEMI,QTNF 
 S CDED=$E(CFOR,2,5),CDEN=CDEE,DATA=DFAT,DEMI=DFAT,QTNF=QPNF 
 D ^IBSRTC 
CCTZ Q  
 ;
ITR ;ICMS Substituicao Refinaria para Transferencia e Venda
 S ICIR="" ;Consumidor com ICMS do Revendedor COSURE
 S X=^IFPED(CDEE,NPED),IPCF=$P(X,"|",15),ILPF=$P(X,"|",14) 
 S X=^IBPRO(CPRO),TPRO=$P(X,"|",21) 
 S X=^IFTFA(CDEE,$J,NPED,0,ITPE),BIRP=$P(X,"|",68),IRIP=$P(X,"|",61),AIRP=$P(X,"|",62),BORE=$P(X,"|",59) 
 S (PBRE,PREF,IRPR,IDPR)="" 
 I CTOP'="01",CTOP'="02","030261/030267/030269"'[CNOS G ITRZ 
 I CPRO?1"" G ITRZ 
 S COMB=$E(CPRO,1,2) 
 I "11/14/15/16/17/19"'[COMB G ITRZ 
 S UF=CUFD,DURV=DFAT D ^IBSRSR ;Subst Refinaria Estado Origem
 S DIPSR=IPSR D ^IBSRCS ;Consumidor com ICMS do Revendedor COSURE
 I 'IPSR G ITRZ 
 S UF=CUFE,DURV=DFAT D ^IBSRSR ;Subst Refinaria Estado Destino
 I 'IPSR G ITRZ 
 S DVIG=DFAT 
 D ^IBSRTP 
 ; *** TAREFA ALM-40243 - DSD - 03/2017 ****************************************************************
 ;TODO ALX Remover depois da implantação do Elo
 If $$$Ambiente=$$$AmbienteProducao {
	 I CTOP="02" D
	 .;D I02^IBSRAI(CUFE,TIPP,DFAT,.REG02)
	 .;D I11^IBSRAI(CUFE,TIPP,DFAT,.REG11)
	 .;S REG=REG02 I CUFE'=CUFD,REG11'?1"" S REG=REG11
	 .;S AIRP=$P(REG,"|",3)
	 I CTOP="02" S DVIG=$ZP(^ILIIC(2,CUFE,TIPP,DVIG+1)),REG=^ILIIC(2,CUFE,TIPP,DVIG),AIRP=$P(REG,"|",3) 
 }
 Else  {
	 I CTOP="02" D
	 .D I02^IBSRAI(CUFE,TIPP,DFAT,.REG02)
	 .D I11^IBSRAI(CUFE,TIPP,DFAT,.REG11)
	 .S REG=REG02 I CUFE'=CUFD,REG11'?1"" S REG=REG11
	 .S AIRP=$P(REG,"|",3)
	 ;I CTOP="02" S DVIG=$ZP(^ILIIC(2,CUFE,TIPP,DVIG+1)),REG=^ILIIC(2,CUFE,TIPP,DVIG),AIRP=$P(REG,"|",3) 
 }
 ; *****************************************************************************************************
 S X=^IBDEP(CDEE),CCLID=$P(X,"|",37)
 S X=^IBCLI(CCLID,1),CMUN=$P(X,"|",4) 
 S ACDEE=CDEE,DURV=DFAT 
 D ^IBSRCL 
 S TICF="",CPROORI=CPRO D ^IBSRPB K TICF,CPROORI 
 I CUFD=CUFE G ITRZ 
 ;Revendedor e Transferencia
 I ($E(CNEG,1)="1"&("11250/12100"'[CNEG))!("11250/12100"[CNEG&'IPCF)!(CNEG="21000")!(CNEG=23101&('IPCF))!(CTOP="02") S IRIP=$J(BORE*AIRP/100,0,2),BIRP=BORE 
ITRZ Q  
 ;
VSC ; Verifica se caminhao/viagem/transportador esta carregado
  ;
  I CDEE'=6269 S FLG=1 G VSCZ
  N XNPED,XITPE,XQPED,TPQPED,XNONF,XITNF,TNQPED
  S XNPED="",TPQPED=0
VSC1 S XNPED=$O(^IFORT(CDEE,NORT,2,XNPED)) I XNPED="" G VSC3
  S XITPE=""
VSC2 S XITPE=$O(^IFORT(CDEE,NORT,2,XNPED,XITPE)) I XITPE="" G VSC1
 S X=$G(^IFORT(CDEE,NORT,2,XNPED,XITPE)),XQPED=$P(X,"|",2)
 S TPQPED=TPQPED+XQPED
 G VSC2
VSC3 S XNONF="",TNQPED=0
VSC4 S XNONF=$O(^IFORT(CDEE,NORT,1,XNONF)) I XNONF="" G VSC6
 S XITNF=""
VSC5 S XITNF=$O(^IFORT(CDEE,NORT,1,XNONF,XITNF)) I XITNF="" G VSC4
 S X=$G(^IFORT(CDEE,NORT,1,XNONF,XITNF)),XNPED=$P(X,"|",1),XITPE=$P(X,"|",2)
 S X=$G(^IFORT(CDEE,NORT,2,XNPED,XITPE)),XQPED=$P(X,"|",2)
 S TNQPED=TNQPED+XQPED
 G VSC5
VSC6 I TNQPED'<TPQPED S FLG=1
 ; verifica se a quantidade dasd notas foram geradas para satisfazer a quantidade
 ; dos itens de pedidos e serao enviados os arquivos para o transportador
VSCZ Q
 ; 
VDW	; Verifica Drawback - Isenção PIS/COFINS
 N DTNF
 S NUAC="",IZFM=""
 I '$D(CCLI)!('$D(CPRO)) G VDWZ
 I CCLI?1""!(CPRO?1"") G VDWZ
 S DTNF=DFAT
 D IPC^IBSRPC
 I NUAC'?1"" S IZFM=1
VDWZ Q
 ;
 ;<Aud GDTI 2920 - Recupeda dados dos compartimentos alocados na viagem
getDadosCompAloc(CDEE,DFAT,VIAG,NPED,ITPE) Public {
	;
	#Dim oViagAloc as cbpi.abadi.faturamento.ViagemAlocacao
	;
	Set dtSaida=##class(cbpi.abadi.datatype.DataMedidata).LogicalToCache(DFAT)
	;
	Set rDados=""
	Set RPED=^IFPED(CDEE,NPED,0,ITPE)
	Set CTRA=$Piece(RPED,"|",10)
	Set CCAM=$Piece(RPED,"|",11)
	Set oVeiculo=##class(cbpi.abadi.basico.veiculo.Veiculo).instanciar(CCAM)
	Set arrCompartVeic=##class(%ListOfObjects).%New()
	If $IsObject(oVeiculo) Set arrCompartVeic=oVeiculo.getCompartimentos()
	Set oViagem=""
	If $IsObject(oVeiculo) {
		Set oViagem=##class(cbpi.abadi.faturamento.Viagem).instanciar(CDEE,dtSaida,CTRA,oVeiculo,VIAG)
	}
	If '$IsObject(oViagem) Quit rDados
	;
	Set iterator=##class(cbpi.abadi.faturamento.ViagemAlocacao).iteratorViagem(oViagem)
	While (iterator.next()) {
		Set oViagemAloc=iterator.getInstance()
		Set NCOM=oViagemAloc.compartimento
		Set QALO=oViagemAloc.quantidade
		If ((oViagemAloc.pedido=NPED)&&(oViagemAloc.pedidoItem=ITPE)) {
			Set QLAC=0
			Set oCompart=arrCompartVeic.GetAt(NCOM)
			If $IsObject(oCompart) Set QLAC=oCompart.qtdLacre
			Set X=NCOM_";"_QALO_";"_QLAC
			Set rDados=rDados_X_"#"
		}
	}
	;
 Quit rDados
 }
 ;
LFI D LFI^IBSRBO Q
RPB D RPB^IBSRTV Q
ATT D ATT^IBSRLU Q  // Tarefa 0060AA81 ASSIS 02.07.15
VMD D VMD^IBSR.preco.MrgDependencia(CCLI,.ILMD) Q
RPV D RPV^IBSR.preco.MrgDependencia(CCLI,PROUTIL,DFAT,.IPRM) Q
 ;
]]></Routine>


<Routine name="IFPEAT0" type="MAC" languagemode="0" timestamp="65441,35433.27173"><![CDATA[
IFPEAT0 ;Atendimento a Cliente<V1.0-PNC-10/94> ; Oct 5 2004  2:23 PM ;ircÚltima Alteração   eliana 06/12/2017 23:51:39 ;Última Alteração   FLCARVALHO 03/03/2020 09:50:33
#Include sistema.BibliotecaMacro 
 ; 
FES ;FUNCOES ESTENDIDAS
 ;
 I CCLI?1"" S MS=142,CMS="deve",CMS1="informado" D ^GAP.GAREM $$$ReadT(X,4)  G FESZ 
 ;
FES1 K ^IBPF3(PART)
 S ^IBPF3(PART,"1-CCC")="Conta Corrente"
 S ^IBPF3(PART,"2-DVE")="Documentos Vencidos"
 I OPC?1""!(OPC=1) S ^IBPF3(PART,"3-CCL")="Retirada de Combustível Claro"
 I OPC?1""!(OPC=2) S ^IBPF3(PART,"4-CES")="Retirada de Combustível Escuro"
 S ^IBPF3(PART,"5-ATC")="Altera Telefone/Contato/E-mail/Insc.Estadual Cliente"
 I $D(iCPR) S ^IBPF3(PART,"9-PRD")="Seleciona Produtos Válidos" ; somente p/campos de leitura de produto (claro/escuro/embalado)
 ; 
 S X="IBPF3;"_PART_";R;C;1;;;FUNÇÕES ESTENDIDAS",%zPAR=X
 D ^IBSRMJ 
 I R?1"" G FESZ
 S RK=R,R=$P(R,"-",1)
 K ^IBPF3(PART)
 ; 
 I R=1 S CTCC=4 D CCC,RTE I 1 
 E  I R=2 S CTCC=4,DVENC=1 D CCC,RTE K DVENC I 1 
 E  I R=3 D TCC,RTE I 1 
 E  I R=4 D TCE,RTE I 1 
 E  I R=5 D MVC W /CUP(21,3),/ED(0) I 1
 E  I R=9 D PPR
 ;
 I RK'?1"9-PRD" G FES1
 ;
FESZ K NAO W /ICC20,/ICC13 Q  
 ;
CCC ;CONSULTA CONTA CORRENTE
 N XCCLI,CCLI1,NCLI,TLCR,VLCR,VSAL,TV,NDV,TBA,COR,XTT,XPG,XLP,J,HORA,PR,AMES,DOLA,MG,LCOB,CZVC,CZVQ,CDEC,DMSC,CD,DEF,FIM 
 N IFRC,ITPE,L,LC,LIN,NPED,PR,QPED,SCLI,SPED,T,TAV,VUNP,TVSAF,TVSAA,VFRU,VITP,AIPI,CMOR,IINF,VFCI,VMVC,VMAX,VDEP,VDPC,VPSD,EFPP 
 S (CCLI1,NCLI,TLCR,VLCR,VSAL,TV,NDV,TBA,COR,J,HORA,PR,AMES,DOLA,MG,LCOB,CZVC,CZVQ,CDEC,CD,DEF,FIM,IFRC,ITPE,L,LC,LIN,NPED,PR,QPED,SCLI,SPED,T,TAV,VUNP,VUNV,TVSAF,TVSAA,VFRU,VITP,AIPI,DMSC)="" 
 S DFAG="" ; <flcarvalho - GDTI-5608 - 2020/03>
 S DEV=0,XTT=1,XPG=0,XLP="20",XTP="23",MG=0,BCOL=80 
 S J=$J,HORA=$P($$H^sistema.DOLLAR,",",2) 
 S X=^IBCLI(CCLI,0),NCLI=$P(X,"|",6),SCLI=$P(X,"|",22) 
 S CCLI1=$E(CCLI,1,$L(CCLI)-2)_"01" 
 S X=^IBCLI(CCLI,0),CDEC=$P(X,"|",5) 
 S X=^IBCLI(CCLI1,0),TLCR=$P(X,"|",11),VLCR=$P(X,"|",12) 
 S X=^IBCLI(CCLI,2),CZVC=$P(X,"|",4),CZVQ=$P(X,"|",5) 
 ;S VSAL="0" I $D(^ICCOC(CCLI)) S X=^ICCOC(CCLI)_"",VSAL=$P(X,"|",1) 
 K IPEU D ^IBSRDB ; HPJ  TAREFA Nº0064AB6D
 K ^ICTCC(CDEE,J,HORA) S ^ICTCC(CDEE,J,HORA,CCLI)=NCLI_"|"_TLCR_"|"_VLCR_"|"_CDEC_"|"_CZVC_"|"_CZVQ_"|"_SCLI 
 S DAT=DFAT K %DI D DT^sistema.DOLLAR S %Z=$E(%Z+100,2,3),AMES=%Y_%Z 
 S X=^IBIND(AMES),DOLA=$P(X,"|",2),DOLA=(DOLA*100)\1 
 N CCLI S (CCLI)="" 
 D ARC 
 K ^ICTCC(CDEE,J,HORA) 
 K PR,FCCLI,CDEN,NDEN,TDEN,FDBA,VDEN,DEMI,DVEN,CDBA,TDBA,NDBA,VDBA,NALU,NFIN,NPED 
CCCZ Q  
 ;
ARC ;ACIONA ROTINA CONSULTA CONTA CORRENTE
 W /CUP(1,1),/ED(0) 
 D IMP^ICRECO2 
 I W'?1"PARE" W /ICC20,/RAW("==> ") $$$Read(X)  W /ICC20,/ICC13 
ARCZ Q  
 ;
RTE ;Remonta TEla
 I OPC?1"" D MTE,EDC G RTEZ 
 I "1/2"[OPC D MCE,EXI,EIC 
 I "3/4"[OPC D TGE,EXI,EXL,EDI
 I TEL=3 D MTA,EDA I 1 
 E  D TDG,RDG 
 D EDE 
RTEZ Q  
 ;
MCE ;Monta tela de produto claro/escuro (Opcao 1 e 2)
 W /CUP(1,1),/ICC28,/ED(0) 
 I OPC=1 W /CUP(1,2),/RAW("Pedido de Combustível Claro") 
 E  W /CUP(1,2),/RAW("Pedido de Combustível Escuro") 
 S NDEE=$E(NDEE,1,29) 
 W /CUP(1,40),/RAW($J(NDEE,29)_" - ") 
 S DAT=DFAT,%DI=0 D DT^sistema.DOLLAR 
 W /CUP(3,2),/RAW("Cliente: ["),/ICC29,/CUP(3,27),/ICC28,/RAW("]"),/ICC29 
 W /CUP(4,1),/ICC28,/RAW("Contato:"),/ICC29,/CUP(4,27),/ICC28,/RAW("Fone:"),/ICC29,/CUP(4,47),/ICC28,/RAW("ZV:"),/ICC29 
 W /CUP(5,1),/ICC28,/RAW("Limite:"),/ICC29,/CUP(5,47),/ICC28,/RAW("Saldo do Cliente:"),/ICC29 
 W /CUP(6,1),/ICC28,/RAW("Observações:"),/CUP(6,48),/RAW("Dt. Prev.Fat: ["),/ICC29,/CUP(6,72),/ICC28,/RAW("]") 
MCE1 W /CUP(7,3),/ICC29,/CUP(8,79),/ICC28 
 ; GDTI 3262 - TAREFA 84458 - DSD - 08/2018 - INCLUSÃO DE CAMPO P/DESC.COMERCIAL
 ;W /CUP(9,7),/ICC28,/RAW("Produto"),/CUP(9,27),/RAW("Qtde    Bomba      Frete        Preco Unit.    Prazo") 
 ;F I=41:1:45 W /CUP(I-31,1),/ICC28,/RAW("["),/ICC29,/CUP(I-31,20),/ICC28,/RAW("] ["),/ICC29,/CUP(I-31,32),/ICC28,/RAW("] ["),/ICC29,/CUP(I-31,38),/ICC28,/RAW("] ["),/ICC29,/CUP(I-31,54),/ICC28,/RAW("] ["),/ICC29,/CUP(I-31,70),/ICC28,/RAW("] ["),/ICC29,/CUP(I-31,78),/ICC28,/RAW("]") 
 ;W /CUP(15,14),/RAW("Pedido Externo -->   Numero: ["),/ICC29,/CUP(15,60),/ICC28,/RAW("]  Item: ["),/ICC29,/CUP(15,78),/ICC28,/RAW("]") 
 W /CUP(9,4),/ICC28,/RAW("Produto"),/CUP(9,19),/RAW("Qtde      Bomba    Frete       Pr.Unit.    Desc.Com.   Prz.")
 F I=41:1:45 W /CUP(I-31,1),/ICC28,/RAW("["),/ICC29,/CUP(I-31,12),/ICC28,/RAW("] ["),/ICC29,/CUP(I-31,26),/ICC28,/RAW("] ["),/ICC29,/CUP(I-31,32),/ICC28,/RAW("] ["),/ICC29,/CUP(I-31,44),/ICC28,/RAW("] ["),/ICC29,/CUP(I-31,58),/ICC28,/RAW("] ["),/ICC29,/CUP(I-31,70),/ICC28,/RAW("] ["),/ICC29,/CUP(I-31,78),/ICC28,/RAW("]")
 W /CUP(15,1),/ICC28,/RAW("("),/ICC29,/CUP(15,32),/ICC28,/RAW(")")
 W /CUP(15,35),/RAW("Ped/It.Externo: ["),/ICC29,/CUP(15,68),/ICC28,/RAW("]["),/ICC29,/CUP(15,78),/ICC28,/RAW("]") 
 ;
TCEZ Q  
 ;
TGE ;Tela de produto granel e embalado (Opcao 3 e 4)
 W /CUP(1,1),/ICC28,/ED(0) 
 I OPC=3 W /CUP(1,2),/RAW("Pedido de Outros Produtos a Granel") 
 E  W /CUP(1,2),/RAW("Pedido de Produtos Embalados") 
 S NDEE=$E(NDEE,1,29) 
 W /CUP(1,40),/RAW($J(NDEE,29)_" - ") 
 S DAT=DFAT,%DI=0 D DT^sistema.DOLLAR 
 W /CUP(3,2),/RAW("Cliente: ["),/ICC29,/CUP(3,27),/ICC28,/RAW("]"),/ICC29 
 W /CUP(4,1),/ICC28,/RAW("Contato:"),/ICC29,/CUP(4,27),/ICC28,/RAW("Fone:"),/ICC29,/CUP(4,47),/ICC28,/RAW("ZV:"),/ICC29 
 W /CUP(5,1),/ICC28,/RAW("Limite:"),/ICC29,/CUP(5,47),/ICC28,/RAW("Saldo do Cliente:"),/ICC29 
 W /CUP(6,1),/ICC28,/RAW("Observações:"),/CUP(6,48),/RAW("Dt. Prev.Fat: ["),/ICC29,/CUP(6,72),/ICC28,/RAW("]") 
 W /CUP(7,3),/ICC29,/CUP(7,79),/ICC28 
 W /CUP(8,3),/ICC29,/CUP(8,79),/ICC28 
 W /CUP(9,76),/ICC29,/RAW("   "),/ICC28 
 W /CUP(9,2),/RAW("Item: ["),/ICC29,/CUP(9,12),/ICC28,/RAW("]") 
 W /CUP(10,4),/RAW("Produto:     ["),/ICC29,/CUP(10,27),/ICC28,/RAW("]  ("),/ICC29,/CUP(10,78),/ICC28,/RAW(")") 
 W /CUP(11,4),/RAW("Quantidade:  ["),/ICC29,/CUP(11,26),/ICC28,/RAW("]") 
 W /CUP(11,45),/RAW("Frete Unitário:  ["),/ICC29,/CUP(11,78),/ICC28,/RAW("]") 
 W /CUP(12,4),/RAW("Bomba:       ["),/ICC29,/CUP(12,20),/ICC28,/RAW("]") 
 W /CUP(12,45),/RAW("Acre(+) Desc(-): ["),/ICC29,/CUP(12,78),/ICC28,/RAW("]") 
 W /CUP(13,4),/RAW("Prazo(s):    ["),/ICC29,/CUP(13,22),/ICC28,/RAW("] ["),/ICC29,/CUP(13,30),/ICC28,/RAW("]") 
 W /CUP(13,45),/RAW("Preco Unitário:  ["),/ICC29,/CUP(13,78),/ICC28,/RAW("]") 
 W /CUP(14,17),/RAW("["),/ICC29,/CUP(14,22),/ICC28,/RAW("] ["),/ICC29,/CUP(14,30),/ICC28,/RAW("]") 
 W /CUP(15,14),/RAW("Pedido Externo -->   Numero: ["),/ICC29,/CUP(15,60),/ICC28,/RAW("]  Item: ["),/ICC29,/CUP(15,78),/ICC28,/RAW("]") 
TGEZ Q  
 ;
TDG ;Tela de dados gerais  
 W /CUP(16,2),/RAW("Total do Pedido:"),/ICC29,/CUP(16,31),/ICC28 
 I OPC=4 W /CUP(16,32),/RAW("Atend.Total/Parcial/C.Comp.: ["),/ICC29,/CUP(16,64),/ICC28,/RAW("]") 
 W /CUP(17,1),/ICC28,/RAW("Cobranca: ["),/ICC29,/CUP(17,19),/ICC28,/RAW("] ("),/ICC29,/CUP(17,45),/ICC28,/RAW(") Solicitante: ["),/ICC29,/CUP(17,78),/ICC28,/RAW("]") 
 W /CUP(18,2),/RAW("Mensagem para Nota Fiscal:") 
 F I=50:1:52 W /CUP(I-31,2),/RAW("["),/ICC29,/CUP(I-31,78),/ICC28,/RAW("]") 
TDGZ Q  
 ;
EXI ;EXIbe informacoes do cliente
 W /CUP(3,13),/ICC24,/RAW(CCLI) I $L(CCLI)'<14 $$$Read(X)  
 S NTPRC=$P("REVENDEDOR;CONSUMIDOR;TRR;ESPECIAL;CONGENERE",";",+TPRC)
 I $D(^IBCRI(1,CCLI,"R")) S TMER="R",NTPRC="REVENDEDOR",TPRC=1
 I $D(^IBCRI(1,CCLI,"C")) S TMER="C",NTPRC="CONSUMIDOR",TPRC=2
 I $D(^IBCRI(1,CCLI,"I")) S NTPRC="INDUSTRIALIZAÇÃO"
 W /CUP(3,31),/ICC24,/RAW($E(NCLI,1,36)_" - "_NTPRC) 
 W /CUP(4,11),/RAW($E(COTT,1,15)),/CUP(4,34),/RAW(TCLI),/CUP(4,52),/RAW(CZVC_"-"_$E(NZVE,1,17)) 
 S WA=VLCR,WF="",WT="" 
 I +WA'=0 W /CUP(5,10) D CI^sistema.DOLLAR 
 D VDV I DEBITO W /CUP(5,29),/RAW("*DÉBITO VENCIDO*") 
 // TAREFA 0064AB6D HPJ
 S WA=VSAL 
 S WA=VLCR-VSAL
 I +WA'=0 W /CUP(5,66) D CI^sistema.DOLLAR 
 //
EXI1 S X=$G(^IFCIC(CCLI)),DMSG=$P(X,"|",1) 
 W /CUP(7,4),/RAW(DMSG) 
 I CNEG=23400 D EXL 
EXIZ Q  
 ;
EIC ;Exibe Item Cadastrado
 ;
 D EXC G EICZ
 ;
 /*
 S XITPE=$ZP(^IFAUX(PART,0,"")) I XITPE?1"" S XITPE=1 G EIC2 
 N CPRO,QPED,IUBO,VFRU,VUNP 
 S IT="" 
EIC1 S IT=$O(^IFAUX(PART,0,IT)) I IT?1"" G EIC2 
 S X=^IFAUX(PART,0,IT),CPRO=$P(X,"|",1),QPED=$P(X,"|",3),IUBO=$P(X,"|",7),VFRU=$P(X,"|",6),VUNP=$P(X,"|",4),PRAZ=$P(X,"|",42) 
 I IT=XITPE G EIC1 
 S X=^IBPRO(CPRO),NPRO=$P(X,"|",2) 
 W /CUP(40+IT-31,4),/ICC24 I CPRO'?1"" W /RAW($E(NPRO,1,16)) I $L(NPRO)>15 $$$Read(X)  
 W /CUP(40+IT-31,25),/ICC24,/RAW(QPED) I $L(QPED)'<7 $$$Read(R)  
 W /CUP(40+IT-31,37),/ICC24,/RAW($S(IUBO=0:"N",IUBO?1"":"",1:"S")) I IUBO'?1"" $$$Read(R)  
 W /CUP(40+IT-31,43),/ICC24 I VFRU'?1"" W /RAW($J((+VFRU/100),11,4)) $$$Read(R)  
 W /CUP(40+IT-31,59),/ICC24 I VUNP'?1"" S X=$J(VUNP/100,0,4) S:X?1".".E X="0"_X W /RAW($J(X,11)) $$$Read(X)  
 W /CUP(40+IT-31,75),/ICC24,/RAW(PRAZ) I $L(PRAZ)'<3 $$$Read(R)  
 G EIC1 
EIC2 I '$D(CPRO) G EICZ 
 I CPRO'?1"" S X=^IBPRO(CPRO),NPRO=$P(X,"|",2) 
 W /CUP(40+XITPE-31,4),/ICC24 I CPRO'?1"" W /RAW($E(NPRO,1,16)) I $L(NPRO)>15 $$$Read(X)  
 W /CUP(40+XITPE-31,25),/ICC24,/RAW(QPED) I $L(QPED)'<7 $$$Read(R)  
 W /CUP(40+XITPE-31,37),/ICC24,/RAW($S(IUBO=0:"N",IUBO?1"":"",1:"S")) I IUBO'?1"" $$$Read(R)  
 W /CUP(40+XITPE-31,43),/ICC24 I VFRU'?1"" W /RAW($J((+VFRU/100),11,4)) $$$Read(R)  
 W /CUP(40+XITPE-31,59),/ICC24 I VUNP'?1"" S X=$J(VUNP/100,0,4) S:X?1".".E X="0"_X W /RAW($J(X,11)) $$$Read(X)  
 W /CUP(40+XITPE-31,75),/ICC24,/RAW(PRAZ) I $L(PRAZ)'<3 $$$Read(R)  
 */
EICZ Q  
 ;
EXC ;Exibe Item Cadastrado
 ; Módulo substitui EIC
 ; GDTI 3262 - TAREFA 84458 - DSD - 08/2018 - INCLUSÃO DE CAMPO P/DESC.COMERCIAL
 S XITPE1=$ZP(^IFAUX(PART,0,""))
 I XITPE1?1"" D  G EXCZ
 .S XITPE=1
 .D PLI
 ;
 N CPRO,QPED,IUBO,VFRU,VUNP,VUDC,PRAZ 
 S XITPE2="" 
EXC1 S XITPE2=$O(^IFAUX(PART,0,XITPE2))
 I XITPE2?1"" D  G EXCZ
 .S XITPE=XITPE1
 .D PLI 
 S X=^IFAUX(PART,0,XITPE2),CPRO=$P(X,"|",1),QPED=$P(X,"|",3),IUBO=$P(X,"|",7),VFRU=$P(X,"|",6),VUNP=$P(X,"|",4),PRAZ=$P(X,"|",42),VUDC=$P(X,"|",120) 
 I XITPE2=XITPE1 G EXC1 
 S X=^IBPRO(CPRO),NPRO=$P(X,"|",2) 
 D PLI
 G EXC1 
 ;
EXCZ Q  
 ;
PLI ; Preenche Linha do Item
 ; GDTI 3262 - TAREFA 84458 - DSD - 08/2018 - INCLUSÃO DE CAMPO P/DESC.COMERCIAL
 ;
 I '$D(CPRO) G PLIZ 
 S X="" I CPRO'?1"" S X=^IBPRO(CPRO)
 S NPRO=$P(X,"|",2) 
 W /CUP(40+XITPE-31,4),/ICC24 I CPRO'?1"" W /FVALUE(CPRO)
 W /CUP(40+XITPE-31,17),/ICC24,/FVALUE(QPED)
 W /CUP(40+XITPE-31,31),/ICC24,/FVALUE($S(IUBO=0:"N",IUBO?1"":"",1:"S"))
 W /CUP(40+XITPE-31,37),/ICC24 I VFRU'?1"" W /FVALUE($J((VFRU/100),7,4))
 W /CUP(40+XITPE-31,49),/ICC24 I VUNP'?1"" W /FVALUE($J((VUNP/100),9,4))
 W /CUP(40+XITPE-31,63),/ICC24 I VUDC'?1"" W /FVALUE($J((VUDC/100),7,4))
 W /CUP(40+XITPE-31,75),/ICC24,/FVALUE(PRAZ)
 W /CUP(15,4),/ICC24 I NPRO'?1"" W /FVALUE($E(NPRO,1,28))
PLIZ Q
 ;
EDI ;Exibe item embalado/Outros graneis
 I '$D(XITPE) G EDIZ 
 W /CUP(9,10),/ICC24,/RAW(XITPE) I $L(XITPE)'<2 $$$Read(X)  
 W /CUP(10,19),/RAW(CPRO) I $L(CPRO)'<8 $$$Read(X)  
 W /CUP(10,33) I NPRO'?1"" W /RAW(($E(NPRO,1,30)_" - "_EMBA)) 
 W /CUP(11,19),/RAW(QPED) I $L(QPED)'<7 $$$Read(X)  
 W /CUP(12,64) I VFRU'?1"" W /RAW($J((+VFRU/100),11,4)) $$$Read(X)  
 I IUBO'?1"" W /CUP(12,19),/RAW($S(IUBO?1"1":"S",1:"N")) $$$Read(X)  
 W /CUP(12,64),/RAW(PADL) I $L(PADL)'<6 $$$Read(X)  
 I CPRO?1"" G EDI1 
 W /CUP(13,19),/RAW(PRAZ1) I $L(PRAZ1)'<3 $$$Read(X)  
 W /CUP(13,27),/RAW(PRAZ2) I $L(PRAZ2)'<3 $$$Read(X)  
 W /CUP(13,35),/RAW(PRAZ3) I $L(PRAZ3)'<3 $$$Read(X)  
 W /CUP(13,19),/RAW(PRAZ4) I $L(PRAZ4)'<3 $$$Read(X)  
 W /CUP(13,27),/RAW(PRAZ5) I $L(PRAZ5)'<3 $$$Read(X)  
 W /CUP(13,35),/RAW(PRAZ6) I $L(PRAZ6)'<3 $$$Read(X)  
EDI1 W /CUP(13,64) I VUNP'?1"" S X=$J(VUNP/100,0,4) S:X?1".".E X="0"_X W /RAW($J(X,14)) $$$Read(X)  
EDIZ Q  
 ;
RDG ;Restaura dados gerais
 W /CUP(16,19),/ICC24 
 I +TPED'=0 S WA=TPED,WT=0,WF="" D CI^sistema.DOLLAR 
 I OPC=4 W /CUP(16,63),/ICC24,/RAW(TOPA) 
 W /CUP(17,14),/ICC24,/RAW(LCOB) I $L(LCOB)'<5 $$$Read(X)  
 S NCOB="" 
 I LCOB'?1"",$E(LCOB,1)?1"B" S X=^IBCOB(LCOB),NCOB=$P(X,"|",3) 
 I LCOB'?1"",$E(LCOB,1)?1"D" S CCOB=$E(LCOB,2,5),X=^IBFOR(1_CCOB),NCOB=$P(X,"|",3) 
 W /CUP(17,24),/ICC24,/RAW($E(NCOB,1,20)) 
 W /CUP(17,63),/ICC24,/RAW(SOLI) I $L(SOLI)'<15 $$$Read(X)  
 I $D(MSG) F I=1:1:3 S MSNF=$P(MSG,"|",I) W /CUP(49+I-31,4),/ICC24,/RAW(MSNF) I $L(MSNF)'<74 $$$Read(X)  
RDGZ Q  
 ;
MTA ;Monta Tela Alocacao
 W /CUP(16,1),/ED(0) 
 W /CUP(17,1),/ICC28,/RAW("Transportador: ["),/ICC29,/CUP(17,23),/ICC28,/RAW("] Placa/Vagao: ") Do exibirCCAM^basico.SRIVT(17,39,65,0)
 W /CUP(17,66),/RAW(" Viagem: ["),/ICC29,/CUP(17,78),/ICC28,/RAW("]") 
 W /CUP(18,2),/RAW("Item: ["),/ICC29,/CUP(18,12),/ICC28,/RAW("]   Comp: ["),/ICC29,/CUP(18,26),/ICC28,/RAW("]    Produto:"),/ICC29,/CUP(18,62),/ICC28,/RAW("Qtde:"),/ICC29,/CUP(18,78),/ICC28 
 W /CUP(19,2),/RAW("Comp-1:"),/ICC29,/CUP(19,16),/ICC28,/RAW("Comp-2:"),/ICC29,/CUP(19,31),/ICC28,/RAW("Comp-3:"),/ICC29,/CUP(19,46),/ICC28,/RAW("Comp-4:"),/ICC29,/CUP(19,61),/ICC28,/RAW("Comp-5:"),/ICC29,/CUP(19,76),/ICC28 
 W /CUP(20,2),/RAW("Comp-6:"),/ICC29,/CUP(20,16),/ICC28,/RAW("Comp-7:"),/ICC29,/CUP(20,31),/ICC28,/RAW("Comp-8:"),/ICC29,/CUP(20,46),/ICC28 
 W /CUP(21,2),/RAW("Local Carregamento: ["),/ICC29,/CUP(21,25),/ICC28,/RAW("]     Dep. Armazenador: ["),/ICC29,/CUP(21,57),/ICC28,/RAW("] ("),/ICC29,/CUP(21,78),/ICC28,/RAW(")") 
MTAZ Q  
 ;
EDA ;Exibe Dados Alocacao
 D TRPIM^IBSRDF(CTRA,.CVTR)
 S MTRA=$CASE(CVTR,1:1,2:2,3:3,4:3,5:3,6:5,7:5,8:4,:"")
 W /CUP(17,19),/ICC24,/RAW(CTRA) I $L(CTRA)'<4 $$$Read(X)  
 D exibir^basico.SRIVT(17,39,65,CCAM,,/*QECD*/ 0,MTRA)
 W /CUP(17,77),/ICC24,/RAW(VIAG) I $L(VIAG)'<1 $$$Read(X)  
EDAZ Q  
 ;
TIT ;exibe Totais do ITem
 W /CUP(18,1),/ED(0) 
 W /CUP(19,1),/ICC28,/RAW("Mercadoria ---->"),/ICC29,/CUP(19,41),/ICC28,/RAW("Enc Financ ->"),/ICC29,/CUP(19,78),/ICC28 
 W /CUP(20,1),/ICC28,/RAW("Frete --------->"),/ICC29,/CUP(20,41),/ICC28,/RAW("ICMS Dev --->"),/ICC29,/CUP(20,78),/ICC28 
 W /CUP(21,1),/ICC28,/RAW("Bomba --------->"),/ICC29,/CUP(21,41),/ICC28,/RAW("ICMS Ret --->"),/ICC29,/CUP(21,78),/ICC28 
 W /CUP(22,1),/ICC28,/RAW("Total do Item ->"),/ICC29,/CUP(22,41),/ICC28,/RAW("IVVC ------->"),/ICC29,/CUP(22,78),/ICC28 
TITZ Q  
 ;
EXL ;EXIbe informacoes do cliente
 N CMUN,CUFE
 S X=$G(^IFCIC(CCLI)),DMSL=$P(X,"|",2)
 S X=^IBCLI(CCLI,1),CMUN=$P(X,"|",4) 
 S X=^IBMUN(CMUN),CUFE=$P(X,"|",4)
 I CUFE?1"AP" S DMSL=DMSL_$S(DMSL'?1"":" / ",1:"")_"ATENCAO: CLIENTE AMAPA"
 W /CUP(8,4),/RAW(DMSL) 
EXLZ Q  
 ;
EDE ;Exibe Data Prev. Fat.
 W /CUP(6,64),/ICC24 
 I DENT?1"" G EDEZ 
 I DENT="99999" W /RAW("Imediata") $$$Read(R)  G EDEZ 
 I DENT?1"P" W /RAW("Programa") $$$Read(R)  G EDEZ 
 I DENT?1N.N S DAT=DENT,%DI="" D DT^sistema.DOLLAR $$$Read(R)  K %DI G EDEZ 
 W /RAW(DENT) I DENT'<8 $$$Read(R)  
EDEZ Q  
 ;
MVC ;Modulo valida cliente
 S TIPBLO=2 D ^IBSRGL I SAI S SAI=0 G MVCZ 
 N VOL,FIM,ALT 
 S (VOL,FIM)=0 
 D TDC 
 D REC I FIM G MVCZ 
 D RMC 
MVC1 D LPT I FIM G MVCZ 
 I ALT D ARM I VOL G MVC1 
MVC2 D EDD,MLT 
MVCZ Q  
 ;
TDC ;Tela dados cliente
 W /CUP(21,3),/ICC28,/RAW("Contato:  ["),/ICC29,/CUP(21,31),/ICC28,/RAW("]") 
 W /CUP(22,3),/ICC28,/RAW("Telefone: ["),/ICC29,/CUP(22,27),/ICC28,/RAW("]       Fax: ["),/ICC29,/CUP(22,54),/ICC28,/RAW("]") 
 W /CUP(23,3),/ICC28,/RAW("E-mail:   ["),/ICC29,/CUP(23,66),/ICC28,/RAW("]") 
 W /CUP(24,3),/ICC28,/RAW("Ins.Est.: ["),/ICC29,/CUP(24,36),/ICC28,/RAW("]") 
TDCZ Q  
 ;
REC ;Recupera dados
 S X=^IBCLI(CCLI,1),TCLI=$P(X,"|",14),FAXC=$P(X,"|",15),CIEC=$P(X,"|",5) 
 S X=^IBCLI(CCLI,0),COTT=$P(X,"|",9),CFOR=$P(X,"|",13) 
 S ZVE=$E(CZVC,1) 
 D ECO,ETE,ETF,EIE 
RECZ Q  
 ;
RMC ;Recupera e-Mail do Cliente - no componente do ponto de venda
 N YCCLI 
 S YCCLI=CCLI 
 S X=^IBCLI(YCCLI,0),SCLI=$P(X,"|",22)
 S (COPV,TICP,MAIL,NPNE)="" 
 S COPV=$O(^IBIPC(YCCLI,""))         
 S XCOPV=$ZP(^IBIPC(YCCLI,"")) 
 I SCLI?1"5" G RMCZ
 I COPV?1"" G RMCZ 
 I COPV'=XCOPV S (TICP,COPV)="" 
 E  S TICP=$O(^IBIPC(YCCLI,COPV,"")) 
 I COPV?1"" G RMCZ 
 I TICP=7!(TICP=8)!(TICP=9) G RMCZ 
 I TICP'?1"" S X=^IBPVI(COPV,TICP),MAIL=$P(X,"|",3),NPNE=$P(X,"|",5) D EEM 
RMCZ Q  
 ;
LPT ;LE Parametros
 I VOL S VOL=0 G LPT5 
 S ALT=0 
 S USRT=%US 
 S DATT=$P($$H^sistema.DOLLAR,",",1),HORT=$P($$H^sistema.DOLLAR,",",2) 
 ;
LPT2 ;Le Contato
 W /CUP(21,16),/CON U 0:(256:"FC":$C(21,24)) $$$Read(R)  S:$A($ZB)=21!($A($ZB)=24) R=$ZB W:$A($ZB)=24 /ICC24 U 0:(256:"SFC":$C(21,24)) W /ICC20,/ICC13 
 I R?1"" G LPT3 
 I $A(R)=21 S FIM=1 G LPTZ 
 I $A(R)=24 S:COTT'?1"" ALT=1,COTT="" G LPT3 
 I R?1C.E S MS=3 D REM,ECO G LPT2 
 I $L(R)>15!(R'?1U.UNP) S:R?1"?" ER="" S MS=23,CMS=15 D REM,ECO G LPT2 
 S COTT=R,ALT=1 
 D ECO 
 ;
LPT3 ;Telefone
 W /CUP(22,16),/CON U 0:(256:"FC":$C(21,24)) $$$Read(R)  S:$A($ZB)=21!($A($ZB)=24) R=$ZB W:$A($ZB)=24 /ICC24 U 0:(256:"SFC":$C(21,24)) W /COFF,/ICC20,/ICC13 
 I R?1"" G LPT4 
 I $A(R)=21 G LPT2 
 I $A(R)=24 S:TCLI'?1"" ALT=1,TCLI="" G LPT4 
 I R?1C.E S MS=3 D REM G LPT3 
 I R?1"?" S MS=23,CMS=10,ER="" D REM,ETE G LPT3 
 I $L(R)>11!(R'?1N.N) S:R?1"?" ER="" S MS=17,CMS=11 D REM,ETE G LPT3 
 S TCLI=R,ALT=1 
 D ETE 
 ;
LPT4 ;Telefone/FAX
 W /CUP(22,43),/CON U 0:(256:"FC":$C(21,24)) $$$Read(R)  S:$A($ZB)=21!($A($ZB)=24) R=$ZB W:$A($ZB)=24 /ICC24 U 0:(256:"SFC":$C(21,24)) W /COFF,/ICC20,/ICC13 
 I R?1"" G LPT5 
 I $A(R)=21 G LPT3 
 I $A(R)=24 S:FAXC'?1"" ALT=1,FAXC="" G LPTZ 
 I R?1C.E S MS=3 D REM G LPT4 
 I R?1"?" S MS=23,CMS=11,ER="" D REM,ETF G LPT4 
 I $L(R)>10!(R'?1N.N) S:R?1"?" ER="" S MS=17,CMS=10 D REM,ETF G LPT4 
 S FAXC=R,ALT=1 
 D ETF 
 ;
LPT5 ;E-mail do cliente
 I COPV?1"" S MS="Deve ser cadastrado o ponto de venda do cliente para atualizar o e-mail." D REM $$$ReadT(X,2)  G LPTZ 
 S ER="",MS="E' necessario respeitar letras maiusculas, minusculas e pontuacao." D REM 
 W /CUP(23,16),/CON U 0:(256:"FC":$C(21,24)) $$$Read(R)  S:$A($ZB)=21!($A($ZB)=24) R=$ZB W:$A($ZB)=24 /ICC24 U 0:(256:"SFC":$C(21,24)) W /COFF,/ICC20,/ICC13 
 I R?1"" G LPT6 
 I $A(R)=21 G LPT4 
 I $A(R)=24 S:MAIL'?1"" MAIL="",ALT=1 G LPT5 
 I $A(R)>21,$A(R)<27 S MS=3 D REM G LPT5 
 I R?1"?" S ER="",MS=23,CMS=40 D REM,EEM $$$ReadT(X,3)  G LPT5 
 I R?1"H" S MAIL=R,ALT=1 D EEM G LPTZ 
 I R'?1UNPL.UNPL!($L(R)>60) S MS=23,CMS=60 D REM,EEM $$$ReadT(X,3)  G LPT5 
 S MAIL=R,ALT=1 
 D EEM 
 ;
LPT6 ;Inscricao estadual do cliente
 G LPTZ
 W /CUP(24,16),/CON U 0:(256:"FC":$C(21,24)) $$$Read(R)  S:$A($ZB)=21!($A($ZB)=24) R=$ZB W:$A($ZB)=24 /ICC24 U 0:(256:"SFC":$C(21,24)) W /COFF,/ICC20,/ICC13 
 I R?1"" G LPTZ 
 I $A(R)=21 G LPT5 
 I $A(R)>21,$A(R)<27 S MS=3 D REM G LPT6 
 I R?1"?" S MS="Deve ser numeros e letras ou ISENTO ou EM ANDAMENTO ou NAO CONTRIBUINTE.",ER="" D REM,EIE G LPT6 
 I R?.UP,R'="ISENTO",R'="EM ANDAMENTO",R'="NAO CONTRIBUINTE" S MS="Deve ser numeros e letras ou ISENTO ou EM ANDAMENTO ou NAO CONTRIBUINTE." D REM,EIE G LPT6 
 ;I $L(R)>20!(R'?1N.UNP&(R'?1U.UP)) S MS="Deve ser numeros e letras ou ISENTO ou EM ANDAMENTO ou NAO CONTRIBUINTE." D REM,EIE G LPT6
 S X=^IBCLI(CCLI,1),CMUE=$P(X,"|",4),X=^IBCLI(CCLI,2),CNEG=$P(X,"|",2) 
 S X=^IBMUN(CMUE),CUFE=$P(X,"|",4) 
 I R="ISENTO"!(R="EM ANDAMENTO")!(((CUFE="SP")&($L(CCLI)<14))) G LPT61 
 S FLG=0 
 D ^IBSREI 
 I FLG'=0 D EIE G LPT6 
LPT61 I R?."0" S MS=305,CMS="Inscricao Estadual" D REM,EIE G LPT6 
 I R["|" S MS=26,CMS="'|'" D REM,EIE G LPT6 
 S CIEC=R,ALT=1 
 D EIE 
LPTZ Q  
 ;
ECO ;Exibe COntato
 W /CUP(21,16),/ICC24,/RAW(COTT) I $L(COTT)'<15 $$$Read(X)  
ECOZ Q  
 ;
ETE ;Exibe Telefone
 W /CUP(22,16),/ICC24,/RAW(TCLI) I $L(TCLI)'<11 $$$Read(X)  
ETEZ Q  
 ;
ETF ;Exibe Telefone FAX
 W /CUP(22,43),/ICC24,/RAW(FAXC) I $L(FAXC)'<11 $$$Read(X)  
ETFZ Q  
 ;
EEM ;Exibe E-mail 
 I MAIL'?1"H" G EEM1 
 S DAT=MAIL D ^sistema.DEI S MAIL=DAT 
 K %DI S DAT=MAIL D DT^sistema.DOLLAR 
 S MAIL=$E(%X+100,2,3)_"/"_$E(%Z+100,2,3)_"/"_%Y 
EEM1 W /CUP(23,16),/ICC24,/RAW(MAIL) I $L(MAIL)'<40 $$$Read(X)  
EEMZ Q  
 ;
EIE ;Exibe inscricao estadual
 W /CUP(24,16),/ICC24,/RAW(CIEC) I $L(CIEC)=20 $$$Read(X)  
EIEZ Q  
 ;
PPR ; Pesquisa Produtos
 ;
 N CPROX
 ;
 K ^IBPF3(PART)
 ;
 W /ICC20,/RAW("Pesquisando produtos válidos..."),/ICC13 H 1
 S CPROX=""
 F  S CPROX=$O(^IBPRO(CPROX)) Q:CPROX?1""  D
 .S R=CPROX 
 .I ",1,2,"[(","_OPC_",") D CPR I 1 ; Módulo de Crítica do Prod.Claro/Escuro (MS'?1"" -> Produto inválido)
 .                                  ; . todas as críticas para seleção dos produtos válidos estão
 .                                  ;   agrupadas nesse módulo para serem compartilhadas 
 .                                  ;   também na leitura do campo PRODUTO (LDP^IFPEAT12) - DSD 08/10
 .                                  ;
 .E  I ",3,4,"[(","_OPC_",") D CPE  ; Módulo de Crítica do Prod.Embalado/Outros Granel (MS'?1"" -> Produto inválido)
 .                                  ; . todas as críticas para seleção dos produtos válidos estão
 .                                  ;   agrupadas nesse módulo para serem compartilhadas 
 .                                  ;   também na leitura do campo PRODUTO (LDP2^IFPEAT14) - DSD 08/10
 .I MS?1"" D
 ..I XAPLD'?1"" S XNPRO="(APELIDO: "_XAPLD_") "_XNPRO 
 ..S NGPRX="GRUPO NÃO DEFINIDO"
 ..I CGPR'?1"" D
 ...S X=$G(^IBGSP(CGPR)),NGPRX=$P(X,"|",1)
 ...I SGPR'?1"" S X=$G(^IBGSP(CGPR,SGPR)),NGPRX=NGPRX_" "_$P(X,"|",1)
 ..S ^IBPF3(PART,NGPRX,CPROX)=XNPRO 
 ;
 D PPG
 ;
 ;S MS="Padrao - 8 caracteres numericos ou apelido do produto." 
 ;S %zPAR="IBPF3;"_PART_";R;C;1;15;"_MS_";PRODUTOS "_$P("CLAROS,ESCUROS,OUTROS GRANEIS,EMBALADOS",",",OPC)_" VÁLIDOS" 
 ;D ^IBSRMJ 
 ;K ^IBPF3(PART)
 ;
PPRZ Q  
 ;
PPG ; Pesquisa Programas
 N NJA ; Numero da janela anterior
 S (NGPRX,CPROX)="",NJA="" 
 W /ICC20,/ICC13 
PPG01 S NGPRX="",MS=""
 S %zPAR="IBPF3;"_PART_";R;C;;12;"_MS_";GRUPO DE PRODUTOS "_$P("CLAROS,ESCUROS,OUTROS GRANEIS,EMBALADOS",",",OPC)_" VÁLIDOS;;;1;;;;1;"_NJA
 D ^IBSRMJ 
 S NJA=""
 I R'?1"" S NGPRX=R 
 E  S %zFEC=1 D FCJ^IBSRMJ G PPGZ 
 ;
PPG02 S CPROX=""
 S MS="Padrao - 8 caracteres numericos ou apelido do produto." 
 S %zPAR="IBPF3;"_PART_","_NGPRX_";T;D;;12;"_MS_";PRODUTOS "_$P("CLAROS,ESCUROS,OUTROS GRANEIS,EMBALADOS",",",OPC)_" VÁLIDOS;;;1;;;;1;"_NJA 
 D ^IBSRMJ 
 S NJA=""
 I R?1"" S NGRP="",%zFEC=1 D FCJ^IBSRMJ S NJA=%njc G PPG01 
 E   S %zFEC=2 D FCJ^IBSRMJ
 ;
 K ^IBPF3(PART)
 ;
PPGZ Q  
 ;
REM D ^GAP.GAREM Q  
EDD D EDD^IFPEAT11 Q  
MLT D MLT^IFPEAT11 Q  
ARM D ARM^IFPEAT11 Q  
MTE D MTE^IFPEAT Q  
EDC D EDC^IFPEAT Q  
TCC D TCC^IFPEAT01 Q  
TCE D TCE^IFPEAT02 Q  
MTL D MTL^IFPEAT04 Q  
VDV D VDV^IFPEAT15 Q
CPR D CPR^IFPEAT12 Q
CPE D CPE^IFPEAT41 Q
]]></Routine>


<Routine name="IFPEAT0E" type="MAC" languagemode="0" timestamp="65441,38316.005272"><![CDATA[
IFPEAT0E ;Atendimento a Cliente <V1.0-PNC-10/94> ; Aug 2 2005  2:30 PM ;pnc ;Última Alteração   FLCARVALHO 03/03/2020 10:38:35

 ///Pacote vfsantos_frete - Projeto ELO - 22/03/2018

 #Include sistema.BibliotecaMacro

 #Dim dtSaida as %Date
 #Dim ORIP as %String			; Representa o código da origem para consumo
 #Dim NFCI AS %String			; Representa o número da FCI da origem de consumo (Quando exigir FCI)

ARM ;Armazena Informações
 S RCONFIRMA=""
 W /CUP(8,77) K ARM
ARM1 
 //Validacao agora será realizada antes do armazenamento
 D TSJ ; Chamado: GDTI 1638
 IF RCONFIRMA="N" S ARM=1,PF1=1 G ARMZ
ARM2 
 W /ICC20,/RAW("OK para armazenar? S// ") U 0:(256:"FC":$C(21,24)) $$$Read(R)  S:$A($ZB)=21!($A($ZB)=24) R=$ZB W:$A($ZB)=24 /ICC24 U 0:(256:"SFC":$C(21,24)) W /ICC20,/ICC13 
 I R?1C S MS=3 D ^GAP.GAREM $$$ReadT(X,2)  G ARM2
 I R'?1"S",R'?1"N",R'?1"" S:R?1"?" ER="" S MS=1 D ^GAP.GAREM $$$ReadT(X,2)  G ARM2
 I R?1"N" S ARM=1 G ARMZ
 W /ICC20,/RAW("Armazenando..."),/ICC13
 ;
 S ITPE=$ZP(^IFAUX(PART,0,""))
 S XCCLI=$E(CCLI,1,$L(CCLI)-2)_"01"
 S DPED=DFAT,DRPE=$P($$H^sistema.DOLLAR,",",1),IPOE=0,(CONTC,CONTL)=0 
 I DENT="99999" S XDENT=DFAT
 E  S XDENT=DENT
 I CCAM?1"" S CCAM=0
 If "1/2/3"[OPC S CLPA=1
 Else  S CLPA=3
 I CLPR=1,CTOP="01",'EEMB D ACP I 1
 E  D AOP 
 //Validacao agora será realizada antes do armazenamento
 ; Chamado: GDTI 1638
 ;;D TSJ ; Incluida na tarefa 006027d8 - Clube do Milhao - DSD - 03/08
 IF ($G(IDPJ)'="") {
	 S MVMS=$G(MVMS),GHJ=$G(GHJ),USRT=%US D GHJ K GHJ ; grava GHJ="" dados no historico do pedido.
 } 
 ; Inclusao de pedido - todos os itens terao a mesma data de entrega, com o mesmo IDPJ
 I CLPA=3,(OCO=1) S CARG=$$H^sistema.DOLLAR_","_%US,^IFOCO(CDEE,NPED)=CARG 
 I DENT'=99999 D EEM
 ;
 S NITPE="" D CRR ; TAREFA 004A6C45 - DSD - 04/12
 ;
 I 1 L
 ;
 I CLPR=1,CTOP="01",DENT'?1"P" D APE
 ;
 ; <AMAURI - 22/01/2014 Tarefa 006CBC92> - Obrigatoriedade de Lacres e Envelopes
 ; 
 ; Entry-Point para permitir associar Lacres/envelopes
 ;
 D TRANS^IBSRDF(CTRA,.TPST),TRPIM^IBSRDF(CTRA,.CVTR)
 If CVTR=1 {
 	If $D(^IFPPL(CDEE,XDENT,+VIAG,CCAM))&&($$viagemEstaCompleta(CDEE,XDENT,+VIAG,CTRA,CCAM)) {
		; Confirma se via chamar a associação de lacres e envelopes
		;
		If $$confirmarAssociacao(CCAM) {
			Set oVeiculo=##class(cbpi.abadi.basico.veiculo.Veiculo).instanciar(CCAM)
			Set dtSaida=##class(cbpi.abadi.datatype.DataMedidata).LogicalToCache(XDENT)
 			Set oViagem=##class(cbpi.abadi.faturamento.Viagem).instanciar(CDEE,dtSaida,CTRA,oVeiculo,VIAG)
 			Set DSAI=XDENT
			Do ^IFPRLE
			Set IMPA=1,PF1=0
		}
	}
 }
 
 W /ICC20,/RAW("Armazenando... Ok")
 W /ICC20,/RAW("=> ") $$$Read(X) W /ICC20,/ICC13
 ;
 ; FIM - <AMAURI - 22/01/2014 Tarefa 006CBC92>
 ;
 K NUPE,DPED,PRAZ,LCOB,IIPI,IPOE,OBSE,MNF,%X,%Y,%Z
 K SPED,IATP,IPRI,IICM,AICM,CPRO,QPED,ISUS,IADC,NUPE,DAT,VIAG 
 K CTRA,ALO,CTCG,NCOM,CLPA,XDENT,XQPED,PBU,IIICM,IAICM,NPED 
 K VPRAZ
 ;
ARMZ Quit
 ;
ACP ;Armazena Combustivel
 D ARP 
 S XITPE="",MPRAZ="" 
ACP1 S XITPE=$O(^IFAUX(PART,0,XITPE)) I XITPE?1"" G ACPZ 
 I DENT?1"P" F DIA=1:1:6 I PROG(DIA)?1"S" S DISE=$S(DIA=1:5,DIA=2:6,DIA=3:0,DIA=4:1,DIA=5:2,DIA=6:3),^IFPRO(DISE,CDEE,NPED)=DVIG_"|"_FREQ 
 ; OBS: A global IFPRO sera' gravada com o dia da semana correspondente ao #7.
 S NITPE=XITPE,ITPE=NITPE 
 D TRI
 S MPRAZ=$S(MPRAZ="":PRAZ,1:MPRAZ_"/"_PRAZ) 
 G ACP1
ACPZ D ENP Q
 ;
AOP ;Armazena outros pedidos
 D ARP 
 S XITPE="",MPRAZ="" 
AOP1 S XITPE=$O(^IFAUX(PART,0,XITPE)) I XITPE?1"" G AOPZ 
 S NITPE=XITPE,ITPE=NITPE 
 D TRI
 I $F(PRAZ,"/") S MPRAZ=PRAZ 
 E  S MPRAZ=$S(MPRAZ="":PRAZ,1:MPRAZ_"/"_PRAZ) 
 G AOP1 
AOPZ D ENP Q  
 ;
ENP ;Exibe Numero Pedido
 I CONTC=0,CONTL=0 W /CUP(21,1),/ICC29,/ED(0),/CUP(22,1),/RAW("Numero(s) do(s) Pedido(s) no Sistema ==> ") 
 W /CUP(53+CONTL-31,74+CONTC-31),/RAW($E(NPED+1000000,2,7)) W:MPRAZ'?1"" /RAW((" ("_MPRAZ_")")) 
 S CONTC=CONTC+12 
 I CONTC=36 S CONTC=0,CONTL=CONTL+1 
ENPZ Q  
 ;
ARP ;Armazena Pedido
 ;Recupera Proximo Numero do Pedido
 D ^IBSRNP 
 ;
 D GDG 
 I $D(^IFAUX(PART,1)) S MNF=^IFAUX(PART,1) D GMS 
 I $D(OBSE),OBSE'?1"" S ^IFPED(CDEE,NPED,4)=OBSE 
 S ^IFPCL(CDEE,CCLI,NPED)="" 
 S ^IFIPC(CCLI,NPED)=CDEE 
 S ^IFIPE(NPED)=CDEE 
 ; atualiza historico de usuario privilegiado - Bloqueio de Pedido
 I $D(USPR),USPR'?1"" S DTHO=$$H^sistema.DOLLAR,CAIP="",CAIP=$O(^IFHBU(1,USPR,CAIP),-1) I CAIP'?1"",$P(^IFHBU(1,USPR,CAIP),"|",1)?1"" S ^IFHBU(1,USPR,CAIP,CDEE,NPED,DTHO)=%AP_"|"_%MOD_"|"_%ROT 
ARPZ Q  
 ;
GDG ;Armazena Dados Gerais
 S X=^IBCLI(CCLI,2),ZVEN=$P(X,"|",4) 
 S X=$G(^IFPED(CDEE,NPED)),IDPJH=+$P(X,"|",9) I X?1"" S IDPJH=""
 I '$D(ICCR) S ICCR="" 
 I '$D(IDPJ)!(DENT?1"P") S IDPJ="" 
 I '$D(ILPF) S ILPF="O" 
 I CTOP'="01" S IDPJ="" 
 S PEIN=0,CANA=6 
 S USRT=%US,HORT=$P($$H^sistema.DOLLAR,",",2) 
 S X=DPED_"|"_CCLI_"|"_CNOP_"|"_CLPA_"|"_DENT_"|"_TOPA_"|"_SOLI 
 S X=X_"|"_LCOB_"|"_IDPJ_"||"_IIPI_"|"_CCLF_"|"_IPOE 
 S $P(X,"|",14)=ILPF,$P(X,"|",15)=IPCF,$P(X,"|",16)=ICCR 
 S $P(X,"|",17)=USRT,$P(X,"|",18)=VTDA,$P(X,"|",19)=HORT 
 S $P(X,"|",20)=$G(ITFL,0),$P(X,"|",21)=ZVEN,$P(X,"|",22)=DMPR 
 S $P(X,"|",29)=DRPE,$P(X,"|",31)=DFPR,$P(X,"|",32)=DMEN 
 S $P(X,"|",33)=DACL,$P(X,"|",36)=PEIN,$P(X,"|",41)=CANA
 ;
 S XY=$G(^IFAUX(PART,0,1)),NPEE=$P(XY,"|",100) 
 S $P(X,"|",42)=NPEE                                     ; tarrefa 006039EE
 ;  
 S $P(X,"|",46)=$G(SEPE),$P(X,"|",47)=$G(NEMP) ;; ASSIS 24/11/2011 tarefa 00531466
 ;NFe 3.10 - Dados de exportação. 
 S $P(X,"|",49)=$G(UFSA),$P(X,"|",50)=$G(IDLE),$P(X,"|",51)=$G(IDLD)
 ///I $D(AENT6335),AENT6335'?1"" S $P(X,"|",43)=AENT6335
 ; 
 ///Referencia de Cliente Falso Cif no Pedido - Atender Painel de Operações
 S FCIF="N"
 I $D(^IBCFC(CDEE,CCLI)) S Y=^IBCFC(CDEE,CCLI),FCIF=$P(Y,"|",1)
 S $P(X,"|",52)=FCIF
 ; 
 ;<AHZ> grava chave da nota fiscal de venda do cliente se o mesmo existir. DSO ALM 54906
 S $P(X,"|",53)=$G(CHNE)
 S $P(X,"|",56)=$G(SNCL)
 S $P(X,"|",55)=$G(NFCL)
 ;</AHZ> 
 ;
 ;<AUD - Projeto ELO - GAP FAT10>
 ; Armazena a informação que define o local de descarregamento do produto no cliente
 ; Será usado para preencher a TAG <FabEntrega>
 Set $Piece(X,"|",54)=$Get(LDPC)
 ;
 Set $Piece(X,"|",57)=$Get(ICPC)
 ;
 S TPNV=$SELECT($G(IFAV)=1:1,$G(ISRV)=1:2,1:0),$P(X,"|",61)=TPNV ; <flcarvalho - GDTI-4701 - Tarefa-112791 - Faturamento antecipado Vendor - 2019/12>
 ;
 S ^IFPED(CDEE,NPED)=X 
 K X,USRT,HORT 
GDGZ Q  
 ;
GMS ;Grava MenSagens 
 ;
 // Elo - defeito 58890 - RWJ 05/2018
 S TAM=$L(MNF,"|")
 F I=1:1:TAM S MSNF(I)=$P(MNF,"|",I) 
 ;
 // LINHA 1 a 3
 F I=1:1:3 K ^IFPED(CDEE,NPED,I) I $G(MSNF(I))'?1"" S ^IFPED(CDEE,NPED,I)=MSNF(I)
 //LINHA 4 em diante
 I TAM>3 F I=4:1:TAM I $G(MSNF(I))'?1"" S ^IFPED(CDEE,NPED,1,I)=MSNF(I)
 ;
 //// Elo - defeito 58890 - RWJ 05/2018
 ;
GMSZ Q  
 ;
TRI ;TRata Itens
 S RIT=^IFAUX(PART,0,XITPE)
 S VUFD=$P(RIT,"|",31),IFDG=$P(RIT,"|",32) 
 S PADL=$P(RIT,"|",34),VULI=$P(RIT,"|",35),VMVC=$P(RIT,"|",36) 
 S IINF=$P(RIT,"|",37),CMOR=$P(RIT,"|",38),VFCI=$P(RIT,"|",39) 
 S VMAX=$P(RIT,"|",40),VDEP=$P(RIT,"|",41),VTTB=$P(RIT,"|",44) 
 S PRAZ=$P(RIT,"|",42) 
 S IPDA=$P(RIT,"|",45),IFET=$P(RIT,"|",46),VDPC=$P(RIT,"|",47) 
 S VPSD=$P(RIT,"|",48),ICFT=$P(RIT,"|",49),ILCP=$P(RIT,"|",50) 
 S NFSC=$P(RIT,"|",53),LORE=$P(RIT,"|",54),EFPP=$P(RIT,"|",55) 
 S AIPI=$P(RIT,"|",28),ITRP=$P(RIT,"|",56),IPIN=$P(RIT,"|",58) 
 S AICM=$P(RIT,"|",60),AIRE=$P(RIT,"|",61),IICM=$P(RIT,"|",62) 
 S TPRZ=$P(RIT,"|",65) 
 ; recupera prazo cobranca
 S TPCB=$P(RIT,"|",66),PZCB=$P(RIT,"|",67),CCOA=$P(RIT,"|",68) 
 S NTAN=$P(RIT,"|",69),Q20C=$P(RIT,"|",70) 
 ;
 S DDRF=$P(RIT,"|",94),NDRF=$P(RIT,"|",95),DNOR=$P(RIT,"|",96),ITRF=$P(RIT,"|",97)
 S DMSC=$P(RIT,"|",98)
 ; 
 S NPEE=$P(RIT,"|",100),NIPE=$P(RIT,"|",101)              ; tarrefa 006039EE
 ;
 ;<Amauri - Projeto 4%> Desligando versão anterior
 ; tarefa 005FBF20 - ASSIS 23/01/2013 - ICMS 4% - Tarefa 007B0113 Eliana 09/2013 Revisão
 ;S DFCI=$P(RIT,"|",102),NFCI=$P(RIT,"|",103),COIM=$P(RIT,"|",104),SFCI=$P(RIT,"|",105)
 ;</Fim Amauri - Projeto 4%> Desligando versão anterior
 ;
 ; <AMAURI - TAREFA 00458FCC - 02/09/2014>
 ; Projeto Convenio 38 (4%) - Funcionalidade do sistema ABADI para permitir cadastrar
 ; parametros fiscais a fim de atender a legislação do convênio 38 do ICMS
 ;
 S NFCI=$P(RIT,"|",103),ORIP=$P(RIT,"|",110)
 ;
 ; <FIM AMAURI - TAREFA 00458FCC - 02/09/2014>
 ;Dados de exportação
 S IDDR=$P(RIT,"|",111),NREE=$P(RIT,"|",112),CNFE=$P(RIT,"|",113)
 ;
 S VUDC=$P(RIT,"|",120) ; TAREFA 75941 - DSD - 04/2018
 S VBOM=$P(RIT,"|",121) ; TAREFA 75941 - DSD - 04/2018
 ;Recupera dados de preço nacional e importado, para fins de alteração de preço conforme a origem.
 Set VULE=$P(RIT,"|",122),VFPI=$P(RIT,"|",124)
 Set VULN=$P(RIT,"|",123),VFPN=$P(RIT,"|",125)
 Set VUNV=$P(RIT,"|",126) ; <flcarvalho - GDTI-4701 - Tarefa-112791 - Faturamento antecipado Vendor - 2019/08>
 Set DFAG=$P(RIT,"|",127) ; <flcarvalho - GDTI-5608 - 2020/03 - Diferença entre o valor unitário original e o ganho de ajuste (arredondamento)>
 ;
 S X=$P(RIT,"|",1,28) 
 F I=28:-1:1 I $P(RIT,"|",I)'?1"" Q
 ; 
 S RIT=$P(RIT,"|",1,I)
 S $P(RIT,"|",8)=DENT
 S CPRO=$P(RIT,"|",1),IPRI=$P(RIT,"|",2),QPED=$P(RIT,"|",3) 
 S VUNP=$P(RIT,"|",4),ISUS=$P(RIT,"|",14),IATP=$P(RIT,"|",16) 
 S IADC=$P(RIT,"|",17),ISUD=$E(ISUS,1) 
 I CPRO=12000000 S ISUS="000000" 
 I $G(IFAV)=1 S ISUS="000000" ; <flcarvalho - GDTI-4701 - Tarefa-112791 - Faturamento antecipado Vendor - 2019/08>
 S W=^IBPRO(CPRO),CIPI=$P(W,"|",13),CGMP=$P(W,"|",15),CLPR=$P(W,"|",24) 
 S W=^IBDEP(CDEE),CUFD=$P(W,"|",8) 
 K K,W,%DI //Defeito59634 - ASSIS 30.09.17
 I DENT?1"P" S ISUS="000000" G TRI1 ; Pedido programado
 D TEE 
TRI1 I ISUS?1"000000"!(DFAB&EEMB) S $P(RIT,"|",10)=CTRA 
 ;
 ;Implementacao CODIF - Portaria CAT 91/06 - SEFAZ/SP
 D DAP ;Determina Autorizacao Previa
 ;
 I $D(ALC(XITPE)) D ALI
 D GRI 
 I $D(ALC(XITPE)),$D(^IFAUX(PART,9))#10 S ^IFPED(CDEE,NPED,0,NITPE,1)=^IFAUX(PART,9) ; transp. eventual
 I "0586/6586"[CDEE,CTRA=2950 S ^IFPED(CDEE,NPED,0,NITPE,1)="TRANSPORTE CONTRATADO P/CLIENTE|ESTRADA DO CHAPERO,943|ITAGUAI|RJ" 
 I ISUS'?1"000000" F I=1:1:6 I $E(ISUS,I)?1"1" S ^IFPSU(CDEE,I,NPED,NITPE)=""
 I ISUS'?1"000000" G TRI2
 I DENT?1"P" G TRIZ ; Pedido programado
 ;
 If $D(ALC(XITPE)) D ALO GoTo TRI2
 ;
 ;NAO ALOC.
 S ^IFPPA(CDEE,XDENT,CLPA,CCLI,NPED,NITPE)="" 
 ;
TRI2 ;
 S ^IFPPR(CDEE,CPRO,NPED,NITPE)=""
 S ^IFPDE(CDEE,XDENT,NPED,NITPE)="" 
 N CDEP
 S CDEP=CDEE,YZITPE=ITPE,ITPE=XITPE,HIPE=26 D ^IBSRHP S ITPE=YZITPE
TRIZ Quit
 ;
ALI ;Aloca Item
 I IADC=2 S SPED=2
 I IADC=1!(IADC=3) S SPED=3
 ;
 ;Implementacao CODIF - Portaria CAT 91/06 - SEFAZ/SP
 I INAP S SPED=2
 S $P(RIT,"|",89)=INAP
 ;
 I CCAM?1"" S CCAM=0 
 I '$D(NCOM) S NCOM=0 
 I NCOM?1"" S NCOM=0 
 S QACO=NCOM_";"_QPED 
 S $P(RIT,"|",9)=VIAG,$P(RIT,"|",10)=CTRA,$P(RIT,"|",11)=CCAM,$P(RIT,"|",12)="",$P(RIT,"|",13)=SPED
 S $P(RIT,"|",47)=QACO 
 K QACO 
 D TRANS^IBSRDF(CTRA,.TPST),TRPIM^IBSRDF(CTRA,.CVTR)
 I CTRA'?1"1".E!EEMB!(TPST=1&(CVTR'?1"1")) G ALIZ 
 I $D(^IBAUT(CDEE))#10=0!'##class(cbpi.abadi.basico.VeiculoFacade).existe(1,CCAM),TPST=1,CVTR?1"1" G ALIZ 
 ;F I=1:1:10 S XNCOM=I I $D(ALC(XITPE,XNCOM)) S QALO=ALC(XITPE,XNCOM),QACO=XNCOM_";"_QALO,$P(RIT,"|",I+46)=QACO
 S XNCOM="" F I=1:1:10 S XNCOM=$O(ALC(XITPE,XNCOM)) Q:XNCOM?1""  S QALO=ALC(XITPE,XNCOM),QACO=XNCOM_";"_QALO,$P(RIT,"|",I+46)=QACO 
 K XNCOM,QALO,QACO,K 
ALIZ Q  
 ;
GRI ;GRava Item
 ;
 S $P(RIT,"|",14)=ISUS,$P(RIT,"|",16)="" ; nao grava IATP
 S $P(RIT,"|",12)=IFDG,$P(RIT,"|",37)=VUFD,$P(RIT,"|",38)=PADL 
 S $P(RIT,"|",39)=VULI,$P(RIT,"|",41)=VMVC,$P(RIT,"|",42)=IINF 
 S $P(RIT,"|",43)=CMOR,$P(RIT,"|",44)=VFCI,$P(RIT,"|",45)=VMAX 
 S $P(RIT,"|",46)=VDEP,$P(RIT,"|",57)=ESTO,$P(RIT,"|",58)=VTTB 
 S $P(RIT,"|",59)=IPDA,$P(RIT,"|",60)=IFET,$P(RIT,"|",61)=VDPC 
 S $P(RIT,"|",62)=VPSD,$P(RIT,"|",63)=ICFT,$P(RIT,"|",65)=ILCP 
 S $P(RIT,"|",66)=NFSC,$P(RIT,"|",68)=LORE,$P(RIT,"|",70)=EFPP 
 S $P(RIT,"|",71)=IPIN 
 S $P(RIT,"|",35)=IICM,$P(RIT,"|",36)=AICM 
 S $P(RIT,"|",73)=TPRZ,$P(RIT,"|",74)=PRAZ
 ; grava prazo de cobranca
 S $P(RIT,"|",76)=TPCB,$P(RIT,"|",77)=PZCB,$P(RIT,"|",78)=CCOA,$P(RIT,"|",79)=NTAN,$P(RIT,"|",80)=Q20C 
 ; usuario / licenca ambiental
 S:$D(ULAM) $P(RIT,"|",93)=ULAM  
 S $P(RIT,"|",94)=DDRF,$P(RIT,"|",95)=NDRF,$P(RIT,"|",96)=DNOR,$P(RIT,"|",97)=ITRF
 S $P(RIT,"|",98)=DMSC
 ;
 S $P(RIT,"|",104)=NIPE              ; tarrefa 006039EE 
 ;
 ;Grava Parâmetros p/ Frete Fluvial - Atende Tarefa No. 0066B91C
 S:$D(COMD) $P(RIT,"|",101)=COMD ;Comboio Duplo
 S:$D(IDBA) $P(RIT,"|",102)=IDBA ;Balsa Aliviada
 ;------------------------------------------------------------------
 ;<Amauri - Projeto 4%> Desligando versão anterior
 ; tarefa 005FBF20 - ASSIS 23/01/2013 - ICMS 4% - Tarefa 007B0113 Eliana 09/2013 Revisão
 ; S:'$D(NFCI) (DFCI,NFCI,COIM,SFCI)="" S $P(RIT,"|",105)=DFCI,$P(RIT,"|",106)=NFCI,$P(RIT,"|",107)=COIM,$P(RIT,"|",108)=SFCI
 ;</Fim Amauri - Projeto 4%> Desligando versão anterior
 ;
 ; <AMAURI - TAREFA 00458FCC - 02/09/2014>
 ; Projeto Convenio 38 (4%) - Funcionalidade do sistema ABADI para permitir cadastrar
 ; parametros fiscais a fim de atender a legislação do convênio 38 do ICMS
 ;
 Set $P(RIT,"|",106)=NFCI
 Set $P(RIT,"|",110)=ORIP
 ;
 ; <FIM AMAURI - TAREFA 00458FCC - 02/09/2014>
 ;NFe 3.10 - Dados de exportação
 Set $P(RIT,"|",111)=IDDR,$P(RIT,"|",112)=NREE,$P(RIT,"|",113)=CNFE
 ;
 S FLG=0 S:$D(^IFPED(CDEE,NPED,0,NITPE)) FLG=1
 ;
 ;----------------------------------------------------------------------------------[ Sergio Freesz ]--
 ///Referencia de Cliente Falso Cif no item do Pedido - Atender Painel de Operações
 S FCIF="N"
 I $D(^IBCFC(CDEE,CCLI)) S X=^IBCFC(CDEE,CCLI),FCIF=$P(X,"|",1)
 S $P(RIT,"|",117)=FCIF
 ;
 S $P(RIT,"|",120)=VUDC ; TAREFA 75941 - DSD - 04/2018
 S $P(RIT,"|",121)=VBOM ; TAREFA 75941 - DSD - 04/2018
 ;Grava dados de preço nacional e importado, para fins de alteração de preço conforme a origem.
 If $G(VULE)>0 Set $P(X,"|",122)=VULE,$P(X,"|",124)=VFPI
 If $G(VULN)>0 Set $P(X,"|",123)=VULN,$P(X,"|",125)=VFPN
 ;
 I ($G(IFAV)=1)||($G(ISRV)=1) S $P(RIT,"|",133)=VUNV ; <flcarvalho - GDTI-4701 - Tarefa-112791 - Faturamento antecipado Vendor - 2019/08>
 S $P(RIT,"|",135)=$J($G(DFAG),0,2) ; <flcarvalho - GDTI-5608 - 2020/03 - Diferença entre o valor unitário original e o ganho de ajuste (arredondamento)>
 ;
 S ^IFPED(CDEE,NPED,0,NITPE)=RIT
 ;
 ;<AUD - Projeto ELO - GAP FAT10 - Informações para o CDATA>
 ;<OBS. IMPORTANTE>
 ; O conceito de NPEC é o mesmo de NPEI
 ; Trata-se do Número do Pedido Externo
 ;</OBS. IMPORTANTE>
 ;
 Set NPEI=""
 If $D(NPEE) Set NPEI=NPEE
 If $D(^IFAUX(PART,0,NITPE,1)) {
	Set X=^IFAUX(PART,0,NITPE,1)
 	Set CPEC=$Piece(X,"|",1)
 	Set NPEC=$Piece(X,"|",2)
 	Set DPCL=$Piece(X,"|",3)
 	Set ICPC=$Piece(X,"|",4)
 	Set NPEI=NPEC
	;
	Set ^IFPED(CDEE,NPED,0,NITPE,7)=CPEC_"|"_NPEC_"|"_DPCL_"|"_ICPC
	;
 }
 ;<AUD - Projeto ELO - GAP FAT10 - Informações para o CDATA>
 ;
 ;<Aud - Registrar o Pedido Externo por Item>
 Set X=^IFPED(CDEE,NPED,0,NITPE)
 Set $Piece(X,"|",119)=NPEI
 Set ^IFPED(CDEE,NPED,0,NITPE)=X
 ;</Aud - Registrar o Pedido Externo por Item>
 ;
 ;Projeto Adequações Sistêmicas - Central de Operações - Restrição Operacional
 Do NovoItem^IFSRPR(CDEE,NPED,NITPE)
 ;If $Data(^IFROB(CDEE)) Do RestOperac
 ;
 ;HPJ TAREFA Nº 000702B2 10/2013
 I ISUS?1"000000" D SMS2 
 I ISUS'?1"000000" D SMS1
 ;
 I 'FLG D LOG
 S IUBO=$P(RIT,"|",7) 
 I CLPR=1,CTOP="01" S VPROD(XITPE)=CPRO_"|"_QPED_"||"_NPED_"|"_NITPE_"|"_IUBO K IUBO 
 I DENT?1"P" S ISUS="000000" G GRIZ ; Pedido programado
 ;**** TRATA ESTOQUE TECNICO - ALTERADO POR ROBERTO ALVES
 S QPED=$P(RIT,"|",3) 
 I CNOS?1"030267" S W=^IECON(CCLI,CPRO),QRES=$P(W,"|",3),QRES=QRES-QPED,$P(W,"|",3)=QRES,^IECON(CCLI,CPRO)=W,^IECON(CCLI,CPRO,0,CDEE,NPED,XITPE)=QPED 
 I CNOS?1"030269" S TPTR="A",YZITPE=ITPE S ITPE=NITPE D ^IBSRET S ITPE=YZITPE ; Trata Estoque Tecnico
 D VER^IBSREP               ; Trata Empenho Cia ( Verifica Cliente )
 I WPF1=1 S WPF1=0 G GRI1 
 S XCPR=CPRO 
 D PRD^IBSREP               ; Trata Empenho Cia ( Verifica Produto)
 I WPF1=0 S TPTS="A",YZITPE=ITPE,ITPE=NITPE D EMP^IBSREP S ITPE=YZITPE G GRI1 
 S WPF1=0 
GRI1 K RIT 
GRIZ Q  
 ;
TSJ ; Trata Status Pedido Janela
 ; ATENCAO: Usado nos programas ^IFPEAT0E, ^IFPEAT63, ^IFPEAT6F
 N USPR,PGSJ,DTHO,USRT
 S USPR="N",USRT=%US
 S X=$G(^IFPJU(2,USRT)),PGSJ=$P(X,"|",1)
 I PGSJ?1"S"!($D(^IFPJU(2,USRT,CDEE))) S USPR="S"
 ;
 K GHJ
 I $G(IDPJ) D CPJ I 1
 //E  D
 //.I IDPJH'?1"",'IDPJH,IDPJ W /ICC20,/RAW("ATENCAO: Esta Operacao reclassificou o status do pedido de NORMAL p/JANELA."),/ICC13 $$$ReadWait(5) ; S HIPE=40,RGAN="Normal|Janela|"_$ZName D ^IBSRHP
 //.S MVMS="",GHJ="" D GHJ K GHJ ; grava GHJ="" dados no historico do pedido.
 ;
TSJZ Q
 ;
CPJ ; Confirma Pedido Janela
 ;
 D ^IBSRDG001
 //I RCONFIRMA?1"N" S IDPJ=0,GHJ="" W /ICC20,/RAW("Alterando status do pedido..."),/ICC13 $$$ReadWait(2)
 //D GHJ
 G CPJZ
 ;
 ; As linhas a seguir foram desativadas - Janelas de Dialogo
 ;
CPJ1 W /ICC20,/RAW("ATENCAO: Pedido Janela. Confirma? S// ") U 0:(256:"FC":$C(21,24)) $$$Read(Rx)  S:$A($ZB)=21!($A($ZB)=24) Rx=$ZB W:$A($ZB)=24 /ICC24 U 0:(256:"SFC":$C(21,24)) W /ICC20,/ICC13 
 I Rx?1"" S Rx="S"
 I ",S,N,"'[(","_Rx_",") S MS=$S(Rx'?1"?":"ERRO: ",1:"")_"Padrao - Deve ser S(im) ou N(ao).",ER="" D ^GAP.GAREM $$$ReadT(X,2)  G CPJ1 
 I Rx?1"S" S MVMS="" D GHJ G CPJZ 
 ;
CPJ2 W /ICC20,/RAW("Informe o motivo: ") U 0:(256:"FC":$C(21,24)) $$$Read(Rx)  S:$A($ZB)=21!($A($ZB)=24) Rx=$ZB W:$A($ZB)=24 /ICC24 U 0:(256:"SFC":$C(21,24)) W /ICC20,/ICC13 
 I $A(Rx)=21 G CPJ1
 I Rx?1"" S MS="ERRO: Campo obrigatorio.",ER="" D ^GAP.GAREM $$$ReadT(X,2) G CPJ2
 I Rx'?1ANP.ANP!($L(Rx)>60) S MS=$S(Rx'?1"?":"ERRO: ",1:"")_"Padrao - Ate' 60 caracteres alfanumericos.",ER="" D ^GAP.GAREM $$$ReadT(X,2) G CPJ2
 S MVMS=Rx,IDPJ=0,GHJ=""
 ;
 W /ICC20,/RAW("Alterando status do pedido..."),/ICC13 $$$ReadT(X,2)
 D GHJ
 ;
CPJZ Q
 ;
GHJ ; Grava Historico Janela
 S DTHO=$$H^sistema.DOLLAR
 D ^IBSRJA
 N ITPE
 S X=^IFPED(CDEE,NPED),$P(X,"|",9)=IDPJ,^IFPED(CDEE,NPED)=X
 S ITPE=" " I $D(^IFHJU(2,CDEE,NPED,ITPE))!($D(GHJ)) S ^IFHJU(2,CDEE,NPED,ITPE,DTHO)=USRT_"|"_%AP_"|"_%MOD_"|"_%ROT_"|"_MVMS_"|"_IDPJ_"|"_DENT
 S ITPE=""
GHJ1 S ITPE=$O(^IFPED(CDEE,NPED,0,ITPE)) I ITPE?1"" G GHJZ 
 S X=^IFPED(CDEE,NPED,0,ITPE),$P(X,"|",92)=IDPJ,^IFPED(CDEE,NPED,0,ITPE)=X 
 S ^IFHJU(2,CDEE,NPED,ITPE,DTHO)=USRT_"|"_%AP_"|"_%MOD_"|"_%ROT_"|"_MVMS_"|"_IDPJ_"|"_DENT
 G GHJ1
GHJZ Q
 ;  
LOG ; Grava no log de historico 
 N CDEP
 // Grava no historico qualquer inclusao de quantidade do pedido
 S YZITPE=ITPE,ITPE=NITPE,HIPE=11,CDEP=CDEE D ^IBSRHP S ITPE=YZITPE
 Q  

viagemEstaCompleta(CDEE,DSAI,VIAG,CTRA,CCAM)
	;
 	New oListaCompartVeic,iKey,oVeicCompart,sequencial,bEstaImcompleto,iCompart
	Set oVeiculo=##class(cbpi.abadi.basico.veiculo.Veiculo).instanciar(CCAM)
	Set oListaCompartVeic=oVeiculo.getCompartimentos()
	;
	Set iCompart=0
	Set bEstaCompleta=1
	Set iKey=""
	For  
	{
		Set iKey=oListaCompartVeic.Next(iKey)
		If iKey="" Quit
		;
		Set oVeicCompart=oListaCompartVeic.GetAt(iKey)
		Set sequencial=oVeicCompart.sequencial
		;
		Set iCompart=$INCREMENT(iCompart)
		If '$D(^IFPRC(CDEE,DSAI,VIAG,CTRA,CCAM,iCompart)) Set bEstaCompleta=0
	}
	;
	Quit bEstaCompleta
	;
eCombustivel(CPRO)
	Set X=^IBPRO(CPRO)
	Set TPRO=$P(X,"|",21)
	Set CLPR=$P(X,"|",24)
	If (CLPR=1)&&(+TPRO=0) quit 1
	Quit 0
	
confirmarAssociacao(CCAM)  ;Solicita confirmação para associar os lacres/envelopes das viagens
	;
	New textoMsg,Ind,resposta,seqmsg,brancos,iseqM
	;
	Kill textoMsg
	Set textoMsg=""
	Set brancos="",$Piece(brancos," ",50)=" ",iseqM=0
	Set tamMaximoTXT=50
	;
	Set pstrResposta=""
	;
	Set textoMsg($i(iseqM))=$C(13,10)_"As alocações para esta viagem foram concluidas."
	Set textoMsg($i(iseqM))=$C(13,10)_""
	Set textoMsg($i(iseqM))=$C(13,10)_"O veículo "_CCAM_" esta totalmente carregado."
	Set textoMsg($i(iseqM))=$C(13,10)_""
	;
	For iLin=1:1:$Order(textoMsg(""),-1)
	{
		Set txt=textoMsg(iLin)
		Set txt=txt_$Extract(brancos,1,tamMaximoTXT-$Length(txt))
		Set textoMsg=textoMsg_txt
	}
	;
	set msg="Deseja associar os Lacres e Envelopes agora  ?"
	Do ^sistema.MsgBox(textoMsg,4,"",1,.pstrResposta,"S",1,msg)
	;
	If pstrResposta'="S" Quit 0
	;
	Quit 1

RestOperac
 	New P1,P2,P3,P4,P5
 	Set P1=CDEE,P2=NPED,P3=NITPE,P4=CCLI,P5=CPRO
 	Do ^IFSRPR
 	Quit

CRR D CRR^IBSRMP(CDEE,NPED,NITPE) Q
TEE D TEE^IFPEAT0F Q  
ALO D ALO^IFPEAT0F Q  
APE D APE^IFPEAT0F Q  
EEM D EEM^IFPEAT0F Q  
DAP D DAP^IBSRAA Q
REM D ^GAP.GAREM $$$ReadT(X,3) Q
SMS1 D SEF^IBSR.faturamento.EnvioSMS(CDEE,NPED,1,0) Q  ;HPJ TAREFA Nº 000702B2 10/2013
SMS2 D SEF^IBSR.faturamento.EnvioSMS(CDEE,NPED,2,0) Q  ;HPJ TAREFA Nº 000702B2 10/2013	
]]></Routine>


<Routine name="IFPEAT12" type="MAC" languagemode="0" timestamp="65441,38317.849363"><![CDATA[
IFPEAT12 ;Atendimento a Cliente <V1.0-PNC-09/94> ; Última Alteração   RICARDOEB 26/04/2018 10:22:21 ;Última Alteração   FLCARVALHO 03/03/2020 10:38:37
#Include sistema.BibliotecaMacro
 ;  
LDP ;Le Dados Produtos 
 ;
 I $D(^ISUEA(%US)) W /ICC20,/RAW("Tecle <PF3> para relacao de produtos válidos."),/ICC13
 ;
LDP0 S (CPRO,NPRO,CUME,CIPI,CEMB,PBRU,AIPI,IPRT,ITRI,ITRP)="" 
 S (PADL,VUNP,VUNV,VULI,VFRU,QPED,IUBO,QKGC,LCOB,PRAZ,VTTB,IPDA,DMSC)="" 
 S (TAMO,DAMO,TAMB,IFRC,CMOR,IINF,VFCI,VMVC,VMAX,VDEP,IFET,VTDA,DFAG)="" 
 S (VDPC,VPSD,ICFT,NFSC,LUB,LFU,LVU,LPA,VOL,IPRI,EFPP,CCOA,NDRF,DNOR,ITRF)="" 
 S (TPCB,PZCB,NTAN,Q20C,NPEE,NIPE,VUDC)="" 
 ;<Amauri - Projeto 4%> Desligando versao anterior
 ; S (DFCI,NFCI,COIM,SFCI)="" ; ICMS 4% - Tarefa 007B0113 Eliana 09/2013 Revisão
 ;</Fim Amauri - Projeto 4%> Desligando versao anterior
 S (TPRZ,IPIN,PF1)=0 
 K IPDG 
 I $D(^IFAUX(PART,0,ITPE)) D RIT I 1
 E  W /CUP(40+ITPE-31,4),/ICC24 
 ;
LDP1 ;le codigo produto
 W /CUP(15,4),/ICC24,/FVALUE($E(NPRO,1,28)) 
 W /CUP(40+ITPE-31,4),/CON U 0:(256:"FC":$C(21,24)) $$$Read(R)  S:$A($ZB)=21!($A($ZB)=24) R=$ZB W:$A($ZB)=24 /ICC24 U 0:(256:"SFC":$C(21,24)) W /COFF,/ICC20,/ICC13,/CUP(22,1),/ED(0) 
 I R?1"",CPRO?1"",'$D(^IFAUX(PART,0)) S MS=2 D ^GAP.GAREM G LDP1 
 ;Tratamento para simples remessa de faturamento antecipado ou faturamento por conta e ordem
 I R?1"",CPRO'?1"" S R=CPRO D:CTOP="03"&&((CDOP=61)||(CDOP=92)) LDR G:'PF1 LDP31  S PF1=0 G LDP1 
 ;I R?1"" S QTM=0 D QTM I QTM S MS="Politica de volume minimo, quantidade inicial de 10.000 litros no pedido" D ^GAP.GAREM G LDP1 
 I R?1"" G LDPZ
 I $A(R)=21,ITPE=1 S VOL=1 F ITPE=5:-1:1 D LIM,LPI I ITPE=1 G LDPZ 
 I $A(R)=21 S ITPE=ITPE-1 G LDP0
 I $A(R)=23 S iCPR="P" D FES K iCPR I R?1"" G LDP1 
 I $A(R)=24,$D(^IFAUX(PART)),$O(^IFAUX(PART,0,ITPE))?1"" D EXC,LPI,TTP G LDP0 
 I $A(R)=26 S SAI=1 G LDPZ 
 I $A(R)>21,$A(R)<27 S MS=3 D ^GAP.GAREM,EPS G LDP1 
 I R'?1N.N!(R?1N.N&(+R'<1000)) G LDP2
 I $D(^IBCSP(2,+R))#10'=1 S MS=569 D ^GAP.GAREM G LDP1 
 S X=^IBCSP(2,+R),R=$P(X,"|",1) 
LDP2 S L=17 D ^IBSRIP D:EXBI TDG,RDG I R<0 D EPS G LDP1 
 ;
 // HPJ 03/2015 TAREFA 004BDCCF
 // Permitir a inclusao do mesmo codigo de produto para cliente carrefour
 ;
 ;N NRGE
 ;S NRGE=0
 ;I $D(^ICIGE(CCLI)) S X=^ICIGE(CCLI),NRGE=$P(X,"|",1) 
 //
 S A=0,IT="" F I=1:1 S IT=$O(^IFAUX(PART,0,IT)) Q:IT?1""  S X=^IFAUX(PART,0,IT) I $P(X,"|",1)=R S A=1 Q
 ; I A=1,NRGE'=1562 S MS=593 D ^GAP.GAREM,EPS G LDP1
 I A=1 S MS=593 D ^GAP.GAREM,EPS G LDP1
 ;
 S iCPR="L" D CPR K iCPR ; Módulo de Crítica do Prod.Claro/Escuro (MS'?1"" -> Produto inválido)
                         ; . todas as críticas do campo de leitura estão agrupadas nesse módulo para serem compartilhadas 
                         ;   também na seleção dos produtos válidos na função <F3>, opção 9-PRD (FES^IFPEAT0) - DSD 08/10
 I MS'?1"" D ^GAP.GAREM,EPS G LDP1
 ;
 /*
 ;Pedido de Combustível não vai utilizar FCI - ELIANA 10/2013
 ; tarefa 005FBF20 - ASSIS 15/01/2013 - ICMS 4% - Tarefa 007B0113 Eliana 09/2013 Revisão
 I $D(^ILNAQ(1,CNOP)),'$D(^ILPSS(1,R)) {
	 S MS="Essa natureza exige cadastro do produto na LIF/MI/PS. Utilize outra Natureza de Operação." 
	 D ^GAP.GAREM,EPS G LDP1
 }
 */
 ;
 ;TAREFA 00708CDF - IPI não deve integrar a base de calculo do ICMS - ASSIS 26/10/12
 I $D(^ILSIP(CCLI,R)) {
	 I CUFE=CUFD S:$E(CCLI,1,8)=33337122 CNOP=584058 S:$E(CCLI,1,8)'=33337122 CNOP=584010
	 //I CUFE=CUFD S:DFAB CNOP=584058 S:'DFAB CNOP=584010 //<EM TESTE>TAREFA 46825 - ASSIS 28.05.17
	 I CUFE'=CUFD S:$E(CCLI,1,8)=33337122 CNOP=684058 S:$E(CCLI,1,8)'=33337122 CNOP=684014
	 //I CUFE'=CUFD S:DFAB CNOP=684058 S:'DFAB CNOP=684014 //<EM TESTE>TAREFA 46825 - ASSIS 28.05.17
	 S X=$G(^IBNOP(CNOP)),CNOS=$P(X,"|",4),CTOP=$E(CNOS,1,2),COOP=$E(CNOS,3,4),CDOP=$E(CNOS,5,6)
 } 
 ; 
 ;
 S CLPR=XCLPR,EEMB=XEEMB 
 I +AIPI=0 S AIPI="" 
 I ITPE=1,'IPI S IPI=1 D IPI I 1 
 E  I IIPI'=1 S AIPI="",ITRP=0 
 I $D(^IBCSP(1,R)) S X=^IBCSP(1,R),XNPRO=$P(X,"|",4)
 I CTOP="01",$D(^IETEC(CCLI,R)) S X=^IETEC(CCLI,R),QRES=$P(X,"|",5) I +QRES>0 D SET I SAI G LDPZ 
 ; 
 I $D(^IFEDC(CDEE)),OPC=1,CTOP="01" D MDP 
LDP3 I CPRO'?1"",CPRO'=R D LCM 
 S CPRO=R,NPRO=XNPRO D EPS 
 // Para simples remessa, sera associada a nota de faturamento antecipado
 I (CTOP="03")&&((CDOP=61)||(CDOP=92)) D LDR I PF1 S PF1=0 G LDP1
 // 
 S CCMK=CMKC I TPRO S CCMK=CMKE
 I '$D(ICCR) D CRP I $D(^IBMFR(CMUE)) D TRF 
 // HPJ GDTI 1638 
 // Restrição da central de operações rotina fat/pe/pj opção 2  
 // ; Inibida por DSD - 08/2018 (Alteração HPJ) ; S IDBJ=0 D ^IBSRBJ 
 // ; Inibida por DSD - 08/2018 (Alteração HPJ) ; I IDBJ,$$$Ambiente=$$$AmbienteProducao S MS="Central Operações informa: Não será possivel registrar pedido na data de entrega solicitada." D ^GAP.GAREM $$$ReadT(X,3)  G LDP0 
 ;I IDBJ,$$$Ambiente'=$$$AmbienteProducao S MS="Atenção: Pedido fora de horário de entrega em ambiente de produção." D ^GAP.GAREM $$$ReadT(X,3) 
 // ; Inibida por DSD - 08/2018 (Alteração HPJ) ; I IDBJ,%US="TRN" S MS="Central Operações informa: Não será possivel registrar pedido na data de entrega solicitada." D ^GAP.GAREM $$$ReadT(X,3)  G LDP0 
 //
 D ^IBSRBL I MS'?1"" D ^GAP.GAREM $$$ReadT(X,3)  I PBLQ D EPS G LDP0 ; Verifica bloqueio de pedidos (PBLQ)
 ;Define ESTO
 S ESTO=1 Do ^IBSRES
 ;Se estoque for controlado pela IEEMB, exibe o saldo e o saldo disponível.
 D EED^IFPEAT41 If VOLTA G LDP1
 ;
 I CTOP?1"01",$D(^IETEC(CCLI,CPRO,2)) D TET 
 I CNOS="010267" D TCO I PF1CON K PF1CON G LDP1 
 S DURV=DENT I DURV?1"99999"!(DURV?1"P") S DURV=DFAT 
 D ^IBSRCA I CAL D ^GAP.GAREM S CAL=0 G LDP0 
 S REG=^IBDEP(CDEE),CGCD=$P(REG,"|",37) 
 S REG=^IBCLI(CGCD,1),XCMOR=$P(REG,"|",4) 
 I "1;2;3"[OPC,$D(^ILCST(1,CCLI)),XCLPR=1,$E(CNOP,1)?1"6",XCMOR'=CMOR S MS=570,CMS="Compra de combustivel com liminar",CMS1="para cliente fora do estado" D ^GAP.GAREM,EPS G LDP0 
 I '$D(NLECF) D PCF 
 D CIN 
 I OPC=1,CTOP="01" D VHV I MS'?1"" S ER="" D ^GAP.GAREM ;$$$ReadT(X,3) ; W /BELL,/BELL,/BELL D ^GAP.GAREM $$$ReadT(X,3)  
 S MS="" 
 I DENT<58257,"11/10/15"[$E(CPRO,1,2),$D(^IBSPI($E(CCLI,1,12))) S MS="* Cliente com isencao de PIS *" 
 I DENT<58257,"11/10/15"[$E(CPRO,1,2),$D(^IBSCO($E(CCLI,1,12))) S MS="* Cliente com isencao de COFINS *" 
 I DENT<58257,"11/10/15"[$E(CPRO,1,2),$D(^IBSCO($E(CCLI,1,12))),$D(^IBSPI($E(CCLI,1,12))) S MS="* Cliente com isencao de PIS e COFINS *" 
 // Produtos maritimos(1506/1566), exige a obrigatoriedade do SELO  ;;  ASSIS 16/12/2011 ;; obrigatoriedade retirada pela Marcela - Tributos
 //I $G(SEPE)?1"",",1506,1566,"[(","_$E(CPRO,1,4)_",") S MS="Produtos maritimos(1506/1566), exige a obrigatoriedade do SELO"  D ^GAP.GAREM,EPS G LDP0
 // 
 I MS'?1"" S ER="" W /BELL D ^GAP.GAREM $$$ReadT(X,3)  
LDP31 I $D(^IBCCO(CDEE)),CTOP="02","13/10"[$E(CPRO,1,2) D LCO
 ;
 ;
LDP4 G LDP4^IFPEAT13 
 ;
LDPZ Q  
 ;
CPR ; Critica Produto - Crítica da leitura do Campo Produto       - iCPR="L"
 ;                    - Seleciona Produtos Válidos na Função <F3> - iCPR="P"
 ;
 ; Módulo de Crítica do Prod.Claro/Escuro (MS'?1"" -> Produto inválido)
 ; . todas as críticas do campo de leitura estão agrupadas nesse módulo para serem compartilhadas 
 ;   também na seleção dos produtos válidos na função <F3>, opção 9-PRD (FES^IFPEAT0) - DSD 08/10
 ;
 S MS=""
 ;
 ;Atende Tarefa No. 0061C283 - Figueiredo, 13/10/2008 - Diesel Original Maritmo
 I CDEE="0806",R=15060008 S ER="",MS="Filial não comercializa este produto" G CPRZ
 ; 
 I $E(R,1,2)="71" S MS="Código bloqueado, utilize o novo código." G CPRZ
 ;
 ; Recupera Dados do Produto
 S X=^IBPRO(R),XNPRO=$P(X,"|",2),XCLPR=$P(X,"|",24),XAPLD=$P(X,"|",25),CUME=$P(X,"|",5) 
 S CEMB=$P(X,"|",4),ITRP=$P(X,"|",7),AIPI=$P(X,"|",8),PBRU=$P(X,"|",9),CIPI=$P(X,"|",13) 
 S TPRO=$P(X,"|",21),IPRT=$P(X,"|",20),ITRI=$P(X,"|",18),EMPE=$P(X,"|",19),CGPR=$P(X,"|",33),SGPR=$P(X,"|",34),IDCA=$P(X,"|",38),IPRE=$P(X,"|",39)
 S X=^IBEMB(CEMB),XEEMB=$P(X,"|",3) 
 S X=$G(^IBCLI(CCLI,2)),CZVC=$P(X,"|",4) 
 ;
 I XCLPR'=1 S MS=154 G CPRZ
 I 'XEEMB,"11100/11150/11200/11250/11255/11260/11270"[CNEG,R?1"11000007"!(R=11000008) S MS=799 G CPRZ
 I 'XEEMB,XCLPR=1,$E(CNEG,1,3)=127 S MS="Nao e' permitido fazer operacao com combustivel para Franquias." G CPRZ
 I OPC=1,TPRO'=0 S MS=301,CMS="Produto",CMS1="claro" G CPRZ
 I OPC=2,TPRO=0 S MS=301,CMS="Produto",CMS1="escuro" G CPRZ 
 ;;;I "RN"[CUFD,CTOP="01",CUFE'=CUFD,'XEEMB,"11/15"[$E(R,1,2) G CPRZ
 I CZVC?1"" S MS=889,CMS="combustiveis",CMS1="registrar" G CPRZ 
 I XEEMB'?1"0" S MS=533,CMS="granel" G CPRZ 
 I '$D(FLAGNP),IPRE?1"N" S MS="Não Produto não pode ser utilizado em rotina de produto" G CPRZ
 S CLPR=XCLPR,EEMB=XEEMB
 ;
 I CTOP="01",CUFD="RJ",'DFAB,EMGR'=7,R=12000000 S MS=390,CMS=CUFD G CPRZ
 I CNOS="020141",IPRT=2 S MS=810 G CPRZ
 I CDOP="67",'$D(^IECON(CCLI,R)) S MS=281,CMS="este produto",CMS1="a consignacao" G CPRZ
 I CNOS="030267" S X=^IECON(CCLI,R),QRES=$P(X,"|",3) I +QRES=0 S MS=587 G CPRZ 
 I CNOS="030269",'$D(^IETEC(CCLI,R)) S MS=281,CMS="este produto",CMS1="o estoque tecnico" G CPRZ 
 I CNOS="030269" S X=^IETEC(CCLI,R),DTER=$P(X,"|",4) I DTER<DFAT S MS=353,CMS="Data de faturamento",CMS1="data fim de Contrato de Estoque Tecnico",ER="" G CPRZ
 ;
 D VER^IBSREP ; Verifica Empenho Cia
 I WPF1=1 S WPF1=0
 E  I WDTER<DFAT S MS="Cliente c/Vigencia vencida, Empenho Cia.: "_WEMP,ER="" G CPRZ 
 ;
 I CTOP?1"01",R="11000007","23201/23202/23622"[CNEG,"010231"'[CNOS S MS=550 G CPRZ 
 I "010231"[CNOS,R'="11000007" S MS=570,CMS="so'",CMS1="gasolina A" G CPRZ 
 I $E(CNEG,1,3)?1"113",$E(R,1,2)'=14 S MS=796 G CPRZ 
 ;
 ;linha abaixo - inclusão do código 15061801,02,03,04 - tarefa 0046559E - 27/12/2007 - rdsouza
 ;I CNEG="21000",'$D(^IBTDA(CCLI)),$E(R,1,2)="15",IDCA="S" S MS="Não é permitido a venda de Diesel Aditivado a TRR" G CPRZ ;Pedido de Samuel 1/7/99
 ; 
 ;Inibição em 13/10/10 tarefa: 006C2174
 ;I 'XEEMB,'$D(^IBRCG(CCLI)),"11100/11150/11200/11250/11255/11260/11270"[CNEG,"10/11/12/14/15"'[$E(R,1,2) S MS=799 G CPRZ
 ;
 I $E(CDEE,1,2)="03","0370/0318/0310/6370/6934/6310"'[CDEE,"11040001/11050001/11050002"[R S MS="Gasolina Premium so' deve ser atendida por Araucaria." G CPRZ ;Pedido EDENIR 13/07/99
 I R=11040001&&("0370/0310/6370/6310"'[CDEE!(CCLI'?1"92689256001801")) S MS=799 G CPRZ ; Exceto para Filial Araucaria enviando p/DPPI-Araucaria
 ; Chamado 1028 idesk 09/11/2004 Ricardo Cristovam - inibe linha abaixo
 ;;S DAT="26/02/97" D ^%DEI I DFAT>DAT,R=23001800 S MS="Produto deve ser 28001800." G CPRZ
 I EMPE=2 S MS=536 G CPRZ
 I "010206"[CNOS,R'?1"15".E S MS=570,CMS="so'",CMS1="oleo diesel" G CPRZ
 I "010205"[CNOS,R'?1"15".E,IPRT'=1 S MS=570,CMS="so'",CMS1="diesel ou lubrif. controlados" G CPRZ
 I CTOP="01",$E(CNEG,1)="1","17/19"[$E(R,1,2),$D(ICCR),'ICCR S MS=573 G CPRZ
 S DURV=DENT I DURV?1"99999"!(DURV?1"P") S DURV=DFAT
 ;
 S XPRO=R,XDVV=DURV D RPV ; TAR ALM-18861 - DSD - 05/2016 - DTCLEAN
 I CTOP="01"!("030267/030269/030261"[CNOS),'IPRM S MS="Produto inválido para o cliente." G CPRZ 
 ;
 I iCPR?1"P" D  I MS'?1"" G CPRZ
 .D DCA(R,$G(ICCR,0))
 ;
CPRZ Q
 ;
EED ;Exibe estoque disponivel
 S estCDEE=CDEE ; - Codigo da Dependência 
 S estCNOP=CNOP ; - Natureza de Operação
 S estCPRO=CPRO ; - Produto
 S estESTO=ESTO ; - Estoque Interno: 1-Base, 2-MLI, 3-FatDir, 4-Contabilidade, 5-Analise
 S estIPRI=IPRI ; - Qtde Completo (0) ou Incompleto (1)
 D EDF^IBSREB I 'ATUEST G EEDZ  ;Recupera Saldo de Embalado Disponível e Físico da Dependencia
 W /CUP(22,1),/ED(0) 
 W /CUP(23,1),/ICC28,/RAW("Estoque Disponivel para pedido -->"),/ICC29 W /RAW($FN(QDBA,".",0)) 
 W /CUP(24,1),/ICC28,/RAW("Estoque Fisico no deposito ------>"),/ICC29 W /RAW($FN(QPDP,".",0)) 
 K estCDEE,estCNOP,estCPRO,estESTO,estIPRI
EEDZ Q  
 ;
LPI ;LimPa Item (rot. duplicado)
 ;
 S X=40+ITPE 
 W /CUP(X-31,75),/ICC24 
 ; GDTI 3262 - TAREFA 84458 - DSD - 08/2018 - INCLUSÃO DE CAMPO P/DESC.COMERCIAL
 ;W /CUP(X-31,59),/ICC24,/CUP(X-31,43),/ICC24,/CUP(X-31,37),/ICC24,/CUP(X-31,25),/ICC24,/CUP(X-31,4),/ICC24 
 W /CUP(X-31,63),/ICC24,/CUP(X-31,49),/ICC24,/CUP(X-31,37),/ICC24
 W /CUP(X-31,31),/ICC24,/CUP(X-31,17),/ICC24,/CUP(X-31,4),/ICC24
 W /CUP(15,4),/ICC24 
 ;
LPIZ Q  
 ;
EPS ;Exibe Produto
 ; GDTI 3262 - TAREFA 84458 - DSD - 08/2018 - INCLUSÃO DE CAMPO P/DESC.COMERCIAL
 ;W /CUP(40+ITPE-31,4),/ICC24 I CPRO'?1"" W /RAW($E(NPRO,1,16)) I $L(NPRO)>15 $$$Read(X)  
 W /CUP(40+ITPE-31,4),/ICC24 I CPRO'?1"" W /FVALUE(CPRO)
 W /CUP(15,4),/ICC24 I CPRO'?1"" W /RAW($E(NPRO,1,28))
EPSZ Q  
 ;
RIT ;Recupera ITem
 S X=^IFAUX(PART,0,ITPE),CPRO=$P(X,"|",1),QPED=$P(X,"|",3) 
 S VUNP=$P(X,"|",4),IPDG=$P(X,"|",5),VFRU=$P(X,"|",6),IUBO=$P(X,"|",7),ISUS=$P(X,"|",14) 
 S IATP=$P(X,"|",16),IADC=$P(X,"|",17),TAMO=$P(X,"|",22) 
 S VITP=$P(X,"|",29),XPBRU=$P(X,"|",30),IFRC=$P(X,"|",26) 
 S QKGC=$P(X,"|",25),TAMO=$P(X,"|",22),DAMO=$P(X,"|",23) 
 S TAMB=$P(X,"|",24),VMVC=$P(X,"|",36),IINF=$P(X,"|",37) 
 S CMOR=$P(X,"|",38),VFCI=$P(X,"|",39),VMAX=$P(X,"|",40) 
 S VDEP=$P(X,"|",41),PRAZ=$P(X,"|",42),LCOB=$P(X,"|",43) 
 S VTTB=$P(X,"|",44),IPDA=$P(X,"|",45),VDPC=$P(X,"|",47) 
 S VPSD=$P(X,"|",48),ICFT=$P(X,"|",49),EFPP=$P(X,"|",55) 
 S AIPI=$P(X,"|",28),ITRP=$P(X,"|",56),IPIN=$P(X,"|",58) 
 S TPRZ=$P(X,"|",65) 
 ; recupera prazo cobranca
 S TPCB=$P(X,"|",66),PZCB=$P(X,"|",67) 
 S CCOA=$P(X,"|",68),NTAN=$P(X,"|",69),Q20C=$P(X,"|",70) 
 ;Documento de referencia - SPED
 S DDRF=$P(X,"|",94),NDRF=$P(X,"|",95),DNOR=$P(X,"|",96),ITRF=$P(X,"|",97)
 ;
 S DMSC=$P(X,"|",98)
 ;S $P(X,"|",99)=ROTA
 ;
 ;Numero do pedido Externo
 S $P(X,"|",100)=NPEE
 S $P(X,"|",101)=NIPE
 ;
 ;Vl.Desconto Comercial
 S VUDC=$P(X,"|",120)
 ;
 I ($G(IFAV)=1)||($G(ISRV)=1) S VUNV=$P(X,"|",126) ; <flcarvalho - GDTI-4701 - Tarefa-112791 - Faturamento antecipado Vendor - 2019/08>
 S $P(X,"|",127)=$J($G(DFAG),0,2) ; <flcarvalho - GDTI-5608 - 2020/03 - Diferença entre o valor unitário original e o ganho de ajuste (arredondamento)>
 ;
 S X=^IBPRO(CPRO),NPRO=$P(X,"|",2),CUME=$P(X,"|",5),IPRT=$P(X,"|",20),CLPR=$P(X,"|",24),PBRU=$P(X,"|",9),CIPI=$P(X,"|",13),TPRO=$P(X,"|",21),IDCA=$P(X,"|",38)
 I $D(^IBCSP(1,CPRO)) S X=^IBCSP(1,CPRO),NPRO=$P(X,"|",4)
 K X 
 S (PADL,VULI)="" 
RITZ Q  
 ;
LCM ;Limpa CaMpos
 S (PADL,VULI,QPED,IUBO,QKGC,TAMO,DAMO,EFPP)="" 
 S (TAMB,CMOR,VFCI,VMVC,IINF,VFRU,VUNP,VUNV,VMAX)="" 
 S (VDEP,LCOB,PRAZ,VTTB,VDPC,VPSD,ICFT)=""
 S (AIPI,ITRP,TPCB,PZCB,VUDC,DFAG)="" 
 ;<Amauri - Projeto 4%> Desligando versao anterior
 ;S (DFCI,NFCI,COIM,SFCI)="" ; ICMS 4% - Tarefa 007B0113 Eliana 09/2013 Revisão
 ;</Fim Amauri - Projeto 4%> Desligando versao anterior
 S IPDA=0 
 D LPI 
LCMZ Q  
 ;
MDP ;Mostra Disponibilidade do Produto
 W /CUP(22,1),/ED(0) 
 K %DI 
 S DFAT1=DFAT+1,T="",D="/",DAT=DFAT,VET=^IFEDC(CDEE),IEDS=$P(VET,"|",3) 
 S DIASEM=(DFAT1-5)#7+1 
 I DIASEM=6,(IEDS?1"N") S DFAT1=DFAT1+2 
 I DIASEM=7 S DFAT1=DFAT1+1 
 D RCV 
MDP1 D DT^sistema.DOLLAR 
 S @("DATEL"_T_"=$E(100+%X,2,3)_D_$E(100+%Z,2,3)_D_$E(%Y,3,4)") 
 I T'?1"" G MDPZ 
 S T=1,DAT=DFAT1 G MDP1         
MDPZ D EDP Q         
 ;
VHV ;Verifica Historico de Venda
 N CDEP,VOVE 
 S DAT=DFAT-45 K %DI D DT^sistema.DOLLAR 
 S AMES=$E(%Y,3,4)_$E(100+%Z,2,3) 
 S MS="" 
 S X=$E(AMES,1,2),X1=$E(AMES,3,4) 
 S X=$S(X>50:1900+X,1:2000+X),AMEN=X_X1 
 I $D(^IFVDA(AMEN,CCLI,CDEE,CPRO)) S X=^IFVDA(AMEN,CCLI,CDEE,CPRO),VOVE=$P(X,"|",1) I VOVE>0 G VHVZ 
 S CDEP="" 
VHV1 S AMEN=$O(^IFVDA(AMEN)) I AMEN?1"" G VHVZ 
VHV2 S CDEP=$O(^IFVDA(AMEN,CCLI,CDEP)) I CDEP?1"" G VHV1 
 I $D(^IFVDA(AMEN,CCLI,CDEP,CPRO)) S X=^IFVDA(AMEN,CCLI,CDEP,CPRO),VOVE=$P(X,"|",1) I VOVE>0 S MS="" G VHVZ 
 S MS="ATENCAO: Nao existe historico de venda para este produto" 
 G VHV2 
VHVZ Q  
 ;
RCV ;ReCupera Variaveis
 ;Disponibilidade do produto e Disp. p/ proximo dia de faturamento
 ; Tarefa: 006CF1C7 - Elim Ref a Global ^IEDCB - 14/11/06
 ;
 ;Disp. p/ fat/fat+1
 S (ADISP,ADISP1,GDISP,GDISP1,DDISP,DDISP1,QDISP,QDISP1)=0 
 ;
RCVZ Q  
 ;
EDP ;Exibe disponibilidade do produto
 W /CUP(22,34),/ICC28,/RAW("  ALCOOL    GASOLINA     DIESEL    QUEROSENE") 
 W /CUP(23,1),/ICC28,/RAW("Disp. do produto: "_DATEL_" ->"),/ICC29,/CUP(22,79) 
 W /CUP(24,1),/ICC28,/RAW("Disp. do produto: "_DATEL1_" ->"),/ICC29,/CUP(23,79) 
 W /CUP(23,32),/RAW($J(ADISP,11)),/CUP(23,44),/RAW($J(GDISP,11)),/CUP(23,56),/RAW($J(DDISP,11)),/CUP(23,68),/RAW($J(QDISP,11)) 
 W /CUP(24,32),/RAW($J(ADISP1,11)),/CUP(24,44),/RAW($J(GDISP1,11)),/CUP(24,56),/RAW($J(DDISP1,11)),/CUP(24,68),/RAW($J(QDISP1,11)) 
EDPZ K ADISP,GDISP,DDISP,QDISP,ADISP1,GDISP1,DDISP1,QDISP1 Q  
 ;
LCO ;Le Consumo
 I CCOA?1"" S CCEM=CFOR 
 E  S X=^IBCLI(CCOA,0),CCEM=$P(X,"|",13) 
LCO1 W /CUP(7,77),/ICC20,/RAW("Consumo: "_CCEM_" // ") U 0:(256:"FC":$C(21,24)) $$$Read(R)  S:$A($ZB)=21!($A($ZB)=24) R=$ZB W:$A($ZB)=24 /ICC24 U 0:(256:"SFC":$C(21,24)) W /COFF,/ICC20,/ICC13 
 I R?1"" S R=CCEM 
 I $A(R)=24 S (CCOA,CCEM)="" G LCOZ 
 I R?1C.E S MS=3 D ^GAP.GAREM $$$ReadT(X,3)  G LCO1 
 I R?1"?" S MS=169,ER="" D ^GAP.GAREM $$$ReadT(X,3)  G LCO1 
 I R'?5N S MS=16,CMS=5 D ^GAP.GAREM $$$ReadT(X,3)  G LCO1 
 I $E(R,2,5)=CDEE S MS=278,CMS="Consumo" D ^GAP.GAREM $$$ReadT(X,3)  G LCO1 
 I '$D(^IBFOR(R)) S MS=290,CMS="Consumo" D ^GAP.GAREM $$$ReadT(X,3)  G LCO1 
 S X=^IBFOR(R),XCCOA=$P(X,"|",4),NFOR=$P(X,"|",3) 
 I '$D(^IBCCO(CDEE,XCCOA)) S MS="Este Consumo nao esta' cadastrado para o C. Coletor. Para nao calcular saida utilize PF4" D ^GAP.GAREM $$$ReadT(X,3)  G LCO1 
 S CCOA=XCCOA 
LCOZ Q  
 ;
SET ;Saldo de Estoque Tecnico
 N RR S SAI=0 
SET1 W /CUP(7,77),/ICC20,/RAW("ATENCAO: ESTOQUE TECNICO: Confirma Nota de Remessa(599003/699003)? ") U 0:(256:"FC":$C(21,24)) $$$Read(RR)  S:$A($ZB)=21!($A($ZB)=24) RR=$ZB W:$A($ZB)=24 /ICC24 U 0:(256:"SFC":$C(21,24)) W /COFF,/ICC20,/ICC13 
 I RR?1"" S MS=2 D ^GAP.GAREM $$$ReadT(X,3)  G SET1 
 I RR'?1"S",RR'?1"N" S:RR?1"?" ER="" S MS=3 D ^GAP.GAREM $$$ReadT(X,3)  G SET1 
 I RR?1C.E S MS=3 D ^GAP.GAREM $$$ReadT(X,3)  G SET1 
 I RR?1"S" S (SAI,VOL)=1 S MS="Corrija a Nat. de Operacao para 599003 ou 699003",ER="" D ^GAP.GAREM $$$ReadT(X,3)  F ITPE=5:-1:1 D LPI I ITPE=1 I 1 
 E  S SAI=0 
SETZ Q  
 ;
LDR ; LE NUM. NOTA FISCAL DE FATURAMENTO
 N YCDEE,XCDEE,YNDRF,COOPX
 ;<AHZ> VERIFICA SE JÁ É O ITEM 2 DA NOTA E SE FOR POR ORDEM E CONTA CONSIDERA A NOTA INFORMADA PARA O ITEM 1
 I ((CDOP=92) && (PF1)) G LDRZ
 I ((CDOP=92) && (ITPE>1) && ($G(XNDNF)'="")) S YCDEE=CDEE,YNDRF=$$SNF(CDEE,+XNDNF),NDRF=YNDRF,DNOR=DTNF G LDR1
 ;W /CUP(8,76),/ICC20,/RAW("Informe o numero da nota de faturamento: ") U 0:(256:"FC":$C(21,24)) $$$Read(R)  S:$A($ZB)=21!($A($ZB)=24) R=$ZB W:$A($ZB)=24 /ICC24 U 0:(256:"SFC":$C(21,24)) W /ICC20,/ICC13 
 W /CUP(23,1),/RAW("Informe o numero da nota de faturamento: ") U 0:(256:"FC":$C(21,24)) $$$Read(R)  S:$A($ZB)=21!($A($ZB)=24) R=$ZB W:$A($ZB)=24 /ICC24 U 0:(256:"SFC":$C(21,24)) W /ICC20,/ICC13
 ;</AHZ> 
 I $A(R)=21 S PF1=1 G LDRZ 
 I R?1"" S MS=2 D ^GAP.GAREM $$$ReadT(X,2) G LDR 
 I R?1C S MS=3 D ^GAP.GAREM $$$ReadT(X,2) G LDR 
 ;
 I R'?1N.N!($L(R)>14) S:R?1"?" ER="" S MS=17,CMS=14 D ^GAP.GAREM $$$ReadT(X,2) G LDR 
 S YCDEE=CDEE,YNDRF=R
 S R=$$SNF(CDEE,+R)
 I (R=""),$D(^IBDPA(EMGR,CDEE)) S X=^IBDPA(EMGR,CDEE),YCDEE=$P(X,"|",2) S R=$$SNF(YCDEE,+YNDRF)
 I (R="") S MS="Nota fiscal não encontrada." d ^GAP.GAREM $$$ReadT(X,2) G LDR 
 ;;;S YNDRF="55003"_$E(R+1000000000,2,10) I '$D(^IFINF(CDEE,YNDRF)) S MS="Nota fiscal não encontrada." d ^GAP.GAREM $$$ReadT(X,2) G LDR
 ;;;S DTNF=^IFINF(CDEE,YNDRF),R=YNDRF
 S DNOR=DTNF
 S R=R+0
 I DNOR?1"" S MS=289,CMS="Nota fiscal" D ^GAP.GAREM $$$ReadT(X,2) G LDR
 I DNOR'?1"",'$D(^IFNFS(YCDEE,DNOR,+R)) S MS=289,CMS="Nota fiscal" D ^GAP.GAREM $$$ReadT(X,2) G LDR 
 S REG=$G(^IFNFS(YCDEE,DNOR,+R)),CCLIX=$P(REG,"|",2),CNOPX=$P(REG,"|",12),INFC=$P(REG,"|",17),IDRT=$P(REG,"|",27),XCCLF=$P(REG,"|",16) ; <AHZ> adicionado ,XCCLF=$P(REG,"|",16) 
 S XTPNV=$P(REG,"|",102) ; <flcarvalho - GDTI-4701 - Tarefa-112791 - Faturamento antecipado Vendor - 2019/08>
 I INFC S MS="Nota Fiscal de saida cancelada." D ^GAP.GAREM $$$ReadT(X,2) G LDR
 ; Critica NF (devolvida parcialmente,devolvida totalmente e retornada
 I IDRT'?1"","2,3"[IDRT S MS="NF de Faturamento Antecipado foi "_$S(IDRT=1:"devolvida parcialmente",IDRT=2:"Devolvida Totalmente",1:"Retornada") D ^GAP.GAREM $$$ReadT(X,3)  G LDR 
 S REG=^IBNOP(CNOPX),CNOSX=$P(REG,"|",4),CTOPX=$E(CNOSX,1,2),COOPX=$E(CNOSX,3,4),CDOPX=$E(CNOSX,5,6)
 ;<<AHZ ELO 4.7.1 
 I (('((CDOP=61)&&(CTOPX="01")&&(CDOPX=55))) && ('((CDOP=92)&&(CTOPX="01")&&(CDOPX=91))))  S MS=508,CMS="faturamento antecipado ou por conta e ordem" d ^GAP.GAREM $$$ReadT(X,2) G LDR  
 ;I '((CDOP=61)&&(CTOPX="01")&&(CDOPX=55)) S MS=508,CMS="faturamento antecipado" d ^GAP.GAREM $$$ReadT(X,2) G LDR  
 ;I '((CDOP=92)&&(CTOPX="01")&&(CDOPX=91)) S MS=508,CMS="faturamento por conta e ordem" d ^GAP.GAREM $$$ReadT(X,2) G LDR  
 ;AHZ>>
 ; <flcarvalho - GDTI-4701 - Tarefa-112791 - Faturamento antecipado Vendor - 2019/08>
 I ($G(ISRV)=1)&&(XTPNV'=1)  S MS="Natureza da nota de faturamento antecipado original é do tipo vendor. Use as naturezas de simples remessa vendor: 599028 ou 699028." D ^GAP.GAREM $$$ReadT(X,3) G LDR
 I ($G(ISRV)'=1)&&(XTPNV=1)  S MS="Natureza de simples remessa vendor só pode ser utilizada com notas de faturamento antecipado vendor: (585029 ou 685029)." D ^GAP.GAREM $$$ReadT(X,3) G LDR
 ; <flcarvalho - GDTI-4701 - Tarefa-112791 - Faturamento antecipado Vendor - 2019/08>
 ;Validação do destinatário para operação de faturamento antecipado
 I (CDOP=61)&&(CCLIX'=CCLI)&&('$D(^IFEFA(YCDEE,1,CCLIX,CCLI))) S MS="O Cliente da NF de Faturamento Antecipado é diferente deste pedido." d ^GAP.GAREM $$$ReadT(X,3) G LDR  
 ;Valida destinatário para operação por conta e ordem
 If (CDOP=92) Do VDC If SAI G LDR
 ;Validar de forma que o COOP da remessa seja o mesmo do COOP do faturamento.
 If COOPX'=COOP S MS="O destino da operação da remessa (COOP) não é compatível com o destino da operação de faturamento." d ^GAP.GAREM $$$ReadT(X,3) G LDR 
 ;TODO ALX Validar se o destinatário é o mesmo destinatário informado no NFFCO no campo CCLF
 ;         quando for PRCO.
 S NDRF=+R 
 ;
 ;<AHZ> Lê a chave de acesso da nota fiscal de venda do cliente.
LDR0 ; LE NUM. NOTA FISCAL DE VENDA CLIENTE SOMENTE PARA OPERAÇÃO DE POR CONTA E ORDEM
 If (CDOP'=92) G LDR1
 ;W /CUP(24,1),/RAW("Informe a chave da NFVC: ") U 0:(256:"FC":$C(21,24)) $$$Read(R)  S:$A($ZB)=21!($A($ZB)=24) R=$ZB W:$A($ZB)=24 /ICC24 U 0:(256:"SFC":$C(21,24)) W /ICC20,/ICC13 
 ;    
 S (EmitenteNFVC, NFCL, SNCL, AnoMesNFVC, UFNFVC, ModeloNFVC) = ""
 S lin=24,col=35
 S CHNE ="",bFlagInibeF8=1
 D ^basico.SRCHT I SAI||(CHNE="") S PF1=1 G LDR
 S XCHNE=CHNE, XNDRF=NDRF, XCCLI=CCLIX
 
 ;<VCT> - Tratamento para não permitir que seja informada uma chave com o emitente diferente do cliente da NF de faturamento.
 S sc = ##class(cbpi.abadi.datatype.ChaveAcesso).recuperarInfo(CHNE, .EmitenteNFVC, .NFCL, .SNCL, .AnoMesNFVC, .UFNFVC, .ModeloNFVC)
 
 S X=^IBCLI(CCLIX,0),DVCli=$p(X,"|",3)
 S CNPJCli=$extract(CCLIX,0,12)_DVCli
 
 //Critica se o emitente da NFVC for diferente do destinatário da NF de faturamento
 I (EmitenteNFVC'=CNPJCli) {
	 S MS= "Emitente da NFVC deve ser o cliente da NF de faturamento." D ^GAP.GAREM $$$ReadT(X,2) G LDR0
 }
 ;<VCT>
 
 ;</AHZ> 
 
LDR1 W /CUP(8,76),/ICC20,/RAW("Item: ") U 0:(256:"FC":$C(21,24)) $$$Read(R)  S:$A($ZB)=21!($A($ZB)=24) R=$ZB W:$A($ZB)=24 /ICC24 U 0:(256:"SFC":$C(21,24)) W /ICC20,/ICC13 
 I $A(R)=21 S PF1=1 G LDR
 I R?1""!($A(R)=21) G LDR
 I R?1C S MS=3 D ^GAP.GAREM $$$ReadT(X,2) G LDR1 
 I R'?1.2N S:R?1"?" ER="" S MS=17,CMS=2 D ^GAP.GAREM $$$ReadT(X,2) G LDR1 
 S R=R+0 
 I '$D(^IFNFS(YCDEE,DNOR,NDRF,0,R)) S MS=696 D ^GAP.GAREM $$$ReadT(X,2) G LDR1 
 S REG=^IFNFS(YCDEE,DNOR,NDRF,0,R),CPROX=$P(REG,"|",1)
 I CPRO'=CPROX,'$D(^IBPRS(1,CPRO,CPROX)) S MS="O produto da nota de faturamento e' diferente ("_CPROX_")" d ^GAP.GAREM $$$ReadT(X,3) G LDR1 
 ; Critica NF devolvida parcialmente
 I IDRT=1,($D(^IFNFS(YCDEE,DNOR,NDRF,5,R))) S ER="",MS="Atenção: Este item foi Devolvido Parcialmente <ENTER>." D ^GAP.GAREM $$$ReadT(X,3)
 S ITRF=R
 ;
 S VUNV=$P(REG,"|",186) ; <flcarvalho - GDTI-4701 - Tarefa-112791 - Faturamento antecipado Vendor - 2019/08>
 S DFAG=$P(REG,"|",189) ; <flcarvalho - GDTI-5608 - 2020/03 - Diferença entre o valor unitário original e o ganho de ajuste (arredondamento)>
 ;
 // se a nota de faturamento não existir, criar na IFREF
 ;<AHZ>
 Set SAI = 0
 If (CDOP=92) {
 	Do validaItemNFVC(CPRO,XCHNE)
 }
 If SAI Goto LDR1
 ;</AHZ>
 S XCDEE=""
 I YCDEE'=CDEE S XCDEE=YCDEE
 I '$D(^IFREF(YCDEE,DNOR,NDRF,ITRF)) S X=$G(^IFNFS(YCDEE,DNOR,NDRF,0,ITRF)),XQPNF=$P(X,"|",4),^IFREF(YCDEE,DNOR,NDRF,ITRF)=XQPNF_"|"_XCDEE
 //
 ; 
LDRZ Q  
VDC	;Valida o destinatário da operação de faturamento por conta e ordem
	;Parâmetros:
	;	CDEE - Código da dependência do pedido
	;	CCLI - Código do cliente da remessa por conta e ordem
	;	CCLIX - Código do cliente do faturamento por conta e ordem
	;	SAI - OUT - Verdadeiro se o destinatário não for válido
	;	DENT,DFAT - IN - Data para fins de pedido
	;   XCCLF - Código do cliente final do faturamento por conta e ordem
	#Dim oClienteFat,oClienteRem As cbpi.abadi.basico.ClienteMap
	#Dim oConfContOrd As cbpi.abadi.faturamento.controle.ConfFatContaOrdem
	N YCDEE,XCDEE,YNDRF,oClienteFat,oClienteRem,oConfContOrd,XDENT
	Set SAI=0
	S XDENT=DENT I XDENT?1"99999"!(XDENT?1"P") S XDENT=DFAT 
	IF (+XDENT=0) S XDENT = DFAT
	;<AHZ> ATENDENDO AO TODO do Lack linha 361
	If (XCCLF'=CCLI) Set SAI=1,MS="O Cliente da NF de Faturamento por Conta e Ordem é diferente deste pedido." D ^GAP.GAREM $$$ReadT(X,2) G VDCZ
	;</AHZ>
	;Recupera o cliente da remessa
	Set oClienteRem=##class(cbpi.abadi.basico.ClienteMap).instanciar(CCLI)
	If '$IsObject(oClienteRem) Set SAI=1,MS="Cliente da remessa não foi localizado." D ^GAP.GAREM $$$ReadT(X,2) G VDCZ
	;Recupera o cliente do faturamento por conta e ordem
	Set oClienteFat=##class(cbpi.abadi.basico.ClienteMap).instanciar(CCLIX)
	If '$IsObject(oClienteFat) Set SAI=1,MS="Cliente do faturamento não foi localizado." D ^GAP.GAREM $$$ReadT(X,2) G VDCZ
	;Recupera a confiração de operação por conta e ordem
	Set oConfContOrd=##class(cbpi.abadi.faturamento.controle.ConfFatContaOrdem).instanciarVigente(CDEE,CCLIX,XDENT)
	If '$IsObject(oConfContOrd) Set SAI=1,MS="Cliente não está parametrizado para faturamento por conta e ordem." D ^GAP.GAREM $$$ReadT(X,2) G VDCZ
	;Valida se o destinatário é válido
	;<AHZ> Recupera se o valor unitário deve ser o do cliente ou do fornecedor
	Set origemPrecoContOrd = oConfContOrd.origemValorUnit
	Set exigeXML           = +oConfContOrd.exigeXML
	;</AHZ>
	#Import cbpi.abadi.faturamento.controle
	If '##class(ConfFatContaOrdemDest).permiteRemessa(oConfContOrd,oClienteRem) Set SAI=1,MS="Cliente da remessa não está configurado como destinatário válido para a operação por conta e ordem." D ^GAP.GAREM $$$ReadT(X,2) G VDCZ
VDCZ	Quit
 ;
RMC ;Recupera Margem do Cliente
 ;
 N PRODUTO,XDVIG,PROMAR,XMDCL
 S PROMAR=R D DPM^IBSRPP ;Devolve PROMAR produto para recuperar Margem de Cliente 
 I PROMAR?1"" S PROMAR=R ; MS=345,CMS="margem",CMS1="Produto "_R G RMCZ 
 ;
 S XMDCL="",INNV=0
 D VMD
 I ILMD D  ; Margem por Dependência - DSD - 02/14 - TAR.006E408C
 .S XDVIG=$O(^IPMCD(CCLI,PROMAR,CDEE,(DURV+1)),-1) 
 .I XDVIG S X=^IPMCD(CCLI,PROMAR,CDEE,XDVIG),XMDCL=$P(X,"|",2)
 E  D      ; Margem por Cliente
 .S XDVIG=$O(^IPMCL(CCLI,PROMAR,(DURV+1)),-1) 
 .I XDVIG S X=^IPMCL(CCLI,CPRO,XDVIG),XMDCL=$P(X,"|",2)
 I $G(XMDCL)?1"" S INNV=1,MS=345,CMS="margem",CMS1="cliente" G RMCZ 
 ;
RMCZ Q
     ;
QTM ; Quantidade minima no total do pedido 
 //Critica de volume minimo para os clientes da GV 617 DA BASE 6937
 //a quantidade inicial de produto tem ser superior a 10.000 L
 //valido somente gasolina, etanol, diesel
 // HPJ TAREFA Nº 003C674A 10/2014
 N IT,CPRO,QTDE,TQTDE
 S IT="",CPRO="",QTDE="",TQTDE=""
 I $D(^ISGRU("LIBVOLUMEPEDIDO",%US)) S QTM=0 G QTMZ  
 //
 F I=1:1 S IT=$O(^IFAUX(PART,0,IT)) Q:IT?1""  D
 .S X=^IFAUX(PART,0,IT),CPRO=$P(X,"|",1), QTDE=$P(X,"|",3)
 .I '$D(^ISGRU("LIBVOLUMEPEDIDO",%US)),'ICCR,",10,11,15,"[(","_$E(CPRO,1,2)_","),R<10000,$E(CZVC,1,3)=617,CDEE=6937 S TQTDE=TQTDE+QTDE
 //
 I TQTDE'?1"",TQTDE<10000 S QTM=1
QTMZ Q     
LIM  ;Limpa campo do Pedido Externo
     S (NPEE,NIPE)="" 
     F I=48,72 W /CUP(15,I),/ICC24 
LIMZ Q 
     ;
     ;<AHZ> DO validaItemNFVC^IFPEAT12(codProduto,CHNE,.valorItemCliente,.noItemNFVC)
     ; retorno
     ; noItemNFVC numero do item na nota fiscal de venda do cliente se não encontrar o item retorna 0 (zero)
     ; valorItemCliente valor do item na nota fiscal do cliente 
validaItemNFVC(codProduto,CHNE) 
	new oNFe,itemNFVC,i,X,cliente, data 
	#DIM oNFe as cbpi.abadi.estoque.nfe.NFe
	Set (noItemNFVC,valorItemCliente) = 0 
	If (origemPrecoContOrd = ##class(cbpi.abadi.faturamento.controle.ConfFatContaOrdem).%GetParameter("CLIENTE")
		 && exigeXML){
		Set oNFe=##class(cbpi.abadi.estoque.nfe.NFe).instanciar(CHNE)
		If $IsObject(oNFe) {
		 	For i=1:1:oNFe.itens.Count() {
			    s X = $G(^IFNFS(YCDEE,DNOR,NDRF))
			    s cliente = $P(X,"|",2)
			    S data = ##class(cbpi.abadi.datatype.DataMedidata).LogicalToCache(DFAT)
		 		Set itemNFVC = oNFe.itens.GetAt(i).codProduto
		 		If codProduto =$$converteProdutoExterno(cliente,itemNFVC,data) {
	 				Set noItemNFVC = i
		 			Set valorItemCliente = oNFe.itens.GetAt(i).valorUnitario
		 		}
		 	}
		}
		if ('noItemNFVC || 'valorItemCliente){
			Set SAI=1,MS="Não foi possível recuperar o preço do item "_codProduto_" da nota fiscal de venda do cliente. Favor verificar se o cliente envia o XML da NF." D ^GAP.GAREM $$$ReadT(X,2)
		}
	}
 	Quit
 
converteProdutoExterno(idClienteFaturamento,itemExterno,dataFaturamento)  //todo usar depara utilizar regras  
  NEW oProduto,produtoInterno
  Set oProduto=  ##class(cbpi.abadi.basico.ProdutoDeParaCliFor).instanciarVigente(EMGR,idClienteFaturamento,itemExterno,dataFaturamento)
  If $IsObject(oProduto) {
    Set produtoInterno=oProduto.Produto
  }
  else {
  	Set produtoInterno = itemExterno
  }
  Quit produtoInterno
 ;</AHZ>  
 ;	 
SNF(CDEE,NDNF,DNOR,TMNF,SENF) N NONX D ^IBSRSN Q NONX			
DCA(CPRO,ICCR) D ^IBSRCA Q
 ;
VMD D VMD^IBSR.preco.MrgDependencia(CCLI,.ILMD) Q 
RPV D RPV^IBSR.preco.MrgDependencia(CCLI,XPRO,XDVV,.IPRM) Q
 ; 
FES D FES^IFPEAT0 Q  
TDG D TDG^IFPEAT0 Q  
RDG D RDG^IFPEAT0 Q  
CRP D CRP^IFPEAT15 Q  
TRF D TRF^IFPEAT15 Q  
TET D TET^IFPEAT15 Q  
EXC D EXC^IFPEAT15 Q  
PCF D PCF^IFPEAT15 Q  
CIN D CIN^IFPEAT15 Q  
TCO D TCO^IFPEAT16 Q  
IPI D IPI^IFPEAT41 Q  
TTP D TTP^IFPEAT47 Q
LNO D LNO^IFPEAT03 Q  
MTN D MTN^IFPEAT03 Q
]]></Routine>


<Routine name="IFPEAT15" type="MAC" languagemode="0" timestamp="65441,38319.666009"><![CDATA[
IFPEAT15 ;Atendimento a Cliente<V1.0-PNC-09/94> ; Aug 11 2005  9:34 AM ;pncÚltima Alteração   douglass 20/04/2018 10:56:34 ;Última Alteração   FLCARVALHO 03/03/2020 10:38:39
#Include sistema.BibliotecaMacro
 ;
CRP ;Confirma Retira Produto 
 I $D(ICCR) G CRPZ  
 Set padraoNao=0
 ;Tratamento temporario para base estendida. 
 If (CDEE=4812) Set padraoNao=1 G CRP1
 S ICCR="0",ILPF="O" 
 I "1/2/3/4/5"'[TPRC G CRPZ 
 I TPRC=5,CTOP'?1"01","030267/030269/030261"'[CNOS G CRPZ 
 I "11/12"[$E(CNEG,1,2),CLPR?1"1" S X=^IBCLI(CCLI,2),ICLR=$P(X,"|",15) I ICLR'?1"S" G CRPZ 
 I $E(CNEG,1)=2,CNEG'=21000,CNEG'=22000,CLPR?1"1" S X=^IBCLI(CCLI,2),ICLR=$P(X,"|",15) I ICLR'?1"S" G CRPZ ; controlar pergunta tb p/ consumidor
 I CTOP="01"!("030267/030269/030261"[CNOS),CNEG?1"1".E,"17/19"[$E(CPRO,1,2) S ICCR=1 G CRPZ 
 ;I TPRC?1"3",'EEMB S ICCR=1 G CRPZ ; TRR passa a pedir transportadora - Tarefa 0044E7A6 - DSD
 ;Se for pedido de faturamento ou remessa por conta e ordem, então o cliente não vai retirar
 If (CDOP=91)||(CDOP=92) Set padraoNao=1,ICCR=0 
 I CTOP="02" G CRPZ 
 W /CUP(8,77) 
CRP1 W /CUP(8,77),/ICC20,/RAW("Cliente vai retirar os produtos? "_$S(TPRC?1"3"&('EEMB):"S// ",padraoNao:"N// ",1:"")) U 0:(256:"FC":$C(21,24)) $$$Read(R)  S:$A($ZB)=21!($A($ZB)=24) R=$ZB W:$A($ZB)=24 /ICC24 U 0:(256:"SFC":$C(21,24)) W /ICC13 
 I TPRC?1"3",'EEMB,R?1"" S R="S"
 I R?1"",padraoNao S R="N" 
 I R'?1"N",R'?1"S" S:R?1"?" ER="" S MS=1 D ^GAP.GAREM $$$ReadT(X,2)  G CRP1 
 I R?1"S" S ICCR="1",ILPF="D" 
 E  S ICCR="0",ILPF="O"
 W /ICC20,/ICC13
CRPZ Q  
 ;
CIN ;Confirma Industrializacao do Produto
 S IPIN=0 
 I CTOP'="01" G CINZ 
 I CLPR'=1 G CINZ 
 I CUFE'=CUFD G CINZ ;So' dentro do estado
 S IPIN=0 I $D(^ILCIN(CCLI)) S IPIN=1 
 I IPIN=1 G CINZ 
 G CINZ ; Nao faz mais a pergunta a partir de 04/06/2003 Eliana
 S IPIN=0 
 I CNEG'=23201,CNEG'=23605,CNEG'=23612,CNEG'=23620 G CINZ 
 I "ES/RJ"'[CUFD G CINZ 
 S COMB=$E(CPRO,1,2) 
 S UF=CUFD,DURV=DENT D ^IBSRSR ;Subst Refinaria Estado Origem
 I CUFD="ES",'IPSR G CINZ 
 I CUFD="RJ",COMB'=15 G CINZ 
 W /CUP(4,76) 
CIN1 W /ICC20,/RAW("Produto vai ser utilizado em processo de PRODUCAO INDUSTRIAL?  ") U 0:(256:"FC":$C(21,24)) $$$Read(R)  S:$A($ZB)=21!($A($ZB)=24) R=$ZB W:$A($ZB)=24 /ICC24 U 0:(256:"SFC":$C(21,24)) W /ICC13 
 I R'?1"N",R'?1"S" S:R?1"?" ER="" S MS=1 D ^GAP.GAREM $$$ReadT(X,2)  G CIN1 
 I R?1"S" S IPIN=1 
 W /ICC20,/ICC13 
CINZ Q  
 ;
TRF ;confirma TRansporte Fluvial
 S ITFL=0 
 W /CUP(8,77) 
TRF1 W /ICC20,/RAW("E' transporte fluvial? ") U 0:(256:"FC":$C(21,24)) $$$Read(R)  S:$A($ZB)=21!($A($ZB)=24) R=$ZB W:$A($ZB)=24 /ICC24 U 0:(256:"SFC":$C(21,24)) W /ICC20,/ICC13 
 I R'?1"N",R'?1"S" S:R?1"?" ER="" S MS=1 D ^GAP.GAREM $$$ReadT(X,2)  G TRF1 
 I R?1"S" S ITFL=1 
TRFZ Q  
 ;
TET ;confirma nota Estoque Tecnico
 S (XXCDEP,XXDFAT,XNDAR,XNONF)="",(XXTQPNF,XXTQETI)=0 
TET1 S XXCDEP=$O(^IETEC(CCLI,CPRO,2,XXCDEP)) G:XXCDEP?1"" TET4 
TET2 S XXDFAT=$O(^IETEC(CCLI,CPRO,2,XXCDEP,XXDFAT)) G:XXDFAT?1"" TET1 
TET3 S XNDAR=$O(^IETEC(CCLI,CPRO,2,XXCDEP,XXDFAT,XNDAR)) G:XNDAR?1"" TET2 
 S X=^IETEC(CCLI,CPRO,2,XXCDEP,XXDFAT,XNDAR),XXQPNF=$P(X,"|",1) 
 S XXTQPNF=XXTQPNF+XXQPNF 
 G TET3 
TET4 S XXCDEP=$O(^IETEC(CCLI,CPRO,3,XXCDEP)) G:XXCDEP?1"" TET7 
TET5 S XXDFAT=$O(^IETEC(CCLI,CPRO,3,XXCDEP,XXDFAT)) G:XXDFAT?1"" TET4 
TET6 S XNONF=$O(^IETEC(CCLI,CPRO,3,XXCDEP,XXDFAT,XNONF)) G:XNONF?1"" TET5 
 S X=^IETEC(CCLI,CPRO,3,XXCDEP,XXDFAT,XNONF),XXQETI=$P(X,"|",1) 
 S XXTQETI=XXTQETI+XXQETI 
 G TET6 
TET7 I XXTQETI'<XXTQPNF G TETZ ; Qtde devolvida e' menor ou igual que a ja' faturada
 W /CUP(8,77) 
TET8 W /ICC20,/RAW("Pedido e' referente a devolucao de estoque tecnico? ") U 0:(256:"FC":$C(21,24)) $$$Read(R)  S:$A($ZB)=21!($A($ZB)=24) R=$ZB W:$A($ZB)=24 /ICC24 U 0:(256:"SFC":$C(21,24)) W /ICC20,/ICC13 
 I R'?1"N",R'?1"S" S:R?1"?" ER="" S MS=1 D ^GAP.GAREM $$$ReadT(X,2)  G TET8 
 I R?1"S" S IFET=1 
TETZ K XXCDEP,XXTQPNF,XXTQETI,XXQPNF,XXQETI,XXDFAT,XNDAR,XNONF Q  
 ;
EXC ;EXClui item
 I '$D(^IFAUX(PART,0,ITPE)) G EXCZ 
 K ^IFAUX(PART,0,ITPE) 
 D RFI 
 I ITPE=1 K ICCR,NLECF 
EXCZ Q  
 ;
PCF ;Pergunta consumo final
 I $D(NLECF) G PCFZ 
 ;<Aud - Projeto ELO - Dez/2017>
 ; Se o Cliente já estiver configurado como CONSUMIDOR pelo cadastro
 ; não será necessário fazer a confirmação.
 S IPCF=0
 S NLECF=""
 If EMGR=71 G PCFZ ;Empresa C0NECTCAR não seleciona Consumo Final
 If ##class(cbpi.abadi.basico.ClienteMap).eConsumidor(CCLI) {
 	Set IPCF=1
 }
 GoTo PCFZ
 ;</Aud - Projeto ELO>
 ;
 I $E(CNEG,1,2)>21,CIPI'=5 G PCFZ ;Pedido Egidio 09/10/2002
 S X=^IBCLI(CCLI,1),CIEC=$P(X,"|",5) 
 I "1/2"'[CLPR G PCFZ ; ELIANA EM 14/03/2014 
 S X=$G(^IBCIF(CCLI)),IPCF=$P(X,"|",2) 
 I IPCF G PCFZ 
 S IPCF=0 
 ;
 ;<Aud - Projeto ELO>
 ; Se for empresa JoinVenture e Tipo de Cliente for = 2 Consumidor
 If ##class(cbpi.abadi.basico.ClienteMap).eConsumidor(CCLI) Set IPCF=1 GoTo PCFZ
 ;</Aud - Projeto ELO>
 ;Combustivel e lubrificante  ---->  Le consumo final para:
 I CCLI=43214055000101,$E(CPRO,1,2)=15 S IPCF=1 G PCFZ 
 I CNEG=12100 G PCFZ 
 ;<Aud - Projeto ELO - Retirada de Regra>
 ; Tratamento dessa regra será feito pela rotina BSC-TP-DF
 ; /// I CNEG=23101 G PCF2                   ;Cooperativa 
 ; /// I CNEG=11250 G PCF2                   ;Posto Intramuros
 ;</Aud - Projeto ELO - Retirada de Regra>
 ;
 ;; TAREFA 006A7618 - ASSIS 18/7/2012
 I +AIPI'=0,$E(CNEG,1,2)>22,(CIEC="ISENTO"!($D(^ILSIE(1,CCLI)))) S IPCF=1 G PCFZ
 I +AIPI'=0,$E(CNEG,1,2)>22,"23101/23602/23620/23621"'[CNEG S IPCF=1 G PCFZ 
 I +AIPI'=0,$E(CNEG,1,2)>22 G PCF2   ;Consumidor e produto com IPI
 G PCFZ 
 ;
 ;Demais produtos
PCF1 I $L(CCLI)=11,(CIEC=""!($E(CIEC,1,5)="ISENT")) G PCF2 
 I $E(CNOP,1)="6",$E(CNEG,1,2)>22,CIPI'=5 G PCF2 
 I CLPR=5,$L(CCLI)=14 G PCF2 
 I CLPR=6 G PCF2 
 I (+AIPI)'=0,$E(CNEG,1,2)>22 G PCF2 
 G PCFZ 
 ;
 ;Le Consumo Final
PCF2 W /CUP(8,77),/ICC20,/RAW("O produto sera' utilizado para CONSUMO FINAL? N // ") U 0:(256:"FC":$C(21,24)) $$$Read(Y)  S:$A($ZB)=21!($A($ZB)=24) Y=$ZB W:$A($ZB)=24 /ICC24 U 0:(256:"SFC":$C(21,24)) W /ICC20,/ICC13 
 I Y?1"" S Y="N" 
 I Y'?1"S",Y'?1"N" S:Y?1"?" ER="" S MS=1 D ^GAP.GAREM $$$ReadT(X,2)  G PCF2 
 S IPCF=0 I Y?1"S" S IPCF=1 
PCFZ Q  
 ;
AMI ;ArMazena Item
 S (ISUD,ISUQ,ISUC,ISUE,ISUV,ISUP)="0",VITP="0",IATP="0",XPBRU="",IPRI=0 
 D VPA
 ;Se é remessa para armazenagem e se LORE é o próprio armazenador, então 
 ;deve baixar o saldo disponível do depósito da filial.
 If '$D(LORE) Set LORE="1"_CDEE
 I CPRO=12000000 G AMI1 ; pedido de gas natural nao pode ficar suspenso
 I $G(IFAV)=1 G AMI1  ; <flcarvalho - GDTI-4701 - Tarefa-112791 - Faturamento antecipado Vendor - 2019/08>
 I CTOP?1"01" D
 .I CDEV S ISUQ="1" 
 .E  D VDV I DEBITO S ISUV="1" 
 Set XLORE=LORE
 If (CNOS="030209")&&(CFOR=LORE) Set XLORE="1"_CDEE
 ;Recupera ISUD, ISUE e IATP
 Do verificarEstoqueDisponivel^IBSREB3(CDEE,CNOP,CPRO,QPED,XLORE,ESTO,IPRI,/*AAP*/ 1,.ISUD,.ISUE,.IATP)		;
AMI1 S ISUS=ISUD_ISUQ_ISUC_ISUE_ISUV_ISUP 
 I ISUS'="000000" G AMI2 
 S XPBRU=(+PBRU*QPED) 
 G AMI3 
 ;SUSPENSO
AMI2 S MS=596,CMS="",ER="" 
 I ISUD?1"1" S CMS=CMS_"DISPONIBILIDADE," 
 I ISUQ?1"1" S CMS=CMS_"PGTO ANTECIPADO," 
 I ISUC?1"1" S CMS=CMS_"CREDITO," 
 I ISUE?1"1" S CMS=CMS_"ESTOQUE," 
 I ISUV?1"1" S CMS=CMS_"DEBITO VENCIDO," 
 I ISUP?1"1" S CMS=CMS_"PRECO MINIMO," 
 S CMS=$E(CMS,1,$L(CMS)-1) 
 D ^GAP.GAREM 
 I DENT=99999 D EDS 
 ;
AMI3 D GRI 
 K X,IPRI,IPDG,ISUS,ISUD,ISUQ,ISUC,ISUE,ISUV,ISUP 
 K IATP,IADC,VITP,XVUNP,XCPRO,LFU,LVU,LUB 
 K UME,AIPI,XPBRU,CPRO 
AMIZ Q  
 ;
VDV ; Verifica se Cliente com Debito Vencido 
 ; tarefa 0049FE3E - tratamento Conectcar
 I CZVC=971000 S DEBITO=0 G VDVZ
 I CDEE="0002","11100/11150/11200/11250"'[CNEG S DEBITO=0 G VDVZ
 I $G(IFAV)=1 S DEBITO=0 G VDVZ ; <flcarvalho - GDTI-4701 - Tarefa-112791 - Faturamento antecipado Vendor - 2019/08>
 D ^IBSRVG 
 S RHDV="IFPEAT|"_TOVV_"|"_DCMA_"|"_ISDB_"|"_NDMA 
VDVZ Q
 ;
GRI ;GRava Item
 N YCDEE
 S YCDEE=CDEE
 I DNOR'="",NDRF'="",'$D(^IFREF(CDEE,DNOR,NDRF)) D IPP
 ;Recupera DENTRO e FORA
 S (DENTRO,FORA)="" Do defineLocalCar^IBSRLC(CDEE,CPRO,DFAT,CCLI,.ILCP,.DENTRO,.FORA) 
 S IPRI=0,SPED=1,IICM=IIICM 
 S X="",$P(X,"|",1)=CPRO,$P(X,"|",2)=IPRI,$P(X,"|",3)=QPED 
 S $P(X,"|",4)=VUNP,$P(X,"|",5)=IPDG,$P(X,"|",6)=VFRU,$P(X,"|",7)=IUBO 
 S $P(X,"|",13)=SPED,$P(X,"|",14)=ISUS,$P(X,"|",15)="000000" 
 S $P(X,"|",16)=IATP,$P(X,"|",17)=IADC,$P(X,"|",22)=TAMO 
 S $P(X,"|",23)=DAMO,$P(X,"|",24)=TAMB,$P(X,"|",25)=QKGC 
 S $P(X,"|",29)=VITP,$P(X,"|",30)=XPBRU,$P(X,"|",31)=VUFD 
 S $P(X,"|",32)=IFDG,$P(X,"|",36)=VMVC,$P(X,"|",37)=IINF 
 S $P(X,"|",38)=CMOR,$P(X,"|",39)=VFCI,$P(X,"|",40)=VMAX 
 S $P(X,"|",41)=VDEP,$P(X,"|",42)=PRAZ,$P(X,"|",43)=LCOB 
 S $P(X,"|",44)=VTTB,$P(X,"|",45)=IPDA,$P(X,"|",46)=IFET 
 S $P(X,"|",47)=VDPC,$P(X,"|",48)=VPSD,$P(X,"|",49)=ICFT 
 ;ILCP e LORE são definidos por IFPEAT12 através da chamada EED^IFPEAT41
 S $P(X,"|",50)=ILCP,$P(X,"|",51)=DENTRO,$P(X,"|",52)=FORA,$P(X,"|",54)=LORE 
 S $P(X,"|",53)=NFSC,$P(X,"|",55)=EFPP 
 S $P(X,"|",28)=AIPI,$P(X,"|",56)=ITRP,$P(X,"|",58)=IPIN 
 S $P(X,"|",59)=ICMC,$P(X,"|",60)=AICM,$P(X,"|",61)=AIRE 
 S $P(X,"|",62)=IICM,$P(X,"|",63)=UNPR,$P(X,"|",64)=UNFR 
 S $P(X,"|",65)=TPRZ 
 ; Testa prazo de cobrança
 S $P(X,"|",66)=TPCB,$P(X,"|",67)=PZCB 
 S $P(X,"|",68)=CCOA,$P(X,"|",69)=NTAN,$P(X,"|",70)=Q20C 
 ;
 ;Documento de referencia - SPED
 S $P(X,"|",94)=YCDEE,$P(X,"|",95)=NDRF,$P(X,"|",96)=DNOR,$P(X,"|",97)=ITRF
 ;
 S $P(X,"|",98)=DMSC
 ;
 #;<AUD - Projeto ELO - Fase 3 Incorporação>
 #; Tratamento do Pedido Externo>
 Set NPEI=NPEE
 If ($D(oArrDadosExt))&&(oArrDadosExt.Count()>0) {
	 Set NIPE=oArrDadosExt.GetAt("NIPE")
	 Set NPEI=oArrDadosExt.GetAt("NPEI")
 }
 Set $P(X,"|",100)=NPEI
 Set $P(X,"|",101)=NIPE
 #;</AUD - Projeto ELO - Fase 3 Incorporação>
 #;
 ;
 D RDC^IBSRPU1(CCLI,CPRO,CDEE,DENT,.VUDC,.DTEX) ; HPJ 100169
 S $P(X,"|",120)=$G(VUDC) ; TAREFA 75941 - DSD - 04/2018
 S $P(X,"|",121)=$G(VBOM) ; TAREFA 75941 - DSD - 04/2018
 ;
 S $P(X,"|",126)=$G(VUNV) ; <flcarvalho - GDTI-4701 - Tarefa-112791 - Faturamento antecipado Vendor - 2019/08>
 S $P(X,"|",127)=$J($G(DFAG),0,2) ; <flcarvalho - GDTI-5608 - 2020/03 - Diferença entre o valor unitário original e o ganho de ajuste (arredondamento)>
 ;
 S ^IFAUX(PART,0,ITPE)=X
 ;
 ;<AUD - Projeto ELO GAP FAT10 - SET/2017>
 ; Registras informações externas do cliente para serem informadas nos
 ; no campo CDATA do xml
 ;
 Set ^IFAUX(PART,0,ITPE,1)=$Get(CPEC)_"|"_$Get(NPEC)_"|"_$Get(DPCL)_"|"_$G(ICPC)
 ;
GRI1 
 ; Variaveis que compõe a memoria e calculo no momento do item na criação do pedido
 
 ;PRVPRE => Custo Refinaria
 ;PRVEDI => Vl.Encargo Distribuidora
 ;PRVFRU => Frete Unitário
 ;PRVUPF => Pedágio Frete Unitário
 ;PRVFRT => Vl.Frete Transferência (**)
 ;PRVDPC => Vl.Desconto Pr.Combustível
 ;PRAPIS => Aliq.PIS
 ;PRAFIN => Aliq.CONFINS
 ;PRPLUC => Perc.Lucro Interestadual
 ;PRBORE => Pr.Bomba da Subst.Tributária da Refinaria (PMPF/MVA)
 ;PREFPP => Encargos de Prazo
 ;PRVDUF => Desconto da UF
 ;PRICMP => ICMS Devido
 ;PRMMAX => Margem Máxima
 ;PRMDCL => Margem Aplicada
 ;PRVPIS => Vl.PIS
 ;PRVCOF => Vl.COFINS
 ;PRVDAC => Vl.Desp.Acessórias
 ;PRVFRT => Vl.Frete Transferência (**)
 ;PRCUSA => Vl.Custo Aditivação
 ;PRSUPJ => Vl.Custo Logístico (Tx.Ped.Janela)
 ;PRVPDP => Vl.PIS Distribuidora
 ;PRVCDP => Vl.COFINS Distribuidora 
 ;PRVUNI => Vl.Unitário Produto
 ;PRDAICM=> %ICMS Devido
 ;PRRAIRE=> %ICMS Subst.Tributária (ICMS Retido)
 ;PRPBRE => Pr.Bomba
 ;PRGDCL => GAP Produto Aditivado/Premium
 ;PRVPREA=> Custo Refinaria Calculado p/A.Anidro (compõe VPRE)
 ;PRVPREG=> Custo Refinaria Calculado p/Gasolina A (compõe VPRE)
 ;PRDPCF => Desconto PIS/COFINS Calculado (compõe VPRE)
 S X=""
 S $P(X,"|",1)=$G(PRVPRE),$P(X,"|",2)=$G(PRVEDI),$P(X,"|",3)=$G(PRVFRU)
 S $P(X,"|",4)=$G(PRVFRT),$P(X,"|",5)=$G(PRVDPC),$P(X,"|",6)=$G(PRAPIS)
 S $P(X,"|",7)=$G(PRAFIN),$P(X,"|",8)=$G(PRPLUC),$P(X,"|",9)=$G(PRBORE)
 S $P(X,"|",10)=$G(PREFPP),$P(X,"|",11)=$G(PRVDUF),$P(X,"|",12)=$G(PRICMP)
 S $P(X,"|",13)=$G(PRMMAX),$P(X,"|",14)=$G(PRMDCL),$P(X,"|",15)=$G(PRVPIS)
 S $P(X,"|",16)=$G(PRVCOF),$P(X,"|",17)=$G(PRVDAC),$P(X,"|",18)=$G(PRVFRT)
 S $P(X,"|",19)=$G(PRCUSA),$P(X,"|",20)=$G(PRSUPJ),$P(X,"|",21)=$G(PRVPDP)
 S $P(X,"|",22)=$G(PRVCDP),$P(X,"|",23)=$G(PRVUNI),$P(X,"|",24)=$G(PRDAICM)
 S $P(X,"|",25)=$G(PRRAIRE),$P(X,"|",26)=$G(PRPBRE),$P(X,"|",27)=$G(PRGDCL) 
 S $P(X,"|",28)=$G(PRVPREA),$P(X,"|",29)=$G(PRVPREG),$P(X,"|",30)=$G(PRDPCF) 
 S $P(X,"|",31)=$G(PRVIRI),$P(X,"|",32)=$G(PRVUPF)
 ;;; LINHA COMENTADA P/POSTERIOR LIBERAÇÃO DO HONÓRIO - DSD-01/2015 ; S ^IFAUX(PART,0,ITPE,3)=X 
 ;
GRIZ Q  
 ;
EDS D EDS^IFPEAT04 Q  
VEF D VEF^IFPEAT04 Q  
EDE D EDE^IFPEAT04 Q  
RFI D RFI^IFPEAT14 Q  
VPA D VPA^IBSRVP Q
 ;
IPP  I $D(^IBDPA(EMGR,CDEE)) S X=^IBDPA(EMGR,CDEE),YCDEE=$P(X,"|",2)
IPPZ Q
]]></Routine>


<Routine name="IFPEAT46" type="MAC" languagemode="0" timestamp="65441,43248"><![CDATA[
IFPEAT46 ;Atendimento a Cliente <V1.0-FFF-11/94> ; Última Alteração   mludwig 20/03/2018 15:37:20 ;Última Alteração   FLCARVALHO 14/11/2019 16:16:35
#Include sistema.BibliotecaMacro
 ;
AMI ;Armazena item 
 New XLORE
 S (ISUD,ISUQ,ISUC,ISUE,ISUV,ISUP)=0,VITP="0",IATP="0"  
 D VPA
 I CPRO=12000000 G AMI2 ; pedido de gas natural nao pode ficar suspenso
 I $G(IFAV)=1 G AMI2  ; <flcarvalho - GDTI-4701 - Tarefa-112791 - Faturamento antecipado Vendor - 2019/08>
 I CTOP?1"01",'CDEV D VDV I DEBITO S ISUV="1" 
 ;Se é remessa para armazenagem e se LORE é o próprio armazenador, então 
 ;deve baixar o saldo disponível do depósito da filial.
 Set XLORE=LORE
 If (CNOS="030209")&&(CFOR=LORE) Set XLORE="1"_CDEE
 ;Recupera ISUD, ISUE e IATP
 Do verificarEstoqueDisponivel^IBSREB3(CDEE,CNOP,CPRO,QPED,XLORE,ESTO,IPRI,/*AAP*/ 1,.ISUD,.ISUE,.IATP)		;
 I IPRI,(ISUD||ISUE) S MS=591,ERR=2 D MEN G AMIZ 
 I CTOP'?1"01" G AMI2 
 I CDEV S ISUQ=1 
 ;
AMI1 ; Chamada p/Verificação de Susp.Prç.Mínimo
 ;I CTOP="01",CLPR=2,EEMB,CNOS'="010267",('ICCR!(CNEG?1"12120")) D VPM
 ;I CTOP="01",EEMB,CNOS'="010267",(CLPR=2!($E(CPRO,1,2)=67)),('ICCR!(CNEG?1"12120")) D VPM ;;; Inclusão de Produto ARLA (67)
 I CTOP="01",EEMB,CNOS'="010267",(CLPR=2!($E(CPRO,1,2)=67)) D VPM  ;;; Retirada da exclusividade p/pedido CIF e 
 ;                                                                  ;;; destribuidores autorizados (12120) - TAREFA 00836E5A - DSD - 10/2013
 /// HPJ TAREFA Nº0047652A 09/2014
 /// Inclusao de produto granel para calculo de preco minimo. Foi removido EEMB
 ; I CTOP="01",CNOS'="010267",(CLPR=2!($E(CPRO,1,2)=67)) D VPM 
 /// Retirada da exclusividade p/pedido CIF e destribuidores autorizados (12120) - TAREFA 00836E5A - DSD - 10/2013
 ;
AMI2 S ISUS=ISUD_ISUQ_ISUC_ISUE_ISUV_ISUP 
 ;DEF.PESO BRUTO ITEM
 I ITPE'=XITPE,XISUS="000000" S PBU=(+PBU-XPBRU) 
 I ISUS'="000000" G AMI3 
 S X=(+PBRU*QPED),PBU=(+X+PBU) 
 G AMI4 
 ;Suspenso
AMI3 S MS=596,CMS="",ER="" 
 I ISUD?1"1" S CMS=CMS_"DISPONIBILIDADE," 
 I ISUQ?1"1" S CMS=CMS_"PGTO.ANTECIP.," 
 I ISUC?1"1" S CMS=CMS_"CREDITO," 
 I ISUE?1"1" S CMS=CMS_"ESTOQUE," 
 I ISUV?1"1" S CMS=CMS_"DEB. VENCIDO," 
 I ISUP?1"1" S CMS=CMS_"PRECO MINIMO," 
 S CMS=$E(CMS,1,$L(CMS)-1) 
 D MEN 
 $$$ReadT(X,2)  
 I DENT=99999 D EDS 
 ;
AMI4 D GIA 
 I XITPE=1,CDEV D LIB ; NAO TROCAR PARA PRAZ=0!!!
 ;
 K X,IPDG,ISUS,ISUD,ISUQ,ISUC,ISUE,ISUV,ISUP 
 K IATP,IADC,VITP,XVUNP,XCPRO,LFU,LVU,LUB 
 K UME,AIPI,PBRU,CPRO 
 ;
AMIZ Q  
 ;
GIA ;Grava item no auxiliar 
 N YCDEE
 S YCDEE=CDEE
 I DNOR'="",NDRF'="",'$D(^IFREF(CDEE,DNOR,NDRF)) D IPP
 S IICM=IIICM 
 S SPED="1",XPBRU=(+PBRU*QPED) 
 ;Embalados têm ILCP e LORE definidos pelo rótulo EED^IFPEAT41
 ;e não utiliza as informações DENTRO e FORA, que são definidos por VEP.
 Set (DENTRO,FORA)="" I 'XEEMB Do defineLocalCar^IBSRLC(CDEE,CPRO,DFAT,CCLI,ILCP,.DENTRO,.FORA)
 S X="",$P(X,"|",1)=CPRO,$P(X,"|",2)=IPRI,$P(X,"|",3)=QPED 
 S $P(X,"|",4)=VUNP,$P(X,"|",5)=IPDG,$P(X,"|",6)=VFRU,$P(X,"|",7)=IUBO 
 S $P(X,"|",13)=SPED,$P(X,"|",14)=ISUS,$P(X,"|",15)="000000" 
 S $P(X,"|",16)=IATP,$P(X,"|",17)=IADC,$P(X,"|",22)=TAMO 
 S $P(X,"|",23)=DAMO,$P(X,"|",24)=TAMB,$P(X,"|",25)=QKGC 
 S $P(X,"|",28)=AIPI,$P(X,"|",29)=VITP,$P(X,"|",30)=XPBRU 
 S $P(X,"|",31)=VUFD,$P(X,"|",32)=IFDG,$P(X,"|",34)=PADL 
 S $P(X,"|",35)=VULI,$P(X,"|",36)=VMVC,$P(X,"|",37)=IINF 
 S $P(X,"|",38)=CMOR,$P(X,"|",39)=VFCI,$P(X,"|",40)=VMAX 
 S $P(X,"|",41)=VDEP,$P(X,"|",42)=PRAZ,$P(X,"|",44)=VTTB 
 S $P(X,"|",45)=IPDA,$P(X,"|",46)=IFET 
 S $P(X,"|",47)=VDPC,$P(X,"|",48)=VPSD,$P(X,"|",49)=ICFT 
 ;ILCP e LORE - Dentro/fora e local de retirada
 S $P(X,"|",50)=ILCP,$P(X,"|",51)=DENTRO,$P(X,"|",52)=FORA,$P(X,"|",54)=LORE 
 S $P(X,"|",53)=NFSC,$P(X,"|",55)=EFPP,$P(X,"|",56)=ITRP 
 S $P(X,"|",60)=AICM,$P(X,"|",61)=AIRE 
 S $P(X,"|",62)=IICM,$P(X,"|",65)=TPRZ 
 ; recupera prazo cobranca
 I $D(TPCB)&($D(PZCB)) S $P(X,"|",66)=TPCB,$P(X,"|",67)=PZCB 
 ;
 ;Documento de referencia - SPED
 S $P(X,"|",94)=YCDEE,$P(X,"|",95)=NDRF,$P(X,"|",96)=DNOR,$P(X,"|",97)=ITRF
 ; 
 S $P(X,"|",98)=DMSC
 ;
 #;<AUD - Projeto ELO - Fase 3 Incorporação>
 #; Tratamento do Pedido Externo>
 Set NPEI=NPEE
 If ($D(oArrDadosExt))&&(oArrDadosExt.Count()>0) {
	 Set NIPE=oArrDadosExt.GetAt("NIPE")
	 Set NPEI=oArrDadosExt.GetAt("NPEI")
 }
 Set $P(X,"|",100)=NPEI
 Set $P(X,"|",101)=NIPE
 #;</AUD - Projeto ELO - Fase 3 Incorporação>
 #;
 ;
 ; <AMAURI - TAREFA 00458FCC - 26/09/2014>
 ; Projeto Convenio 38 (4%) - Funcionalidade do sistema ABADI para permitir cadastrar
 ; parametros fiscais a fim de atender a legislação do convênio 38 do ICMS
 ; Informar Origem e FCI p/ Consumo
 ;
 Set $P(X,"|",103)=$Get(NFCI)
 Set $P(X,"|",110)=$Get(ORIP)
 ;
 ; <FIM AMAURI - TAREFA 00458FCC - 26/09/2014>
 ;Dados de exportação para o item - IDDR, NREE e CNFE
 Set $P(X,"|",111)=$Get(IDDR),$P(X,"|",112)=$Get(NREE),$P(X,"|",113)=$Get(CNFE)
 ;Grava dados de preço nacional e importado, para fins de alteração de preço conforme a origem.
 If $G(VULE)>0 Set $P(X,"|",122)=VULE,$P(X,"|",124)=VFPI
 If $G(VULN)>0 Set $P(X,"|",123)=VULN,$P(X,"|",125)=VFPN
 ;
 S $P(RIT,"|",126)=$G(VUNV) ; <flcarvalho - GDTI-4701 - Tarefa-112791 - Faturamento antecipado Vendor - 2019/08>
 S $P(RIT,"|",127)=$G(DFAG) ; <flcarvalho - GDTI-5608 - 2020/03 - Diferença entre o valor unitário original e o ganho de ajuste (arredondamento)>
 ;
 Set ^IFAUX(PART,0,XITPE)=X
 //adicionado para gravar o PartNumber. <AHZ>
 Set ^IFAUX(PART,0,XITPE,1)=$Get(CPEC)_"|"_$Get(NPEC)_"|"_$Get(DPCL)_"|"_$G(ICPC)
 I XITPE=1,$O(^IFAUX(PART,0,XITPE))?1"" G GIAZ 
 S IT=XITPE 
GIA1 S IT=$O(^IFAUX(PART,0,IT)) I IT?1"" G GIAZ 
 S X=^IFAUX(PART,0,IT),$P(X,"|",42)=PRAZ,^IFAUX(PART,0,IT)=X 
 G GIA1 
GIAZ Q  
 ;
VPM ;Verifica preco minimo
 D ^IBSRPM 
 I VUNP<PRMIN S ISUP="1" 
 K PRMIN 
VPMZ Q  
 ;
LIB ;Libera pedidos suspensos por credito
 N XITPE,ISUS,X 
 S CMS="" 
 S XITPE=1 
LIB1 S XITPE=$O(^IFAUX(PART,0,XITPE)) I XITPE?1"" G LIB2 
 S X=^IFAUX(PART,0,XITPE),ISUS=$P(X,"|",14) 
 I $E(ISUS,3)="0" G LIB1 
 S ISUS=$E(ISUS,1,2)_"0"_$E(ISUS,4,6),$P(X,"|",14)=ISUS,^IFAUX(PART,0,XITPE)=X 
 I CMS?1"" S CMS=XITPE 
 E  S CMS=CMS_", "_XITPE 
 G LIB1 
LIB2 I CMS'?1"" S MS=795,ER="" D ^GAP.GAREM $$$ReadT(X,2)  
LIBZ Q  
 ;
MEN D ^GAP.GAREM Q  
EDS D EDS^IFPEAT04 Q  
VEF D VEF^IFPEAT04 Q  
EDE D EDE^IFPEAT04 Q  
VDV D VDV^IFPEAT15 Q 
VPA D VPA^IBSRVP Q
 ;
IPP ;
 I $D(^IBDPA(EMGR,CDEE)) S X=^IBDPA(EMGR,CDEE),YCDEE=$P(X,"|",2)
IPPZ Q
 ; 
Z P IFPEAT46 X "ZS IFPEAT46" Q  
]]></Routine>


<Routine name="IFPEAT6A" type="MAC" languagemode="0" timestamp="65441,37211.65831"><![CDATA[
IFPEAT6A ;Atendimento a Cliente<V1.0-PNC-12/94> ; Jan 27 2005  9:41 AM ;dsdÚltima Alteração   mludwig 19/03/2018 21:21:07 ;Última Alteração   FLCARVALHO 03/03/2020 10:20:11
#Include sistema.BibliotecaMacro
 ; 
AIT ;Altera ITens
 D MTE 
 S X=^IBCLI(CCLI,0),SCLI=$P(X,"|",22) 
 S X=^IBDEP(CDEE),CGCDX=$P(X,"|",9),PPCNPJ=$E(CGCDX,1,8)
AIT1 D LOP I PF1 G AITZ 
 I "1/2"[OPI,SCLI S MS=892,CMS="incluir ou alterar item" D ^GAP.GAREM G AITZ 
 I OPI=1 D INI G AIT2 
 D IIT I PF1 G AITZ 
 I OPI=2 D ALI 
 I OPI=3 D CAI 
AIT2 ;Recalcula o frete do pedido
 ;D RFA
AITZ W /CUP(9,1),/ED(0) Q  
 ;
RFA ;Recalcula Frete apos Alteracao dos itens
 S X=^IFPED(CDEE,NPED),CNOP=$P(X,"|",3) 
 S X=^IBNOP(CNOP),CNOS=$P(X,"|",4),CTOP=$E(CNOS,1,2) 
 I CTOP'?1"01","030267/030269/030261"'[CNOS G RFAZ 
RFA10 ;Soma volume total para calculo de frete
 S VOLFRT=0,ITPE="" 
RFA11 S ITPE=$O(^IFPED(CDEE,NPED,0,ITPE)) I ITPE="" G RFA20 
 S X=^IFPED(CDEE,NPED,0,ITPE),QPED=$P(X,"|",3) 
 S VOLFRT=VOLFRT+QPED 
 G RFA11 
 ;
RFA20 S ITPE="" 
 S VOLUMEFRETE=VOLFRT 
 ;
RFA21 ;Recalcula Frete e Preco Unitario de cada item
 S ITPE=$O(^IFPED(CDEE,NPED,0,ITPE)) I ITPE="" G RFAZ 
 S (CNOP,CNOS,CTOP,CDOP,CPRO,IPRI,QPED,VUNP,VUNV,VUNI,IPDG,DMSC,DFAG)="" 
 S (VFRU,DVFRU,VUPF,IUBO,IFRC,IATP,AQPED,ISUE,ISUD,ISUQ,ISUC,ISUV,ISUP,ILID)="" 
 S (ILIV,ILIP,NPRO,IPRT,EEMB,CNEG,QDIB,IALT,CUFE,CMUE,VMVC,IINF)="" 
 S (CMOR,VFCI,VMAX,VDEP,VTTB,IPDA,VDPC,VPSD,ICFT,NFSC,EFPP,CCOA)="" 
 S (NTAN,Q20C,VUDC)="" 
 S X=^IBDEP(CDEE),CUFD=$P(X,"|",8) 
 S (PADL,VULI,NLPLU,PF1PLU)="" 
 D RAI 
 S VOLFRT=VOLUMEFRETE 
 D CFU 
 W /CUP(13,64),/ICC24,/RAW($J((+VFRU/100),14,4)) $$$Read(X)  ; Exibe Frete
 D DVD 
 S VUNP=VUNI 
 D EVU 
 D GIA 
 G RFA21 
 ;
RFAZ Q  
 ;
MTE ;Monta TEla
 W /CUP(9,1),/ED(0) 
 W /CUP(9,2),/RAW("Opcao:     ["),/ICC29,/CUP(9,16),/ICC28,/RAW("]  <1>-Inclusao   <2>-Alteracao   <3>-Exclusao") 
 W /CUP(11,2),/RAW("Item: ["),/ICC29,/CUP(11,13),/ICC28,/RAW("]  Ultima Alteracao:"),/ICC29,/CUP(11,78),/ICC28 
 W /CUP(12,4),/RAW("Produto:     ["),/ICC29,/CUP(12,27),/ICC28,/RAW("] ("),/ICC29,/CUP(12,78),/ICC28,/RAW(")") 
 W /CUP(13,4),/RAW("Quantidade:  ["),/ICC29,/CUP(13,26),/ICC28,/RAW("]") 
 W /CUP(13,45),/RAW("Frete Unitario:  ["),/ICC29,/CUP(13,78),/ICC28,/RAW("]") 
 W /CUP(14,4),/RAW("Bomba:       ["),/ICC29,/CUP(14,20),/ICC28,/RAW("]") 
 W /CUP(14,45),/RAW("Acre(+) Desc(-): ["),/ICC29,/CUP(14,78),/ICC28,/RAW("]") 
 W /CUP(15,4),/RAW("Cons. Final: ["),/ICC29,/CUP(15,20),/ICC28,/RAW("]") 
 W /CUP(15,45),/RAW("Preco Unitario:  ["),/ICC29,/CUP(15,78),/ICC28,/RAW("]") 
 W /CUP(16,4),/RAW("Prazo(s):    ["),/ICC29,/CUP(16,22),/ICC28,/RAW("] ["),/ICC29,/CUP(16,30),/ICC28,/RAW("] ["),/ICC29,/CUP(16,38),/ICC28,/RAW("]") 
 W /CUP(16,45),/RAW("Pedido Externo:  ["),/ICC29,/CUP(16,78),/ICC28,/RAW("]") 
 W /CUP(17,17),/RAW("["),/ICC29,/CUP(17,22),/ICC28,/RAW("] ["),/ICC29,/CUP(17,30),/ICC28,/RAW("] ["),/ICC29,/CUP(17,38),/ICC28,/RAW("]") 
 W /CUP(17,45),/RAW("Item Pedido Ext: ["),/ICC29,/CUP(17,78),/ICC28,/RAW("]") 
 W /CUP(18,45),/RAW("Desc.Comercial:  ["),/ICC29,/CUP(18,78),/ICC28,/RAW("]") ; GDTI 3262 - TAREFA 84458 - DSD - 08/2018 
MTEZ Q  
 ;
LOP ;Le OPcao
 S PF1=0 
 W /CUP(9,15),/ICC24,/CON U 0:(256:"FC":$C(21,24)) $$$Read(R)  S:$A($ZB)=21!($A($ZB)=24) R=$ZB W:$A($ZB)=24 /ICC24 U 0:(256:"SFC":$C(21,24)) W /COFF,/ICC20,/ICC13 
 I $A(R)=21!(R?1"") S PF1=1 G LOPZ 
 I R?1C S MS=3 D ^GAP.GAREM G LOP 
 I R'=1,R'=2,R'=3 S MS=25,CMS=3 S:R?1"?" ER="" D ^GAP.GAREM G LOP 
 I PTAU?1"1",R'=3 S MS="Pedido de Transferencia gerado automaticamente. Nao pode ser alterado." D ^GAP.GAREM G LOP:('$D(^ISUEA(%US))) 
 I PVAU?1"1",R'=3 S MS="Pedido de Venda gerado automaticamente. Nao pode ser alterado." D ^GAP.GAREM G LOP:('$D(^ISUEA(%US))) 
 I R=1,DFAB,$E(CCLI,1,8)=PPCNPJ,CTOP="02" S X=$G(^IBUSP(%US)),UPTM=$P(X,"|",22) I +UPTM=0 S MS="Pedido de Transferencia deve ser registrado no JDE." D ^GAP.GAREM G LOP ;*** JDE ***
 I R=1,$D(^ICDEV(CCLI,0)) S MS="ERRO: Opção inválida p/pedido cliente PA.",ER="" D ^GAP.GAREM G LOP ; TAREFA 004A6C45 - DSD - 04/12
 I %ROT="PD",CTOP="01",R=1 S MS="So' e' possivel incluir itens de venda atraves da rotina FAT/PE/AT." D ^GAP.GAREM G LOP 
 I FLVUDC,R=1 S MS="Pedido c/desc.comercial não pode ser alterado." D ^GAP.GAREM G LOP ; TAREFA 84458 - DSD - 08/2018
 S OPI=+R 
LOPZ Q  
 ;
IIT ;Identifica ITem
 S PF1=0 
IIT1 W /CUP(11,10),/ICC24,/CON U 0:(256:"FC":$C(21,24)) $$$Read(R)  S:$A($ZB)=21!($A($ZB)=24) R=$ZB W:$A($ZB)=24 /ICC24 U 0:(256:"SFC":$C(21,24)) W /COFF,/ICC20,/ICC13 
 I R?1""!($A(R)=21) S PF1=1 G IITZ 
 I R?1C S MS=3 D ^GAP.GAREM G IIT1 
 I R'?.N!($L(R)>3) S MS=17,CMS=3 S:R?1"?" ER="" D ^GAP.GAREM G IIT1 
 I '$D(^IFPED(CDEE,NPED,0,+R)) S MS=576 D ^GAP.GAREM G IIT1 
 S X=^IFPED(CDEE,NPED,0,+R),SPED=$P(X,"|",13),NORC=$P(X,"|",40) 
 I SPED=6 S MS=632 D ^GAP.GAREM G IIT1 
 I OPI=2,SPED=7 S MS=630,CMS="transferido",CMS1="alterar" D ^GAP.GAREM G IIT1 
 I '$D(^ISUEA(%US)),OPI=2&($D(^IFCOL(CDEE,NPED,+R))) S MS="Item nao pode ser alterado, ja tem data de coleta." D ^GAP.GAREM G IIT1 
 I OPI=2,SPED'=1 S MS=630,CMS="alocado",CMS1="alterar" D ^GAP.GAREM G IIT1 
 I OPI=2&(NORC'="") S MS="Item nao pode ser alterado, ja esta em OC." D ^GAP.GAREM G IIT1:('$D(^ISUEA(%US))) 
 I OPI=2 D VAL I 'OK G IIT1 
 I OPI=3,SPED=7 S MS=630,CMS="transferido",CMS1="cancelar" D ^GAP.GAREM G IIT1 
 I OPI=3,SPED=4!(SPED=5) S MS=630,CMS="faturado",CMS1="cancelar" D ^GAP.GAREM G IIT1 
 I OPI=3 D VCA I 'OK G IIT1 
 I OPI=3,NORC'?1"",'PTAU,'PVAU S MS="Item nao pode ser excluido, ja esta em OC." D ^GAP.GAREM G IIT1 
 ;;;I '$D(^ISUEA(%US)),OPI=3&($D(^IFCOL(CDEE,NPED,+R))),'PTAU,'PVAU S MS="Item nao pode ser excluido, ja tem data de coleta." D ^GAP.GAREM G IIT1 
 S ITPE=+R I $L(ITPE)<2 W /CUP(11,10),/ICC24,/RAW(ITPE) 
IITZ Q  
 ;
VAL ;Verifica ALteracao
 S OK=1 
 S X=^IFPED(CDEE,NPED,0,+R),NORC=$P(X,"|",40) 
 I '$D(^IBUSP(%US)) S UPMP="" I 1 
 E  S X=^IBUSP(%US),UPMP=$P(X,"|",4) 
 ; Tarefa 0060514B - desvincula a permissão de manutenção de pedido da restrição de existir Ordem de Carregamento 
 I NORC'?1"" S NORC=$E(NORC+1000000,2,7),MS=748,CMS="ordem de carregamento",CMS1=NORC,OK=0 D ^GAP.GAREM 
 ;I NORC'?1"",UPMP'?1"1" S NORC=$E(NORC+1000000,2,7),MS=748,CMS="ordem de carregamento",CMS1=NORC,OK=0 D ^GAP.GAREM 
 I $D(^ISUEA(%US)) S OK=1
VALZ Q  
 ;
VCA ;Verifica CAncelamento
 S OK=1 
 I $D(^IFPED(CDEE,NPED,5,+R)) S MS=863,CMS="Item",CMS1="Impossivel cancelar.",OK=0 D ^GAP.GAREM G VCAZ 
 I $D(^IFPFA(CDEE,NPED)) S MS="Pedido esta' sendo faturado. Impossivel cancelar.",OK=0 D ^GAP.GAREM G VCAZ 
 S X=^IFPED(CDEE,NPED,0,+R),IAPM=$P(X,"|",34),NORC=$P(X,"|",40),NOCA=$P(X,"|",64),NORT=$P(X,"|",69) 
 I IAPM'?1"" S MS=877,OK=0 D ^GAP.GAREM G VCAZ 
 I NOCA'?1"" S NOCA=$E(NOCA+1000000,2,7),MS=748,CMS="ordem de carregamento",CMS1=NOCA,OK=0 D ^GAP.GAREM G VCAZ 
 I NORT'?1"" S NORT=$E(NORT+1000000,2,7),MS=748,CMS="ordem de retirada",CMS1=NORT,OK=0 D ^GAP.GAREM G VCAZ 
 I '$D(^IBUSP(%US)) S UPMP="" 
 E  S X=^IBUSP(%US),UPMP=$P(X,"|",4) 
 I NORC'?1"",UPMP'?1"1" S NORC=$E(NORC+1000000,2,7),MS=748,CMS="ordem de carregamento",CMS1=NORC,OK=0 D ^GAP.GAREM 
VCAZ Q  
 ;
INI D INI^IFPEAT6B Q  
ALI D ALI^IFPEAT6K Q  
CAI D CAI^IFPEAT6P Q  
RAI D RAI^IFPEAT6K Q  
CFU D CFU^IFPEAT6D Q  
DVD D DVD^IFPEAT6E Q  
EVU D EVU^IFPEAT6E Q  
GIA D GIA^IFPEAT6N Q  
 ;
]]></Routine>


<Routine name="IFPEAT6B" type="MAC" languagemode="0" timestamp="65441,37264.294706"><![CDATA[
IFPEAT6B ;Atendimento a Cliente<V1.0-PNC-12/94> ;Última Alteração   FLCARVALHO 03/03/2020 10:21:04
#Include sistema.BibliotecaMacro
 ;   
INI ;INclui Item
 S (ITPE,XCPRO,XCIPI,XITRP,XAIPI,XITRI,XTPRO,XEEMB,CNOP,CNOS,CTOP)="" 
 S (CDOP,CNEG,IALT,CPRO,NPRO,IATP,IADC,CEMB,EEMB,NDRF,DNOR,ITRF)="" 
 S (CLPR,ITRP,AIPI,ITRI,EMPE,TPRO,IPRT,CIPI,EMBA,QPED,VUNP,VUNV,DFAG)="" 
 S (VUNI,VFRU,DVFRU,IUBO,IPRI,ICCR,IPDG,IFRC,YITPE,CMUE,CUFE,CUFD,PTAU)="" 
 S (ITFL,PADL,VULI,VMVC,IINF,CMOR,VFCI,VDEP,VMAX)="" 
 S (VTTB,VDPC,VPSD,ICFT,NFSC,EFPP,CCOA,Q20C,NTAN)="" 
 S (PRAZ,PRAZ1,PRAZ2,PRAZ3,PRAZ4,PRAZ5,PRAZ6,TPCB,PZCB)="" 
 S (TPRZ,IPDA,IPIN)=0 
 //
 S (NPEE,NIPE)=""
 //
 D RII I SAI G INIZ 
 W /CUP(11,10),/ICC24,/RAW(ITPE) I $L(ITPE)'<2 $$$Read(X)  
 D LDI I PF1!SAI G INIZ 
 D DCA 
 D VEI I SAI G INIZ 
 D AII 
INIZ S %K=",VPROD,XCCLI,CCLI,NCLI,SCLI,CDOP,PF1,SAI,NPED,OPI,LCC,TCA,NCDEE,NDFAT,OP,BRANCO,CDCA,CZVC,COTT,TCLI,NZVE,FLVUDC,CNEG,CIEC,PART,OPC,ADENT,CTOP,IFAV,ISRV" D ^GAP.GARKG 
 W /CUP(17,1),/ED(0) 
 Q  
 ;
RII ;Recupera dados para Inclusao do Item
 S SAI=0,IFDG=0,VUFR="" 
 S X=^IFPED(CDEE,NPED),CNOP=$P(X,"|",3),CLPA=$P(X,"|",4),TOPA=$P(X,"|",6),ICCR=$P(X,"|",16),IPCF=$P(X,"|",15),ITFL=$P(X,"|",20),IIPI=$P(X,"|",11),IPCO=$P(X,"|",27),DENT=$P(X,"|",5),DFPR=$P(X,"|",31),DMEN=$P(X,"|",32),DACL=$P(X,"|",33),PTAU=$P(X,"|",35),ADENT=DENT 
 I IPCO S MS="Pedido congelado. Impossivel inclusao",SAI=1 D ^GAP.GAREM $$$ReadT(X,2)  G RIIZ 
 S X=^IBNOP(CNOP),CNOS=$P(X,"|",4),IEST=$P(X,"|",7),IEDI=$P(X,"|",8) 
 S CTOP=$E(CNOS,1,2),COOP=$E(CNOS,3,4),CDOP=$E(CNOS,5,6) 
 S ITPE=$O(^IFPED(CDEE,NPED,0,"")),X=^IFPED(CDEE,NPED,0,ITPE),XCPRO=$P(X,"|",1),WCTRA=$P(X,"|",10),SPED=$P(X,"|",13),ESTO=$P(X,"|",57),LCARG=$P(X,"|",67),XAIPI=$P(X,"|",28),XPRAZ=$P(X,"|",74) 
 I ESTO=3 S ESTO=1 
 ; recupera prazo de cobranca
 S TPCB=$P(X,"|",76),PZCB=$P(X,"|",77) 
 ;
 S XPRAZ1=$P(XPRAZ,"/",1) 
 S XPRAZ2=$P(XPRAZ,"/",2) 
 S XPRAZ3=$P(XPRAZ,"/",3) 
 S XPRAZ4=$P(XPRAZ,"/",4) 
 S XPRAZ5=$P(XPRAZ,"/",5) 
 S XPRAZ6=$P(XPRAZ,"/",6) 
 I (+XAIPI)=0 S XITRP=0 
 E  S XITRP=1 
 S PRAZ=XPRAZ1 ; TAREFA 006B23BF HPJ
 S X=^IBPRO(XCPRO),XCIPI=$P(X,"|",13),XITRI=$P(X,"|",18),XTPRO=$P(X,"|",21),CEMB=$P(X,"|",4),XCLPR=$P(X,"|",24) 
 I $E(XCLPR)'=1 S PRAZ=XPRAZ,PRAZ1=XPRAZ1,PRAZ2=XPRAZ2,PRAZ3=XPRAZ3,PRAZ4=XPRAZ4,PRAZ5=XPRAZ5,PRAZ6=XPRAZ6 
 I XCLPR=8 S SAI=1,MS=346,CMS="incluido equipamento" D ^GAP.GAREM G RIIZ 
 S X=^IBEMB(CEMB),XEEMB=$P(X,"|",3) 
 S IATP="" I XEEMB S IATP=0 S:TOPA="P" IATP=1
 K PRO I SPED'=6 S PRO(XCPRO)=ITPE 
 S NIT=1,UITPE=ITPE 
RII1 S ITPE=$O(^IFPED(CDEE,NPED,0,ITPE)) I ITPE?1"" G RII2 
 S NIT=NIT+1,UITPE=ITPE 
 S X=^IFPED(CDEE,NPED,0,ITPE),CPRO=$P(X,"|",1),SPED=$P(X,"|",13) 
 I SPED'=6 S PRO(CPRO)=ITPE 
 G RII1 
RII2 ;I NIT'<10 S SAI=1,MS=628,CMS=10 D ^%GAREM G RIIZ
 ;I UITPE'<99 S SAI=1,MS=630,CMS="atingiu o numero 99",CMS1="incluir itens no pedido" D ^GAP.GAREM G RIIZ 
 S ITPE=UITPE+1 
 S X=^IBCLI(CCLI,2),CNEG=$P(X,"|",2) 
 S X=^IBCLI(CCLI,1),CMUE=$P(X,"|",4) 
 S X=^IBMUN(CMUE),CUFE=$P(X,"|",4) 
 S X=^IBDEP(CDEE),CUFD=$P(X,"|",8)
 S X=$G(^IBICB(CCLI,CDEE)),CMKC=$P(X,"|",3),CMKE=$P(X,"|",4) 
 S CCMK=CMKC I TPRO S CCMK=CMKE 
 S X=^IFCOF,IALT=$P(X,"|",1) 
RIIZ K UITPE,NIT,SPED,CMKC,CMKE Q  
 ;
DCA ;define Dados do CArregamento
 S IADC=1 
 S X=^IBPRO(CPRO),CUME=$P(X,"|",5),CGMP=$P(X,"|",15) 
 ;I EEMB=0,(CTOP?1"02"&(CDOP'?1"43")) S IADC=2
 ; matheusrc GDTI 3390 - Melhoria na operação Anglo American - Regime especial
 I EEMB=0,(CTOP?1"02"&(CDOP'?1"43"))! $D(^IBDCO(CNOS)) S IADC=2 
DCAZ K CUME Q  
 ;
VEI ;Verifica Estado do item p/ Inclusao
 New XLORE
 S XXCPRO=CPRO N CPRO S CPRO=XXCPRO 
 I $E(CPRO,1,2)=11 S CPRO=11100001 
 I $E(CPRO,1,2)=15 S CPRO=15010007 
 S SAI=0 
 S (ISUD,ISUQ,ISUC,ISUE,ISUV,ISUP)=0 
 I CPRO=12000000 G VEI1 ; pedido de gas natural nao pode ficar suspenso
 I $G(IFAV)=1 G VEI1  ; <flcarvalho - GDTI-4701 - Tarefa-112791 - Faturamento antecipado Vendor - 2019/08>
 ;Se é remessa para armazenagem e se LORE é o próprio armazenador, então 
 ;deve baixar o saldo disponível do depósito da filial.
 Set XLORE=LORE
 Set CFOR = $Get(CFOR) 
 If (CNOS="030209")&&(CFOR=LORE) Set XLORE="1"_CDEE
 ;Recupera ISUD, ISUE e IATP
 Do verificarEstoqueDisponivel^IBSREB3(CDEE,CNOP,CPRO,QPED,XLORE,ESTO,IPRI,/*AAP*/ 1,.ISUD,.ISUE,.IATP)		;
 I IPRI,(ISUD||ISUE) S SAI=1,MS=591 D ^GAP.GAREM G VEIZ 
 D VPA
 I CTOP?1"01",'CDEV D
 .D VCR 
 .D VDV I DEBITO S ISUV=1 
 ;;;I CTOP?1"01",CLPR?1"2",EEMB,CNOS'?1"010267" D VPM
 I CTOP="01",EEMB,CNOS'="010267",(CLPR=2!($E(CPRO,1,2)=67)) D VPM         ;;;67 Produto ARLA
 ;I EEMB G VEI1 
 I CDEV S ISUQ=1 
VEI1 ;I 'ISUD,'ISUQ,'ISUC,'ISUV,'ISUP G VEIZ
 I 'ISUD,'ISUC,'ISUE,'ISUV,'ISUP G VEIZ 
 S MS=596,CMS="",ER="" 
 I ISUD S CMS=CMS_"DISPONIBILIDADE," 
 ;I ISUQ S CMS=CMS_"PGTO.ANTECIP.,"
 I ISUC S CMS=CMS_"CREDITO," 
 I ISUE S CMS=CMS_"ESTOQUE,"
 I ISUV S CMS=CMS_"DEBITO VENCIDO," 
 I ISUP S CMS=CMS_"PRECO MINIMO," 
 S CMS=$E(CMS,1,$L(CMS)-1) D ^GAP.GAREM $$$ReadT(X,2)  
VEIZ K XXCPRO Q  
 ;
DES ;Define ESTO
 D RES^IBSRES
DESZ Q  
 ;
 ;
VCR ;Verifica CRedito
 ; tarefa 0049FE3E - tratamento Conectcar
 I CZVC=971000 G VCRZ
 I CDEE="0002","11100/11150/11200/11250"'[CNEG G VCRZ
 ;
 N AIPI S AIPI="" 
 S SCRD="" 
 S X=^IBCLI(XCCLI,0),TLCR=$P(X,"|",11),VLCR=$P(X,"|",12) 
 S X=^IBPRO(CPRO),AIPI=$P(X,"|",8) 
 S X=^IBTXB,VTXB=$P(X,"|",3) 
 S X=(+AIPI/100+1*VUNP) S:IFRC X=(+X+VFRU) S:IUBO X=(+X+VTXB) S VITP=(+X*QPED) 
 I '$D(^ICIGE(CCLI)) G VCR1 
 S X=^ICIGE(CCLI),NRGE=$P(X,"|",1) 
 S X=^ICCGE(NRGE),ISCR=$P(X,"|",3) 
 I ISCR'?1"S" G VCR1 
 ;verifica limite do grupo economico
 D VGE 
 G VCR2 
VCR1 ;limite individual
 I TLCR?1"1" S DAT=DFAT K %DI D DT^sistema.DOLLAR S AMES=%Y_$E(%Z+100,2,3),X=^IBIND(AMES),DOLA=$P(X,"|",2),DOLA=(+DOLA*100),SCRD=(VLCR*DOLA+0.5)\1 
 D ^IBSRDB 
 S RHIS="IFPEAT|"_SCRD_"|N|"_VITP_"|"_VSAL 
VCR2 ;
 S SCRD=(+SCRD-VSAL) 
 S ISUC=((+SCRD-VITP)["-") 
VCRZ K VTXB,VITP,TLCR,VLCR,SCRD,AMES,DOLA,VSAL,DAT,%X,%Y,%Z,W,DMA Q  
 ;
VGE ;Verifica Credito do Grupo Economico
 N CCLI,NPTE,TVLCR,TVSAL S (CCLI,TVLCR,TVSAL)="" 
VGE1 S CCLI=$O(^ICCGE(NRGE,CCLI)) I CCLI?1"" G VGEZ 
 S NPTE=$E(CCLI,$L(CCLI)-1,$L(CCLI)) 
 I NPTE'?1"01" G VGE1 
 S X=^IBCLI(CCLI,0),VLCR=$P(X,"|",12),TLCR=$P(X,"|",11) 
 I VLCR?1"" S VLCR="0" 
 I TLCR?1"1" S DAT=DFAT K %DI D DT^sistema.DOLLAR S AMES=%Y_$E(%Z+100,2,3),X=^IBIND(AMES),DOLA=$P(X,"|",2),DOLA=(+DOLA*100),VLCR=(VLCR*DOLA)\1 
 S TVLCR=(TVLCR+VLCR) 
 D ^IBSRDB 
 S TVSAL=(TVSAL+VSAL) 
 G VGE1 
VGEZ S SCRD=TVLCR,VSAL=TVSAL 
 S RHIS="IFPEAT|"_TVLCR_"|S|"_VITP_"|"_TVSAL 
 Q  
 ;
VPM ;Verifica Preco Minimo
 ;
 ; **** TAREFA 0048504F **********************************
 I '$D(VFCI) S VFCI="" 
 S VUNI="",DMSC="",ERR=0,VUFD="",ACDEE=CDEE 
 S PUDE=0,DURV=DFAT 
 K TICF D ^IBSRPU K ACDEE 
 ; **********************************************************
 D ^IBSRPM 
 I VUNP<PRMIN S ISUP="1" 
 E  S ISUP="0" 
 K PRMIN 
VPMZ Q  
 ;
LDI D LDI^IFPEAT6C Q  
AII D AII^IFPEAT6F Q  
VDV D VDV^IFPEAT15 Q
VPA D VPA^IBSRVP Q
 ;
]]></Routine>


<Routine name="IFPEAT6F" type="MAC" languagemode="0" timestamp="65441,38321.77442"><![CDATA[
IFPEAT6F ;Atendimento a Cliente<V1.0-PNC-01/95> ; Última Alteração   amaurid 23/04/2018 20:47:55 ;Última Alteração   FLCARVALHO 03/03/2020 10:38:41
#Include sistema.BibliotecaMacro
 ; 
AII ;Armazenamento de Item Incluido 
 S YITPE="" 
 W /CUP(6,77),/ICC20,/RAW("OK para armazenar? S// ") U 0:(256:"FC":$C(21,24)) $$$Read(R)  S:$A($ZB)=21!($A($ZB)=24) R=$ZB W:$A($ZB)=24 /ICC24 U 0:(256:"SFC":$C(21,24)) W /ICC20,/ICC13 
 I R?1"N" G AIIZ 
 I R'?1"S",R'?1"" S:R?1"?" ER="" S MS=1 D ^GAP.GAREM $$$ReadT(X,2)  G AII 
 W /ICC20,/RAW("Armazenando...") 
 K MOD 
 S X=^IFPED(CDEE,NPED),DENT=$P(X,"|",5),CLPA=$P(X,"|",4),IDPJH=+$P(X,"|",9)
 Set NPEE=$Piece(X,"|",42)
 ;
 I DENT?1"P" G AII1 
 ;
 ;
 S I=0
 I IATP=0!(IATP=1) S I=1 G AII00 
 I ISUD=1 S I=1 
AII00 S ISUS=I_ISUQ_ISUC_ISUE_ISUV_ISUP,ILIB="000000" 
 S SPED=1 
 S ADMEN="",ADENT="" 
 I CLPA=3 D RDT 
 I CLPA=3,(DMEN'=ADMEN) D GDT G AII0 
 I CLPA=3,(DENT'=ADENT) D GDT 
AII0 ;
 D MDI I ATUEST G AII2 
AII1 D GII 
AII2 I CTOP?1"01",CLPR?1"1",'EEMB,'TPRO D CPA 
 W /ICC20,/RAW("Armazenando... OK"),/ICC13 $$$ReadT(X,2)  W /ICC20,/ICC13 
 ;
 ; atualiza historico de usuario privilegiado - Bloqueio de Pedido
 I $D(USPR),USPR'?1"" S DTHO=$$H^sistema.DOLLAR,CAIP="",CAIP=$O(^IFHBU(1,USPR,CAIP),-1) I CAIP'?1"",$P(^IFHBU(1,USPR,CAIP),"|",1)?1"" S ^IFHBU(1,USPR,CAIP,CDEE,NPED,DTHO)=%AP_"|"_%MOD_"|"_%ROT 
 ;
 I $D(MOD) D EXM 
AIIZ K VMVC,IINF,CMOR,VFCI,VMAX,VDEP,MOD Q  

AIA ;Atualiza invertidos
 S IT="" F I=1:1 S IT=$O(^IFPPA(CDEE,ADENT,CLPA,CCLI,NPED,IT)) Q:IT=""  K ^IFPPA(CDEE,ADENT,CLPA,CCLI,NPED,IT) S ^IFPPA(CDEE,DENT,CLPA,CCLI,NPED,IT)="" 
 S IT="" F I=1:1 S IT=$O(^IFPDE(CDEE,ADENT,NPED,IT)) Q:IT=""  K ^IFPDE(CDEE,ADENT,NPED,IT) S ^IFPDE(CDEE,DENT,NPED,IT)="" 
AIAZ Q  
 ;
 ;
MDI ;Movimenta estoque Disponivel em Inclusao de item
 New estIATP ; - Pedido NÃO Pode (0) OU Pode (1) ser Atendido Parcialmente
 New XLORE
 ;<Tarefa ALM 6612 - 03/11/2015 - Nivaldo>
 ;<Inclusão do LORE e chamada da opção altera quantidade reservada por parâmetro>
 ;Se é remessa para armazenagem e se LORE é o próprio armazenador, então 
 ;deve baixar o saldo disponível do depósito da filial.
 Set XLORE=$G(LORE)
 If (CNOS="030209")&&(CFOR=XLORE) Set XLORE="1"_CDEE
 S ATUEST=$$reservarEstDisponivel^IBSREB3(CDEE,XLORE,CNOP,CPRO,.QPED,.ISUD,.ISUE,ESTO,IPRI,IATP,.QTDENOVOITEM) ;Atualiza Estoque Disponivel
 I 'ATUEST G MDIZ
 ;Se NÃO é atendimento parcial ou 
 ;   se toda a quantidade foi reservada
 ;   então NÃO precisa criar item adicional e grava o item do pedido com a quantidade solicitada.
 I +IATP=0!(+QTDENOVOITEM=0) D GII G MDIZ 
 ;Divide item incluido Atendido Parcialmente
 ;Grava o item com a quantidade que foi reservada.
 S ISUD=0,ISUE=0 D GII 
 ;Grava o segundo item com a quantidade que NÃO foi reservada.
 ;   estIATP é definido como zero para garantir que o item não será novamente quebrado em dois. 
 S YITPE=ITPE+1,ITPE=YITPE,ISUD=1,ISUE=1,QPED=QTDENOVOITEM,estIATP=0
 S ATUEST=$$reservarEstDisponivel^IBSREB3(CDEE,$G(LORE),CNOP,CPRO,.QPED,.ISUD,.ISUE,ESTO,IPRI,estIATP,.QTDENOVOITEM) ;Atualiza Estoque Disponivel
 D GII S ITPE=ITPE-1
 S MOD="" 
MDIZ Q  
 ;
GII ;Grava Item Incluido
 N YCDEE
 S (VIAG,CTRA,CCAM,NONF,ITNF,NOEM,TAMO,DAMO,TAMB,QKGC,ADMEN)="" 
 S YCDEE=CDEE
 I DNOR'="",NDRF'="",'$D(^IFREF(CDEE,DNOR,NDRF)) D IPP
 S X=^IFPED(CDEE,NPED),CCLI=$P(X,"|",2),DENT=$P(X,"|",5),CLPA=$P(X,"|",4),IPCF=$P(X,"|",15),ICCR=$P(X,"|",16) 
 I '$D(VUFD) S VUFD="" 
 S TPCC=$S($L(CCLI)=14:1,1:3) 
 D ^IBSRAI 
 S XDENT=$S(DENT?1"99999":DFAT,1:DENT) 
 S DSAI=XDENT 
 I CPRO=12000000 S ISUD=0,ISUQ=0,ISUC=0,ISUE=0,ISUV=0,ISUP=0 ; nao suspende pedido de gas natural
 I $G(IFAV)=1 S ISUD=0,ISUQ=0,ISUC=0,ISUE=0,ISUV=0,ISUP=0  ; <flcarvalho - GDTI-4701 - Tarefa-112791 - Faturamento antecipado Vendor - 2019/08>
 I DENT?1"P" S ISUD=0,ISUQ=0,ISUC=0,ISUE=0,ISUV=0,ISUP=0 ; Pedido programado
 S SPED=1,ISUS=ISUD_ISUQ_ISUC_ISUE_ISUV_ISUP,ILIB="000000" 
 S CTRA="" 
 I CLPA=3 S DSAI=DENT 
 S X=CPRO_"|"_IPRI_"|"_QPED_"|"_VUNP_"|"_IPDG_"|"_VFRU_"|"_IUBO_"|"_DSAI_"|"_VIAG_"|"_CTRA_"|"_CCAM_"|"_IFDG_"|"_SPED_"|"_ISUS_"|"_ILIB_"||"_IADC_"|"_NONF_"|"_ITNF_"|"_NOEM_"||"_TAMO_"|"_DAMO 
 S X=X_"|"_TAMB_"|"_QKGC_"|"_IFRC 
 S $P(X,"|",28)=AIPI
 S $P(X,"|",35)=IIICM,$P(X,"|",36)=IAICM,$P(X,"|",37)=VUFD 
 S $P(X,"|",38)=PADL,$P(X,"|",39)=VULI 
 S $P(X,"|",41)=VMVC,$P(X,"|",42)=IINF,$P(X,"|",43)=CMOR 
 S $P(X,"|",44)=VFCI,$P(X,"|",45)=VMAX,$P(X,"|",46)=VDEP 
 S $P(X,"|",57)=ESTO,$P(X,"|",58)=VTTB,$P(X,"|",59)=IPDA 
 S $P(X,"|",61)=VDPC,$P(X,"|",62)=VPSD,$P(X,"|",63)=ICFT 
 S $P(X,"|",65)=ILCP,$P(X,"|",68)=LORE
 S $P(X,"|",66)=NFSC,$P(X,"|",70)=EFPP,$P(X,"|",71)=IPIN 
 S $P(X,"|",73)=TPRZ,$P(X,"|",74)=PRAZ 
 ; recupera prazo de cobranca
 I $D(TPCB)&($D(PZCB)) S $P(X,"|",76)=TPCB,$P(X,"|",77)=PZCB 
 S $P(X,"|",78)=CCOA,$P(X,"|",79)=NTAN,$P(X,"|",80)=Q20C 
 ;
 S CARG=$$H^sistema.DOLLAR_","_%US,$P(X,"|",67)=CARG 
 ;Documento de referencia - SPED
 S $P(X,"|",94)=CDEE,$P(X,"|",95)=NDRF,$P(X,"|",96)=DNOR,$P(X,"|",97)=ITRF
 ;
 S $P(X,"|",98)=$G(DMSC)
 ;
 ;Grava Parâmetros p/ Frete Fluvial - Atende Tarefa No. 0066B91C
 S:$D(COMD) $P(X,"|",101)=COMD ;Comboio Duplo
 S:$D(IDBA) $P(X,"|",102)=IDBA ;Balsa Aliviada
 ;----------------------------------------------------------------------------------[ Sergio Freesz ]--

 ///Referencia de Cliente Falso Cif no item do Pedido - Atender Painel de Operações
 S FCIF="N"
 I $D(^IBCFC(CDEE,CCLI)) S Y=^IBCFC(CDEE,CCLI),FCIF=$P(Y,"|",1)
 S $P(X,"|",117)=FCIF
 ;
 I ($G(IFAV)=1)||($G(ISRV)=1) S $P(X,"|",133)=VUNV ; <flcarvalho - GDTI-4701 - Tarefa-112791 - Faturamento antecipado Vendor - 2019/08>
 S $P(X,"|",135)=$J($G(DFAG),0,2) ; <flcarvalho - GDTI-5608 - 2020/03 - Diferença entre o valor unitário original e o ganho de ajuste (arredondamento)>
 ;
 S ^IFPED(CDEE,NPED,0,ITPE)=X
 ;
 ;<Aud - Registra o pedido externo por Item>
 Set NPEI=""
 If $D(NPEE) Set NPEI=NPEE
 If $D(^IFPED(CDEE,NPED,0,ITPE,7)) {
	 Set X=^IFPED(CDEE,NPED,0,ITPE,7)
	 Set NPEI=$Piece(X,"|",2)
 }
 Set X=^IFPED(CDEE,NPED,0,ITPE)
 Set $Piece(X,"|",119)=NPEI
 Set ^IFPED(CDEE,NPED,0,ITPE)=X
 ;</Aud - Atualiza o pedido externo por Item>
 ;
 D RVI S X=^IFPED(CDEE,NPED,0,ITPE),$P(X,"|",100)=$J(VITP/QPED,0,2),^IFPED(CDEE,NPED,0,ITPE)=X
 ;
 I EEMB=0,CLPR?1"1",OP=2,OPI=1,PRAZ'=PRAZDEF D HIC I 1
 E  S HIPE=11,CDEP=CDEE D ^IBSRHP
 F I=1:1:6 I $E(ISUS,I)=1 D VER 
 I DENT?1"P" G GIIZ 
 D VPJ ; Incluida na tarefa 006027d8 - Clube do Milhao - DSD - 03/08
       ; Inclusao de item de pedido - se ao menos um item do pedido for janela, o IDPJ do pedido sera' janela

 ;
 ;Projeto Adequações Sistêmicas - Central de Operações - Restrição Operacional da Base (FRT/RO/AR)-----
 Do NovoItem^IFSRPR(CDEE,NPED,ITPE)
 Set RegPedidoItem=^IFPED(CDEE,NPED,0,ITPE),ISUS=$Piece(RegPedidoItem,"|",14)
 ;If $Data(^IFROB(CDEE)) 
 ;{
 ;	 Do RestOperac
 ;	 
 ;}
 ;----------------------------------------------------------------------------------[ Figueiredo ]------
 ;
 F I=1:1:6 S:$E(ISUS,I)?1"1" ^IFPSU(CDEE,I,NPED,ITPE)="" 
 I ISUS?1"000000" S ^IFPPA(CDEE,XDENT,CLPA,CCLI,NPED,ITPE)="" 
 S ^IFPPR(CDEE,CPRO,NPED,ITPE)="",^IFPDE(CDEE,XDENT,NPED,ITPE)="" 
 I CNOS?1"030267" S QRES=QRES-QPED,W=^IECON(CCLI,CPRO),$P(W,"|",3)=QRES,^IECON(CCLI,CPRO)=W,^IECON(CCLI,CPRO,0,CDEE,NPED,ITPE)=QPED 
 I CNOS?1"030269" S TPTR="A" D ^IBSRET    ; Trata Estoque Tecnico
 D VER^IBSREP                             ; Trata Empenho Cia.
 I WPF1=0 S TPTS="A" D EMP^IBSREP 
 S WPF1=0 
 ;D EEM
GIIZ K VIAG,CTRA,CCAM,SPED,ISUE,ISUS,ILIB,NONF,ITNF,NOEM,TAMO,DAMO,TAMB,QKGC 
 K DENT,CLPA,XDENT,USRT,HORT,IIICM,IAICM,IICM,AICM Q  
 ;
VER ;Atualiza historico Suspensao
 I I=1 S HIPE=13 
 I I=2 S HIPE=15 
 I I=3 S HIPE=17 
 I I=4 S HIPE=18 
 I I=5 S HIPE=16 
 I I=6 S HIPE=14 
 S (RGAN,X)=^IFPED(CDEE,NPED,0,ITPE) 
 S CDEP=CDEE,IT=ITPE D ^IBSRHP 
VERZ Q  
 ;
VEP ;VERIFICA SE EXISTE ITENS FATURADOS
 S IT="",FLG=0 
VEP1 S IT=$O(^IFPED(CDEE,NPED,0,IT)) I IT?1"" G VEPZ 
 S X=^IFPED(CDEE,NPED,0,IT),XSPED=$P(X,"|",13),NORC=$P(X,"|",40) 
 I XSPED'?1"1"!(NORC'="") S FLG=1 G VEPZ 
 G VEP1 
VEPZ Q  
 ;
RDT ;Recalcula Datas do Pedido
 S ADENT=DENT,ADFPR=DFPR,ADMEN=DMEN,ADACL=DACL,ATOPA=TOPA 
 S TTPE=3 D ^IBSRDA 
RDTZ Q  
 ;
DTA ;Recalculo de datas a partir da data acordada
 S DMEN=DACL 
DTA1 S CONT=0 
 I TENT'>0 S DFPR=DMEN-TENT G DTA5 
 S DFPR=DMEN 
DTA2 S CONT=CONT+1 
 S DFPR=DFPR-1 
DTA3 S DAT=DFPR K %DI D DT^sistema.DOLLAR S SANO=%Y 
 S SDIA=DFPR#7 
 I SDIA'=3&(SDIA'=4)&('$D(^IBFEN(SANO,1,DFPR))) G DTA4 
 S DFPR=DFPR-1 
 G DTA3 
DTA4 I CONT'<TENT G DTA5 
 G DTA2 
 ;
DTA5 S DENT=DFPR-1 
 ;
DTA6 S DAT=DENT K %DI D DT^sistema.DOLLAR S SANO=%Y 
 S SDIA=DAT#7 
 I SDIA'=3&(SDIA'=4)&('$D(^IBFEN(SANO,1,DENT))) G DTAZ 
 S DENT=DENT-1 
 G DTA6 
DTAZ Q  
 ;
GDT ;Gava Datas
 I DACL'=""&(DMEN'>DACL) D DTA 
 S MS="Atencao! As datas do pedido serao recalculadas",ER="" D ^GAP.GAREM $$$ReadT(X,3)  
 S CARG=$$H^sistema.DOLLAR_","_%US 
 D VEP D:FLG=0&('$D(^IFCOL(CDEE,NPED))) MOP,AIA I FLG=1!($D(^IFCOL(CDEE,NPED))) S DENT=ADENT 
 S (X,RGAN)=^IFPED(CDEE,NPED),CDEP=CDEE,HIPE=21 D ^IBSRHP 
 S X=^IFPED(CDEE,NPED),$P(X,"|",31)=DFPR,$P(X,"|",32)=DMEN,$P(X,"|",33)=DACL,$P(X,"|",5)=DENT,^IFPED(CDEE,NPED)=X 
 I DACL'=""&(DMEN>DACL) S ^IFOCO(CDEP,NPED)=CARG 
GDTZ Q  
 ;
MOP ;MODIFICA DATAS DOS ITENS
 S IT="" 
MOP1 S IT=$O(^IFPED(CDEE,NPED,0,IT)) I IT?1"" G MOPZ 
 S X=^IFPED(CDEE,NPED,0,IT),$P(X,"|",8)=DENT,^IFPED(CDEE,NPED,0,IT)=X 
 G MOP1 
MOPZ Q  
 ;
EXM ;EXibe Modificacoes no armazenamento
 W /CUP(18,1),/RAW("Item    Nome do Produto   Embalag  Quant  Di  Qt  Cr  Dv  Pm  Status Pedido") 
 W /CUP(19,1),/RAW("==== ==================== ======= ======= ==  ==  ==  ==  ==  =============") 
 W /CUP(19,79),/ICC29 
 S X=^IBPRO(CPRO),NPRO=$P(X,"|",2),CEMB=$P(X,"|",4) 
 S X=^IBEMB(CEMB),EMBA=$P(X,"|",4) 
 S LIN=51 D EIM 
 I YITPE'?1"" N ITPE S ITPE=YITPE D EIM 
 W /CUP(6,77),/ICC20,/RAW("==> ") $$$Read(X)  W /ICC20,/ICC13,/CUP(16,1),/ED(0) 
EXMZ K NPRO,CEMB,EMBA Q  
 ;
EIM ;Exibe Item Modificado
 S X=^IFPED(CDEE,NPED,0,ITPE),QPED=$P(X,"|",3),ISUS=$P(X,"|",14) 
 W /CUP(LIN-31,1),/RAW($J(ITPE,4)),/CUP(LIN-31,6),/RAW($E(NPRO,1,20)) 
 W /CUP(LIN-31,27),/RAW(EMBA),/CUP(LIN-31,33),/RAW($J(QPED,7)) 
 S STA="" F I=1,2,3,5,6 S Y="OK  " S:$E(ISUS,I)?1"1" Y="SU  " S STA=STA_Y 
 W /CUP(LIN-31,43),/RAW(STA),/CUP(LIN-31,63),/RAW("Registrado") 
 S LIN=LIN+1 
EIMZ K QPED,ISUS Q  
 ;
EEM ; Envia E-Mail confirmando pedido para o cliente
 N VETMAIL,NPRO,CEMB,EMBA 
 F I=1:1 Q:('$D(VETMAIL(I)))  S VETMAIL(I)="" 
 S MAIL="" 
 S COPV=$O(^IBIPC(CCLI,"")) 
 I COPV?1"" G EEMZ 
 I MAIL?1"" S TICP=$O(^IBIPC(CCLI,COPV,"")) I TICP'?1"" S X=$G(^IBPVI(COPV,TICP)),MAIL=$P(X,"|",3) 
 I MAIL?1"" G EEMZ 
 S REMM="ipinet@ipiranga.com.br" 
 S DESM=MAIL 
 S (EMCC,EMBC)="" 
 S ASSU="Inclusao de item de Pedido" 
 S VETMAIL(1)="A(o) "_NCLI_" - "_COPV 
 S VETMAIL(2)=" " 
 S VETMAIL(3)="Prezado cliente," 
 S VETMAIL(4)=" " 
 S DAT=DENT K %DI D DT^sistema.DOLLAR 
 S VETMAIL(5)="Foi incluido um item no seu pedido numero "_NPED_", para o dia "_$E(%X+100,2,3)_"/"_$E(%Z+100,2,3)_"/"_%Y_"," 
 S VETMAIL(6)=" " 
 S VETMAIL(7)="Produto e quantidade incluidos:" 
 S NLIN=7 
 S X=^IBPRO(CPRO),NPRO=$P(X,"|",2),CEMB=$P(X,"|",4) 
 S X=^IBEMB(CEMB),EMBA=$P(X,"|",4) 
 S NLIN=NLIN+1 
 S VETMAIL(NLIN)=NPRO_": "_QPED 
 I EMBA'?1"",EMBA'="GRANEL" S VETMAIL(NLIN)=NPRO_"-"_EMBA_": "_QPED 
 ;
EEM2 S NLIN=NLIN+1,VETMAIL(NLIN)=" " 
 S NLIN=NLIN+1,VETMAIL(NLIN)="Agradecemos por utilizar nossos servicos." 
 S NLIN=NLIN+1,VETMAIL(NLIN)=" " 
 S NLIN=NLIN+1,VETMAIL(NLIN)="Central de Servicos a Clientes" 
 ;Recupera o nome da empresa
 New oEmpresa
 If $G(EMGR)'="" {
 	Set oEmpresa=##class(cbpi.abadi.basico.EmpresaIpiranga).instanciar(EMGR)
 	If $IsObject(oEmpresa) Set LINHA=LINHA+1,VETMAIL(LINHA)=oEmpresa.nome
 }
 D FEM 
 ;I +ISUS'?1"0" D EEA --> SO' SE CLIENTE IPIRANGA NET
EEMZ Q  
 ;
HIC ; Monta Historico de Item Incluido de Granel c/
    ; Prazo Original alterado na inclusao de item do pedido
 S WPRAZ=PRAZ,PRAZ=PRAZDEF
 S HIPE=11,CDEP=CDEE D ^IBSRHP
 S PRAZ=WPRAZ
 S RGAN=^IFPED(CDEE,NPED,0,ITPE),$P(RGAN,"|",74)=PRAZDEF
 S HIPE=3,CDEP=CDEE H 1 D ^IBSRHP
HICZ K RGAN,WPRAZ Q
 ;
VPJ ; Verifica Pedido Janela
 N CEMB,TPRO,CLPR,EEMB
 I CPRO?1"" G VPJZ
 S X=$G(^IBPRO(CPRO)),CEMB=$P(X,"|",4),TPRO=$P(X,"|",21),CLPR=$P(X,"|",24)
 S X=$G(^IBEMB(CEMB)),EEMB=$P(X,"|",3)
 I CLPR=1,'TPRO,'EEMB D RVJ,TSJ
VPJZ Q
 ;
RVI D RVI^IBSRVI(CDEE,NPED,ITPE,%AP,%MOD,%ROT,DFAB,.VITP,.SUPJ) Q
RVJ D ^IBSRVJ Q
FEM D ^IBSRMM Q  
CPA D CPA^IFPEAT6G Q  
TSJ D TSJ^IFPEAT0E Q
 ;
IPP ;
 I $D(^IBDPA(EMGR,CDEE)) S X=^IBDPA(EMGR,CDEE),YCDEE=$P(X,"|",2)
IPPZ Q 

RestOperac
 New P1,P2,P3,P4,P5
 Set P1=CDEE,P2=NPED,P3=ITPE,P4=CCLI,P5=CPRO
 Do ^IFSRPR
 Quit 
]]></Routine>


<Routine name="IFPEAT6K" type="MAC" languagemode="0" timestamp="65441,37514.748529"><![CDATA[
IFPEAT6K ;ALTERA PEDIDO<V1.1-FFF-01/95> ;Última Alteração   FLCARVALHO 03/03/2020 10:25:14
#Include sistema.BibliotecaMacro
 ; 
ALI ;ALTERA ITEM
 ;
 S (CNOP,CNOS,CTOP,CDOP,CPRO,IPRI,QPED,VUNP,VUNV,VUNI,IPDG,DFAG)="" 
 S (VFRU,DVFRU,IUBO,IFRC,IATP,AQPED,ISUD,ISUQ,ISUC,ISUV,ISUP,ILID)="" 
 S (ILIV,ILIP,NPRO,IPRT,EEMB,CNEG,IALT,CUFE,CMUE,VMVC,IINF,DMSC)="" 
 S (CMOR,VFCI,VMAX,VDEP,VTTB,IPDA,VDPC,VPSD,ICFT,NFSC,EFPP,CCOA)="" 
 S (NTAN,Q20C,VUDC)="" 
 S X=^IBDEP(CDEE),CUFD=$P(X,"|",8) 
 S (PADL,VULI,NLPLU,PF1PLU)="" 
 I SCLI S MS=892,CMS="alterar item" D EM G ALIZ 
 D RAI I CAL D EM $$$ReadT(X,2)  G ALIZ 
 D EXI 
 ;D ^IBSRVP I CDEV S MS="ERRO: Alteração inválida p/cliente PA.",ER="" D EM $$$ReadT(X,2) G ALIZ ; TAREFA 004A6C45 - DSD - 04/12
 D ^IBSRVP I CDEV Set XLORE=$G(LORE) D EED^IFPEAT41 D AIA G ALIZ 
 ;
 ; Verifica bloqueio de pedidos (PBLQ)
 D ^IBSRBL I MS'?1"" D EM $$$ReadT(X,3)  I PBLQ G ALIZ
 ;
 I "3/4"[CLPR D ZVQ G:CZVQ?1"" ALIZ I 1 
 E  D ZVC I CZVC?1"" G ALIZ 
 S (ARM,PF1,SAI,LPR)=0 
 I $D(^IBCCO(CDEE)),CTOP="02","13/10"[$E(CPRO,1,2) D LCO 
 ;Se estoque for controlado pela IEEMB, exibe o saldo e o saldo disponível.
 ;EED Devolve: LORE, ILCP e LOCAL
 Set XLORE=$G(LORE) D EED^IFPEAT41 I VOLTA G ALIZ
 If XLORE'=LORE S ARM=1
 D LDI3 I PF1!SAI G ALIZ 
 I 'ARM G ALIZ 
 D VEA I SAI G ALIZ 
 D AIA 
ALIZ S %K=",VPROD,XCCLI,CCLI,NCLI,SCLI,CDOP,PF1,SAI,NPED,OPI,TCA,LCC,NCDEE,NDFAT,OP,BRANCO,CDCA,CZVC,COTT,TCLI,NZVE,FLVUDC,CNEG,CIEC,PART,OPC,CLPA,CTOP,FLVUDC,IFAV,ISRV" D ^GAP.GARKG 
 W /CUP(17,1),/ED(0) 
 Q  
 ;
IIA ;IDENTIFICA ITEM A ALTERAR
 S SAI=0 
IIA1 W /CUP(10,20),/ICC24,/CON U 0:(256:"FC":$C(21,24)) $$$Read(R)  S:$A($ZB)=21!($A($ZB)=24) R=$ZB W:$A($ZB)=24 /ICC24 U 0:(256:"SFC":$C(21,24)) W /COFF,/ICC20,/ICC13 
 I R?1""!($A(R)=21) S SAI=1 G IIAZ 
 I R?1C S MS=3 D EM G IIA1 
 I R'?.N!($L(R)>2) S MS=17,CMS=2 S:R?1"?" ER="" D EM G IIA1 
 I '$D(^IFPED(CDEE,NPED,0,+R)) S MS=576 D EM G IIA1 
 S X=^IFPED(CDEE,NPED,0,+R),SPED=$P(X,"|",13) 
 I SPED=6 S MS=632 D EM G IIA1 
 I SPED=7 S MS=630,CMS="transferido",CMS1="altera'-lo" D EM G IIA1 
 I SPED'=1 S MS=630,CMS="alocado",CMS1="altera'-lo" D EM G IIA1 
 I $D(^IFCOL(CDEE,NPED,+R)) S MS=630,CMS="com data de coleta",CMS1="altera'-lo" D EM G IIA1 
 S ITPE=+R I $L(ITPE)<2 W /CUP(10,20),/ICC24,/RAW(ITPE) 
IIAZ K SPED Q  
 ;
RAI ;RECUPERA DADOS P/ ALTERACAO
 S X=^IFPED(CDEE,NPED),CNOP=$P(X,"|",3),CLPA=$P(X,"|",4),DENT=$P(X,"|",5),TOPA=$P(X,"|",6),ICCR=$P(X,"|",16),IPCF=$P(X,"|",15),ITFL=$P(X,"|",20),IIPI=$P(X,"|",11),DFPR=$P(X,"|",31),DMEN=$P(X,"|",32),DACL=$P(X,"|",33),PTAU=$P(X,"|",35)
 S NPEE=$P(X,"|",42) //Defeito 64914 - ASSIS 12.12.17
 S X=^IBNOP(CNOP),CNOS=$P(X,"|",4),IEST=$P(X,"|",7),IEDI=$P(X,"|",8) 
 S CTOP=$E(CNOS,1,2),CDOP=$E(CNOS,5,6) 
 S X=^IFPED(CDEE,NPED,0,ITPE),CPRO=$P(X,"|",1),IPRI=$P(X,"|",2) 
 S QPED=$P(X,"|",3),VUNP=$P(X,"|",4),IPDG=$P(X,"|",5) 
 S VFRU=$P(X,"|",6),IUBO=$P(X,"|",7),DSAI=$P(X,"|",8) 
 S IFDG=$P(X,"|",12),ISUS=$P(X,"|",14),ILIB=$P(X,"|",15) 
 S IFRC=$P(X,"|",26),AICM=$P(X,"|",36),AIPI=$P(X,"|",28) 
 S PADL=$P(X,"|",38),VULI=$P(X,"|",39),VMVC=$P(X,"|",41) 
 S ESTO=$P(X,"|",57),VTTB=$P(X,"|",58),IPDA=$P(X,"|",59) 
 S VDPC=$P(X,"|",61),VPSD=$P(X,"|",62),ICFT=$P(X,"|",63) 
 S ILCP=$P(X,"|",65),LORE=$P(X,"|",68)
 S NFSC=$P(X,"|",66),LCARG=$P(X,"|",67),EFPP=$P(X,"|",70) 
 S IPCO=$P(X,"|",72),TPRZ=$P(X,"|",73),PRAZ=$P(X,"|",74) 
 S CCOA=$P(X,"|",78),NTAN=$P(X,"|",79),Q20C=$P(X,"|",80),DMSC=$P(X,"|",98)
 S NIPE=$P(X,"|",104) //Defeito 64914 - ASSIS 12.12.17
 S NFCI=$P(X,"|",106),ORIP=$P(X,"|",110)
 ;S VUDC=$P(X,"|",120) ; GDTI 3262 - TAREFA 84458 - DSD - 08/2018
 S VULE=$P(X,"|",122),VULN=$P(X,"|",123)
 S VFPI=$P(X,"|",124),VFPN=$P(X,"|",125)
 S PRAZ1=$P(PRAZ,"/",1) 
 S PRAZ2=$P(PRAZ,"/",2) 
 S PRAZ3=$P(PRAZ,"/",3) 
 S PRAZ4=$P(PRAZ,"/",4) 
 S PRAZ5=$P(PRAZ,"/",5) 
 S PRAZ6=$P(PRAZ,"/",6) 
 I IPCO S MS="Pedido congelado. Impossivel alterar item",CAL=1 G RAIZ 
 I (+AIPI)=0 S AIPI="",ITRP=0 
 E  S ITRP=1 
 S XAIPI=AIPI,XITRP=ITRP 
 S XIFRC="N" I IFRC S XIFRC="S" 
 S AQPED=QPED,VUFR=VFRU 
 S ISUD=$E(ISUS,1),ISUQ=$E(ISUS,2),ISUC=$E(ISUS,3),ISUV=$E(ISUS,5),ISUP=$E(ISUS,6) 
 S ILID=$E(ILIB,1),ILIQ=$E(ILIB,2),ILIC=$E(ILIB,3),ILIV=$E(ILIB,5),ILIP=$E(ILIB,6)
 ;
 ; GDTI 3262 - TAREFA 84458/ENTREGA 97428 - DSD - 11/2018 - RECALCULO DESC.COMERCIAL
 D RDP^IBSR.preco.RecuperaDescComercial(CDEE,NPED,ITPE,"","",.VUDC)
 ;
 //<VCT> Busca de PART NUMBER
 S X=$Get(^IFPED(CDEE,NPED,0,ITPE,7)),CPEC=$P(X,"|",1)
 //<VCT>
 S X=^IBPRO(CPRO),NPRO=$P(X,"|",2),CEMB=$P(X,"|",4),CIPI=$P(X,"|",13),CGMP=$P(X,"|",15),IPRT=$P(X,"|",20),TPRO=$P(X,"|",21),CLPR=$P(X,"|",24) 
 S X=^IBEMB(CEMB),EEMB=$P(X,"|",3) 
 S IATP="" I EEMB S IATP=0 S:TOPA="P" IATP=1
 S DURV=DSAI S:DURV'?1N.N DURV=DFAT D ^IBSRCA I CAL G RAIZ 
 S X=^IBCLI(CCLI,2),CNEG=$P(X,"|",2),X=^IBCLI(CCLI,1),CMUE=$P(X,"|",4) 
 S X=^IBMUN(CMUE),CUFE=$P(X,"|",4) 
 S X=$G(^IBICB(CCLI,CDEE)),CMKC=$P(X,"|",3),CMKE=$P(X,"|",4) 
 S CCMK=CMKC I TPRO S CCMK=CMKE 
 ;Se ESTO não foi definido, define o ESTO
 I ESTO?1"" S ESTO=1 D DES
 S X=^IFCOF,IALT=$P(X,"|",1) 
 S ZPRAZ=PRAZ,XPRAZ=PRAZ 
 I CLPR'?1"1"!(EEMB'?1"0") G RAIZ 
 D DTM 
 ;Recupera limite de Prazo
 D ^IBSRLP I LIMPRAZ?1"" G RAI1 
 S XPRAZ=LIMPRAZ 
RAI1 D RCB,TPE S ZPRAZ=PRA2 I 1 ; TESTA PRAZO ESPECIAL
RAIZ K CEMB,ISUS,CMKC,CMKE Q  
 ;
DTM ;Define Tipo de Mercado
 S X=^IBCLI(CCLI,2),CNEG=$P(X,"|",2) 
 I CNEG?1"21000" S TMER="T" G DTMZ 
 I $E(CNEG,1)?1"1" S TMER="R" 
 I $E(CNEG,1)?1"2" S TMER="C" 
DTMZ Q  
 ;
RCB ; Recupera prazo de Cobranca
 D ^IBSRPZ1 S PZCB=PZCB+NDIC 
RCBZ Q  
 ;
DES ;Define ESTO
 D DES^IBSRES
DESZ Q  
 ;
ZVC ;ZONA VENDA COMBUSTIVEIS
 S CZVC="" 
 I $D(^IBCLI(CCLI,2))#10 S X=^IBCLI(CCLI,2),CZVC=$P(X,"|",4) 
 I CZVC?1"" S MS=889,CMS="combustiveis",CMS1="alterar" D ^GAP.GAREM 
 K CLP,PRO 
ZVCZ Q  
 ;
ZVQ ;ZONA VENDA QUIMICO
 S CZVQ="" 
 I $D(^IBCLI(CCLI,2))#10 S X=^IBCLI(CCLI,2),CZVQ=$P(X,"|",5) 
 I CZVQ?1"" S MS=889,CMS="quimico",CMS1="alterar" D ^GAP.GAREM 
 K CLP,PRO 
ZVQZ Q  
 ;
EXI ;EXIBE DADOS DO ITEM
 S DPED=$P(LCARG,",",1),HORT=$P(LCARG,",",2),USRT=$P(LCARG,",",3) 
 S %DI="" 
 I LCARG'?1"" W /CUP(11,35),/RAW(USRT_" - ") S DAT=DPED D DT^sistema.DOLLAR S HORAX=HORT D ^IBSRHE W /RAW((" - "_HEMED)) 
 W /CUP(12,19),/RAW(CPRO) $$$ReadC(X,$L(CPRO)'<8)  W /CUP(12,32),/RAW($E(NPRO,1,42)) 
 W /CUP(13,19),/RAW(QPED) I $L(QPED)'<7 $$$Read(X)  
 W /CUP(13,64) I VFRU'?1"" W /RAW($J((+VFRU/100),14,4)) $$$Read(X)  
 W /CUP(14,19),/RAW($S(IUBO?1"":"",IUBO:"S",1:"N")) I IUBO'?1"" $$$Read(X)  
 W /CUP(14,64),/RAW(PADL) 
 W /CUP(15,19),/RAW($S(IPCF?1"1":"S",1:"N")) $$$Read(X)  
 W /CUP(15,64) S X=$J(VUNP/100,0,4) W /RAW($J(X,14)) $$$Read(X)  
 W /CUP(18,64) I VUDC S X=$J(VUDC/100,0,4) W /RAW($J(X,14)) $$$Read(X) ; GDTI 3262 - TAREFA 84458 - DSD - 08/2018
 W /CUP(16,19),/RAW(PRAZ1) I $L(PRAZ1)'<3 $$$Read(X)  
 W /CUP(16,27),/RAW(PRAZ2) I $L(PRAZ2)'<3 $$$Read(X)  
 W /CUP(16,35),/RAW(PRAZ3) I $L(PRAZ3)'<3 $$$Read(X) 
 W /CUP(16,64),/RAW(NPEE) I $L(NPEE)'<15 $$$Read(X) //Defeito 64914 - ASSIS 12.12.17
 W /CUP(17,19),/RAW(PRAZ4) I $L(PRAZ4)'<3 $$$Read(X)  
 W /CUP(17,27),/RAW(PRAZ5) I $L(PRAZ5)'<3 $$$Read(X)  
 W /CUP(17,35),/RAW(PRAZ6) I $L(PRAZ6)'<3 $$$Read(X)
 W /CUP(17,64),/RAW(NIPE) I $L(NIPE)'<6 $$$Read(X) //Defeito 64914 - ASSIS 12.12.17
EXIZ Q  
 ;
VEA ;VERIFICA ESTADO DO ITEM P/ ALTERACAO
 S XXCPRO=CPRO N CPRO S CPRO=XXCPRO  
 I $E(CPRO,1,2)=11 S CPRO=11100001 
 I $E(CPRO,1,2)=15 S CPRO=15010007 
 S XXILIV=ILIV,XXILIC=ILIC,XXILIQ=ILIQ 
 I CPRO=12000000 S ISUC=0,ISUV=0,ISUQ=0,ISUP=0,ILIC=0,ILIV=0,ILIQ=0,ILIP=0 G VEAZ
 I ILIV!(ILIC),QPED>AQPED S ILIC=0
 D VPA 
 I CTOP?1"01",'ILIC,'ISUC,'CDEV D VCR 
 I CTOP?1"01",'ILIV,'CDEV D VDV I DEBITO S ISUV=1 
 ;;;I CTOP?1"01",CLPR?1"2",EEMB,'ILIP,CNOS'?1"010267" D VPM
 I CTOP?1"01",EEMB,'ILIP,CNOS'="010267",(CLPR=2!($E(CPRO,1,2)=67)) D VPM         ;;;67 Produto ARLA 
 I CTOP?1"01",QPED'=AQPED,CDEV S ISUQ=1 
VEA1 I 'ISUQ,'ISUC,'ISUV,'ISUP G VEA2 
 S MS=596,CMS="",ER="" 
 I ISUQ S CMS=CMS_"PGTO.ANTECIP.," 
 I ISUC S CMS=CMS_"CREDITO," 
 I ISUV S CMS=CMS_"DEBITO VENCIDO," 
 I ISUP S CMS=CMS_"PRECO MINIMO," 
 S CMS=$E(CMS,1,$L(CMS)-1) D ^GAP.GAREM $$$ReadT(X,2)  
VEA2 I 'ISUC S ILIC=XXILIC 
 I 'ISUV S ILIV=XXILIV 
 I 'ISUQ S ILIQ=XXILIQ 
VEAZ K XXCPRO,XXILIV,XXILIC,XXILIQ Q  
 ;
VCR D VCR^IFPEAT6B Q  
VPM D VPM^IFPEAT6B Q  
LDI3 D LDI3^IFPEAT6D Q  
AIA D AIA^IFPEAT6N Q  
LCO D LCO^IFPEAT6C Q  
TPE D TPE^IFPEAT6C Q  
VDV D VDV^IFPEAT15 Q  
VPA D VPA^IBSRVP Q
EM D ^GAP.GAREM Q  
 ;
Z P IFPEAT6K X "ZS IFPEAT6K" Q  
]]></Routine>


<Routine name="IFPEAT6N" type="MAC" languagemode="0" timestamp="65441,38313.480198"><![CDATA[
IFPEAT6N ;ALTERA PEDIDO<V1.0-FFF-01/95> ; Apr 4 2005  2:50 PM ;pnc ;Última Alteração   FLCARVALHO 03/03/2020 10:38:33
#Include sistema.BibliotecaMacro
 ;  
AIA ;Armazenamento de Item Alterado  
 S YITPE="" 
 S PER="OK para armazenar",DEF="S" D PLM I R?1"N" G AIAZ 
 W /ICC20,/RAW("Armazenando...") 
 K MOD 
 ;Recupera o local de retirada anterior e ISUE
 S X=^IFPED(CDEE,NPED,0,ITPE),ALORE=$P(X,"|",68),XISUS=$P(X,"|",14)
 S ISUE=$E(XISUS,4) 
 ;MDA chama GIA
 I (QPED'=AQPED)||(LORE'=ALORE) D MDA I ATUEST G AIA1 
 D GIA 
AIA1 I QPED'=AQPED,CTOP?1"01",CLPR?1"1",'EEMB,'TPRO D CPA 
 W /ICC20,/RAW("OK"),/ICC13 $$$ReadT(X,2)  W /ICC20,/ICC13 
 ;
 ; atualiza historico de usuario privilegiado - Bloqueio de Pedido
 I $D(USPR),USPR'?1"" S DTHO=$$H^sistema.DOLLAR,CAIP="",CAIP=$O(^IFHBU(1,USPR,CAIP),-1) I CAIP'?1"",$P(^IFHBU(1,USPR,CAIP),"|",1)?1"" S ^IFHBU(1,USPR,CAIP,CDEE,NPED,DTHO)=%AP_"|"_%MOD_"|"_%ROT 
 ;
 I $D(MOD) D EXM 
AIAZ K YITPE,MOD Q  
 ;
AQR ;Atualiza Quantidade Restante (Consignacao)
 I QPED<AQPED S QRES=QRES+(AQPED-QPED) 
 I QPED>AQPED S QRES=QRES-(QPED-AQPED) 
AQRZ Q  
 ;
GIA ;Grava Item Alterado
 S ADMEN="",ADENT="",XCUI=0 
 S X=^IFPED(CDEE,NPED),CLPA=$P(X,"|",4) 
 I $D(NPEE) S $P(X,"|",42)=NPEE,^IFPED(CDEE,NPED)=X //Defeito 64914 - ASSIS 12.12.17
 S X=^IFPED(CDEE,NPED,0,ITPE),XISUS=$P(X,"|",14)
 I '$D(ISUE) S ISUE=$E(XISUS,4)
 S I=0 
 I IATP=0!(IATP=1) S I=1 G GIA00 
 I ISUD=1 S I=1 
GIA00 S ISUS=I_ISUQ_ISUC_ISUE_ISUV_ISUP 
 I CLPA=3 D RDT 
 I CLPA=3,(DMEN'=ADMEN) D GDT G GIA0 
 I CLPA=3,(DENT'=ADENT) D GDT 
GIA0 ;
 S X=^IFPED(CDEE,NPED,0,ITPE)
 S CPRO=$P(X,"|",1),DSAI=$P(X,"|",8),CTRA=$P(X,"|",10) 
 S ISUS=$P(X,"|",14),XISUS=$P(X,"|",14),ILIB=$P(X,"|",15) 
 I CPRO=12000000 S ISUD=0,ISUQ=0,ISUC=0,ISUE=0,ISUV=0,ISUP=0 ; nao suspende pedido de gas natural
 I $G(IFAV)=1 S ISUD=0,ISUQ=0,ISUC=0,ISUE=0,ISUV=0,ISUP=0 ; <flcarvalho - GDTI-4701 - Tarefa-112791 - Faturamento antecipado Vendor - 2019/08>
 S ISUS=ISUD_ISUQ_ISUC_ISUE_ISUV_ISUP 
 S ILIB=ILID_ILIQ_ILIC_$E(ILIB,4)_ILIV_ILIP 
 ;
 F I=1:1:6 I $E(ISUS,I)=1 S $E(ILIB,I)=0 ; DSD - 04/01/09 - ENCONTRADO CASO DE ISUS=010000 E ILIB=010000
 ;
 ;Beatriz Alves - 03/12/2019 ---------------------------------------------------------------------
 ;Verifica se produto é embalado ou granel
 ;Produto indicado difere do indicado pela opção de registro do pedido.
 New rgCodProd,rgCodEmba,rgPedido,flg
 Set (rgCodProd,rgCodEmba,rgPedido,flg)=""
 Set rgCodProd=^IBPRO(CPRO),CEMB=$Piece(rgCodProd,"|",4),CLPR=$Piece(rgCodProd,"|",24) Kill rgCodProd
 Set rgCodEmba=^IBEMB(CEMB),EEMB=$Piece(rgCodEmba,"|",3) Kill rgCodEmba
 If CLPR'=1 ;Não Combustível
 {
	Set flg=0,xCLPA=CLPA
 	If EEMB,CLPA'=3 Set CLPA=3,flg=1   ;Embalado
 	If 'EEMB,CLPA'=1 Set CLPA=1,flg=1  ;Granel
 	If flg 
 	{
	 	Set regPedido=^IFPED(CDEE,NPED)
	 	Set $Piece(regPedido,"|",4)=CLPA
	 	Set ^IFPED(CDEE,NPED)=regPedido
	 	Kill regPedido,flg
	 	
	 	;Beatriz Alves - 04/12/2019 - Registro LOG ABADI --> Axiodis
		Set CARG=$$H^sistema.DOLLAR
	 	Set DLog=$Piece(CARG,",",1),HLog=$Piece(CARG,",",2)
	 	Set ^ILOG.IFPEAT6N(CDEE,NPED,DLog,HLog)=xCLPA_"|"_CLPA
	 	Kill CARG,DLog,HLog,xCLPA
	 	
 	}
 }
 ;------------------------------------------------------------------------------------------------
 ; 
 S (RGAN,X)=^IFPED(CDEE,NPED,0,ITPE) 
 S CARG=$$H^sistema.DOLLAR_","_%US 
 S $P(X,"|",2,7)=IPRI_"|"_QPED_"|"_VUNP_"|"_IPDG_"|"_VFRU_"|"_IUBO 
 S $P(X,"|",12)=IFDG,$P(X,"|",14,15)=ISUS_"|"_ILIB 
 S $P(X,"|",26)=IFRC,$P(X,"|",38,39)=PADL_"|"_VULI 
 S $P(X,"|",41,46)=VMVC_"|"_IINF_"|"_CMOR_"|"_VFCI_"|"_VMAX_"|"_VDEP 
 S $P(X,"|",58)=VTTB,$P(X,"|",61,63)=VDPC_"|"_VPSD_"|"_ICFT 
 ;Grava o local de retirada
 ;If LORE=("1"_CDEE) S LORE=""
 ;a linha foi retirada pra mudança de compartamento, sempre irá gravar o LORE.
 S $P(X,"|",67)=CARG,$P(X,"|",68)=LORE,$P(X,"|",70)=EFPP 
 S $P(X,"|",73)=TPRZ,$P(X,"|",74)=PRAZ,$P(X,"|",98)=DMSC 
 ; recupera prazo cobranca
 I $D(TPCB)&($D(PZCB)) S $P(X,"|",76)=TPCB,$P(X,"|",77)=PZCB 
 S $P(X,"|",78)=CCOA,$P(X,"|",79)=NTAN,$P(X,"|",80)=Q20C 
 ;
 I ILIC=0 S $P(X,"|",85)="" 
 ;
 //Defeito 64914 - ASSIS 12.12.17
 S $P(X,"|",104)=$G(NIPE)
 ; 
 If $D(NFCI) Set $P(X,"|",106)=NFCI
 If $D(ORIP) Set $P(X,"|",110)=ORIP
 ;----------------------------------------------------------------------------------[ Sergio Freesz ]--
 ///Referencia de Cliente Falso Cif no item do Pedido - Atender Painel de Operações
 S FCIF="N"
 I $D(^IBCFC(CDEE,CCLI)) S Y=^IBCFC(CDEE,CCLI),FCIF=$P(Y,"|",1)
 S $P(X,"|",117)=FCIF
 ; 
 I ($G(IFAV)=1)||($G(ISRV)=1) S $P(X,"|",133)=VUNV ; <flcarvalho - GDTI-4701 - Tarefa-112791 - Faturamento antecipado Vendor - 2019/08>
 S $P(X,"|",135)=$J($G(DFAG),0,2) ; <flcarvalho - GDTI-5608 - 2020/03 - Diferença entre o valor unitário original e o ganho de ajuste (arredondamento)>
 ;
 S ^IFPED(CDEE,NPED,0,ITPE)=X 
 ;
 ;Verifica Restrição Operacional - antoniog em 24/07/2019
 Do Alteracao^IFSRPR(CDEE,NPED,ITPE,0)
 ;If $Data(^IFROB(CDEE)) 
 ;{
 ;	 Do RestOperac
 ;	 Set RegPedidoItem=^IFPED(CDEE,NPED,0,ITPE),ISUS=$Piece(RegPedidoItem,"|",14)
 ;}
 ;----------------------------------------------------------------------------------[ Figueiredo ]------
 ; 
 D CGN
 ;
 ;<Aud - Registra o pedido externo por Item>
 Set NPEI=""
 If $D(NPEE) Set NPEI=NPEE
 If $D(^IFPED(CDEE,NPED,0,ITPE,7)) {
	 Set X=^IFPED(CDEE,NPED,0,ITPE,7)
	 Set NPEI=$Piece(X,"|",2)
 }
 Set X=^IFPED(CDEE,NPED,0,ITPE),ISUS=$Piece(X,"|",14)
 Set $Piece(X,"|",119)=NPEI
 Set ^IFPED(CDEE,NPED,0,ITPE)=X
 ;</Aud - Atualiza o pedido externo por Item>
 ;
 I '$D(RGAN) S RGAN=^IFPED(CDEE,NPED,0,ITPE)
 I ($P(RGAN,"|",3)-QPED) D RVI S X=^IFPED(CDEE,NPED,0,ITPE),$P(X,"|",100)=$J(VITP/QPED,0,2),^IFPED(CDEE,NPED,0,ITPE)=X
 ; 
 // Grava no historico qualquer alteracao no quantidade do pedido
 I +QPED'=+$P(RGAN,"|",3) S HIPE=10,CDEP=CDEE D ^IBSRHP 
 S RGAN=^IFPED(CDEE,NPED,0,ITPE)
 ;
 D GET             ; Ver Consignacao, Estoque Tecnico e Empenho Cia.  
 S HIPE=3,CDEP=CDEE D ^IBSRHP 
 F I=1:1:6 I $E(ISUS,I)'=$E(XISUS,I) D VER 
 S X=^IFPED(CDEE,NPED),CLPA=$P(X,"|",4) 
 K ^IFPPA(CDEE,DSAI,CLPA,CCLI,NPED,ITPE) 
 S X=^IFPED(CDEE,NPED,0,ITPE),$P(X,"|",10)="",^IFPED(CDEE,NPED,0,ITPE)=X 
 I ISUS?1"000000" S ^IFPPA(CDEE,DSAI,CLPA,CCLI,NPED,ITPE)="" 
 F I=1:1:6 K ^IFPSU(CDEE,I,NPED,ITPE) 
 F I=1:1:6 S:$E(ISUS,I)?1"1" ^IFPSU(CDEE,I,NPED,ITPE)="" 
 I CLPR=1 G GIAZ 
 I ITPE=1,$O(^IFPED(CDEE,NPED,0,ITPE))?1"" G GIAZ 
 S IT=ITPE 
GIA1 S IT=$O(^IFPED(CDEE,NPED,0,IT)) I IT?1"" G GIAZ 
 S X=^IFPED(CDEE,NPED,0,IT),$P(X,"|",74)=PRAZ
 I '$G(NPEE) S $P(X,"|",104)="" //Defeito 64914 - ASSIS 12.12.17
 S ^IFPED(CDEE,NPED,0,IT)=X 
 ;
 G GIA1 
GIAZ K CTRA,ISUS,ILIB,ISUE,CLPA,I,HORT,USRT Q  
 ;
AIN ;Atualiza invertidos
 S IT="" F I=1:1 S IT=$O(^IFPPA(CDEE,ADENT,CLPA,CCLI,NPED,IT)) Q:IT=""  K ^IFPPA(CDEE,ADENT,CLPA,CCLI,NPED,IT) S ^IFPPA(CDEE,DENT,CLPA,CCLI,NPED,IT)="" 
 S IT="" F I=1:1 S IT=$O(^IFPDE(CDEE,ADENT,NPED,IT)) Q:IT=""  K ^IFPDE(CDEE,ADENT,NPED,IT) S ^IFPDE(CDEE,DENT,NPED,IT)="" 
AINZ Q  
 ;
RDT ;Recalcula Datas do Pedido
 S ADENT=DENT,ADFPR=DFPR,ADMEN=DMEN,ADACL=DACL,ATOPA=TOPA 
 S TTPE=4 D ^IBSRDA 
RDTZ Q  
 ;
DTA ;Recalculo de datas a partir da data acordada
 S DMEN=DACL 
DTA1 S CONT=0 
 I TENT'>0 S DFPR=DMEN-TENT G DTA5 
 S DFPR=DMEN 
DTA2 S CONT=CONT+1 
 S DFPR=DFPR-1 
DTA3 S DAT=DFPR K %DI D DT^sistema.DOLLAR S SANO=%Y 
 S SDIA=DFPR#7 
 I SDIA'=3&(SDIA'=4)&('$D(^IBFEN(SANO,1,DFPR))) G DTA4 
 S DFPR=DFPR-1 
 G DTA3 
DTA4 I CONT'<TENT G DTA5 
 G DTA2 
 ;
DTA5 S DENT=DFPR-1 
 ;
DTA6 S DAT=DENT K %DI D DT^sistema.DOLLAR S SANO=%Y 
 S SDIA=DAT#7 
 I SDIA'=3&(SDIA'=4)&('$D(^IBFEN(SANO,1,DENT))) G DTAZ 
 S DENT=DENT-1 
 G DTA6 
DTAZ Q  
 ;
GDT ;Gava Datas
 I DACL'=""&(DMEN'>DACL) D DTA 
 S MS="Atencao! As datas do pedido serao recalculadas",ER="" D ^GAP.GAREM $$$ReadT(X,3)  
 S CARG=$$H^sistema.DOLLAR_","_%US 
 D VEP D:FLG=0&('$D(^IFCOL(CDEE,NPED))) MOP,AIN I FLG=1!($D(^IFCOL(CDEE,NPED))) S DENT=ADENT 
 S (X,RGAN)=^IFPED(CDEE,NPED),CDEP=CDEE,HIPE=21 D ^IBSRHP 
 S X=^IFPED(CDEE,NPED),$P(X,"|",31)=DFPR,$P(X,"|",32)=DMEN,$P(X,"|",33)=DACL,$P(X,"|",5)=DENT,^IFPED(CDEE,NPED)=X 
 I DACL'=""&(DMEN>DACL) S ^IFOCO(CDEP,NPED)=CARG 
GDTZ Q  
 ;
MOP ;MODIFICA DATAS DOS ITENS
 S IT="" 
MOP1 S IT=$O(^IFPED(CDEE,NPED,0,IT)) I IT?1"" G MOPZ 
 S X=^IFPED(CDEE,NPED,0,IT),$P(X,"|",8)=DENT,^IFPED(CDEE,NPED,0,IT)=X 
 G MOP1 
MOPZ Q  
 ;
VER ;Atualiza historico liberacao/Suspensao
 S STA=0 
 I $E(ISUS,I)=0,$E(XISUS,I)=1 S STA=1 
 I $E(ISUS,I)=1,$E(XISUS,I)=0 S STA=2 
 I I=1 S:STA=1 HIPE=5 S:STA=2 HIPE=13 
 I I=2 S:STA=1 HIPE=7 S:STA=2 HIPE=15 
 I I=3 S:STA=1 HIPE=20 S:STA=2 HIPE=17 
 I I=4 S:STA=1 HIPE=12 S:STA=2 HIPE=18 
 I I=5 S:STA=1 HIPE=27 S:STA=2 HIPE=16 
 I I=6 S:STA=1 HIPE=6 S:STA=2 HIPE=14 
 S (RGAN,X)=^IFPED(CDEE,NPED,0,ITPE) 
 S CDEP=CDEE,IT=ITPE D ^IBSRHP 
VERZ Q  
 ;
VEP ;VERIFICA SE EXISTE ITENS FATURADOS
 S IT="",FLG=0 
VEP1 S IT=$O(^IFPED(CDEE,NPED,0,IT)) I IT?1"" G VEPZ 
 S X=^IFPED(CDEE,NPED,0,IT),XSPED=$P(X,"|",13),NORC=$P(X,"|",40) 
 I XSPED'?1"1"!(NORC'="") S FLG=1 G VEPZ 
 G VEP1 
VEPZ Q  
 ;
GET ;Consiguinacao e estoque tecnico
 I CNOS?1"030267",QPED'=AQPED S W=^IECON(CCLI,CPRO),QRES=$P(W,"|",3) D AQR S $P(W,"|",3)=QRES,^IECON(CCLI,CPRO)=W,^IECON(CCLI,CPRO,0,CDEE,NPED,ITPE)=QPED 
 I CNOS?1"030269" S TPTR="A" D ^IBSRET        ; Trata Estoque Tecnico
 D VER^IBSREP                                 ; Trata Empenho Cia.
 I WPF1=0 S TPTS="A" D EMP^IBSREP 
 S WPF1=0 
GETZ Q  
 ;
EXM ;Exibe Modificacoes do armazenamento
 W /CUP(18,1),/RAW("Item    Nome do Produto   Embalag  Quant  Di  Qt  Cr  Dv  Pm  Status Pedido") 
 W /CUP(19,1),/RAW("==== ==================== ======= ======= ==  ==  ==  ==  ==  =============") 
 W /CUP(19,79),/ICC29 
 S X=^IBPRO(CPRO),NPRO=$P(X,"|",2),CEMB=$P(X,"|",4) 
 S X=^IBEMB(CEMB),EMBA=$P(X,"|",4) 
 S LIN=51 D EIM 
 I YITPE'?1"" N ITPE S ITPE=YITPE D EIM 
 W /CUP(6,77),/ICC20,/RAW("==> ") $$$Read(X)  W /ICC20,/ICC13,/CUP(16,1),/ED(0) 
EXMZ K NPRO,CEMB,EMBA Q  
 ;
EIM ;EXIBE ITEM MODIFICADO
 S X=^IFPED(CDEE,NPED,0,ITPE),QPED=$P(X,"|",3),ISUS=$P(X,"|",14) 
 W /CUP(LIN-31,1),/RAW($J(ITPE,4)),/CUP(LIN-31,6),/RAW($E(NPRO,1,20)) 
 W /CUP(LIN-31,27),/RAW(EMBA),/CUP(LIN-31,33),/RAW($J(QPED,7)) 
 S STA="" F I=1,2,3,5,6 S Y="OK  " S:$E(ISUS,I)?1"1" Y="SU  " S STA=STA_Y 
 W /CUP(LIN-31,43),/RAW(STA),/CUP(LIN-31,63),/RAW("Registrado") 
 S LIN=LIN+1 
EIMZ K QPED,ISUS Q  
 ;
CPA ;Cancela planilha de alocacao
 I '$D(^IFPEA(CDEE,NPED)) D VAV G CPAZ 
 S (XITPE,CCAM,VIAG,NCOM)="" 
CPA0 S XITPE=$O(^IFPEA(CDEE,NPED,XITPE)) I XITPE?1"" G CPA5 
CPA1 S CCAM=$O(^IFPEA(CDEE,NPED,XITPE,CCAM)) I CCAM?1"" G CPA4 
 I 1 L (^IBCLI(XCCLI),^IFPRP(CDEE,DSAI,CCAM)) 
 I $D(^IFPRR(CDEE,DSAI,CCAM,NPED)) K ^IFPRR(CDEE,DSAI,CCAM,NPED) 
CPA2 S VIAG=$O(^IFPEA(CDEE,NPED,XITPE,CCAM,VIAG)) I VIAG?1"" G CPA1 
 K ^IBCHK(CDEE,DSAI,CCAM,VIAG,NPED,XITPE) 
CPA3 S NCOM=$O(^IFPEA(CDEE,NPED,XITPE,CCAM,VIAG,NCOM)) I NCOM?1"" G CPA2 
 S X=$G(^IFPRP(CDEE,DSAI,CCAM,VIAG)) I X?1"" G CPA3 
 S OBPR=$P(X,"|",3),QALC=$P(X,"|",5),XCTRA=$P(X,"|",6) 
 S X=$G(^IFPRP(CDEE,DSAI,CCAM,VIAG,NCOM)) I X?1"" G CPA3 
 S XQPED=$P(X,"|",1) 
 K ^IFPRP(CDEE,DSAI,CCAM,VIAG,NCOM) 
 S QALC=QALC-XQPED 
 I QALC'>0 K ^IFPRP(CDEE,DSAI,CCAM,VIAG) 
 E  D AVC 
 G CPA3 
CPA4 K ^IFPEA(CDEE,NPED,XITPE) 
 K ^IFIPA(CDEE,NPED,XITPE) 
 S X=$G(^IFPED(CDEE,NPED,0,XITPE)) I X?1"" G CPA0 
 S XCPRO=$P(X,"|",1),XQPED=$P(X,"|",3),IUBO=$P(X,"|",7) 
 S VPROD(XITPE)=XCPRO_"|"_XQPED_"||"_NPED_"|"_XITPE_"|"_IUBO 
 G CPA0 
CPA5 I 1 L ^IBCLI(XCCLI) 
CPAZ K XQPED,XCPRO,IUBO Q  
 ;
VAV ;Verifica alteracao no vetor
 I '$D(VPROD(ITPE)) G VAVZ 
 S X=VPROD(ITPE),$P(X,"|",2)=QPED,VPROD(ITPE)=X 
VAVZ Q  
 ;
AVC ;Atualiza viagem do caminhao
 S X=^IBDEP(CDEE),NDEP=$P(X,"|",3) 
 S XNCOM="" 
AVC1 S XNCOM=$O(^IFPRP(CDEE,DSAI,CCAM,VIAG,XNCOM)) I XNCOM?1"" G AVC2 
 S X=^IFPRP(CDEE,DSAI,CCAM,VIAG,XNCOM),TCOM=$P(X,"|",2) 
 S XNPED="" 
 S XNPED=$O(^IFPRP(CDEE,DSAI,CCAM,VIAG,XNCOM,XNPED)) 
 S X=$G(^IFPED(CDEE,XNPED)),XXCCLI=$P(X,"|",2) I XXCCLI?1"" G AVC1 
 S X=$G(^IBICB(XXCCLI,CDEE)),KMIV=$P(X,"|",2),AGEO=$P(X,"|",5),TEIV=$P(X,"|",6) 
 I "0515/6515"[CDEE S XTEIV=$P(TEIV,":",1) I $P(TEIV,":",2)>30 S XTEIV=XTEIV+1 
 I "0515/6515"'[CDEE S XTEIV=$J(TEIV/50,0,0) 
 I +XTEIV=0 S XTEIV=1 
 S VETOR(1,XXCCLI)=AGEO_"|"_XTEIV 
 S VETOR(2,TCOM)="" 
 G AVC1 
AVC2 S (XAGEO,XXCCLI,TEIV)="",(MAIOR,CONT)=0 
AVC3 S XXCCLI=$O(VETOR(1,XXCCLI)) I XXCCLI?1"" G AVC4 
 S X=VETOR(1,XXCCLI),AGEO=$P(X,"|",1),XTEIV=$P(X,"|",2) 
 I AGEO'?1"" S XAGEO=AGEO 
 I MAIOR<XTEIV S MAIOR=XTEIV 
 S CONT=CONT+1 
 G AVC3 
AVC4 S TEIV=MAIOR+CONT 
 S (TCOM,XTCOM)="" F I=1:1 S TCOM=$O(VETOR(2,TCOM)) Q:TCOM?1""  S XTCOM=XTCOM_TCOM 
 I $L(XTCOM)=4 S XTCOM="M" 
 S ^IFPRP(CDEE,DSAI,CCAM,VIAG)=XAGEO_"|"_TEIV_"|"_OBPR_"|"_XTCOM_"|"_QALC_"|"_XCTRA 
AVCZ K VETOR Q  
 ;
RVI D RVI^IBSRVI(CDEE,NPED,ITPE,%AP,%MOD,%ROT,DFAB,.VITP,.SUPJ) Q
MDA D MDA^IFPEAT6O Q  ;Movimenta estoque Disponivel em Alteracao de item
PLM D PLM^IFPEAT6R Q  
 ;
CGN ;Tratamento para Pedido Granel
 I $D(^IFAPG(CDEE,CCLI,NPED))
 {
	N CTRA,ROTA,PLCV,DATI,DATF,VIAG,DTSA
	S (CTRA,ROTA,PLCV,DATI,DATF,VIAG,DTSA)=""	
	S X=^IFAPG(CDEE,CCLI,NPED)
	S CTRA=$P(X,"|",1),ROTA=$P(X,"|",2),PLCV=$P(X,"|",6)
	S DATI=$P(X,"|",3),DATF=$P(X,"|",4),VIAG=$P(X,"|",7),DTSA=$P(X,"|",8)
	S X=^IFAGI(CDEE,PLCV,NPED),$P(X,"|",1)=QPED,^IFAGI(CDEE,PLCV,NPED)=X
    D RFG^IBSRFU5
 }
CGNZ Q 

RestOperac ;Restrição Operacional - SOP
 New P1,P2,P3,P4,P5
 Set P1=CDEE,P2=NPED,P3=ITPE,P4=CCLI,P5=CPRO
 Do ^IFSRPR
 Quit 
]]></Routine>


<Routine name="IPCABM" type="MAC" languagemode="0" timestamp="65421,63872.125131"><![CDATA[
IPCABM ;Bloqueia/Libera Manutencao em Precos ; Sep 26 2005  9:40 AM ;dsdÚltima Alteração   VICTORSG 26/01/2018 09:51:30 ;Última Alteração   FLCARVALHO 12/02/2020 17:44:32
#Include sistema.BibliotecaMacro
#define setCorpoEmail(%postreamMail,%pstrTexto) Do %postreamMail.Write(%pstrTexto)
 ;
MCO ;Modulo de COntrole
 S $ZT="^sistema.err" 
 S PART=$J 
 I '$D(^ISGRU("MKPRECO",%US)) S MS=156,CMS="Grupo de Preco Combustivel"  D ^GAP.GAREM $$$ReadT(X,3)  G MCOZ 
 S DATC=+$$H^sistema.DOLLAR 
 I $D(^IBBLO(%AP,%MOD,%ROT)) S MS=36,ER="" D ^GAP.GAREM $$$ReadT(X,3)  G MCOZ 
 D MTE 
 S FIM=0 
 W /CUP(9,1),/ED(0) 
 S DIBF="" 
 ;Libera Bloqueio
 I '$D(^IPBMA(1)) G MCO1 
 K VETCPRO D DGP ; <flcarvalho - GDTI-5783 - Tarefa-122448 - Bloqueio por margem/>
 D EBL
 S THBL=2 
 D COL I FIM G MCOZ 
 D LIB 
 G MCO 
 ;Bloqueia
MCO1 
 K VETCPRO D DGP ; <flcarvalho - GDTI-5783 - Tarefa-122448 - Bloqueio por margem/>
 D LDB
 I FIM G MCOZ
 D LGP
 I FIM S FIM=0 G MCO1
 S THBL=1 
 D COB I FIM S FIM=0 G MCO1 
 D BLO 
MCOZ I $D(MUDA),MUDA S %K=",ROTI" D ^GAP.GARKG G ^@ROTI 
 Q  
 ;
MTE ;Monta TEla para bloqueio
 D ^IBSRTE 
 I $D(^IPBMA(1)) G MTE1
 ;
 W /CUP(4,1),/ICC28,/RAW("Bloqueia manutencao nas tabelas de preco a partir de: ["),/ICC29,/CUP(4,66),/ICC28,/RAW("]") 
 ;
MTE1
 D MTG
 W /CUP(20,75),/ICC29,/RAW("  "),/ICC28
MTEZ Q  
 ;
 ; <flcarvalho - GDTI-5783 - Tarefa-122448 - Bloqueio por margem> ######################################################################
MTG ; Monta tela grupo de produto a ser bloqueado
 W /CUP(6,1),/ICC28,/RAW("Para os grupos de produto (APCO):")
 W /CUP(7,1),/ICC28,/RAW("Gasolina:["),/ICC29,/CUP(7,14),/ICC28,/RAW("] ")
 W /CUP(7,17),/ICC28,/RAW("Álcool:["),/ICC29,/CUP(7,28),/ICC28,/RAW("] ")
 W /CUP(7,31),/ICC28,/RAW("Diesel:["),/ICC29,/CUP(7,42),/ICC28,/RAW("] ")
 W /CUP(7,45),/ICC28,/RAW("Querosene:["),/ICC29,/CUP(7,59),/ICC28,/RAW("] ")
 W /CUP(7,62),/ICC28,/RAW("Óleo Comb.:["),/ICC29,/CUP(7,77),/ICC28,/RAW("] ")
MTGZ Q
 ; </flcarvalho - GDTI-5783 - Tarefa-122448 - Bloqueio por margem> ######################################################################
 ;
EBL ;Exibe BLoqueio
 S X=^IPBMA(1),CARG=$P(X,"|",1),DIBF=$P(X,"|",2) 
 S DATT=$P(CARG,",",1),HORA=$P(CARG,",",2),USRT=$P(CARG,",",3) 
 S H=HORA\3600,X=HORA#3600,M=X\60,S=X#60 
 S HORA=$E(H+100,2,3)_":"_$E(M+100,2,3)_":"_$E(S+100,2,3) 
 S X=$G(^%GAU(USRT)),NUSRT=$P(X,"|",2) 
 S DAT=DIBF K %DI D DT^sistema.DOLLAR S XDIBF=$E(%X+100,2,3)_"/"_$E(%Z+100,2,3)_"/"_%Y 
 S DAT=DATT K %DI D DT^sistema.DOLLAR S DATT=$E(%X+100,2,3)_"/"_$E(%Z+100,2,3)_"/"_%Y 
 W /CUP(4,1),/ICC28,/RAW("Manutencao bloqueada a partir de"),/ICC29,/RAW(XDIBF) 
 W /CUP(9,1),/ICC28,/RAW("Bloqueado no Dia:"),/ICC29,/RAW(DATT),/ICC28,/RAW("as"),/ICC29,/RAW(HORA) 
 W /CUP(12,1),/ICC28,/RAW("             Por:"),/ICC29,/RAW(USRT_" - "_NUSRT) 
EBLZ Q  
 ;
LDB ;Le Data a ser Bloqueada
 S DIBF="" 
LDB1 W /CUP(4,57),/ICC24,/CON U 0:(256:"FC":$C(21,24)) $$$Read(R)  S:$A($ZB)=21!($A($ZB)=24) R=$ZB W:$A($ZB)=24 /ICC24 U 0:(256:"SFC":$C(21,24)) W /COFF,/ICC20,/ICC13 
 I R?1"/" D ^IBSRTR G:'MUDA LDB S FIM=1 G LDBZ 
 I R?1""!($A(R)=21) S FIM=1 G LDBZ 
 I R?1C.E S MS=3 D ^GAP.GAREM G LDB1 
 I R?1"?" S MS=4,ER="" D ^GAP.GAREM G LDB1 
 S DAT=R D ^sistema.DEI I DAT<1 S MS=4 D ^GAP.GAREM G LDB1 
 S D=+$$H^sistema.DOLLAR 
 I DAT<D S MS=6 D ^GAP.GAREM G LDB1 
 S DIBF=DAT 
 W /CUP(4,58) S %DI="" D DT^sistema.DOLLAR $$$Read(X)  
LDBZ Q  
 ;
 ; <flcarvalho - GDTI-5783 - Tarefa-122448 - Bloqueio por margem> ######################################################################
DGP ; Define Grupo de Produto e linha e coluna de exibição
 ;
 S XCOMB=1,COMB=11,XLIN=7,XCOL=13 ;"GAS"
 D RGP
 ;
 S XCOMB=2,COMB=10,XLIN=7,XCOL=27 ;"ALC"
 D RGP
 ;
 S XCOMB=3,COMB=15,XLIN=7,XCOL=41 ;"DIE"
 D RGP
 ;
 S XCOMB=4,COMB=14,XLIN=7,XCOL=58 ;"QUE"
 D RGP
 ;
 S XCOMB=5,COMB=17,XLIN=7,XCOL=76 ;"OCB"
 D RGP
 ;
 S XCOMB=""
DGP1 ; Exibe opção para seleção do grupo de produto
 S XCOMB=$O(VETCPRO(XCOMB)) G:XCOMB="" DGPZ
 S X=VETCPRO(XCOMB)
 S R=$P(X,"|",1),XLIN=$P(X,"|",2),XCOL=$P(X,"|",3)
 D EGP
 G DGP1
 ;
DGPZ Q
 ;
RGP ; Recupera grupo de produto e monta o vetor
 ; Entrada:
 ;	COMB,XCOMB,XLIN,XCOL
 S XOPCAO="S"
 S X=$G(VETCPRO(XCOMB))
 I X="" S X=XOPCAO_"|"_XLIN_"|"_XCOL_"|"_XCOMB
 ;
 I '$D(^IPBMA(1)) G RGP1
 I '$D(^IPBMA(1,COMB)) S XOPCAO="N"
RGP1
 S $P(X,"|",1)=XOPCAO,$P(X,"|",4)=COMB
 S VETCPRO(XCOMB)=X
RGPZ Q
 ;
EGP ; Exibe campo grupo produto
 W /CUP(XLIN,XCOL),/ICC24,/RAW(R) $$$Read(R)
EGPZ Q
 ;
LGP ; Lê Grupo de produto
 ;
LGP1
 S XCOMB="",DIRE=1
LGP2
 S XCOMB=$O(VETCPRO(XCOMB),DIRE) G:XCOMB="" LGPZ
 S X=VETCPRO(XCOMB)
 S (R,XR)=$P(X,"|",1),XLIN=$P(X,"|",2),XCOL=$P(X,"|",3)
 S FIM="" 
 D EGP,TCG
 I FIM=1 G LGP2
 S X=VETCPRO(XCOMB),$P(X,"|",1)=R,VETCPRO(XCOMB)=X
 G LGP2
 ;
LGPZ Q
 ;
TCG ; Trata campo grupo de produto
 S DIRE=1
 W /CUP(XLIN,XCOL),/CON U 0:(256:"FC":$C(21,24)) $$$Read(R)  S:$A($ZB)=21!($A($ZB)=24) R=$ZB W:$A($ZB)=24 /ICC24 U 0:(256:"SFC":$C(21,24)) W /COFF,/ICC20,/ICC13 
 I R?1"" S R=XR
 I ($A(R)=21) S FIM=1,DIRE=-1 G TCGZ 
 I R?1C.E S MS=3 D ^GAP.GAREM G TCG
 I R?1"?" S MS=4,ER="" D ^GAP.GAREM G TCG
 I ",S,N,"'[R S MS=4 D ^GAP.GAREM G TCG
 ;
TCGZ Q
 ;
 ; </flcarvalho - GDTI-5783 - Tarefa-122448 - Bloqueio por margem> ######################################################################
 ;
COB ;Confirma O Bloqueio
 S FIM=0 
 W /CUP(6,76),/ICC20,/RAW("OK para bloquear? S// ") U 0:(256:"FC":$C(21,24)) $$$Read(R)  S:$A($ZB)=21!($A($ZB)=24) R=$ZB W:$A($ZB)=24 /ICC24 U 0:(256:"SFC":$C(21,24)) W /ICC20,/ICC13 
 I R?1"" S R="S" 
 I R'?1"S",R'?1"N" S MS=1 S:R?1"?" ER="" D ^GAP.GAREM $$$ReadT(X,3)  W /ICC20,/ICC13 G COB 
 I R?1"N" S FIM=1 
COBZ Q  
 ;
BLO ;armazena BLOqueio da dependencia
 W /CUP(6,76),/ICC20,/RAW("Armazenando bloqueio...") 
 S DATA=$P($$H^sistema.DOLLAR,",",1),HORA=$P($$H^sistema.DOLLAR,",",2),USRT=%US 
 S CARG=DATA_","_HORA_","_USRT
 ;
 S ^IPBMA(1)=CARG_"|"_DIBF 
 S ^IPBMA("LOG",DIBF,DATA,HORA,USRT)=THBL
 ;
 D ABG
 ;
 W /RAW("OK") $$$ReadT(X,2)  W /ICC20,/ICC13
 ;
 S EMAIL="" 
 D TRE 
BLOZ Q  
 ;        
ABG ; Armazena Bloqueio por Grupo
 S XCOMB=""
ABG1
 S XCOMB=$O(VETCPRO(XCOMB)) G:XCOMB="" ABGZ
 S X=VETCPRO(XCOMB)
 S XOPCAO=$P(X,"|",1),XLIN=$P(X,"|",2),XCOL=$P(X,"|",3),COMB=$P(X,"|",4)
 I XOPCAO'="S" G ABG1
 ;
 I THBL=1 S ^IPBMA(1,COMB)=THBL
 S ^IPBMA("LOG",DIBF,DATA,HORA,USRT,COMB)=THBL
 ;
 G ABG1
 ;
ABGZ Q
 ;
COL ;COnfirma Liberacao
 S FIM=0 
 W /CUP(6,76),/ICC20,/RAW("Manutencao bloqueada na data acima. OK para liberar? ") U 0:(256:"FC":$C(21,24)) $$$Read(R)  S:$A($ZB)=21!($A($ZB)=24) R=$ZB W:$A($ZB)=24 /ICC24 U 0:(256:"SFC":$C(21,24)) W /ICC20,/ICC13 
 I R'?1"S",R'?1"N" S MS=1 S:R?1"?" ER="" D ^GAP.GAREM $$$ReadT(X,3)  W /ICC20,/ICC13 G COL 
 I R?1"N" S FIM=1 
COLZ Q  
 ;
LIB ;LIBera manutencao
 W /CUP(6,76),/ICC20,/RAW("Liberando...") 
 S DATA=$P($$H^sistema.DOLLAR,",",1),HORA=$P($$H^sistema.DOLLAR,",",2),USRT=%US 
 S CARG=DATA_","_HORA_","_USRT 
 S X=^IPBMA(1),DIBF=$P(X,"|",2) 
 S ^IPBMA("LOG",DIBF,DATA,HORA,USRT)=THBL 
 K ^IPBMA(1)
 ;
 D ABG
 ;
 W /RAW("OK") $$$ReadT(X,2)  W /ICC20,/ICC13 
 S EMAIL="" 
 D TRE
LIBZ Q  
 ;
TRE ;Transmite E-Mail
 ;
 //<Amauri - Abril/2013>
 // Tarefa 0067D09D - Projeto Obsolescência de Interface - Envio de Email
 //
 New strEmailsTo,strEmailFrom,strEmailsCC,strEmailsCO,strAssunto
 New strTitulo,oStreamMail,strAnexos,strURL,arrayFiles,oHTTPRequest
 ;
 Set oStreamMail=##class(%Library.GlobalCharacterStream).%New()
 ;
 S DIR=$$$ZU12()
 ;I DIR="/adm/des/" G TREZ 
 S MAIL="abadi@ipiranga.com.br;centralfni@ipiranga.com.br;centroop@ipiranga.com.br"
 S CONTATO="abadi@ipiranga.com.br"
 ; HPJ TAREFA 004EBCCE 11/2013
 S (UMAIL,UCONTATO,USRT)=""
 F  S USRT=$O(^ISGRU("AVISO_ALTERA-PA",USRT)) Q:USRT?1""  D
   .S X=$G(^%GAU(USRT)),MNEU=$P(X,"|",17),UMAIL=$P(X,"|",24)
   .I UMAIL?1"",MNEU'?1"" S UMAIL=MNEU_"@ipiranga.com.br"
   .S UCONTATO=UCONTATO_UMAIL_";"
 S MAIL=MAIL_";"_UCONTATO  
 I $$$Ambiente'=$$$AmbienteProducao S MAIL="flcarvalho@ipiranga.com.br"
 ;
 Set strEmailsTo=MAIL
 Set strEmailFrom=CONTATO
 ;
 Set strAssunto=$S(THBL=1:"Bloqueio",1:"Liberacao")_" das Tabelas de Preços ABADI (PCO/CA/BM)"
 ;
 S NREG="***************************************************************" D GAU 
 S NREG="De:          CIA BRASILEIRA DE PETROLEO IPIRANGA" D GAU 
 S NREG="Para:        Central de Informatica" D GAU 
 S NREG="***************************************************************" D GAU 
 S NREG="Tabelas de Preços no ABADI "_$S(THBL=1:"bloqueado",1:"liberado")_" por "_%US_"." D GAU 
 S NREG="Data efetiva de bloqueio: "_$$FDE(DIBF) D GAU
 S NREG=EMAIL D GAU
 ;
 S XCOMB=""
TRE1
 F XCOMB=$O(VETCPRO(XCOMB)) G:XCOMB="" TRE2
 S X=VETCPRO(XCOMB)
 S XOPCAO=$P(X,"|",1),XLIN=$P(X,"|",2),XCOL=$P(X,"|",3),COMB=$P(X,"|",4)
 ;
 S NREG=$Case(COMB,11:"GASOLINA",10:"ÁLCOOL",15:"DIESEL",14:"QUEROSENE",17:"ÓLEO COMBUSTÍVEL",:"")
 S NREG=NREG_" - "_$Case(THBL,1:$Case(XOPCAO,"S":"BLOQUEADO",:"LIBERADO"),:"LIBERADO")
 D GAU
 ;
 G TRE1
 ;
TRE2 
 ;
 Set strTitulo=""
 Set strEmailsCC=""
 Set strEmailsCO=""
 Set strAnexos=""
 Set strURL=""
 Set arrayFiles=""
 Set oHTTPRequest=""
 ;
 Set OK=$$enviaEmail^basico.SEEM(strEmailsTo,strEmailFrom,strAssunto,strTitulo,oStreamMail,strEmailsCC,strEmailsCO)
 ;
 Do oStreamMail.%Close()
 ;
 //
 //</Amauri>
 ;
TREZ Q  
 ;
GAU ;Grava Arquivo Unix
 //
 //<Amauri - Abril/2013>
 // Tarefa 0067D09D - Projeto Obsolescência de Interface - Envio de Email
 //
 $$$setCorpoEmail(oStreamMail,NREG)
 $$$setCorpoEmail(oStreamMail,"<BR>")
 //
 //</Amauri>
 // 
GAUZ Q  
 ;
FDE(X) ;Formata Data Externa
 I X?1"" G FDEZ 
 K %DI S DAT=X D DT^sistema.DOLLAR 
 S X=$E(100+%X,2,3)_"/"_$E(100+%Z,2,3)_"/"_%Y 
FDEZ Q X 

Z P IPCABM X "ZS IPCABM" Q  
]]></Routine>


<Routine name="IPHIBM1" type="MAC" languagemode="0" timestamp="65421,62399.939087"><![CDATA[
IPHIBM1 ;Bloqueio/Liberacao de Manutencao em Precos; Oct 28 1999  9:01 AM ; Oct 28 1999  9:13 AM ;gprÚltima Alteração  alexlack 16/11/2006 11:33:43 ;Última Alteração   FLCARVALHO 12/02/2020 17:19:59
#Include sistema.BibliotecaMacro
 ;
COR ;COntrole de Relatorio
 S $ZT="^sistema.err" 
 S PART=$J 
 S VIDEO=0 I XTT=1 S VIDEO=1,XLP=22,W="" W /CUP(1,1),/ED(0) 
 S BCOL=80 
 I DJOB S ^%GAB(%AP,%PN1,%PN2,$J)="J|"_%US_"|"_%MOD_"|"_%ROT_"|"_$$H^sistema.DOLLAR 
 I 'DJOB,DEV'=0,DEV'=%DP W /ICC20,/RAW("Imprimindo...") 
 O DEV:##class(cbpi.abadi.sistema.Dispositivo).getParamOpen(DEV) U DEV $$$DefMnmNmspc(DEV) 
 I 'DJOB G COR2 
 S X=0 
 I $D(^%GAB(%AP))#10,^%GAB(%AP)=1 S X=1 
 I $D(^%GAB(%AP,%PN1))#10,^%GAB(%AP,%PN1)=1 S X=1 
 I $D(^%GAB(%AP,%PN1,%PN2))#10,^%GAB(%AP,%PN1,%PN2)=1 S X=1 
 I 'X S ^%GAB(%AP,%PN1,%PN2,$J)=DEV_"J|"_%US_"|"_%MOD_"|"_%ROT_"|"_$$H^sistema.DOLLAR G COR2 
 I XTT=2 D CAP 
 D ^GAP.GARCR 
 W /CR(3),/ICSP((BCOL-62\2)),/RAW("*** APLICACAO BLOQUEADA, IMPOSSIVEL EMISSAO DO RELATORIO ***") G COR3 
 ;
COR2 I XTT=2 D CAP 
 D IMP 
 ;
COR3 I DJOB K ^%GAB(%AP,%PN1,%PN2,$J) 
 S ELFR="" 
 S XXDEV=DEV D FCH^GAP.GARAD S FIM=0 
 I 'DJOB,XXDEV'=0,XXDEV'=%DP W /RAW("OK"),/ICC13 $$$ReadT(X,3)  
CORZ Q  
 ;
CAP ;CAPa de relatorio
 S TITR="HISTORICO DE BLOQUEIO/LIBERACAO DE MANUTENCAO EM PRECOS" 
 D ^IBSRCR 
CAPZ Q  
 ;
IMP ;IMPrime Relatorio
 S TRACO="" 
 S $P(TRACO,"-",79)="" 
 D CAB 
 S DIBF="" 
IMP1 S DIBF=$ZP(^IPBMA("LOG",DIBF)) I DIBF?1"" G IMPZ 
 S NID=1 
 S DATA="" 
IMP2 S DATA=$ZP(^IPBMA("LOG",DIBF,DATA)) I DATA?1"" W /CR(1),/RAW(TRACO) G IMP1 
 S HORA="" 
IMP3 S HORA=$ZP(^IPBMA("LOG",DIBF,DATA,HORA)) I HORA?1"" G IMP2 
 S H=HORA\3600,X=HORA#3600,M=X\60,S=X#60 
 S XHORA=$E(H+100,2,3)_":"_$E(M+100,2,3)_":"_$E(S+100,2,3) 
 S USRT="" 
IMP4 S USRT=$O(^IPBMA("LOG",DIBF,DATA,HORA,USRT)) I USRT?1"" G IMP3 
 S X=^IPBMA("LOG",DIBF,DATA,HORA,USRT),THBL=$P(X,"|",1) 
 S XTHBL=$P("Bloqueado|Liberado","|",THBL) 
 S X=$G(^%GAU(USRT)),NUSRT=$P(X,"|",2) 
 I $Y+2>XLP D CAB S NID=1 I W?1"PARE" G IMPZ 
 W /CR(1) 
 I NID S NID=0 S DAT=DIBF,%DI="" D DT^sistema.DOLLAR 
 W /ICSP(10),/RAW(XTHBL) 
 S DAT=DATA,%DI="" W /ICSP(22) D DT^sistema.DOLLAR 
 W /ICSP(32),/RAW(XHORA),/ICSP(42),/RAW((USRT_" - "_$E(NUSRT,1,19)))
 ; <flcarvalho - GDTI-5783 - Tarefa-122448 - Bloqueio por margem>
 S (COMB,XCOMB,XCOMBDESC)=""
IMP5
 S COMB=$O(^IPBMA("LOG",DIBF,DATA,HORA,USRT,COMB)) I COMB="" G IMP6
 S XCOMB=$Case(COMB,11:"G",10:"A",15:"D",14:"Q",17:"O",:"")
 S XCOMBDESC=$Case(XCOMBDESC,"":XCOMBDESC_XCOMB,:XCOMBDESC_"/"_XCOMB)
 G IMP5
IMP6
 W /ICSP(70),/RAW(XCOMBDESC)
 ; </flcarvalho - GDTI-5783 - Tarefa-122448 - Projeto arredondamento na 5a casa>
 G IMP4
IMPZ Q  
 ;
CAB ;CABecalho de 80 colunas
 ;Video
 I XTT=2 G CAB1 
 W /CON U 0:(256:"FC":$C(21,24)) 
 D FF^sistema.DOLLAR 
 U 0:(256:"SFC":$C(21,24)) W /COFF 
 I W?1"PARE" G CABZ 
 G CAB2 
CAB1 ;Impressora
 D ^GAP.GARCR I W?1"PARE" G CABZ 
 S TIT="* * *   HISTORICO DE BLOQUEIO/LIBERACAO DE MANUTENCAO EM PRECOS   * * *" 
 S C=(80-$L(TIT))\2 
 W /CR(2),/ICSP(C),/RAW(TIT) 
 W /CR(2) 
CAB2 
 W /RAW("Data Fat  Ocorrencia    Data      Hora             Usuario             GR.PROD. "),/CR(1) 
 W /RAW("========  ==========  ========  ========  =========================  ===========") 
      ; "123456789.123456789.123456789.123456789.123456789.123456789.123456789.123456789."
      ; "         10        20        30        40        50        60        70        80"
CABZ Q  
 ;
Z P IPHIBM1 X "ZS IPHIBM1" Q  
]]></Routine>


<Class name="cbpi.abadi.preco.sistemacusto.Operacao">
<IncludeCode>sistema.BibliotecaMacro</IncludeCode>
<Super>%RegisteredObject</Super>
<TimeChanged>65422,41176.477195</TimeChanged>
<TimeCreated>64897,56673.376442</TimeCreated>

<Method name="realizarBloqueios">
<Description>
Avalia se já existe algum bloqueio para o cenário

Realiza o bloqueio de margem e faturamento</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pidCenario:%Integer</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	#Dim status,dataBloqueio,dataBloqueioExistente,idcenarioBloqueio,temBloqueioVigente,bBloquearFaturamento,bBloquearMargem,dataAtual
	#Dim usuarioSistCus
	#Dim oCenario As cbpi.abadi.preco.sistemacusto.CenarioIntegracao
	;
	Set status = $$$OK
	Set temBloqueioVigente = 0
	Set usuarioSistCus = "CUS"
	;
	Set oCenario = ##class(cbpi.abadi.preco.sistemacusto.CenarioIntegracao).instanciar(pidCenario)
	;
	If '$IsObject(oCenario) {
		Set status = $$$ERROR(5001,"Não foi possível carregar o cenário " _ pidCenario _ " para realizar os bloqueios.")
	}
	;
	If ($$$ISOK(status)) {
		Set dataBloqueio = $ZDateH(oCenario.dataVigencia,3)
		Set dataBloqueio = ##class(cbpi.abadi.datatype.DataMedidata).CacheToLogical(dataBloqueio)
		;
		Set bBloquearFaturamento = oCenario.faturamentoBloqueado
		Set bBloquearMargem = oCenario.margemBloqueada
		;
	}
	;
	If ($$$ISOK(status)) {
		;
		If ('bBloquearFaturamento) && ('bBloquearMargem) {
			Set status = ..enviarEmailNaoBloqueio(pidCenario, 3, dataBloqueio, usuarioSistCus)
		}
		Else {
			If (bBloquearFaturamento) {
				Set status = ..bloquearFaturamento(dataBloqueio,usuarioSistCus)
			}
			Else {
				/// Envia o e-mail para a área de inteligência de mercado informando que não será feito o bloqueio de faturamento
				Set status = ..enviarEmailNaoBloqueio(pidCenario, 1, dataBloqueio, usuarioSistCus)
			}
			If ($$$ISOK(status)) {
				If (bBloquearMargem) {
					Set dataAtual = +$$H^sistema.DOLLAR
					;
					Set status = ..bloquearMargem(dataAtual, usuarioSistCus)
					If ($$$ISERR(status)) {
						If (bBloquearFaturamento) {
							Set status = ..liberarFaturamento(usuarioSistCus)
						}
					}
				}
				Else {
					/// Envia o e-mail para a área de inteligência de mercado informando que não será feito o bloqueio de margem
					Set status = ..enviarEmailNaoBloqueio(pidCenario, 2, dataBloqueio, usuarioSistCus)
				}
			}
		}
	}
	;
	Quit status
]]></Implementation>
</Method>

<Method name="liberarBloqueios">
<Description>
Realiza a liberação dos bloqueios de faturamento e margem</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pidCenario:%Integer</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	#Dim status,dataBloqueioAtual,dataBloqueioExistente,idcenarioBloqueio,temBloqueioVigente
	#Dim podeLiberar,sc,bLiberarFaturamento,bLiberarMargem
	#Dim oCenario As cbpi.abadi.preco.sistemacusto.CenarioIntegracao
	;
	Set (status, sc) = $$$OK
	;
	Set oCenario = ##class(cbpi.abadi.preco.sistemacusto.CenarioIntegracao).instanciar(pidCenario)
	;
	If '$IsObject(oCenario) {
		Set status = $$$ERROR(5001,"Não foi possível carregar o cenário " _ pidCenario _ " para realizar os bloqueios.")
	}
	;
	Set dataBloqueioAtual = $ZDateH(oCenario.dataVigencia,3)
	Set dataBloqueioAtual = ##class(cbpi.abadi.datatype.DataMedidata).CacheToLogical(dataBloqueioAtual)
	;
	Set bLiberarFaturamento = oCenario.faturamentoBloqueado
	Set bLiberarMargem = oCenario.margemBloqueada
	;
	If ($$$ISOK(status)) {
		;
		If (bLiberarFaturamento) {
			Set sc = ..liberarFaturamento("CUS")
		}
		;
		If ($$$ISERR(sc)) {
			Set status = $$$ERROR(sc)
		}
		;
		If (bLiberarMargem) {
			Set sc = ..liberarMargem("CUS")
		}
		If ($$$ISERR(status) && $$$ISERR(sc)) {
			Set status = $$$ERROR(status,sc)
		}
		ElseIf ($$$ISERR(sc)) {
			Set status = $$$ERROR(sc)
		}
	}
	;
	Quit status
]]></Implementation>
</Method>

<Method name="bloquearFaturamento">
<Description>
Copiado de IPCABF</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pDataBloqueio:%Integer="",pUsuario:%String=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	#Dim CARG,CDEP,CDIS,DATA,DATAH,DDFAT,DIBF,EMAIL,HORA,HORAH,IDEM,NAOBLO,OK,TEM,THBL,USRT,VETDEP,X,XCDEP,status
	#Dim dataBloqueioExistente
	;
	Set status = $$$OK
	;
	Set (DATA,DATAH)=$Piece($$H^sistema.DOLLAR,",",1)
	Set (HORA,HORAH)=$Piece($$H^sistema.DOLLAR,",",2)
	;
	If (+pDataBloqueio < DATA) {
	 	Set status=$$$ERROR(5001,"Data de bloqueio, "_$$ZD^sistema.DOLLAR(pDataBloqueio,4)_", é menor que a data atual.")
	}
	;
	If ($$$ISOK(status)) {
		Set USRT=pUsuario 
		Set CARG=DATA_","_HORA_","_USRT 
		Set EMAIL="Dependencias bloqueadas:" 
		Set (OK,TEM)=0 
		Set (NAOBLO,XCDEP)=""
		Set VETDEP="T" ; Indica que deve recuperar todas as dependências
		Do recuperarLista^basico.SRIDT(.VETDEP,7) ; 7 -Empresa para a qual será recuperada as dependências
		;
		For {
			Set XCDEP=$Order(VETDEP(XCDEP))
			Quit:(XCDEP?1"")
			;
			Set X=^IBDEP(XCDEP),CDIS=$Piece(X,"|",4) 
			If XCDEP=CDIS {
				Continue
			}
			;
			If $Order(^IFNFS(XCDEP,""))?1"" {
				Continue
			}
			If $Data(^IPDFB(1,XCDEP)) {
				Set X=^IPDFB(1,XCDEP)
				Set dataBloqueioExistente=$Piece(X,"|",2)
				If (dataBloqueioExistente<=pDataBloqueio) {
					Continue
				}
			}
			Set X=^IBDEP(XCDEP)
			Set IDEM=$Piece(X,"|",35) 
			If IDEM'="S" {
				Continue 
			}
			If '$Data(^IFCOF(XCDEP)) {
				Continue 
			}
			Set TEM=1
			Set X=^IFCOF(XCDEP)
			Set DDFAT=$Piece(X,"|",1) 
			/*If ('$Data(^ISUEA(pUsuario)) && ('$Data(^ISGRU("PCO",pUsuario))) 
			&& ((pDataBloqueio<DDFAT) || ((pDataBloqueio=DDFAT) && (DDFAT=DATA)))) {
				Set NAOBLO=NAOBLO_", "_XCDEP 
				Continue 
			}*/ ; O sistema de custos tem o mesmo privilégio dos usuários do grupo PCO, por isso não entrarão nesta validação do bloqueio de faturamento.
			Set ^IPDFB("LOG",XCDEP,DATA,HORA,USRT)=1_"|"_pDataBloqueio ; 1 indica bloqueio
			Set ^IPDFB(1,XCDEP)=CARG_"|"_pDataBloqueio 
			Set OK=1 
			Set EMAIL=EMAIL_$Char(10)_XCDEP
		}
		;
		If (TEM && 'OK) {
			Set status=$$$ERROR(5001,"Nao foi possivel bloquear as dependencias: "_$Extract(NAOBLO,3,999))
		}
		/*ElseIf ('TEM && 'OK) { ; Quando não há dependências para bloquear, significa que estão bloqueadas e que pode prosseguir com a aplicação do cenário
			;Set status=$$$ERROR(5002,"NAO EXISTEM DEPENDENCIAS PARA BLOQUEAR.")
		}*/ ; Tratamento para não bloquear o processo quando não encontrar dependências para bloquear, pois já estão bloqueadas
		Else {
			If NAOBLO'?1"" {
				Set status=$$$ERROR(5001,"Nao foi possivel bloquear as dependencias: "_$Extract(NAOBLO,3,999))
				;
				; Como não foi possível bloquear o faturamento para algumas dependências, libera o faturamento das que foram bloqueadas.
				Set sc = ..liberarFaturamento("CUS")
			}
			ElseIf (OK) { ; Envia o e-mail somente se alguma dependência foi bloqueada.
				Set status=..enviarEmailFaturamento(1,pDataBloqueio,EMAIL,pUsuario)
			}
		}
	}
	Kill NAOBLO 
	Quit status
	;
]]></Implementation>
</Method>

<Method name="liberarFaturamento">
<Description>
Copiado de IPCABF</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pUsuario:%String,pEnviaEmail:%Integer=1</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	#Dim CARG,CDEE,CDEP,DATA,DIBF,EMAIL,ER,HORA,MS,NDEP,R,THBL,USRT,VETDEP,X,XCDEP,status
	#Dim DTRE,ITPE,NPED,VUNP
 	;
 	Kill VETDEP
 	Set status=$$$OK
 	;
	If ($$$ISOK(status)) {
		Do recuperarLista^basico.SRIDT(.VETDEP,7) ; 7 -Empresa para a qual será recuperada as dependências
		;
		Set EMAIL="Dependencias liberadas:" 
	 	Set DATA=$Piece($$H^sistema.DOLLAR,",",1),HORA=$Piece($$H^sistema.DOLLAR,",",2),USRT=pUsuario 
	 	Set CARG=DATA_","_HORA_","_USRT 
	 	Set XCDEP="",DIBF=""
	 	;
	 	S %US=pUsuario,%AP="PCO",%MOD="CA",%ROT="BF"
	 	;
		For { 
			Set XCDEP=$Order(^IPDFB(1,XCDEP)) 
			Quit:XCDEP?1""
			;
			Set X=^IPDFB(1,XCDEP)
			Set DIBF=$Piece(X,"|",2)
			Set ^IPDFB("LOG",XCDEP,DATA,HORA,USRT)=2_"|"_DIBF ; 2 - Desbloqueio do faturamento
			Kill ^IPDFB(1,XCDEP) 
			Set EMAIL=EMAIL_$Char(10)_XCDEP
			;
			; Copiado de APP^IPCABF ; ; Atualiza Pedidos PA
			Set (DTRE,NPED,ITPE)=""
			For  {
				Set DTRE=$Order(^IFPCP.BLF(XCDEP,DTRE)) 
				Quit:DTRE?1""
				For  {
					Set NPED=$Order(^IFPCP.BLF(XCDEP,DTRE,NPED)) 
					Quit:NPED?1""
					For {
						Set ITPE=$Order(^IFPCP.BLF(XCDEP,DTRE,NPED,ITPE)) 
						Quit:ITPE?1""
						Set X=$Get(^IFPCP(XCDEP,DTRE,NPED,ITPE))
						If X'?1"" Set VUNP=$Piece(X,"|",3)
						If $Data(^IFPED(XCDEP,NPED,0,ITPE)),'VUNP {
							Do CRR^IBSRMP(XCDEP,NPED,ITPE) 
						}
						Else {
							Kill ^IFPCP.BLF(XCDEP,DTRE,NPED,ITPE)
						}
					}
				}
			}
		}
		If (pEnviaEmail) && (DIBF'="") {
			Set status = ..enviarEmailFaturamento(2,DIBF,EMAIL,pUsuario)
		}
	}
	Quit status
]]></Implementation>
</Method>

<Method name="bloquearMargem">
<Description>
Copiado de IPCABM</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pDataBloqueio:%Integer="",pUsuario:%String=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	#Dim CARG,DATA,DIBF,EMAIL,HORA,THBL,USRT,status,X,dataBloqueioAtual,temBloqueioMargem
	;
	Set status=$$$OK
 	Set DATA=$Piece($$H^sistema.DOLLAR,",",1),HORA=$Piece($$H^sistema.DOLLAR,",",2),USRT=pUsuario 
 	Set CARG=DATA_","_HORA_","_USRT
 	Set temBloqueioMargem = 0
 	Set EMAIL=""
 	;
 	If (pDataBloqueio >= DATA) {
	 	;
	 	If $Data(^IPBMA(1)) {
		 	Set X=^IPBMA(1)
		 	Set dataBloqueioAtual=$Piece(X,"|",2)
		 	If (dataBloqueioAtual<=pDataBloqueio) {
			 	Set temBloqueioMargem = 1
		 	}
	 	}
	 	;
	 	If (($$$ISOK(status) && 'temBloqueioMargem)||((temBloqueioMargem=1)&&(dataBloqueioAtual=pDataBloqueio))) {
		 	Set ^IPBMA("LOG",pDataBloqueio,DATA,HORA,USRT)=1 
		 	Set ^IPBMA(1)=CARG_"|"_pDataBloqueio
		 	Set status=..atualizarBloqueioMargemGrupo(pDataBloqueio, pUsuario, 1, .EMAIL)
		 	Set status=..enviarEmailMargem(1,pDataBloqueio,EMAIL,pUsuario)
	 	}
 	}
 	Else {
	 	Set status = $$$ERROR(5001,"Data de bloqueio de margem não pode ser menor que a data atual.")
 	}
 	;
 	Quit status
]]></Implementation>
</Method>

<Method name="atualizarBloqueioMargemGrupo">
<Description>
Bloquear margem por grupo de produto
Quando o bloqueio for feito pelo sistema de margens, será bloqueado todos os grupos</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[pDataBloqueio:%Integer="",pUsuario:%String="",pTipoBloqueio,&pEMAIL:%String]]></FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	#Dim COMB,DATA,HORA,USRT,VETGRP,DIBF,status
	;
	Set status=$$$OK
 	Set DATA=$Piece($$H^sistema.DOLLAR,",",1),HORA=$Piece($$H^sistema.DOLLAR,",",2)
 	Set USRT=pUsuario,DIBF=pDataBloqueio
 	;
 	Kill VETGRP
 	Do ..definirVetorGrupo(.VETGRP)
 	;
 	If $Data(VETGRP) {
	 	Set COMB=""
	 	For {
		 	Set COMB=$Order(VETGRP(COMB))
		 	Quit:(COMB="")
		 	;
		 	If (pTipoBloqueio=1) {
		 		Set ^IPBMA(1,COMB)=pTipoBloqueio
		 	}
	 		Set ^IPBMA("LOG",DIBF,DATA,HORA,USRT,COMB)=pTipoBloqueio
	 		;
	 		Set pEMAIL = pEMAIL _ "<br/>" _ ..obterDescricaoGrupoProduto(COMB) _ " - "_$Case(pTipoBloqueio,1:"BLOQUEADO",:"LIBERADO")
	 	}
 	}
 	Quit status
]]></Implementation>
</Method>

<Method name="definirVetorGrupo">
<Description>
Define vetor de grupo de produto</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&VETGRP]]></FormalSpec>
<Implementation><![CDATA[
	S VETGRP(11)="" ; GAS
	S VETGRP(10)="" ; ALC
	S VETGRP(15)="" ; DIE
	S VETGRP(14)="" ; QUE
	S VETGRP(17)="" ; OLC
]]></Implementation>
</Method>

<Method name="obterDescricaoGrupoProduto">
<Description>
Obter a descrição por grupo de produto</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pCodigo:%Integer</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	Quit $Case(pCodigo,11:"GASOLINA",10:"ÁLCOOL",15:"DIESEL",14:"QUEROSENE",17:"ÓLEO COMBUSTÍVEL",:"")
]]></Implementation>
</Method>

<Method name="liberarMargem">
<Description>
Copiado de IPCABM</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pUsuario:%String=""</FormalSpec>
<Implementation><![CDATA[
	#Dim CARG,DATA,DIBF,EMAIL,HORA,USRT,X,status
	Set status=$$$OK
	Set DATA=$Piece($$H^sistema.DOLLAR,",",1)
	Set HORA=$Piece($$H^sistema.DOLLAR,",",2)
	Set USRT=pUsuario 
	Set EMAIL=""
	Set CARG=DATA_","_HORA_","_USRT 
	Set X=$G(^IPBMA(1))
	If (X '= "") {
		Set DIBF=$Piece(X,"|",2) 
		Set ^IPBMA("LOG",DIBF,DATA,HORA,USRT)=2 
		Kill ^IPBMA(1) 
		Set status=..atualizarBloqueioMargemGrupo(DIBF, pUsuario, 2, .EMAIL)
		If DIBF'="" {
			Set status=..enviarEmailMargem(2,DIBF,EMAIL,pUsuario)
		}
	}
	Quit status
]]></Implementation>
</Method>

<Method name="enviarEmailFaturamento">
<Description>
Copiado de TRE^IPCABF</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pTipoOperacao:%Integer,pDataBloqueio:%Integer,pEmail:%String,pUsuario:%String</FormalSpec>
<Implementation><![CDATA[
	#define setCorpoEmail(%postreamMail,%pstrTexto) Do %postreamMail.Write(%pstrTexto)
	;
	#Dim CONTATO,DATAH,DIBF,DIR,EMAIL,HEMED,HORABLQ,HORAH,HORAX,MAIL,MNEU,NREG,OK,THBL
	#Dim UCONTATO,UMAIL,USRT,X,XCUSU,XLOTR,XNUSU,arrayFiles,oHTTPRequest,strAnexos
	#Dim strAssunto,strEmailFrom,strEmailsCC,strEmailsCO,strEmailsTo,strTitulo,strURL
	#Dim CLOT1,XCCGO,XCLOT,XEMPR,status
 	;
 	Set status = $$$OK
 	Set DATAH=$Piece($$H^sistema.DOLLAR,",",1)
 	Set HORAH=$Piece($$H^sistema.DOLLAR,",",2)
 
 Set oStreamMail=##class(%Library.GlobalCharacterStream).%New()
 ;
 Set CONTATO="abadi@ipiranga.com.br"
 If ($$$Ambiente '= $$$AmbienteProducao) {
 	Set X="" If $Data(^ISUEA(pUsuario)) Set X=$Get(^%GAU(pUsuario))
 	Set MAIL=$Piece(X,"|",24)
	If ((MAIL?1"") || (pUsuario="INT") || (pUsuario="CUS")) {
		If ($$$Ambiente = $$$AmbienteHomolog) {
			Set MAIL="flcarvalho@ipiranga.com.br;renanmc@ipiranga.com.br"
		}
		Else {
			Set MAIL="flcarvalho@ipiranga.com.br"
		}
	}
 }
 Else  {
	Set MAIL="abadi@ipiranga.com.br;centralfni@ipiranga.com.br;precos@ipiranga.com.br;IpirangaOPRApoioOperacional@ultra.com.br" 
	Set MAIL=MAIL_";centroop@ipiranga.com.br;producaocpd@ultra.com.br"
	Set MAIL=MAIL_";operacoes.ipp@ipiranga.com.br;OPR-Todas_as_dependncias@ultra.com.br"
	Set MAIL=MAIL_";Ipirangaoprapoiooperacional@ultra.com.br;Ipirangaoprperformanceoperacional@ultra.com.br;OPR@ultra.com.br;AIT-GS@ultra.com.br;"
	Set MAIL=MAIL_";IpirangaAbadiBloqueioeLiberacao@ultra.com.br"
	Set (UMAIL,UCONTATO,USRT)=""
	For  {
		Set USRT=$Order(^ISGRU("AVISO_ALTERA-PA",USRT)) 
		Quit:USRT?1""
		Set X=$Get(^%GAU(USRT)),MNEU=$Piece(X,"|",17),UMAIL=$Piece(X,"|",24)
		If UMAIL?1"",MNEU'?1"" Set UMAIL=MNEU_"@ipiranga.com.br"
		Set UCONTATO=UCONTATO_UMAIL_";"
	}
	Set MAIL=MAIL_";"_UCONTATO  
 }
 ;
 Set strEmailsTo=MAIL
 Set strEmailFrom=CONTATO
 ;
 Set strAssunto=$Select(pTipoOperacao=1:"Bloqueio",1:"Liberação")_" do faturamento ABADI"
 ;
 Set X=^%GAU(pUsuario),XNUSU=$Piece(X,"|",2),XCCGO=$Piece(X,"|",3),XCLOT=$Piece(X,"|",4),XEMPR=$Piece(X,"|",13)
	;
	Set X="" If XCCGO,$Data(^ISCGO(+XEMPR,XCCGO)) Set X=^ISCGO(+XEMPR,XCCGO) 
	Set XCUSU=$Piece(X,"|",2) 
	;
	Set X="" If XCLOT Set CLOT1=1_$Extract(XCLOT+10000,2,5) If $Data(^IBFOR(CLOT1)) Set X=^IBFOR(CLOT1) 
	Set XLOTR=$Piece(X,"|",3) 
 	;
 	
 If pTipoOperacao=1 {
 	Set HORAX=$Select(pDataBloqueio>DATAH:1,1:HORAH)
 	Set HEMED=$ZTime(HORAX,1)
 	Set HORABLQ=HEMED
 }
 Set NREG="" 
 $$$setCorpoEmail(oStreamMail,NREG)
 $$$setCorpoEmail(oStreamMail,"<BR>")
 Set NREG="ATENÇÃO:" 
 $$$setCorpoEmail(oStreamMail,NREG)
 $$$setCorpoEmail(oStreamMail,"<BR>")
 Set NREG=""
 $$$setCorpoEmail(oStreamMail,NREG)
 $$$setCorpoEmail(oStreamMail,"<BR>")
 Set NREG="A "_XLOTR_" "_$Select(pTipoOperacao=1:"ATIVOU",1:"DESATIVOU")_" O BLOQUEIO DE FATURAMENTO DO ABADI PARA O DIA "_$$ZD^sistema.DOLLAR(pDataBloqueio,4)_$Select(pTipoOperacao=1:", A PARTIR DE "_HORABLQ,1:"")_"."
 $$$setCorpoEmail(oStreamMail,NREG)
 $$$setCorpoEmail(oStreamMail,"<BR>")
 Set NREG=""
 $$$setCorpoEmail(oStreamMail,NREG)
 $$$setCorpoEmail(oStreamMail,"<BR>")
 Set NREG="Responsável pelo "_$Select(pTipoOperacao=1:"Bloqueio:",1:"Desbloqueio:")
 $$$setCorpoEmail(oStreamMail,NREG)
 $$$setCorpoEmail(oStreamMail,"<BR>")
 Set NREG=XNUSU_" [SISTEMA CUSTOS]"
 $$$setCorpoEmail(oStreamMail,NREG)
 $$$setCorpoEmail(oStreamMail,"<BR>")
 Set NREG=XCUSU
 $$$setCorpoEmail(oStreamMail,NREG)
 $$$setCorpoEmail(oStreamMail,"<BR>")
 Set NREG=""
 $$$setCorpoEmail(oStreamMail,NREG)
 $$$setCorpoEmail(oStreamMail,"<BR>")
 Set NREG=pEmail
 $$$setCorpoEmail(oStreamMail,NREG)
 $$$setCorpoEmail(oStreamMail,"<BR>")
 Set NREG=""
 $$$setCorpoEmail(oStreamMail,NREG)
 $$$setCorpoEmail(oStreamMail,"<BR>")
 Set NREG="ATENÇÃO: "
 $$$setCorpoEmail(oStreamMail,NREG)
 $$$setCorpoEmail(oStreamMail,"<BR>")
 If pTipoOperacao=1 {
 	Set NREG="- As filiais que estiverem faturando no dia "_$$ZD^sistema.DOLLAR(pDataBloqueio,4)_", ou vierem a faturar a partir dessa data antes do desbloqueio do faturamento, terão suas tarefas de faturamento CANCELADAS AUTOMATICAMENTE."
 	$$$setCorpoEmail(oStreamMail,NREG)
 	$$$setCorpoEmail(oStreamMail,"<BR>") 
 	Set NREG="- Ao receberem a notificação de desbloqueio devem verificar se há necessidade de criar novas tarefas de faturamento na rotina FAT-FA-TF."
 	$$$setCorpoEmail(oStreamMail,NREG)
 	$$$setCorpoEmail(oStreamMail,"<BR>")
 }
 Else { 
 	Set NREG="- Verifiquem se há tarefas de faturamento ativas para a filial. Caso necessário criem novas tarefas na rotina FAT-FA-TF."
 	$$$setCorpoEmail(oStreamMail,NREG)
 	$$$setCorpoEmail(oStreamMail,"<BR>")
 }
 ; ***
 Set strTitulo=""
 Set strEmailsCC=""
 Set strEmailsCO=""
 Set strAnexos=""
 Set strURL=""
 Set arrayFiles=""
 Set oHTTPRequest=""
 ;
 Set status=$$enviaEmail^basico.SEEM(strEmailsTo,strEmailFrom,strAssunto,strTitulo,oStreamMail,strEmailsCC,strEmailsCO)
 ;
 Do oStreamMail.%Close()
 ;
 Quit status
]]></Implementation>
</Method>

<Method name="enviarEmailMargem">
<Description>
Copiado de TRE^IPCABM</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pTipoOperacao:%Integer,pDataBloqueio:%Integer,pEmail:%String,pUsuario:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	#Dim CONTATO,DIBF,DIR,EMAIL,MAIL,MNEU,NREG,OK,THBL,UCONTATO,UMAIL,USRT,X,arrayFiles,status,XNUSU
	#Dim oHTTPRequest,strAnexos,strAssunto,strEmailFrom,strEmailsCC,strEmailsCO,strEmailsTo,strTitulo,strURL
	;
	Set oStreamMail=##class(%Library.GlobalCharacterStream).%New()
	;
	Set status=$$$OK
	Set CONTATO="abadi@ipiranga.com.br"
	;
	Set XNUSU=""
	Set X=^%GAU(pUsuario),XNUSU=$Piece(X,"|",2)
	;
	Set (UMAIL,UCONTATO,USRT)=""
	;
	If ($$$Ambiente '= $$$AmbienteProducao) {
	 	Set X="" If $Data(^ISUEA(pUsuario)) Set X=$Get(^%GAU(pUsuario))
	 	Set MAIL=$Piece(X,"|",24)
		If ((MAIL?1"") || (pUsuario="INT") || (pUsuario="CUS")) {
			If ($$$Ambiente = $$$AmbienteHomolog) {
				Set MAIL="flcarvalho@ipiranga.com.br;renanmc@ipiranga.com.br"
			}
			Else {
				Set MAIL="flcarvalho@ipiranga.com.br"
			}
		}
	}
	Else  {
		Set MAIL="abadi@ipiranga.com.br;centralfni@ipiranga.com.br;centroop@ipiranga.com.br"
		For {
			Set USRT=$Order(^ISGRU("PCO",USRT)) 
			Quit:USRT?1""
			Set X=$Get(^%GAU(USRT))
			Set MNEU=$Piece(X,"|",17)
			Set UMAIL=$Piece(X,"|",24)
			If UMAIL?1"",MNEU'?1"" {
				Set UMAIL=MNEU_"@ipiranga.com.br"
			}
			Set UCONTATO=UCONTATO_UMAIL_";"
		}
		Set MAIL=MAIL_";"_UCONTATO
	}
	;
	Set strEmailsTo=MAIL
	Set strEmailFrom=CONTATO
	;
	Set strAssunto=$Select(pTipoOperacao=1:"Bloqueio",1:"Liberacao")_" das Tabelas de Preços ABADI (PCO/CA/BM)"
	;
	Set NREG="***************************************************************"
	$$$setCorpoEmail(oStreamMail,NREG)
 	$$$setCorpoEmail(oStreamMail,"<BR>")
 	Set NREG="De:          CIA BRASILEIRA DE PETROLEO IPIRANGA"
	$$$setCorpoEmail(oStreamMail,NREG)
 	$$$setCorpoEmail(oStreamMail,"<BR>")
 	Set NREG="Para:        Central de Informatica"
	$$$setCorpoEmail(oStreamMail,NREG)
 	$$$setCorpoEmail(oStreamMail,"<BR>")
 	Set NREG="***************************************************************"
	$$$setCorpoEmail(oStreamMail,NREG)
 	$$$setCorpoEmail(oStreamMail,"<BR>")
 	Set NREG="Tabelas de Preços no ABADI "_$Select(pTipoOperacao=1:"bloqueado",1:"liberado")_" por "_XNUSU_". [SISTEMA CUSTOS]."
	$$$setCorpoEmail(oStreamMail,NREG)
 	$$$setCorpoEmail(oStreamMail,"<BR>")
 	Set NREG="Data efetiva de bloqueio: "_$$ZD^sistema.DOLLAR(pDataBloqueio,4)
	$$$setCorpoEmail(oStreamMail,NREG)
 	$$$setCorpoEmail(oStreamMail,"<BR>")
 	Set NREG=pEmail
	$$$setCorpoEmail(oStreamMail,NREG)
 	$$$setCorpoEmail(oStreamMail,"<BR>")
 	;
	Set strTitulo=""
	Set strEmailsCC=""
	Set strEmailsCO=""
	Set strAnexos=""
	Set strURL=""
	Set arrayFiles=""
	Set oHTTPRequest=""
	;
	Set status=$$enviaEmail^basico.SEEM(strEmailsTo,strEmailFrom,strAssunto,strTitulo,oStreamMail,strEmailsCC,strEmailsCO)
	;
	Do oStreamMail.%Close()
	;
	Quit status
]]></Implementation>
</Method>

<Method name="enviarEmailNaoBloqueio">
<Description>
Envia e-mail de não bloqueio do faturamento</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pidCenario:%Integer,pTipoBloqueio:%Integer,pDataBloqueio:%Integer,pUsuario:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	#define setCorpoEmail(%postreamMail,%pstrTexto) Do %postreamMail.Write(%pstrTexto)
	;
	#Dim CONTATO,DATAH,DIBF,DIR,EMAIL,HEMED,HORABLQ,HORAH,HORAX,MAIL,MNEU,NREG,OK,THBL
	#Dim UCONTATO,UMAIL,USRT,X,XCUSU,XLOTR,XNUSU,arrayFiles,oHTTPRequest,strAnexos
	#Dim strAssunto,strEmailFrom,strEmailsCC,strEmailsCO,strEmailsTo,strTitulo,strURL
	#Dim CLOT1,XCCGO,XCLOT,XEMPR,status
 	;
 	Set status = $$$OK
 	Set DATAH=$Piece($$H^sistema.DOLLAR,",",1)
 	Set HORAH=$Piece($$H^sistema.DOLLAR,",",2)
	;
	Set oStreamMail=##class(%Library.GlobalCharacterStream).%New()
	;
	Set CONTATO="abadi@ipiranga.com.br"
	If ($$$Ambiente '= $$$AmbienteProducao) {
		Set X="" If $Data(^ISUEA(pUsuario)) Set X=$Get(^%GAU(pUsuario))
		Set MAIL=$Piece(X,"|",24)
		If ((MAIL?1"") || (pUsuario="INT") || (pUsuario="CUS")) {
			If ($$$Ambiente = $$$AmbienteHomolog) {
				Set MAIL="flcarvalho@ipiranga.com.br;renanmc@ipiranga.com.br"
			}
			Else {
				Set MAIL="flcarvalho@ipiranga.com.br"
			}
		}
	}
	Else  {
	Set MAIL="precos@ipiranga.com.br;"
	}
	;
	Set strEmailsTo=MAIL
	Set strEmailFrom=CONTATO
	;
	Set strAssunto="Execução do cenário será feito sem o Bloqueio de "
	Set strAssunto=strAssunto_$Case(pTipoBloqueio,1:"Faturamento",2:"Margem",3:"Faturamento/Margem",:"")_" "
	Set strAssunto=strAssunto_" conforme parametrização."
	;
	Set NREG="" 
	$$$setCorpoEmail(oStreamMail,NREG)
	$$$setCorpoEmail(oStreamMail,"<BR>")
	Set NREG="ATENÇÃO:" 
	$$$setCorpoEmail(oStreamMail,NREG)
	$$$setCorpoEmail(oStreamMail,"<BR>")
	Set NREG=""
	$$$setCorpoEmail(oStreamMail,NREG)
	$$$setCorpoEmail(oStreamMail,"<BR>")
	Set NREG="O cenário " _ pidCenario _ " será executado sem o bloqueio de " _$Case(pTipoBloqueio,1:"Faturamento",2:"Margem",3:"Faturamento/Margem",:"")_"."
	$$$setCorpoEmail(oStreamMail,NREG)
	$$$setCorpoEmail(oStreamMail,"<BR>")
	Set NREG=""
	$$$setCorpoEmail(oStreamMail,NREG)
	$$$setCorpoEmail(oStreamMail,"<BR>")
	Set NREG="Data de vigência do cenário: " _ $$ZD^sistema.DOLLAR(pDataBloqueio,4)
	$$$setCorpoEmail(oStreamMail,NREG)
	$$$setCorpoEmail(oStreamMail,"<BR>")
	;
	Set strTitulo=""
	Set strEmailsCC=""
	Set strEmailsCO=""
	Set strAnexos=""
	Set strURL=""
	Set arrayFiles=""
	Set oHTTPRequest=""
	;
	Set status=$$enviaEmail^basico.SEEM(strEmailsTo,strEmailFrom,strAssunto,strTitulo,oStreamMail,strEmailsCC,strEmailsCO)
	;
	Do oStreamMail.%Close()
	;
	Quit status
]]></Implementation>
</Method>

<Method name="enviarEmailCenarioIncompleto">
<Description>
Envia e-mail do cenário incompleto.
Método invocado para enviar e-mail quando o ABADI não conseguir atualizar todos os registros no Oracle</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pidCenario:%Integer</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	#define setCorpoEmail(%postreamMail,%pstrTexto) Do %postreamMail.Write(%pstrTexto)
	;
	#Dim status,CONTATO,DATAH,HORAH,MAIL,NREG,arrayFiles,oHTTPRequest,pDataBloqueio
	#Dim strAnexos,strAssunto,strEmailFrom,strEmailsCC,strEmailsCO,strEmailsTo,strTitulo,strURL
	#Dim oCenario As cbpi.abadi.preco.sistemacusto.CenarioIntegracao
	;
	Set status = $$$OK
	Set oCenario = ##class(cbpi.abadi.preco.sistemacusto.CenarioIntegracao).instanciar(pidCenario)
	;
	If ($IsObject(oCenario)) {
		Set DATAH=$Piece($$H^sistema.DOLLAR,",",1)
	 	Set HORAH=$Piece($$H^sistema.DOLLAR,",",2)
		;
		Set oStreamMail=##class(%Library.GlobalCharacterStream).%New()
		;
		Set CONTATO="abadi@ipiranga.com.br"
		If ($$$Ambiente '= $$$AmbienteProducao) {
			If ($$$Ambiente = $$$AmbienteHomolog) {
				Set MAIL="flcarvalho@ipiranga.com.br;renanmc@ipiranga.com.br"
			}
			Else {
				Set MAIL="flcarvalho@ipiranga.com.br"
			}
		}
		Else  {
			Set MAIL="precos@ipiranga.com.br;flcarvalho@ipiranga.com.br;douglass@ipiranga.com.br"
		}
		;
		Set strEmailsTo=MAIL
		Set strEmailFrom=CONTATO
		;
		Set strAssunto="Execução do cenário de custos ("_ pidCenario _") - Atualização incompleta dos registros de estratégia "
		;
		Set NREG="" 
		$$$setCorpoEmail(oStreamMail,NREG)
		$$$setCorpoEmail(oStreamMail,"<BR>")
		Set NREG="ATENÇÃO:" 
		$$$setCorpoEmail(oStreamMail,NREG)
		$$$setCorpoEmail(oStreamMail,"<BR>")
		Set NREG=""
		$$$setCorpoEmail(oStreamMail,NREG)
		$$$setCorpoEmail(oStreamMail,"<BR>")
		Set NREG="O cenário " _ pidCenario _ " terminou a atualização com sucesso no ABADI mas não conseguiu atualizar todos os registros para o sistema de custos."
		$$$setCorpoEmail(oStreamMail,NREG)
		$$$setCorpoEmail(oStreamMail,"<BR>")
		Set NREG="Por favor, abra um chamado para que o problema seja verificado."
		$$$setCorpoEmail(oStreamMail,NREG)
		$$$setCorpoEmail(oStreamMail,"<BR>")
		Set NREG=""
		$$$setCorpoEmail(oStreamMail,NREG)
		$$$setCorpoEmail(oStreamMail,"<BR>")
		Set NREG="Total de registros processados no ABADI: " _ oCenario.totalRegProc
		$$$setCorpoEmail(oStreamMail,NREG)
		$$$setCorpoEmail(oStreamMail,"<BR>")
		;
		Set strTitulo=""
		Set strEmailsCC=""
		Set strEmailsCO=""
		Set strAnexos=""
		Set strURL=""
		Set arrayFiles=""
		Set oHTTPRequest=""
		;
		Set status=$$enviaEmail^basico.SEEM(strEmailsTo,strEmailFrom,strAssunto,strTitulo,oStreamMail,strEmailsCC,strEmailsCO)
		;
		Do oStreamMail.%Close()
	}
	Else {
		Set status = $$$ERROR(5001,"Não foi possível instanciar o cenário " _ pidCenario)
	}
	;
	Quit status
]]></Implementation>
</Method>
</Class>


<Project name="flcarvalho_123290" LastModified="2020-03-03 12:03:51.921889">
  <Items>
    <ProjectItem name="IBSR.preco.MrgPrzPrEPontual.MAC" type="MAC"></ProjectItem>
    <ProjectItem name="IFFAFA3A.MAC" type="MAC"></ProjectItem>
    <ProjectItem name="IFFAFA4D.MAC" type="MAC"></ProjectItem>
    <ProjectItem name="IFPEAT0.MAC" type="MAC"></ProjectItem>
    <ProjectItem name="IFPEAT0E.MAC" type="MAC"></ProjectItem>
    <ProjectItem name="IFPEAT12.MAC" type="MAC"></ProjectItem>
    <ProjectItem name="IFPEAT15.MAC" type="MAC"></ProjectItem>
    <ProjectItem name="IFPEAT46.MAC" type="MAC"></ProjectItem>
    <ProjectItem name="IFPEAT6A.MAC" type="MAC"></ProjectItem>
    <ProjectItem name="IFPEAT6B.MAC" type="MAC"></ProjectItem>
    <ProjectItem name="IFPEAT6F.MAC" type="MAC"></ProjectItem>
    <ProjectItem name="IFPEAT6K.MAC" type="MAC"></ProjectItem>
    <ProjectItem name="IFPEAT6N.MAC" type="MAC"></ProjectItem>
    <ProjectItem name="IPCABM.MAC" type="MAC"></ProjectItem>
    <ProjectItem name="IPHIBM1.MAC" type="MAC"></ProjectItem>
    <ProjectItem name="cbpi.abadi.preco.sistemacusto.Operacao" type="CLS"></ProjectItem>
  </Items>
  <BreakPoints>
    <BreakPoint Routine="IFFAFA3A.MAC" Offset="232"></BreakPoint>
    <BreakPoint Routine="IFFAFA4D.MAC" Offset="112"></BreakPoint>
    <BreakPoint Routine="IFFAFA4D.MAC" Offset="326"></BreakPoint>
  </BreakPoints>
</Project>
</Export>
